# 需求文档 - 配送完成后佣金生成功能修复

## 简介

本需求旨在修复配送完成后未自动生成团长佣金的问题。当前系统在批量更新订单状态为"已送达"时，缺少调用佣金生成逻辑，导致团长无法获得应得的佣金。

## 术语表

- **OrderService**: 订单服务，负责订单管理和状态更新
- **DeliveryService**: 配送服务，负责配送单管理和配送完成操作
- **LeaderService**: 团长服务，负责佣金记录的生成和管理
- **佣金记录**: commission_record表中的记录，记录团长从订单中获得的佣金
- **订单状态**: order_status字段，3表示"已送达"
- **批量更新**: batchUpdateToDelivered方法，用于批量将订单状态更新为"已送达"

## 需求

### 需求 1：配送完成时自动生成佣金

**用户故事**: 作为系统管理员，当我完成配送单时，系统应该自动为相关订单生成团长佣金记录，以便团长能够及时获得收益。

#### 验收标准

1. WHEN 管理员点击"完成配送"按钮 THEN 系统应将配送单状态更新为"已完成"，并将关联的所有订单状态更新为"已送达"
2. WHEN 订单状态从非"已送达"更新为"已送达" THEN 系统应自动调用LeaderService生成佣金记录
3. WHEN 批量更新订单状态时 THEN 系统应为每个订单检查是否需要生成佣金，并逐个调用佣金生成接口
4. WHEN 佣金生成失败时 THEN 系统应记录错误日志，但不应阻止订单状态更新（保证业务连续性）
5. WHEN 订单的leaderId为空或payAmount无效时 THEN 系统应跳过该订单的佣金生成，并记录警告日志

### 需求 2：佣金生成的幂等性保证

**用户故事**: 作为系统开发者，我需要确保佣金生成具有幂等性，避免重复生成佣金记录。

#### 验收标准

1. WHEN 同一订单多次触发佣金生成 THEN 系统应只生成一条佣金记录
2. WHEN 订单状态从"已送达"再次更新为"已送达" THEN 系统应跳过佣金生成
3. WHEN LeaderService检测到订单已存在佣金记录 THEN 应返回错误信息，OrderService应记录日志但不抛出异常
4. THE commission_record表应有uk_order_id唯一索引，确保一个订单只能有一条佣金记录

### 需求 3：佣金生成的可追溯性

**用户故事**: 作为系统管理员，我需要能够追踪佣金生成的过程，以便排查问题。

#### 验收标准

1. WHEN 系统开始生成佣金时 THEN 应记录INFO级别日志，包含orderId、leaderId、payAmount
2. WHEN 佣金生成成功时 THEN 应记录INFO级别日志，包含生成的佣金记录ID
3. WHEN 佣金生成失败时 THEN 应记录ERROR级别日志，包含失败原因和异常堆栈
4. WHEN 订单参数无效导致跳过佣金生成时 THEN 应记录WARN级别日志，说明跳过原因
5. THE 日志应包含足够的上下文信息，便于问题定位

### 需求 4：前端展示佣金生成结果

**用户故事**: 作为系统管理员，当我完成配送后，我希望能够看到佣金生成的结果反馈。

#### 验收标准

1. WHEN 配送完成操作成功时 THEN 前端应显示成功提示，包含"配送已完成"的消息
2. WHEN 用户刷新佣金管理页面时 THEN 应能看到新生成的待结算佣金记录
3. THE 佣金管理页面的"待结算佣金"统计数据应实时更新
4. THE 前端不需要显示每个订单的佣金生成详情（后端日志已记录）
