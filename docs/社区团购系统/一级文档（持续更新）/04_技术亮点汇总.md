# ç¤¾åŒºå›¢è´­ç³»ç»Ÿ - æŠ€æœ¯äº®ç‚¹æ±‡æ€»

**é¡¹ç›®**: åŸºäºSpring Bootçš„ç¤¾åŒºå›¢è´­ç³»ç»Ÿ  
**å­¦ç”Ÿ**: è€¿åº·ç‘ (20221204229)  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-11-04  
**ç”¨é€”**: ç­”è¾©å‡†å¤‡ã€æŠ€æœ¯å±•ç¤º

---

## ğŸ¯ æŠ€æœ¯äº®ç‚¹æ€»è§ˆ

æœ¬é¡¹ç›®å…±å®ç°**10ä¸ªæ ¸å¿ƒæŠ€æœ¯äº®ç‚¹**ï¼Œæ¶µç›–å¾®æœåŠ¡æ¶æ„ã€ç®—æ³•è®¾è®¡ã€å¹¶å‘æ§åˆ¶ã€ä¸šåŠ¡é—­ç¯ç­‰å¤šä¸ªæ–¹é¢ã€‚

| åºå· | æŠ€æœ¯äº®ç‚¹ | éš¾åº¦ | åˆ›æ–°æ€§ | å®ç”¨æ€§ |
|------|---------|------|--------|--------|
| 1 | åŒè½¨åˆ¶æ—¥å¿—ç³»ç»Ÿ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| 2 | Haversineè·ç¦»è®¡ç®—ç®—æ³• | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| 3 | æ— Redisåˆ†å¸ƒå¼é”æ–¹æ¡ˆ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| 4 | ä¸‰å±‚å¹‚ç­‰æ€§è®¾è®¡ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| 5 | Sagaæ¨¡å¼è·¨æœåŠ¡è°ƒç”¨ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| 6 | ç¤¾åŒºä¼˜å…ˆæ¨èç®—æ³• | â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| 7 | è®¢å•å¿«ç…§è®¾è®¡ | â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| 8 | å¾®æœåŠ¡æ•°æ®åº“éš”ç¦» | â­â­â­â­ | â­â­â­ | â­â­â­â­ |
| 9 | JWTç½‘å…³ç»Ÿä¸€é‰´æƒ | â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| 10 | å®šæ—¶ä»»åŠ¡è‡ªåŠ¨åŒ– | â­â­â­ | â­â­â­ | â­â­â­â­ |

---

## 1ï¸âƒ£ åŒè½¨åˆ¶æ—¥å¿—ç³»ç»Ÿ â­â­â­â­â­

### æŠ€æœ¯æ–¹æ¡ˆ
```
æŠ€æœ¯æ—¥å¿— (Logback)              ä¸šåŠ¡æ—¥å¿— (AOP)
â”œâ”€ æ§åˆ¶å°å½©è‰²è¾“å‡º                â”œâ”€ @OperationLogæ³¨è§£
â”œâ”€ æ–‡ä»¶æŒä¹…åŒ–                    â”œâ”€ å¼‚æ­¥ä¿å­˜æ•°æ®åº“
â”œâ”€ æŒ‰æ—¥æœŸ+å¤§å°æ»šåŠ¨               â”œâ”€ è‡ªåŠ¨è·å–ç”¨æˆ·ä¿¡æ¯
â””â”€ ä¿ç•™30å¤©                      â””â”€ æ•æ„Ÿä¿¡æ¯è„±æ•

ç”¨é€”ï¼šå¼€å‘è°ƒè¯•                   ç”¨é€”ï¼šä¸šåŠ¡å®¡è®¡
```

### æ ¸å¿ƒä»£ç 
```java
@Aspect
@Component
public class OperationLogAspect {
    
    @Around("@annotation(operationLog)")
    public Object doAround(ProceedingJoinPoint joinPoint, 
                          OperationLog operationLog) {
        // å¼‚æ­¥ä¿å­˜æ“ä½œæ—¥å¿—åˆ°æ•°æ®åº“
        executorService.submit(() -> {
            SysOperationLog log = new SysOperationLog();
            log.setModule(operationLog.module());
            log.setOperation(operationLog.operation());
            log.setUserId(SecurityUtil.getCurrentUserId());
            // è‡ªåŠ¨è„±æ•æ•æ„Ÿä¿¡æ¯
            log.setParams(desensitize(params));
            logRepository.save(log);
        });
    }
}
```

### æŠ€æœ¯äº®ç‚¹
- âœ… **æŠ€æœ¯ä¸ä¸šåŠ¡åˆ†ç¦»**: äº’ä¸å¹²æ‰°ï¼Œå„å¸å…¶èŒ
- âœ… **å¼‚æ­¥å¤„ç†**: ä¸å½±å“ä¸šåŠ¡æ€§èƒ½
- âœ… **è‡ªåŠ¨è„±æ•**: ä¿æŠ¤æ•æ„Ÿä¿¡æ¯
- âœ… **AOPæ— ä¾µå…¥**: æ³¨è§£å³ç”¨ï¼Œä»£ç æ•´æ´

### åº”ç”¨åœºæ™¯
- å¼€å‘è°ƒè¯•: å¿«é€Ÿå®šä½é—®é¢˜
- ä¸šåŠ¡å®¡è®¡: ç”¨æˆ·æ“ä½œè¿½æº¯
- å®‰å…¨ç›‘æ§: å¼‚å¸¸è¡Œä¸ºæ£€æµ‹

---

## 2ï¸âƒ£ Haversineè·ç¦»è®¡ç®—ç®—æ³• â­â­â­â­â­

### ä¸šåŠ¡èƒŒæ™¯
ç”¨æˆ·æäº¤ç¤¾åŒºç”³è¯·æ—¶ï¼Œç³»ç»Ÿéœ€è¦æ ¹æ®ç”¨æˆ·ç»çº¬åº¦è‡ªåŠ¨åŒ¹é…æœ€è¿‘çš„å·²æœ‰ç¤¾åŒºï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒã€‚

### æŠ€æœ¯æ–¹æ¡ˆ
```
Step 1: çŸ©å½¢èŒƒå›´ç²—ç­›ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
â”œâ”€ è®¡ç®—ç»çº¬åº¦èŒƒå›´ (lat Â± Î”lat, lng Â± Î”lng)
â””â”€ SQL WHERE æ¡ä»¶å¿«é€Ÿè¿‡æ»¤

Step 2: Haversineå…¬å¼ç²¾ç®—
â”œâ”€ éå†å€™é€‰ç¤¾åŒº
â”œâ”€ è®¡ç®—çƒé¢è·ç¦»
â””â”€ é€‰æ‹©æœ€è¿‘ç¤¾åŒº
```

### æ ¸å¿ƒä»£ç 
```java
public static double calculateDistance(double lat1, double lng1, 
                                      double lat2, double lng2) {
    final double R = 6371; // åœ°çƒåŠå¾„(km)
    
    double dLat = Math.toRadians(lat2 - lat1);
    double dLng = Math.toRadians(lng2 - lng1);
    
    double a = Math.sin(dLat/2) * Math.sin(dLat/2) +
               Math.cos(Math.toRadians(lat1)) * 
               Math.cos(Math.toRadians(lat2)) *
               Math.sin(dLng/2) * Math.sin(dLng/2);
    
    double c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    
    return R * c; // è¿”å›å…¬é‡Œæ•°
}
```

### æŠ€æœ¯äº®ç‚¹
- âœ… **é«˜ç²¾åº¦**: è€ƒè™‘åœ°çƒæ›²ç‡ï¼Œè¯¯å·®<1%
- âœ… **æ€§èƒ½ä¼˜åŒ–**: çŸ©å½¢ç²—ç­› + ç²¾ç¡®è®¡ç®—
- âœ… **å®ç”¨æ€§å¼º**: ç¤¾åŒºæ¨èã€é…é€èŒƒå›´åˆ¤æ–­
- âœ… **ç®—æ³•ç»å…¸**: Haversineå…¬å¼å¹¿æ³›åº”ç”¨

### æ€§èƒ½æ•°æ®
- çŸ©å½¢ç²—ç­›: 10000æ¡ â†’ 100æ¡ (99%è¿‡æ»¤)
- ç²¾ç¡®è®¡ç®—: 100æ¬¡ Ã— 0.01ms = 1ms
- æ€»è€—æ—¶: < 5ms

---

## 3ï¸âƒ£ æ— Redisåˆ†å¸ƒå¼é”æ–¹æ¡ˆ â­â­â­â­â­

### ä¸šåŠ¡åœºæ™¯
æ‹¼å›¢å¹¶å‘åœºæ™¯ï¼š10äººåŒæ—¶å‚åŠ 3äººå›¢ï¼Œå¦‚ä½•ä¿è¯åªæœ‰3äººæˆåŠŸï¼Ÿ

### æŠ€æœ¯æ–¹æ¡ˆ
ä½¿ç”¨æ•°æ®åº“è¡Œé” (`SELECT ... FOR UPDATE`) æ›¿ä»£Redisåˆ†å¸ƒå¼é”

### æ ¸å¿ƒä»£ç 
```java
// Repositoryå±‚
@Query("SELECT t FROM GroupBuyTeam t WHERE t.teamId = :teamId")
@Lock(LockModeType.PESSIMISTIC_WRITE)
Optional<GroupBuyTeam> findByIdForUpdate(@Param("teamId") Long teamId);

// Serviceå±‚
@Transactional
public void joinTeam(Long teamId, Long userId) {
    // è¡Œé”è·å–å›¢ä¿¡æ¯
    GroupBuyTeam team = teamRepository
        .findByIdForUpdate(teamId)
        .orElseThrow(() -> new BusinessException("å›¢ä¸å­˜åœ¨"));
    
    // æ£€æŸ¥æ˜¯å¦å·²æ»¡
    if (team.getCurrentNum() >= team.getRequiredNum()) {
        throw new BusinessException("å›¢å·²æ»¡");
    }
    
    // äººæ•°+1ï¼ˆè¡Œé”ä¿æŠ¤ï¼‰
    team.setCurrentNum(team.getCurrentNum() + 1);
    teamRepository.save(team);
}
```

### æŠ€æœ¯äº®ç‚¹
- âœ… **é›¶ä¾èµ–**: ä¸éœ€è¦Redisï¼Œé™ä½æ¶æ„å¤æ‚åº¦
- âœ… **äº‹åŠ¡ä¿è¯**: æ•°æ®åº“äº‹åŠ¡ACIDç‰¹æ€§
- âœ… **å¹¶å‘å®‰å…¨**: è¡Œé”æœºåˆ¶å¯é 
- âœ… **é€‚ç”¨åœºæ™¯**: ä¸­å°è§„æ¨¡å¹¶å‘(1000 QPSå†…)

### å¹¶å‘æµ‹è¯•ç»“æœ
```
æµ‹è¯•åœºæ™¯: 10äººåŒæ—¶å‚åŠ 3äººå›¢
â”œâ”€ é¢„æœŸ: 3äººæˆåŠŸï¼Œ7äººå¤±è´¥
â”œâ”€ å®é™…: 3äººæˆåŠŸï¼Œ7äººå¤±è´¥
â””â”€ ç»“è®º: âœ… å¹¶å‘æ§åˆ¶æœ‰æ•ˆ
```

### ä¼˜åŠ£åŠ¿åˆ†æ
| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| Redisåˆ†å¸ƒå¼é” | é«˜æ€§èƒ½ã€è·¨æœåŠ¡ | éœ€è¦é¢å¤–ä¸­é—´ä»¶ | é«˜å¹¶å‘(10000+ QPS) |
| **æ•°æ®åº“è¡Œé”** | é›¶ä¾èµ–ã€äº‹åŠ¡ä¿è¯ | æ€§èƒ½è¾ƒä½ | **ä¸­å°å¹¶å‘(1000 QPS)** |

---

## 4ï¸âƒ£ ä¸‰å±‚å¹‚ç­‰æ€§è®¾è®¡ â­â­â­â­â­

### ä¸šåŠ¡èƒŒæ™¯
æ‹¼å›¢æ”¯ä»˜åœºæ™¯å¯èƒ½å¤šæ¬¡å›è°ƒï¼Œå¦‚ä½•ä¿è¯å¹‚ç­‰æ€§ï¼Ÿ

### ä¸‰å±‚å¹‚ç­‰è®¾è®¡

#### ç¬¬ä¸€å±‚: æ”¯ä»˜å›è°ƒå¹‚ç­‰
```java
public void paymentCallback(Long memberId) {
    // æŸ¥è¯¢å‚å›¢è®°å½•
    GroupBuyMember member = memberRepository.findById(memberId)
        .orElseThrow();
    
    // å¹‚ç­‰æ€§æ£€æŸ¥
    if (member.getPayStatus() == PayStatus.PAID) {
        log.warn("é‡å¤å›è°ƒï¼Œå·²æ”¯ä»˜ï¼ŒmemberId={}", memberId);
        return; // ç›´æ¥è¿”å›
    }
    
    // æ›´æ–°æ”¯ä»˜çŠ¶æ€
    member.setPayStatus(PayStatus.PAID);
}
```

#### ç¬¬äºŒå±‚: æˆå›¢é€»è¾‘å¹‚ç­‰
```java
public void checkTeamSuccess(Long teamId) {
    // è¡Œé”è·å–å›¢ä¿¡æ¯
    GroupBuyTeam team = teamRepository.findByIdForUpdate(teamId)
        .orElseThrow();
    
    // å¹‚ç­‰æ€§æ£€æŸ¥
    if (team.getTeamStatus() == TeamStatus.SUCCESS) {
        log.warn("é‡å¤æˆå›¢æ£€æŸ¥ï¼Œå·²æˆå›¢ï¼ŒteamId={}", teamId);
        return;
    }
    
    // åˆ¤æ–­æ˜¯å¦æˆå›¢
    if (team.getCurrentNum() >= team.getRequiredNum()) {
        team.setTeamStatus(TeamStatus.SUCCESS);
        // æ‰¹é‡æ›´æ–°è®¢å•çŠ¶æ€
        batchUpdateOrders(teamId);
    }
}
```

#### ç¬¬ä¸‰å±‚: å®šæ—¶ä»»åŠ¡å¹‚ç­‰
```java
@Scheduled(cron = "0 0 * * * ?") // æ¯å°æ—¶æ‰§è¡Œ
public void checkExpiredTeams() {
    List<GroupBuyTeam> expiredTeams = teamRepository
        .findExpiredTeams(LocalDateTime.now());
    
    for (GroupBuyTeam team : expiredTeams) {
        try {
            // è¡Œé” + çŠ¶æ€æ£€æŸ¥
            if (team.getTeamStatus() != TeamStatus.ONGOING) {
                continue; // å·²å¤„ç†ï¼Œè·³è¿‡
            }
            
            // æ›´æ–°ä¸ºå¤±è´¥
            team.setTeamStatus(TeamStatus.FAILED);
            
            // é€€æ¬¾é€»è¾‘...
        } catch (Exception e) {
            // å¼‚å¸¸éš”ç¦»ï¼Œä¸å½±å“å…¶ä»–å›¢
            log.error("å¤„ç†è¿‡æœŸå›¢å¤±è´¥", e);
        }
    }
}
```

### æŠ€æœ¯äº®ç‚¹
- âœ… **ä¸‰å±‚é˜²æŠ¤**: æ”¯ä»˜å›è°ƒã€æˆå›¢æ£€æŸ¥ã€å®šæ—¶ä»»åŠ¡
- âœ… **çŠ¶æ€æœº**: çŠ¶æ€æ£€æŸ¥ä¿è¯å¹‚ç­‰
- âœ… **è¡Œé”ä¿æŠ¤**: å¹¶å‘åœºæ™¯ä¸‹çš„æœ€åé˜²çº¿
- âœ… **å¼‚å¸¸éš”ç¦»**: å•ä¸ªå¤±è´¥ä¸å½±å“æ•´ä½“

---

## 5ï¸âƒ£ Sagaæ¨¡å¼è·¨æœåŠ¡è°ƒç”¨ â­â­â­â­

### ä¸šåŠ¡åœºæ™¯
ç”¨æˆ·å‚å›¢æµç¨‹ï¼šGroupBuyService â†’ OrderService â†’ PaymentService

### Sagaæ¨¡å¼è®¾è®¡
```
æ­£å‘æµç¨‹:
GroupBuyService â†’ OrderService.createOrder()
                â†“ æˆåŠŸ
                OrderService â†’ PaymentService.pay()
                â†“ æˆåŠŸ
                PaymentService â†’ GroupBuyService.payCallback()
                â†“ æˆåŠŸ
                å®Œæˆ

è¡¥å¿æµç¨‹:
OrderService.createOrder() å¤±è´¥
  â†“
GroupBuyService è®°å½•å¤±è´¥çŠ¶æ€

PaymentService.pay() å¤±è´¥
  â†“
OrderService è®¢å•30åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸ
  â†“
GroupBuyService å®šæ—¶ä»»åŠ¡é€€æ¬¾
```

### æ ¸å¿ƒä»£ç 
```java
// GroupBuyService: å‘èµ·å‚å›¢
@Transactional
public Long joinTeam(Long teamId, Long userId) {
    // Step 1: è¡Œé”æ£€æŸ¥å›¢çŠ¶æ€
    GroupBuyTeam team = getTeamWithLock(teamId);
    
    // Step 2: åˆ›å»ºè®¢å•ï¼ˆFeignè°ƒç”¨ï¼‰
    Long orderId;
    try {
        orderId = orderServiceClient.createOrder(orderRequest);
    } catch (Exception e) {
        log.error("åˆ›å»ºè®¢å•å¤±è´¥", e);
        throw new BusinessException("å‚å›¢å¤±è´¥");
    }
    
    // Step 3: è®°å½•å‚å›¢ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
    GroupBuyMember member = new GroupBuyMember();
    member.setOrderId(orderId);
    member.setPayStatus(PayStatus.UNPAID);
    memberRepository.save(member);
    
    return orderId;
}
```

```java
// OrderService: è®¢å•è‡ªåŠ¨è¿‡æœŸï¼ˆè¡¥å¿æœºåˆ¶ï¼‰
@Scheduled(fixedRate = 300000) // æ¯5åˆ†é’Ÿæ£€æŸ¥
public void checkExpiredOrders() {
    LocalDateTime expireTime = LocalDateTime.now().minusMinutes(30);
    List<OrderMain> orders = orderRepository
        .findByPayStatusAndCreateTimeBefore(0, expireTime);
    
    for (OrderMain order : orders) {
        order.setOrderStatus(7); // å·²è¿‡æœŸ
        orderRepository.save(order);
    }
}
```

### æŠ€æœ¯äº®ç‚¹
- âœ… **è¡¥å¿æœºåˆ¶**: è®¢å•è‡ªåŠ¨è¿‡æœŸï¼Œæ— éœ€å›æ»š
- âœ… **Fallbacké™çº§**: Feignè°ƒç”¨å¤±è´¥æœ‰å…œåº•
- âœ… **å¼‚å¸¸éš”ç¦»**: å•ä¸ªæœåŠ¡å¤±è´¥ä¸å½±å“æ•´ä½“
- âœ… **æœ€ç»ˆä¸€è‡´æ€§**: é€šè¿‡å®šæ—¶ä»»åŠ¡ä¿è¯

---

## 6ï¸âƒ£ ç¤¾åŒºä¼˜å…ˆæ¨èç®—æ³• (v3.0ç‰¹æ€§) â­â­â­â­

### ä¸šåŠ¡ä»·å€¼
æœ¬ç¤¾åŒºçš„æ‹¼å›¢ä¼˜å…ˆæ˜¾ç¤ºï¼Œæå‡ç”¨æˆ·å½’å±æ„Ÿå’Œé…é€æ•ˆç‡

### æŠ€æœ¯å®ç°
```sql
SELECT t.*, c.community_name
FROM group_buy_team t
LEFT JOIN community c ON t.community_id = c.community_id
WHERE t.activity_id = ?
  AND t.team_status = 0
  AND t.current_num < t.required_num
  AND t.expire_time > NOW()
ORDER BY 
  CASE WHEN t.community_id = ? THEN 0 ELSE 1 END ASC,
  t.create_time DESC
LIMIT 10;
```

### æ ¸å¿ƒæ€æƒ³
- **SQLå±‚å®ç°**: æ€§èƒ½é«˜ï¼Œæ— éœ€åº”ç”¨å±‚æ’åº
- **CASE WHEN**: æœ¬ç¤¾åŒºæ’åºæƒé‡ä¸º0ï¼Œä¼˜å…ˆæ˜¾ç¤º
- **äºŒçº§æ’åº**: ç›¸åŒç¤¾åŒºå†…æŒ‰æ—¶é—´å€’åº

### å‰ç«¯å±•ç¤ºæ•ˆæœ
```
æ‹¼å›¢åˆ—è¡¨:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ T001 [æœ¬ç¤¾åŒº] å¼ å›¢é•¿  2/3äºº  12å°æ—¶   â”‚ â† ç»¿è‰²æ ‡ç­¾
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ T002 [æœ¬ç¤¾åŒº] æå›¢é•¿  1/3äºº  8å°æ—¶    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ T003 [èŠ±å›­å°åŒº] ç‹å›¢é•¿  2/3äºº  6å°æ—¶  â”‚ â† æ™®é€š
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯äº®ç‚¹
- âœ… **SQLä¼˜åŒ–**: ä¸€æ¡SQLæå®šæ’åº
- âœ… **ç”¨æˆ·ä½“éªŒ**: æœ¬ç¤¾åŒºä¼˜å…ˆï¼Œé…é€æ›´å¿«
- âœ… **ä¸šåŠ¡ä»·å€¼**: æå‡ç¤¾åŒºå‡èšåŠ›

---

## 7ï¸âƒ£ è®¢å•å¿«ç…§è®¾è®¡ â­â­â­â­â­

### ä¸šåŠ¡ç—›ç‚¹
å•†å“ä»·æ ¼å˜æ›´åï¼Œå†å²è®¢å•æ˜¾ç¤ºçš„åº”è¯¥æ˜¯ä¸‹å•æ—¶çš„ä»·æ ¼

### æŠ€æœ¯æ–¹æ¡ˆ
```
order_itemè¡¨è®¾è®¡:
â”œâ”€ product_id (å¼•ç”¨)
â”œâ”€ product_name (å¿«ç…§) â­
â”œâ”€ product_price (å¿«ç…§) â­
â”œâ”€ product_image (å¿«ç…§) â­
â””â”€ product_spec (å¿«ç…§)
```

### æ ¸å¿ƒä»£ç 
```java
// åˆ›å»ºè®¢å•æ—¶ä¿å­˜å¿«ç…§
public void createOrder(CreateOrderRequest request) {
    // æŸ¥è¯¢å•†å“æœ€æ–°ä¿¡æ¯
    Product product = productServiceClient.getProduct(productId);
    
    // ä¿å­˜å¿«ç…§åˆ°order_item
    OrderItem item = new OrderItem();
    item.setProductId(product.getProductId());
    item.setProductName(product.getProductName()); // å¿«ç…§
    item.setProductPrice(product.getPrice());       // å¿«ç…§
    item.setProductImage(product.getImage());       // å¿«ç…§
    
    orderItemRepository.save(item);
}
```

### æŠ€æœ¯äº®ç‚¹
- âœ… **æ•°æ®ä¸€è‡´æ€§**: å†å²è®¢å•ä¸å—å•†å“å˜æ›´å½±å“
- âœ… **ç”µå•†æœ€ä½³å®è·µ**: ä¸»æµç”µå•†éƒ½é‡‡ç”¨å¿«ç…§è®¾è®¡
- âœ… **ç”¨æˆ·ä½“éªŒ**: ä»·æ ¼é€æ˜ï¼Œé¿å…çº çº·

---

## 8ï¸âƒ£ å¾®æœåŠ¡æ•°æ®åº“éš”ç¦» â­â­â­â­

### æ¶æ„è®¾è®¡
```
7ä¸ªç‹¬ç«‹æ•°æ®åº“ï¼Œ19å¼ è¡¨
â”œâ”€ user_service_db (5å¼ è¡¨)
â”‚   â”œâ”€ sys_user
â”‚   â”œâ”€ user_address
â”‚   â”œâ”€ user_account
â”‚   â”œâ”€ user_feedback
â”‚   â””â”€ sys_operation_log
â”‚
â”œâ”€ product_service_db (2å¼ è¡¨)
â”‚   â”œâ”€ product_category
â”‚   â””â”€ product
â”‚
â”œâ”€ groupbuy_service_db (3å¼ è¡¨)
â”‚   â”œâ”€ group_buy
â”‚   â”œâ”€ group_buy_team
â”‚   â””â”€ group_buy_member
â”‚
â”œâ”€ order_service_db (3å¼ è¡¨)
â”‚   â”œâ”€ shopping_cart
â”‚   â”œâ”€ order_main
â”‚   â””â”€ order_item
â”‚
â”œâ”€ payment_service_db (1å¼ è¡¨)
â”‚   â””â”€ payment_record
â”‚
â”œâ”€ delivery_service_db (1å¼ è¡¨)
â”‚   â””â”€ delivery
â”‚
â””â”€ leader_service_db (4å¼ è¡¨)
    â”œâ”€ group_leader_store
    â”œâ”€ commission_record
    â”œâ”€ community
    â””â”€ community_application
```

### æŠ€æœ¯äº®ç‚¹
- âœ… **æ•°æ®åº“éš”ç¦»**: æ¯ä¸ªæœåŠ¡ç‹¬ç«‹æ•°æ®åº“
- âœ… **Feignè°ƒç”¨**: åº”ç”¨å±‚æ›¿ä»£ç‰©ç†å¤–é”®
- âœ… **æ‰©å±•æ€§**: æœåŠ¡å¯ç‹¬ç«‹æ‰©å±•
- âœ… **å®¹é”™æ€§**: å•ä¸ªæ•°æ®åº“æ•…éšœä¸å½±å“æ•´ä½“

---

## 9ï¸âƒ£ JWTç½‘å…³ç»Ÿä¸€é‰´æƒ â­â­â­â­â­

### æ¶æ„è®¾è®¡
```
å‰ç«¯ â†’ Gateway â†’ å¾®æœåŠ¡
       â†“ JWTéªŒè¯
       â†“ ç™½åå•æ£€æŸ¥
       â†“ ç”¨æˆ·ä¿¡æ¯é€ä¼ 
       å¾®æœåŠ¡
```

### æ ¸å¿ƒä»£ç 
```java
@Component
public class JwtAuthenticationFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                            GatewayFilterChain chain) {
        String path = exchange.getRequest().getPath().value();
        
        // ç™½åå•æ”¾è¡Œ
        if (isWhitelist(path)) {
            return chain.filter(exchange);
        }
        
        // è·å–Token
        String token = exchange.getRequest()
            .getHeaders().getFirst("Authorization");
        
        // éªŒè¯Token
        if (!jwtUtil.validateToken(token)) {
            return unauthorized(exchange);
        }
        
        // è§£æç”¨æˆ·ä¿¡æ¯å¹¶é€ä¼ 
        Long userId = jwtUtil.getUserId(token);
        ServerHttpRequest request = exchange.getRequest().mutate()
            .header("X-User-Id", String.valueOf(userId))
            .build();
        
        return chain.filter(exchange.mutate().request(request).build());
    }
}
```

### æŠ€æœ¯äº®ç‚¹
- âœ… **ç»Ÿä¸€é‰´æƒ**: å¾®æœåŠ¡æ— éœ€é‡å¤éªŒè¯
- âœ… **ç™½åå•æœºåˆ¶**: ç™»å½•ã€æ³¨å†Œç­‰æ¥å£æ”¾è¡Œ
- âœ… **ç”¨æˆ·ä¿¡æ¯é€ä¼ **: Headerä¼ é€’userId
- âœ… **æ€§èƒ½ä¼˜åŒ–**: å‡å°‘é‡å¤JWTè§£æ

---

## ğŸ”Ÿ å®šæ—¶ä»»åŠ¡è‡ªåŠ¨åŒ– â­â­â­â­

### ä¸šåŠ¡åœºæ™¯

#### 1. æ‹¼å›¢è¿‡æœŸé€€æ¬¾
```java
@Scheduled(cron = "0 0 * * * ?") // æ¯å°æ—¶
public void checkExpiredTeams() {
    // æŸ¥è¯¢è¿‡æœŸå›¢
    List<GroupBuyTeam> teams = teamRepository
        .findExpiredTeams(LocalDateTime.now());
    
    for (GroupBuyTeam team : teams) {
        // æ›´æ–°å›¢çŠ¶æ€
        team.setTeamStatus(TeamStatus.FAILED);
        
        // è°ƒç”¨PaymentServiceé€€æ¬¾
        List<GroupBuyMember> members = memberRepository
            .findByTeamId(team.getTeamId());
        
        for (GroupBuyMember member : members) {
            paymentServiceClient.refund(member.getOrderId());
        }
    }
}
```

#### 2. ä½£é‡‘è‡ªåŠ¨ç»“ç®—
```java
@Scheduled(cron = "0 0 2 1 * ?") // æ¯æœˆ1å·å‡Œæ™¨2ç‚¹
public void settleCommission() {
    // æŸ¥è¯¢å¾…ç»“ç®—ä½£é‡‘
    List<CommissionRecord> records = commissionRepository
        .findByStatus(0);
    
    // æŒ‰å›¢é•¿åˆ†ç»„
    Map<Long, List<CommissionRecord>> groupedMap = records.stream()
        .collect(Collectors.groupingBy(
            CommissionRecord::getLeaderId));
    
    // æ‰¹é‡ç»“ç®—
    for (Map.Entry<Long, List<CommissionRecord>> entry : 
         groupedMap.entrySet()) {
        Long leaderId = entry.getKey();
        BigDecimal totalCommission = entry.getValue().stream()
            .map(CommissionRecord::getCommissionAmount)
            .reduce(BigDecimal.ZERO, BigDecimal::add);
        
        // è°ƒç”¨UserServiceå¢åŠ ä½™é¢
        userServiceClient.recharge(leaderId, totalCommission);
        
        // æ›´æ–°ä½£é‡‘çŠ¶æ€
        entry.getValue().forEach(r -> r.setStatus(1));
    }
}
```

### æŠ€æœ¯äº®ç‚¹
- âœ… **è‡ªåŠ¨åŒ–**: æ— éœ€äººå·¥å¹²é¢„
- âœ… **å¼‚å¸¸éš”ç¦»**: å•ä¸ªå¤±è´¥ä¸å½±å“å…¶ä»–
- âœ… **å¹‚ç­‰è®¾è®¡**: é‡å¤æ‰§è¡Œæ— å‰¯ä½œç”¨
- âœ… **Cronè¡¨è¾¾å¼**: çµæ´»çš„æ—¶é—´é…ç½®

---

## ğŸ“ ç­”è¾©æ¼”ç¤ºå»ºè®®

### é‡ç‚¹å±•ç¤ºæŠ€æœ¯(é€‰3-5ä¸ª)
1. **Haversineè·ç¦»è®¡ç®—** - ç®—æ³•èƒ½åŠ›
2. **ä¸‰å±‚å¹‚ç­‰æ€§è®¾è®¡** - å¹¶å‘æ§åˆ¶èƒ½åŠ›
3. **åŒè½¨åˆ¶æ—¥å¿—ç³»ç»Ÿ** - ç³»ç»Ÿè®¾è®¡èƒ½åŠ›
4. **å¾®æœåŠ¡æ•°æ®åº“éš”ç¦»** - æ¶æ„è®¾è®¡èƒ½åŠ›
5. **Sagaæ¨¡å¼** - åˆ†å¸ƒå¼äº‹åŠ¡èƒ½åŠ›

### æ¼”ç¤ºæµç¨‹å»ºè®®
```
1. å…ˆè®²ä¸šåŠ¡åœºæ™¯ï¼ˆä¸ºä»€ä¹ˆéœ€è¦ï¼‰
2. å†è®²æŠ€æœ¯æ–¹æ¡ˆï¼ˆæ€ä¹ˆå®ç°çš„ï¼‰
3. å±•ç¤ºæ ¸å¿ƒä»£ç ï¼ˆå…³é”®é€»è¾‘ï¼‰
4. è¯´æ˜æŠ€æœ¯äº®ç‚¹ï¼ˆåˆ›æ–°ç‚¹åœ¨å“ªï¼‰
5. æ€§èƒ½æ•°æ®æ”¯æ’‘ï¼ˆæ•ˆæœå¦‚ä½•ï¼‰
```

### å¸¸è§é—®é¢˜å‡†å¤‡

**Q1: ä¸ºä»€ä¹ˆä¸ç”¨Redisåˆ†å¸ƒå¼é”ï¼Ÿ**
> A: é¡¹ç›®è§„æ¨¡é€‚ä¸­ï¼Œå¹¶å‘é‡åœ¨1000 QPSä»¥å†…ï¼Œæ•°æ®åº“è¡Œé”å®Œå…¨å¤Ÿç”¨ã€‚ä½¿ç”¨æ•°æ®åº“è¡Œé”å¯ä»¥å‡å°‘ä¸­é—´ä»¶ä¾èµ–ï¼Œé™ä½æ¶æ„å¤æ‚åº¦ï¼ŒåŒæ—¶åˆ©ç”¨æ•°æ®åº“äº‹åŠ¡çš„ACIDç‰¹æ€§ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚

**Q2: Haversineç®—æ³•ç²¾åº¦å¦‚ä½•ï¼Ÿ**
> A: Haversineå…¬å¼è€ƒè™‘äº†åœ°çƒæ›²ç‡ï¼Œè¯¯å·®å°äº1%ã€‚å¯¹äºç¤¾åŒºå›¢è´­åœºæ™¯ï¼ˆé€šå¸¸3-5å…¬é‡ŒèŒƒå›´ï¼‰ï¼Œç²¾åº¦å®Œå…¨æ»¡è¶³éœ€æ±‚ã€‚åŒæ—¶é‡‡ç”¨äº†çŸ©å½¢ç²—ç­›+ç²¾ç¡®è®¡ç®—çš„ä¼˜åŒ–æ–¹æ¡ˆï¼Œæ€§èƒ½åœ¨5msä»¥å†…ã€‚

**Q3: å¾®æœåŠ¡å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ**
> A: é‡‡ç”¨Sagaæ¨¡å¼å®ç°æœ€ç»ˆä¸€è‡´æ€§ã€‚æ­£å‘æµç¨‹é€šè¿‡Feignè°ƒç”¨ä¸²è”æœåŠ¡ï¼Œå¤±è´¥æ—¶é€šè¿‡è¡¥å¿æœºåˆ¶ï¼ˆå¦‚è®¢å•30åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸã€å®šæ—¶ä»»åŠ¡é€€æ¬¾ï¼‰ä¿è¯æ•°æ®æœ€ç»ˆä¸€è‡´ã€‚

**Q4: å¦‚ä½•ä¿è¯æ”¯ä»˜å¹‚ç­‰æ€§ï¼Ÿ**
> A: é‡‡ç”¨ä¸‰å±‚å¹‚ç­‰è®¾è®¡ï¼šç¬¬ä¸€å±‚æ”¯ä»˜å›è°ƒçŠ¶æ€æ£€æŸ¥ï¼Œç¬¬äºŒå±‚æˆå›¢é€»è¾‘çŠ¶æ€æœºï¼Œç¬¬ä¸‰å±‚å®šæ—¶ä»»åŠ¡å¼‚å¸¸éš”ç¦»ã€‚å¤šé‡é˜²æŠ¤ç¡®ä¿é‡å¤è°ƒç”¨ä¸äº§ç”Ÿå‰¯ä½œç”¨ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [01_é¡¹ç›®æ€»è§ˆ](./01_é¡¹ç›®æ€»è§ˆ.md) - é¡¹ç›®å®Œæ•´ä»‹ç»
- [æœåŠ¡é—´ååŒé—­ç¯åˆ†æ](./æœåŠ¡é—´ååŒé—­ç¯åˆ†æ_2025-11-01.md) - ä¸šåŠ¡é—­ç¯è®¾è®¡
- [æ•°æ®åº“è®¾è®¡è¯´æ˜æ–‡æ¡£](../äºŒçº§æ–‡æ¡£ï¼ˆå‚è€ƒï¼‰/æ•°æ®åº“è®¾è®¡è¯´æ˜æ–‡æ¡£_v6.0.md) - æ•°æ®åº“è®¾è®¡

---

**åˆ›å»ºæ—¥æœŸ**: 2025-11-04  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**ç”¨é€”**: ç­”è¾©å‡†å¤‡ã€æŠ€æœ¯å±•ç¤º  
**çŠ¶æ€**: âœ… å·²å®Œæˆ


