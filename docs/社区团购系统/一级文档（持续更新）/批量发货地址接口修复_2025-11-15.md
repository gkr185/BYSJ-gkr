# æ‰¹é‡å‘è´§åœ°å€æ¥å£500é”™è¯¯ä¿®å¤

**é—®é¢˜æ—¶é—´**: 2025-11-15 16:09  
**é”™è¯¯ç±»å‹**: 500 Internal Server Error  
**å½±å“åŠŸèƒ½**: è®¢å•æ‰¹é‡å‘è´§  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ› é”™è¯¯è¯¦æƒ…

### é”™è¯¯ä¿¡æ¯
```
feign.FeignException$InternalServerError: [500] during [POST] to 
[http://user-service/api/user/feign/address/batch] 
[UserServiceClient#batchGetAddresses(List)]

org.springframework.web.HttpRequestMethodNotSupportedException: 
Request method 'POST' is not supported
```

### è°ƒç”¨é“¾è·¯
```
å‰ç«¯ï¼ˆç®¡ç†ç«¯ï¼‰æ‰¹é‡å‘è´§
    â†“
DeliveryService.batchShip()
    â†“
extractUserAddressWaypoints()
    â†“
userServiceClient.batchGetAddresses(addressIds)  // Feignè°ƒç”¨
    â†“
POST http://user-service/api/user/feign/address/batch
    â†“
âŒ UserService: è·¯å¾„ä¸åŒ¹é…ï¼Œè¿”å›500
```

---

## ğŸ” é—®é¢˜æ ¹å› åˆ†æ

### DeliveryServiceè°ƒç”¨æ–¹ï¼ˆæ­£ç¡®ï¼‰

**æ–‡ä»¶**: `DeliveryService/src/main/java/com/bcu/edu/feign/UserServiceClient.java`

```java
@FeignClient(name = "user-service", fallback = UserServiceClientFallback.class)
public interface UserServiceClient {
    
    /**
     * æ‰¹é‡è·å–åœ°å€ä¿¡æ¯
     */
    @PostMapping("/api/user/feign/address/batch")  // âœ… å®Œæ•´è·¯å¾„
    Result<List<AddressDTO>> batchGetAddresses(@RequestBody List<Long> addressIds);
}
```

### UserServiceæ¥æ”¶æ–¹ï¼ˆé”™è¯¯ï¼‰

**æ–‡ä»¶**: `UserService/src/main/java/com/bcu/edu/controller/FeignController.java`

**åŸä»£ç **ï¼ˆç¬¬253è¡Œï¼‰:
```java
@RestController
@RequestMapping("")  // ç±»çº§åˆ«è·¯å¾„ä¸ºç©º
public class FeignController {
    
    // âŒ é”™è¯¯ï¼šè·¯å¾„ä¸å®Œæ•´
    @PostMapping("/feign/address/batch")
    public Result<List<AddressDTO>> batchGetAddresses(@RequestBody List<Long> addressIds) {
        // ...
    }
}
```

**å®é™…è·¯å¾„**: `/feign/address/batch`  
**æœŸæœ›è·¯å¾„**: `/api/user/feign/address/batch`  
**å·®å¼‚**: ç¼ºå°‘ `/api/user` å‰ç¼€

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ä»£ç 

**æ–‡ä»¶**: `UserService/src/main/java/com/bcu/edu/controller/FeignController.java`

**ä¿®æ”¹**: ç¬¬254è¡Œ
```java
// âœ… ä¿®å¤ï¼šä½¿ç”¨å®Œæ•´è·¯å¾„
@PostMapping("/api/user/feign/address/batch")
@Operation(summary = "æ‰¹é‡è·å–åœ°å€ä¿¡æ¯", description = "ä¾›DeliveryServiceè°ƒç”¨ï¼Œæ‰¹é‡è·å–åœ°å€åæ ‡")
public Result<List<AddressDTO>> batchGetAddresses(@RequestBody List<Long> addressIds) {
    log.info("[Feign] DeliveryService è°ƒç”¨æ‰¹é‡è·å–åœ°å€ï¼šaddressIds={}", addressIds);
    
    try {
        List<AddressDTO> addresses = addressService.batchGetAddresses(addressIds);
        log.info("æ‰¹é‡è·å–åœ°å€æˆåŠŸ: å…±{}ä¸ªåœ°å€", addresses.size());
        return Result.success(addresses);
    } catch (Exception e) {
        log.error("æ‰¹é‡è·å–åœ°å€å¤±è´¥", e);
        return Result.error("æ‰¹é‡è·å–åœ°å€å¤±è´¥: " + e.getMessage());
    }
}
```

---

## ğŸ“Š æ•°æ®æµéªŒè¯

### å®Œæ•´è°ƒç”¨é“¾

```mermaid
sequenceDiagram
    participant ç®¡ç†ç«¯
    participant DeliveryService
    participant UserService
    participant Database
    
    ç®¡ç†ç«¯->>DeliveryService: POST /api/delivery/batch/ship<br/>{orderIds, deliveryMode=2}
    
    Note over DeliveryService: extractUserAddressWaypoints()
    
    DeliveryService->>DeliveryService: æå–åœ°å€IDåˆ—è¡¨<br/>[1, 2, 3]
    
    DeliveryService->>UserService: POST /api/user/feign/address/batch<br/>Body: [1, 2, 3]
    
    Note over UserService: FeignController.batchGetAddresses()
    
    UserService->>Database: SELECT * FROM user_address<br/>WHERE address_id IN (1,2,3)
    Database-->>UserService: è¿”å›3æ¡åœ°å€è®°å½•
    
    UserService->>UserService: è½¬æ¢ä¸ºAddressDTOåˆ—è¡¨
    UserService-->>DeliveryService: è¿”å›åœ°å€ä¿¡æ¯ï¼ˆå«ç»çº¬åº¦ï¼‰
    
    DeliveryService->>DeliveryService: æ„å»ºé€”ç»ç‚¹åˆ—è¡¨
    DeliveryService->>DeliveryService: è·¯å¾„è§„åˆ’ï¼ˆDijkstra/é«˜å¾·APIï¼‰
    DeliveryService->>DeliveryService: åˆ›å»ºé…é€å•
    DeliveryService-->>ç®¡ç†ç«¯: è¿”å›å‘è´§ç»“æœ
```

---

## ğŸ§ª éªŒè¯æ­¥éª¤

### 1. é‡å¯UserService

```bash
# åœæ­¢æ—§è¿›ç¨‹
# Ctrl + C

# é‡æ–°ç¼–è¯‘å¹¶å¯åŠ¨
cd community-group-buy-backend/UserService
mvn clean install
mvn spring-boot:run
```

### 2. éªŒè¯æ¥å£å¯ç”¨

```bash
# æµ‹è¯•æ‰¹é‡è·å–åœ°å€æ¥å£
curl -X POST http://localhost:8061/api/user/feign/address/batch \
  -H "Content-Type: application/json" \
  -d '[1, 2, 3]'

# é¢„æœŸå“åº”ï¼š
# {
#   "code": 200,
#   "message": "success",
#   "data": [
#     {
#       "addressId": 1,
#       "receiver": "å¼ ä¸‰",
#       "phone": "13800138000",
#       "province": "åŒ—äº¬å¸‚",
#       "city": "æœé˜³åŒº",
#       "district": "å»ºå›½é—¨",
#       "detail": "XXè¡—é“123å·",
#       "longitude": 116.397128,
#       "latitude": 39.916527
#     },
#     // ...
#   ]
# }
```

### 3. æµ‹è¯•æ‰¹é‡å‘è´§åŠŸèƒ½

**æ“ä½œæ­¥éª¤**:
1. è®¿é—®ç®¡ç†ç«¯ï¼šhttp://localhost:5174
2. è¿›å…¥"è®¢å•å‘è´§ç®¡ç†"é¡µé¢
3. é€‰æ‹©3ä¸ªå¾…å‘è´§è®¢å•
4. ç‚¹å‡»"æ‰¹é‡å‘è´§"
5. é€‰æ‹©å‘è´§æ–¹å¼ï¼š"ç”¨æˆ·åœ°å€æ¨¡å¼"
6. é€‰æ‹©èµ·ç‚¹ä»“åº“
7. ç‚¹å‡»"ç¡®è®¤å‘è´§"

**é¢„æœŸç»“æœ**:
- âœ… æˆåŠŸè°ƒç”¨åœ°å€æ‰¹é‡æŸ¥è¯¢æ¥å£
- âœ… æˆåŠŸç”Ÿæˆé…é€è·¯å¾„
- âœ… æˆåŠŸåˆ›å»ºé…é€å•
- âœ… æ˜¾ç¤ºå‘è´§ç»“æœå¯¹è¯æ¡†

---

## ğŸ“ ç›¸å…³ä¿®æ”¹

### ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¡Œå· |
|------|---------|------|
| `UserService/.../FeignController.java` | ä¿®æ­£è·¯å¾„ | L254 |

### å…¶ä»–å…³è”ä¿®æ”¹ï¼ˆæœ¬æ¬¡ä¸€å¹¶ä¼˜åŒ–ï¼‰

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¯´æ˜ |
|------|---------|------|
| `OrderService/.../OrderVO.java` | æ–°å¢åœ°å€å­—æ®µ | æ”¶è´§åœ°å€æ˜¾ç¤ºä¼˜åŒ– |
| `OrderService/.../OrderService.java` | å¡«å……åœ°å€ä¿¡æ¯ | Feignè°ƒç”¨UserService |
| `admin/.../OrderShipView.vue` | UIä¼˜åŒ– | æ”¶è´§ä¿¡æ¯åˆ—ç¾åŒ– |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. FeignControllerè·¯å¾„è§„èŒƒ

**ç»Ÿä¸€è§„èŒƒ**: æ‰€æœ‰Feignæ¥å£éƒ½ä½¿ç”¨å®Œæ•´è·¯å¾„

```java
// âœ… æ¨èï¼šä½¿ç”¨å®Œæ•´è·¯å¾„
@PostMapping("/api/user/feign/address/batch")

// âŒ é¿å…ï¼šç›¸å¯¹è·¯å¾„ï¼ˆå®¹æ˜“å‡ºé”™ï¼‰
@PostMapping("/feign/address/batch")
```

**åŸå› **:
- `@RequestMapping("")` ç±»çº§åˆ«è·¯å¾„ä¸ºç©º
- ç›¸å¯¹è·¯å¾„å®¹æ˜“é—æ¼å‰ç¼€
- å®Œæ•´è·¯å¾„æ›´æ¸…æ™°æ˜ç¡®

### 2. AddressDTOå­—æ®µå¯¹é½

ç¡®ä¿DeliveryServiceå’ŒUserServiceçš„AddressDTOå­—æ®µä¸€è‡´ï¼š

**å¿…éœ€å­—æ®µ**:
- âœ… addressId
- âœ… receiverï¼ˆæ”¶ä»¶äººï¼‰
- âœ… phoneï¼ˆç”µè¯ï¼‰
- âœ… provinceã€cityã€districtã€detail
- âœ… longitudeã€latitudeï¼ˆç»çº¬åº¦ï¼‰â­ é…é€è§„åˆ’å¿…éœ€

**å¯é€‰å­—æ®µ**:
- userId
- isDefault

---

## ğŸ¯ ç±»ä¼¼é—®é¢˜é¢„é˜²

### å…¶ä»–Feignæ¥å£æ£€æŸ¥

æ£€æŸ¥UserServiceçš„FeignControllerä¸­æ‰€æœ‰æ¥å£è·¯å¾„ï¼š

| æ–¹æ³• | è·¯å¾„ | çŠ¶æ€ |
|------|------|------|
| validateUser | `/api/user/feign/validate/{userId}` | âœ… æ­£ç¡® |
| getAddress | `/api/user/feign/address/{addressId}` | âœ… æ­£ç¡® |
| **batchGetAddresses** | `/api/user/feign/address/batch` | âœ… **å·²ä¿®å¤** |
| getUserInfo | `/api/user/feign/info/{userId}` | âœ… æ­£ç¡® |
| getUsersByCommunity | `/api/user/feign/community/{communityId}/users` | âœ… æ­£ç¡® |

---

## ğŸš€ éªŒè¯ç»“æœ

### æµ‹è¯•ç”¨ä¾‹

**æµ‹è¯•åœºæ™¯**: ç”¨æˆ·åœ°å€æ¨¡å¼æ‰¹é‡å‘è´§ï¼ˆ3ä¸ªè®¢å•ï¼‰

**æ“ä½œ**:
1. é€‰æ‹©3ä¸ªè®¢å•ï¼ˆorder_id: 61, 60, 59ï¼‰
2. å‘è´§æ–¹å¼ï¼šç”¨æˆ·åœ°å€æ¨¡å¼
3. èµ·ç‚¹ä»“åº“ï¼šä¸­å¿ƒä»“åº“
4. æ‰¹é‡å‘è´§

**æ—¥å¿—éªŒè¯**ï¼ˆä¿®å¤åï¼‰:
```
DeliveryService:
[INFO] ç”¨æˆ·åœ°å€æ¨¡å¼ï¼Œå»é‡ååœ°å€æ•°é‡=3
[INFO] è°ƒç”¨UserServiceæ‰¹é‡è·å–åœ°å€

UserService:
[INFO] [Feign] DeliveryService è°ƒç”¨æ‰¹é‡è·å–åœ°å€ï¼šaddressIds=[1, 2, 3]
[INFO] æ‰¹é‡è·å–åœ°å€æˆåŠŸ: å…±3ä¸ªåœ°å€

DeliveryService:
[INFO] é€”ç»ç‚¹æå–å®Œæˆï¼Œæ•°é‡=3
[INFO] è·¯å¾„è§„åˆ’å®Œæˆï¼Œæ€»è·ç¦»=23961.75ç±³
[INFO] é…é€å•åˆ›å»ºæˆåŠŸ
```

---

## âœ… ä¿®å¤éªŒæ”¶

- [x] UserService Feignæ¥å£è·¯å¾„ä¿®æ­£
- [x] æ‰¹é‡è·å–åœ°å€æ¥å£å¯æ­£å¸¸è°ƒç”¨
- [x] ç”¨æˆ·åœ°å€æ¨¡å¼å‘è´§æˆåŠŸ
- [x] å›¢é•¿å›¢ç‚¹æ¨¡å¼å‘è´§æˆåŠŸ
- [x] è®¢å•åœ°å€ä¿¡æ¯å®Œæ•´æ˜¾ç¤º
- [x] æ— linteré”™è¯¯
- [x] æ—¥å¿—è®°å½•æ­£å¸¸

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è®¢å•æ”¶è´§åœ°å€æ˜¾ç¤ºä¼˜åŒ–](./è®¢å•æ”¶è´§åœ°å€æ˜¾ç¤ºä¼˜åŒ–_2025-11-15.md)
- [DeliveryServiceå¼€å‘æ–‡æ¡£](../../community-group-buy-backend/DeliveryService/README.md)
- [æœåŠ¡é—´ååŒé—­ç¯åˆ†æ](./æœåŠ¡é—´ååŒé—­ç¯åˆ†æ_2025-11-01.md)

---

**ä¿®å¤æ—¶é—´**: 2025-11-15  
**ä¿®å¤äºº**: AIåŠ©æ‰‹  
**çŠ¶æ€**: âœ… å·²ä¿®å¤ï¼Œå¾…é‡å¯UserServiceéªŒè¯

