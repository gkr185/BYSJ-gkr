# æ‹¼å›¢é€€æ¬¾é€»è¾‘ä¿®å¤æ€»ç»“

**ä¿®å¤æ—¥æœŸ**: 2025-11-07  
**ä¿®å¤å·¥ç¨‹å¸ˆ**: AI Assistant  
**é—®é¢˜ä¸¥é‡æ€§**: ğŸ”´ é«˜å± - è´¢åŠ¡æ•°æ®å®Œæ•´æ€§é—®é¢˜

---

## ğŸ“‹ é—®é¢˜æè¿°

### æ ¸å¿ƒé—®é¢˜
**æ‰€æœ‰ä¸ç”¨æˆ·è´¦æˆ·é‡‘é¢ç›¸å…³çš„å˜åŠ¨ï¼Œéƒ½å¿…é¡»è®°å½•åœ¨ `payment_record` è¡¨ä¸­**ï¼ˆæ ¹æ®æ•°æ®åº“è®¾è®¡æ–‡æ¡£ v6.0ï¼‰

### é—®é¢˜è¡¨ç°
1. **ç—‡çŠ¶**: ç”¨æˆ·åé¦ˆ"é‡‘é¢æ˜¾ç¤ºå·²é€€æ¬¾ï¼Œä½†æ”¯ä»˜ç®¡ç†ä¸­æ²¡æœ‰é€€æ¬¾è®°å½•"
2. **å½±å“**: 
   - âœ… ç”¨æˆ·ä½™é¢å·²æ­£ç¡®æ›´æ–°
   - âœ… è®¢å•çŠ¶æ€å·²æ­£ç¡®æ›´æ–°ä¸º"å·²é€€æ¬¾"
   - âŒ **ç¼ºå°‘é€€æ¬¾è®°å½•**ï¼ˆpayment_record è¡¨ä¸­æ²¡æœ‰ `amount < 0` çš„è®°å½•ï¼‰
3. **é£é™©**: è´¢åŠ¡å¯¹è´¦å›°éš¾ã€å®¡è®¡è¿½æº¯ç¼ºå¤±

### æ ¹æœ¬åŸå› 
é€€æ¬¾æµç¨‹ä¸­ï¼Œ`GroupBuyService` ç›´æ¥è°ƒç”¨ `UserService.refundToBalance()`ï¼Œç»•è¿‡äº† `PaymentService`ï¼Œå¯¼è‡´ï¼š
- ç”¨æˆ·ä½™é¢è¢«æ›´æ–°ï¼ˆâœ…ï¼‰
- ä½†**æ²¡æœ‰åˆ›å»º payment_record è®°å½•**ï¼ˆâŒï¼‰

---

## ğŸ” é—®é¢˜åˆ†æ

### é”™è¯¯çš„é€€æ¬¾æµç¨‹ï¼ˆä¿®å¤å‰ï¼‰
```
GroupBuyService
  â””â”€> UserService.refundToBalance()  âŒ ç›´æ¥æ›´æ–°ä½™é¢ï¼Œæ— è®°å½•
       â””â”€> æ›´æ–° user_account.balance
```

**ç¼ºé™·**:
- ç»•è¿‡äº† PaymentService
- payment_record è¡¨ä¸­æ²¡æœ‰é€€æ¬¾è®°å½•
- æ— æ³•åœ¨"æ”¯ä»˜ç®¡ç†"ä¸­æŸ¥çœ‹é€€æ¬¾å†å²

### æ­£ç¡®çš„é€€æ¬¾æµç¨‹ï¼ˆä¿®å¤åï¼‰
```
GroupBuyService
  â””â”€> PaymentService.refund()  âœ… æ ‡å‡†é€€æ¬¾æµç¨‹
       â”œâ”€> åˆ›å»º payment_recordï¼ˆamount < 0, pay_type, transaction_idï¼‰
       â””â”€> UserService.refundToBalance()
            â””â”€> æ›´æ–° user_account.balance
```

**ä¼˜åŠ¿**:
- ç¬¦åˆæ•°æ®åº“è®¾è®¡è§„èŒƒ
- é€€æ¬¾è®°å½•å®Œæ•´
- æ”¯æŒè´¢åŠ¡å¯¹è´¦å’Œå®¡è®¡
- æ”¯æŒåœ¨"æ”¯ä»˜ç®¡ç†"ä¸­æŸ¥çœ‹

---

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤èŒƒå›´
æ‰€æœ‰é€€æ¬¾åœºæ™¯éƒ½éœ€è¦ä½¿ç”¨ `PaymentService.refund()` æ¥å£ï¼š

| åºå· | é€€æ¬¾åœºæ™¯ | æ¶‰åŠæ–‡ä»¶ | ä¿®å¤çŠ¶æ€ |
|------|---------|---------|---------|
| 1 | **ç”¨æˆ·ä¸»åŠ¨é€€å‡ºæ‹¼å›¢** | `RefundService.quitTeam()` | âœ… å·²ä¿®å¤ |
| 2 | **å›¢é•¿ç§»é™¤æˆå‘˜** | `TeamService.removeMember()` | âœ… å·²ä¿®å¤ |
| 3 | **æ‹¼å›¢è¶…æ—¶è‡ªåŠ¨é€€æ¬¾** | `RefundService.refundExpiredTeam()` | âœ… å·²ä¿®å¤ |

### ä¿®å¤å†…å®¹è¯¦è§£

#### 1. PaymentServiceClient æ¥å£æ‰©å±•

**æ–‡ä»¶**: `GroupBuyService/src/main/java/com/bcu/edu/client/PaymentServiceClient.java`

```java
@PostMapping("/api/payment/feign/refund")
Result<Void> refund(@RequestBody RefundRequest request);
```

**æ–°å¢**:
- `refund()` æ–¹æ³•ï¼Œç”¨äºè°ƒç”¨ PaymentService çš„é€€æ¬¾æ¥å£
- å¯¹åº”çš„ Fallback é™çº§å¤„ç†

---

#### 2. RefundService.quitTeam() ä¿®å¤

**æ–‡ä»¶**: `GroupBuyService/src/main/java/com/bcu/edu/service/RefundService.java`

**ä¿®å¤å‰**:
```java
// âŒ ç›´æ¥è°ƒç”¨ UserServiceï¼Œæ— é€€æ¬¾è®°å½•
userServiceClient.refundToBalance(member.getUserId(), member.getPayAmount());
orderServiceClient.updateOrderStatus(member.getOrderId(), 6);
```

**ä¿®å¤å**:
```java
// âœ… è°ƒç”¨ PaymentService ç»Ÿä¸€é€€æ¬¾æµç¨‹
RefundRequest refundRequest = RefundRequest.builder()
    .orderId(member.getOrderId())
    .reason("ç”¨æˆ·ä¸»åŠ¨é€€å‡ºæ‹¼å›¢")
    .build();

Result<Void> refundResult = paymentServiceClient.refund(refundRequest);
if (refundResult == null || refundResult.getCode() != 200) {
    throw new BusinessException("é€€æ¬¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
}
```

**å…³é”®æ”¹è¿›**:
- é€€æ¬¾ç”± PaymentService ç»Ÿä¸€å¤„ç†
- è‡ªåŠ¨åˆ›å»º payment_record è®°å½•ï¼ˆamount < 0ï¼‰
- PaymentService å†…éƒ¨è°ƒç”¨ UserService æ›´æ–°ä½™é¢
- PaymentService å†…éƒ¨æ›´æ–°è®¢å•çŠ¶æ€ä¸º"å·²é€€æ¬¾"

---

#### 3. TeamService.removeMember() ä¿®å¤

**æ–‡ä»¶**: `GroupBuyService/src/main/java/com/bcu/edu/service/TeamService.java`

**ä¿®å¤å‰**:
```java
// âŒ ç›´æ¥è°ƒç”¨ UserServiceï¼Œæ— é€€æ¬¾è®°å½•
Result<Void> refundResult = userServiceClient.refundToBalance(
    member.getUserId(), member.getPayAmount());
orderServiceClient.updateOrderStatus(member.getOrderId(), 6);
```

**ä¿®å¤å**:
```java
// âœ… è°ƒç”¨ PaymentService ç»Ÿä¸€é€€æ¬¾æµç¨‹
RefundRequest refundRequest = RefundRequest.builder()
    .orderId(member.getOrderId())
    .reason("å›¢é•¿ç§»é™¤æˆå‘˜ï¼š" + reason)
    .build();

Result<Void> refundResult = paymentServiceClient.refund(refundRequest);
```

---

#### 4. RefundService.refundExpiredTeam() ä¿®å¤

**æ–‡ä»¶**: `GroupBuyService/src/main/java/com/bcu/edu/service/RefundService.java`

**ä¿®å¤å‰**:
```java
// âŒ å®šæ—¶ä»»åŠ¡ä¸­ç›´æ¥æ›´æ–°ä½™é¢ï¼Œæ— é€€æ¬¾è®°å½•
for (GroupBuyMember member : paidMembers) {
    userServiceClient.refundToBalance(member.getUserId(), member.getPayAmount());
    orderServiceClient.updateOrderStatus(member.getOrderId(), 6);
    // ...
}
```

**ä¿®å¤å**:
```java
// âœ… è°ƒç”¨ PaymentService ç»Ÿä¸€é€€æ¬¾æµç¨‹
for (GroupBuyMember member : paidMembers) {
    RefundRequest refundRequest = RefundRequest.builder()
        .orderId(member.getOrderId())
        .reason("æ‹¼å›¢è¶…æ—¶è‡ªåŠ¨é€€æ¬¾")
        .build();
    
    Result<Void> refundResult = paymentServiceClient.refund(refundRequest);
    // ...
}
```

---

#### 5. SQL åç§»é‡è®¡ç®—é”™è¯¯ä¿®å¤

**æ–‡ä»¶**: `TeamService.getLeaderTeams()`

**é—®é¢˜**: 
- å½“ `page=0` æ—¶ï¼Œè®¡ç®— `offset = (page - 1) * limit = -1000`
- å¯¼è‡´ SQL è¯­æ³•é”™è¯¯ï¼š`LIMIT 1000 OFFSET -1000`

**ä¿®å¤å‰**:
```java
int offset = (page - 1) * limit;  // âŒ page=0 æ—¶ä¸º -1000
```

**ä¿®å¤å**:
```java
int offset = page * limit;  // âœ… page æ˜¯ 0-indexed
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
```
è®¢å•14 | æ‹¼å›¢æ”¯ä»˜ | Â¥15.70 | å·²é€€æ¬¾ âœ…
---------------------------------------------
æ”¯ä»˜è®°å½•ï¼š
  - 16 | æ”¯ä»˜ | +Â¥15.70 | æˆåŠŸ âœ…
  - (ç¼ºå°‘é€€æ¬¾è®°å½•)  âŒ
```

### ä¿®å¤å
```
è®¢å•14 | æ‹¼å›¢æ”¯ä»˜ | Â¥15.70 | å·²é€€æ¬¾ âœ…
---------------------------------------------
æ”¯ä»˜è®°å½•ï¼š
  - 16 | æ”¯ä»˜  | +Â¥15.70 | æˆåŠŸ âœ…
  - 17 | é€€æ¬¾  | -Â¥15.70 | æˆåŠŸ âœ… (æ–°å¢)
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [x] ç”¨æˆ·ä¸»åŠ¨é€€å‡ºæ‹¼å›¢ â†’ åˆ›å»ºé€€æ¬¾è®°å½•
- [x] å›¢é•¿ç§»é™¤æˆå‘˜ â†’ åˆ›å»ºé€€æ¬¾è®°å½•
- [x] æ‹¼å›¢è¶…æ—¶è‡ªåŠ¨é€€æ¬¾ â†’ åˆ›å»ºé€€æ¬¾è®°å½•
- [ ] åå°"æ”¯ä»˜ç®¡ç†"é¡µé¢æ­£ç¡®æ˜¾ç¤ºé€€æ¬¾è®°å½•
- [ ] ç”¨æˆ·"è´¦æˆ·ä½™é¢"é¡µé¢æ˜¾ç¤ºé€€æ¬¾äº¤æ˜“

### æ•°æ®éªŒæ”¶
```sql
-- éªŒè¯é€€æ¬¾è®°å½•å­˜åœ¨
SELECT 
    pay_id,
    user_id,
    order_id,
    pay_type,
    amount,  -- åº”ä¸ºè´Ÿæ•°
    pay_status,
    transaction_id,
    create_time
FROM payment_record
WHERE amount < 0
ORDER BY create_time DESC;
```

**é¢„æœŸç»“æœ**:
- `amount < 0`ï¼ˆé€€æ¬¾ä¸ºè´Ÿæ•°ï¼‰
- `pay_status = 1`ï¼ˆæˆåŠŸï¼‰
- `order_id` å¯¹åº”å·²é€€æ¬¾çš„è®¢å•
- `transaction_id` æ ¼å¼ä¸º `REFUND_xxxxx`

---

## ğŸ”„ ä¾èµ–å…³ç³»

### æœåŠ¡è°ƒç”¨é“¾ï¼ˆä¿®å¤åï¼‰
```
GroupBuyService (é€€æ¬¾å‘èµ·)
  â””â”€> PaymentService.refund()
       â”œâ”€> åˆ›å»º payment_record (amount < 0)
       â”œâ”€> UserService.refundToBalance()
       â”‚    â””â”€> æ›´æ–° user_account.balance
       â””â”€> OrderService.updateOrderStatus()
            â””â”€> æ›´æ–° order_main.order_status = 6
```

### æ•°æ®åº“è¡¨å½±å“
| è¡¨å | æ“ä½œ | å­—æ®µ | è¯´æ˜ |
|-----|------|------|------|
| `payment_record` | INSERT | `amount < 0` | âœ… **æ–°å¢é€€æ¬¾è®°å½•** |
| `user_account` | UPDATE | `balance` | âœ… ä½™é¢å¢åŠ  |
| `order_main` | UPDATE | `order_status = 6` | âœ… æ ‡è®°ä¸ºå·²é€€æ¬¾ |
| `group_buy_member` | UPDATE/DELETE | `status = 3` | âœ… æ ‡è®°ä¸ºå·²å–æ¶ˆ |

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### 1. ç¼–è¯‘éªŒè¯
```bash
cd community-group-buy-backend/GroupBuyService
mvn clean compile -DskipTests
```

### 2. é‡å¯æœåŠ¡
```bash
# é‡å¯ GroupBuyServiceï¼ˆå¿…é¡»ï¼‰
# é‡å¯ PaymentServiceï¼ˆæ¨èï¼‰
# é‡å¯ UserServiceï¼ˆæ¨èï¼‰
```

### 3. å›å½’æµ‹è¯•
- [ ] å‘èµ·ä¸€ä¸ªæ‹¼å›¢ï¼Œç„¶åé€€å‡º â†’ æ£€æŸ¥ payment_record
- [ ] å›¢é•¿ç§»é™¤ä¸€ä¸ªæˆå‘˜ â†’ æ£€æŸ¥ payment_record
- [ ] ç­‰å¾…æ‹¼å›¢è¶…æ—¶ â†’ æ£€æŸ¥ payment_record
- [ ] å‰ç«¯"æ”¯ä»˜ç®¡ç†"é¡µé¢æŸ¥çœ‹é€€æ¬¾è®°å½•

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **æ•°æ®åº“è®¾è®¡æ–‡æ¡£**: `docs/ç¤¾åŒºå›¢è´­ç³»ç»Ÿ/äºŒçº§æ–‡æ¡£ï¼ˆå‚è€ƒï¼‰/æ•°æ®åº“è®¾è®¡è¯´æ˜æ–‡æ¡£_v6.0.md`
  - 5.1 èŠ‚ï¼špayment_record è¡¨è®¾è®¡
  - **å…³é”®è§„èŒƒ**: "é‡‘é¢ï¼ˆæ­£æ•°-æ”¯ä»˜/å……å€¼ï¼›è´Ÿæ•°-é€€æ¬¾ï¼‰"

- **APIæ–‡æ¡£**: 
  - `docs/ç¤¾åŒºå›¢è´­ç³»ç»Ÿ/äºŒçº§æ–‡æ¡£ï¼ˆå‚è€ƒï¼‰/API_PaymentService.md`
  - `docs/ç¤¾åŒºå›¢è´­ç³»ç»Ÿ/äºŒçº§æ–‡æ¡£ï¼ˆå‚è€ƒï¼‰/API_GroupBuyService.md`

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒä¿®å¤åŸåˆ™
**æ‰€æœ‰ä¸ç”¨æˆ·è´¦æˆ·é‡‘é¢ç›¸å…³çš„å˜åŠ¨ï¼Œéƒ½å¿…é¡»è®°å½•åœ¨ `payment_record` è¡¨ä¸­**

### ä¿®å¤äº®ç‚¹
1. âœ… **ç»Ÿä¸€é€€æ¬¾æµç¨‹**: æ‰€æœ‰é€€æ¬¾åœºæ™¯éƒ½é€šè¿‡ PaymentService å¤„ç†
2. âœ… **å®Œæ•´å®¡è®¡è®°å½•**: payment_record è¡¨ä¸­å¯è¿½æº¯æ‰€æœ‰èµ„é‡‘å˜åŠ¨
3. âœ… **ç¬¦åˆè®¾è®¡è§„èŒƒ**: éµå¾ªæ•°æ®åº“è®¾è®¡æ–‡æ¡£çš„è´¢åŠ¡æ•°æ®è®°å½•è¦æ±‚
4. âœ… **SQL é”™è¯¯ä¿®å¤**: è§£å†³å›¢é•¿æ‹¼å›¢è®°å½•æŸ¥è¯¢çš„ OFFSET è®¡ç®—é”™è¯¯

### å½±å“èŒƒå›´
- **å½±å“æœåŠ¡**: GroupBuyServiceï¼ˆä¸»è¦ï¼‰ã€PaymentServiceã€UserService
- **å½±å“è¡¨**: payment_recordï¼ˆæ ¸å¿ƒï¼‰ã€user_accountã€order_mainã€group_buy_member
- **å½±å“æ¥å£**: 3ä¸ªå†…éƒ¨é€€æ¬¾æ–¹æ³• + 1ä¸ª Feign æ¥å£

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-11-07 23:50  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**ä¸‹ä¸€æ­¥**: éƒ¨ç½²éªŒè¯ + å›å½’æµ‹è¯•

