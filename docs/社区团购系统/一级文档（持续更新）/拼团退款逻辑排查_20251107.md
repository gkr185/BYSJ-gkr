# æ‹¼å›¢é€€æ¬¾é€»è¾‘æ’æŸ¥æŠ¥å‘Š

**åˆ›å»ºæ—¥æœŸ**: 2025-11-07  
**é—®é¢˜æè¿°**: æ‹¼å›¢æ”¯ä»˜æµç¨‹ä¸­ï¼Œé€€æ¬¾æ˜¾ç¤ºæˆåŠŸä½†é‡‘é¢æœªçœŸæ­£é€€å›è´¦æˆ·  
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜ï¼ˆæ¶‰åŠèµ„é‡‘å®‰å…¨ï¼‰

---

## ğŸ“‹ é€€æ¬¾è°ƒç”¨é“¾è·¯åˆ†æ

### åœºæ™¯1: ç”¨æˆ·ä¸»åŠ¨é€€å‡ºæ‹¼å›¢

```
ç”¨æˆ·æ“ä½œï¼šé€€å‡ºæ‹¼å›¢
    â†“
GroupBuyService.RefundService.quitTeam()
    â†“
userServiceClient.refundToBalance(userId, amount)  // Feignè°ƒç”¨
    â†“
UserService: POST /api/account/feign/refund
    â†“
AccountService.refundBalanceForFeign(userId, amount, sagaId)
    â†“
account.addBalance(amount)  // âœ… å¢åŠ ä½™é¢
accountRepository.save(account)  // âœ… ä¿å­˜åˆ°æ•°æ®åº“
```

### åœºæ™¯2: å›¢é•¿ç§»é™¤æˆå‘˜

```
å›¢é•¿æ“ä½œï¼šç§»é™¤æˆå‘˜
    â†“
GroupBuyService.TeamService.removeMember()
    â†“
userServiceClient.refundToBalance(userId, amount)  // Feignè°ƒç”¨
    â†“
ï¼ˆåŒä¸Šï¼‰
```

### åœºæ™¯3: æ‹¼å›¢å¤±è´¥è‡ªåŠ¨é€€æ¬¾ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰

```
å®šæ—¶ä»»åŠ¡ï¼šæ‰«æè¿‡æœŸå›¢
    â†“
GroupBuyService.RefundService.refundExpiredTeams()
    â†“
userServiceClient.refundToBalance(userId, amount)  // Feignè°ƒç”¨
    â†“
ï¼ˆåŒä¸Šï¼‰
```

---

## ğŸ” ä»£ç å®¡æŸ¥ç»“æœ

### âœ… UserService é€€æ¬¾é€»è¾‘æ­£ç¡®

**æ–‡ä»¶**: `UserService/src/main/java/com/bcu/edu/service/AccountService.java`

```java
@Transactional
public void refundBalanceForFeign(Long userId, BigDecimal amount, String sagaId) {
    if (amount.compareTo(BigDecimal.ZERO) <= 0) {
        throw new BusinessException(ResultCode.VALIDATE_FAILED.getCode(), "è¿”è¿˜é‡‘é¢å¿…é¡»å¤§äº0");
    }

    UserAccount account = accountRepository.findByUserId(userId)
            .orElseThrow(() -> new BusinessException(ResultCode.NOT_FOUND.getCode(), "è´¦æˆ·ä¸å­˜åœ¨"));

    account.addBalance(amount);  // âœ… æ­£ç¡®å¢åŠ ä½™é¢
    account = accountRepository.save(account);  // âœ… ä¿å­˜åˆ°æ•°æ®åº“

    log.info("[Saga-{}] ä½™é¢è¿”è¿˜æˆåŠŸ: userId={}, amount={}, newBalance={}", 
        sagaId, userId, amount, account.getBalance());
}
```

**UserAccount.addBalance() æ–¹æ³•**:
```java
public void addBalance(BigDecimal amount) {
    if (amount != null && amount.compareTo(BigDecimal.ZERO) > 0) {
        this.balance = this.balance.add(amount);  // âœ… æ­£ç¡®
    }
}
```

### âœ… GroupBuyService è°ƒç”¨æ­£ç¡®

**æ–‡ä»¶**: `GroupBuyService/src/main/java/com/bcu/edu/client/UserServiceClient.java`

```java
@PostMapping("/api/account/feign/refund")
Result<Void> refundToBalance(@RequestParam("userId") Long userId, 
                              @RequestParam("amount") BigDecimal amount);
```

**è°ƒç”¨ç¤ºä¾‹** (`RefundService.java`):
```java
userServiceClient.refundToBalance(member.getUserId(), member.getPayAmount());
log.info("ç”¨æˆ·{}é€€æ¬¾æˆåŠŸï¼Œé‡‘é¢={}", member.getUserId(), member.getPayAmount());
```

---

## âš ï¸ å¯èƒ½çš„é—®é¢˜ç‚¹

### é—®é¢˜1: PaymentService é€€æ¬¾é€»è¾‘ä¸ä¸€è‡´

**æ–‡ä»¶**: `PaymentService/src/main/java/com/bcu/edu/service/PaymentService.java`

PaymentService çš„é€€æ¬¾ä½¿ç”¨äº†ä¸åŒçš„æ¥å£ï¼š

```java
private void handleBalanceRefund(PaymentRecord refundRecord, Long userId) {
    // âŒ è°ƒç”¨çš„æ˜¯ recharge æ¥å£ï¼Œè€Œä¸æ˜¯ refund æ¥å£
    Result<Void> rechargeResult = userServiceClient.recharge(userId, refundRecord.getAmount().abs());
    
    if (rechargeResult.getCode() == 200) {
        refundRecord.setPayStatus(PayStatus.SUCCESS.getCode());
        paymentRepository.save(refundRecord);
    }
}
```

**å¯¹åº”çš„ UserServiceClient**:
```java
// PaymentService çš„ UserServiceClient
@PostMapping("/feign/account/recharge")
Result<Void> recharge(@RequestParam("userId") Long userId, 
                      @RequestParam("amount") BigDecimal amount);
```

è™½ç„¶ `/feign/account/recharge` æœ€ç»ˆä¹Ÿè°ƒç”¨äº† `accountService.recharge()`ï¼Œå®ƒåŒæ ·ä¼šå¢åŠ ä½™é¢ï¼Œä½†æ˜¯ï¼š
1. ç¼ºå°‘ Saga äº‹åŠ¡IDè¿½è¸ª
2. è¿”å›ç±»å‹ä¸ä¸€è‡´

---

## ğŸ› æ½œåœ¨é—®é¢˜æ’æŸ¥

### æ£€æŸ¥ç‚¹1: äº‹åŠ¡å›æ»š

**å¯èƒ½åŸå› **: é€€æ¬¾æˆåŠŸä½†åç»­æ“ä½œå¤±è´¥å¯¼è‡´äº‹åŠ¡å›æ»š

**éªŒè¯æ–¹æ³•**:
```sql
-- æŸ¥çœ‹ç”¨æˆ·ä½™é¢å˜åŒ–
SELECT * FROM user_account WHERE user_id = ?;

-- æŸ¥çœ‹é€€æ¬¾æ—¥å¿—
-- æ£€æŸ¥ UserService æ—¥å¿—ä¸­æ˜¯å¦æœ‰ï¼š
-- "[Saga-xxx] ä½™é¢è¿”è¿˜æˆåŠŸ: userId=xxx, amount=xxx, newBalance=xxx"
```

### æ£€æŸ¥ç‚¹2: Feignè°ƒç”¨å¤±è´¥ä½†æœªæ­£ç¡®å¤„ç†

**GroupBuyService è°ƒç”¨é€€æ¬¾æ—¶çš„é”™è¯¯å¤„ç†**:

```java
// RefundService.java
try {
    userServiceClient.refundToBalance(member.getUserId(), member.getPayAmount());
    log.info("ç”¨æˆ·{}é€€æ¬¾æˆåŠŸï¼Œé‡‘é¢={}", member.getUserId(), member.getPayAmount());
} catch (Exception e) {
    log.error("é€€æ¬¾å¤±è´¥ï¼ŒuserId={}, amount={}", member.getUserId(), member.getPayAmount(), e);
    throw new BusinessException("é€€æ¬¾å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");
}
```

**é—®é¢˜**: å¦‚æœFeignè°ƒç”¨è¶…æ—¶æˆ–è¿”å›å¤±è´¥ï¼Œä½†GroupBuyServiceè®¤ä¸ºæˆåŠŸäº†ï¼ˆå› ä¸ºæ²¡æœ‰æŠ›å¼‚å¸¸ï¼‰ï¼Œå°±ä¼šå‡ºç°"æ˜¾ç¤ºé€€æ¬¾æˆåŠŸä½†å®é™…æ²¡é€€"çš„æƒ…å†µã€‚

### æ£€æŸ¥ç‚¹3: æœåŠ¡é—´è°ƒç”¨å¤±è´¥

**å¯èƒ½åœºæ™¯**:
- UserService æœªå¯åŠ¨
- ç½‘ç»œé—®é¢˜å¯¼è‡´Feignè°ƒç”¨å¤±è´¥
- Feignçš„fallbackè¿”å›äº†æˆåŠŸä½†å®é™…å¤±è´¥

**UserServiceClientFallback**:
```java
@Override
public Result<Void> refundToBalance(Long userId, BigDecimal amount) {
    log.error("UserServiceé€€æ¬¾è°ƒç”¨å¤±è´¥ï¼ŒuserId={}, amount={}", userId, amount);
    throw new BusinessException(ResultCode.SERVICE_UNAVAILABLE, 
        "é€€æ¬¾æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");
}
```

è¿™ä¸ªfallbackæ˜¯æ­£ç¡®çš„ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

---

## ğŸ”§ ä¿®å¤å»ºè®®

### ä¿®å¤1: ç»Ÿä¸€PaymentServiceçš„é€€æ¬¾æ¥å£è°ƒç”¨

**ä¿®æ”¹æ–‡ä»¶**: `PaymentService/src/main/java/com/bcu/edu/client/UserServiceClient.java`

æ·»åŠ  `refundToBalance` æ–¹æ³•ï¼š

```java
/**
 * é€€æ¬¾åˆ°ç”¨æˆ·ä½™é¢ï¼ˆç”¨äºé€€æ¬¾åœºæ™¯ï¼‰
 * 
 * @param userId ç”¨æˆ·ID
 * @param amount é€€æ¬¾é‡‘é¢
 * @return æˆåŠŸ/å¤±è´¥
 */
@PostMapping("/api/account/feign/refund")
Result<Void> refundToBalance(@RequestParam("userId") Long userId, 
                              @RequestParam("amount") BigDecimal amount);
```

**ä¿®æ”¹æ–‡ä»¶**: `PaymentService/src/main/java/com/bcu/edu/service/PaymentService.java`

```java
private void handleBalanceRefund(PaymentRecord refundRecord, Long userId) {
    log.info("å¼€å§‹ä½™é¢é€€æ¬¾: userId={}, amount={}", userId, refundRecord.getAmount().abs());

    try {
        // âœ… ä½¿ç”¨ refundToBalance æ¥å£
        Result<Void> refundResult = userServiceClient.refundToBalance(userId, refundRecord.getAmount().abs());
        
        if (refundResult.getCode() == 200) {
            // é€€æ¬¾æˆåŠŸ
            refundRecord.setPayStatus(PayStatus.SUCCESS.getCode());
            refundRecord.setTransactionId("REFUND_" + System.currentTimeMillis());
            paymentRepository.save(refundRecord);
            
            log.info("ä½™é¢é€€æ¬¾æˆåŠŸ: payId={}, userId={}, amount={}", 
                refundRecord.getPayId(), userId, refundRecord.getAmount().abs());
        } else {
            log.error("ä½™é¢é€€æ¬¾å¤±è´¥: userId={}, msg={}", userId, refundResult.getMessage());
            throw new BusinessException("é€€æ¬¾å¤±è´¥: " + refundResult.getMessage());
        }
    } catch (Exception e) {
        log.error("ä½™é¢é€€æ¬¾å¼‚å¸¸: userId={}, amount={}", userId, refundRecord.getAmount().abs(), e);
        throw new BusinessException("é€€æ¬¾å¤±è´¥: " + e.getMessage());
    }
}
```

### ä¿®å¤2: å¢å¼ºGroupBuyServiceçš„é€€æ¬¾ç»“æœéªŒè¯

**ä¿®æ”¹æ–‡ä»¶**: `GroupBuyService/src/main/java/com/bcu/edu/service/RefundService.java`

```java
// 5. é€€æ¬¾ï¼ˆFeignï¼‰â­å¢å¼ºç»“æœéªŒè¯
if (needDecrementCount) {
    try {
        Result<Void> refundResult = userServiceClient.refundToBalance(
            member.getUserId(), member.getPayAmount());
        
        // âœ… éªŒè¯è¿”å›ç»“æœ
        if (refundResult == null || refundResult.getCode() != 200) {
            log.error("é€€æ¬¾å¤±è´¥ï¼ŒuserId={}, amount={}, result={}", 
                member.getUserId(), member.getPayAmount(), refundResult);
            throw new BusinessException("é€€æ¬¾å¤±è´¥: " + 
                (refundResult != null ? refundResult.getMessage() : "æœåŠ¡æ— å“åº”"));
        }
        
        log.info("ç”¨æˆ·{}é€€æ¬¾æˆåŠŸï¼Œé‡‘é¢={}", member.getUserId(), member.getPayAmount());
    } catch (Exception e) {
        log.error("é€€æ¬¾å¤±è´¥ï¼ŒuserId={}, amount={}", member.getUserId(), member.getPayAmount(), e);
        throw new BusinessException("é€€æ¬¾å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");
    }
} else {
    log.info("æœªæ”¯ä»˜æˆå‘˜é€€å‡ºï¼Œæ— éœ€é€€æ¬¾ï¼ŒuserId={}, status={}", userId, member.getStatus());
}
```

ç±»ä¼¼ä¿®æ”¹åº”ç”¨åˆ°æ‰€æœ‰é€€æ¬¾è°ƒç”¨çš„åœ°æ–¹ã€‚

---

## ğŸ“Š æµ‹è¯•éªŒè¯æ­¥éª¤

### æ­¥éª¤1: å¼€å¯è¯¦ç»†æ—¥å¿—

åœ¨ `application.yml` ä¸­æ·»åŠ ï¼š

```yaml
logging:
  level:
    com.bcu.edu.service.AccountService: DEBUG
    com.bcu.edu.client.UserServiceClient: DEBUG
    org.springframework.cloud.openfeign: DEBUG
```

### æ­¥éª¤2: å®Œæ•´æµ‹è¯•æµç¨‹

1. **å‡†å¤‡æµ‹è¯•æ•°æ®**
   ```sql
   -- æŸ¥çœ‹ç”¨æˆ·åˆå§‹ä½™é¢
   SELECT user_id, balance FROM user_account WHERE user_id = æµ‹è¯•ç”¨æˆ·ID;
   ```

2. **æ‰§è¡Œé€€å‡ºæ‹¼å›¢æ“ä½œ**
   - ç”¨æˆ·å‚å›¢å¹¶æ”¯ä»˜ï¼ˆä½™é¢åº”å‡å°‘ï¼‰
   - ç”¨æˆ·é€€å‡ºæ‹¼å›¢ï¼ˆè§¦å‘é€€æ¬¾ï¼‰

3. **éªŒè¯é€€æ¬¾ç»“æœ**
   ```sql
   -- æŸ¥çœ‹ä½™é¢æ˜¯å¦æ¢å¤
   SELECT user_id, balance FROM user_account WHERE user_id = æµ‹è¯•ç”¨æˆ·ID;
   
   -- åº”è¯¥æ¢å¤åˆ°åˆå§‹ä½™é¢
   ```

4. **æ£€æŸ¥æ—¥å¿—**
   - GroupBuyService æ—¥å¿—ï¼š`ç”¨æˆ·Xé€€æ¬¾æˆåŠŸï¼Œé‡‘é¢=XX`
   - UserService æ—¥å¿—ï¼š`[Saga-xxx] ä½™é¢è¿”è¿˜æˆåŠŸ: userId=X, amount=XX, newBalance=XX`
   - æ•°æ®åº“ä½™é¢å˜åŒ–ä¸æ—¥å¿—ä¸€è‡´

### æ­¥éª¤3: å¼‚å¸¸åœºæ™¯æµ‹è¯•

1. **UserService æœªå¯åŠ¨**
   - åœæ­¢ UserService
   - å°è¯•é€€å‡ºæ‹¼å›¢
   - åº”è¯¥è¿”å›é”™è¯¯ï¼š"é€€æ¬¾æœåŠ¡æš‚æ—¶ä¸å¯ç”¨"
   - GroupBuyService åº”è¯¥æœ‰é”™è¯¯æ—¥å¿—

2. **æ•°æ®åº“é”è¡¨åœºæ™¯**
   - æ¨¡æ‹Ÿæ•°æ®åº“é”
   - è§‚å¯Ÿæ˜¯å¦æœ‰è¶…æ—¶å’Œé‡è¯•æœºåˆ¶

---

## ğŸ“ æ£€æŸ¥æ¸…å•

### åç«¯æœåŠ¡æ£€æŸ¥
- [ ] UserService æ­£å¸¸è¿è¡Œ
- [ ] GroupBuyService æ­£å¸¸è¿è¡Œ
- [ ] PaymentService æ­£å¸¸è¿è¡Œ
- [ ] æœåŠ¡é—´Feignè°ƒç”¨æ­£å¸¸

### ä»£ç é€»è¾‘æ£€æŸ¥
- [ ] UserServiceçš„é€€æ¬¾æ¥å£æ­£ç¡®å¢åŠ ä½™é¢
- [ ] GroupBuyServiceæ­£ç¡®è°ƒç”¨é€€æ¬¾æ¥å£
- [ ] PaymentServiceä½¿ç”¨ç»Ÿä¸€çš„é€€æ¬¾æ¥å£
- [ ] æ‰€æœ‰é€€æ¬¾è°ƒç”¨éƒ½éªŒè¯äº†è¿”å›ç»“æœ

### æ•°æ®åº“æ£€æŸ¥
- [ ] user_accountè¡¨æ•°æ®æ­£å¸¸
- [ ] ä½™é¢å­—æ®µç±»å‹æ­£ç¡®ï¼ˆDECIMALï¼‰
- [ ] æ²¡æœ‰è§¦å‘å™¨æˆ–çº¦æŸå¯¼è‡´æ›´æ–°å¤±è´¥

### æ—¥å¿—æ£€æŸ¥
- [ ] GroupBuyServiceæœ‰é€€æ¬¾æˆåŠŸæ—¥å¿—
- [ ] UserServiceæœ‰ä½™é¢è¿”è¿˜æˆåŠŸæ—¥å¿—
- [ ] æ—¥å¿—ä¸­çš„ä½™é¢æ•°å€¼æ­£ç¡®
- [ ] æ²¡æœ‰å¼‚å¸¸æˆ–ERRORæ—¥å¿—

---

## ğŸ¯ ç»“è®º

æ ¹æ®ä»£ç å®¡æŸ¥ï¼Œé€€æ¬¾é€»è¾‘æœ¬èº«æ˜¯**æ­£ç¡®çš„**ã€‚é—®é¢˜å¯èƒ½å‡ºåœ¨ï¼š

1. **æœåŠ¡é—´è°ƒç”¨å¤±è´¥** - UserServiceæœªå¯åŠ¨æˆ–ç½‘ç»œé—®é¢˜
2. **äº‹åŠ¡å›æ»š** - é€€æ¬¾æˆåŠŸä½†åç»­æ“ä½œå¤±è´¥
3. **æ—¥å¿—è¯¯å¯¼** - GroupBuyServiceè®°å½•äº†"é€€æ¬¾æˆåŠŸ"ä½†å®é™…Feignè°ƒç”¨å¤±è´¥
4. **PaymentServiceä¸ä¸€è‡´** - ä½¿ç”¨äº†ä¸åŒçš„æ¥å£ä½†æ²¡æœ‰Sagaè¿½è¸ª

**å»ºè®®ä¼˜å…ˆæ£€æŸ¥**:
1. æŸ¥çœ‹UserServiceæ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦æœ‰"ä½™é¢è¿”è¿˜æˆåŠŸ"çš„è®°å½•
2. å¯¹æ¯”æ—¥å¿—ä¸­çš„ä½™é¢ä¸æ•°æ®åº“å®é™…ä½™é¢
3. åº”ç”¨ä¸Šè¿°ä¿®å¤å»ºè®®ï¼Œç»Ÿä¸€æ¥å£è°ƒç”¨

---

**æŠ¥å‘Šäºº**: AIåŠ©æ‰‹  
**æ›´æ–°æ—¶é—´**: 2025-11-07

