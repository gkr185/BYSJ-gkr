# ç¤¾åŒºå›¢è´­ç³»ç»Ÿ - æœåŠ¡é—´ååŒé—­ç¯åˆ†æ

**åˆ†ææ—¥æœŸ**: 2025-11-01  
**ç³»ç»Ÿç‰ˆæœ¬**: v0.90ï¼ˆ90%å®Œæˆï¼‰  
**åˆ†æç›®çš„**: ç¡®ä¿æœåŠ¡é—´ååŒé€»è¾‘å®Œæ•´å¹¶å½¢æˆé—­ç¯

---

## ğŸ“Š ç³»ç»ŸæœåŠ¡å…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯åº”ç”¨å±‚ï¼ˆ3ä¸ªï¼‰                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  ç”¨æˆ·ç«¯+å›¢é•¿  â”‚  â”‚   ç®¡ç†ç«¯     â”‚  â”‚   ç§»åŠ¨ç«¯     â”‚          â”‚
â”‚  â”‚  (5173)      â”‚  â”‚  (5174)      â”‚  â”‚  (æœªå¼€å‘)    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ JWT Token
                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   API Gateway (9000) â”‚ âœ… å·²å®Œæˆ
          â”‚  - JWTç»Ÿä¸€é‰´æƒ       â”‚
          â”‚  - æœåŠ¡è·¯ç”±         â”‚
          â”‚  - CORSè·¨åŸŸ         â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   ConsulæœåŠ¡æ³¨å†Œå‘ç°  â”‚ âœ… å·²é…ç½®
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚              â”‚              â”‚              â”‚
      â–¼              â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚  â”‚ Product  â”‚  â”‚GroupBuy  â”‚  â”‚  Leader  â”‚
â”‚ Service  â”‚  â”‚ Service  â”‚  â”‚ Service  â”‚  â”‚ Service  â”‚
â”‚  8061    â”‚  â”‚  8062    â”‚  â”‚  8063    â”‚  â”‚  8068    â”‚
â”‚ âœ…å®Œæˆ   â”‚  â”‚ âœ…å®Œæˆ   â”‚  â”‚ âœ…å®Œæˆ   â”‚  â”‚ âœ…å®Œæˆ   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚             â”‚             â”‚             â”‚
      â”‚             â”‚             â”‚             â”‚
      â–¼             â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Order   â”‚  â”‚ Payment  â”‚  â”‚Delivery  â”‚  â”‚  Common  â”‚
â”‚ Service  â”‚  â”‚ Service  â”‚  â”‚ Service  â”‚  â”‚  Module  â”‚
â”‚  8065    â”‚  â”‚  8066    â”‚  â”‚  8067    â”‚  â”‚    -     â”‚
â”‚ âœ…å®Œæˆ   â”‚  â”‚ ğŸ”´å¾…å¼€å‘ â”‚  â”‚ ğŸŸ¡å¾…å¼€å‘ â”‚  â”‚ âœ…å®Œæˆ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ ¸å¿ƒä¸šåŠ¡é—­ç¯åˆ†æ

### é—­ç¯1: æ‹¼å›¢æ”¯ä»˜å®Œæ•´æµç¨‹ â­â­â­â­â­ï¼ˆæœ€é‡è¦ï¼‰

```mermaid
sequenceDiagram
    autonumber
    participant ç”¨æˆ· as ç”¨æˆ·(å‰ç«¯)
    participant GW as Gateway(9000)
    participant GB as GroupBuyService(8063)
    participant OS as OrderService(8065)
    participant PS as PaymentService(8066)
    participant US as UserService(8061)
    
    ç”¨æˆ·->>GW: 1.å‚ä¸æ‹¼å›¢
    GW->>GB: 2.POST /api/groupbuy/team/join
    GB->>GB: 3.è¡Œé”æ£€æŸ¥å›¢çŠ¶æ€
    GB->>GB: 4.é˜²é‡å¤å‚å›¢æ£€æŸ¥
    GB->>OS: 5.Feign: åˆ›å»ºè®¢å•
    OS->>OS: 6.ç”Ÿæˆè®¢å•ï¼ˆå¾…æ”¯ä»˜ï¼‰
    OS-->>GB: 7.è¿”å›è®¢å•ID
    GB->>GB: 8.è®°å½•å‚å›¢ï¼ˆstatus=UNPAIDï¼‰
    GB-->>ç”¨æˆ·: 9.è¿”å›è®¢å•ID
    
    ç”¨æˆ·->>GW: 10.å‘èµ·æ”¯ä»˜
    GW->>PS: 11.POST /api/payment/create
    PS->>PS: 12.åˆ›å»ºæ”¯ä»˜è®°å½•
    
    alt ä½™é¢æ”¯ä»˜
        PS->>US: 13.Feign: ä½™é¢æ‰£æ¬¾
        US->>US: 14.æ‰£æ¬¾æˆåŠŸ
        US-->>PS: 15.è¿”å›æˆåŠŸ
        PS->>PS: 16.æ›´æ–°æ”¯ä»˜è®°å½•(status=1)
        PS->>OS: 17.Feign: æ›´æ–°è®¢å•æ”¯ä»˜çŠ¶æ€
        OS->>OS: 18.pay_status=1
        PS->>GB: 19.Feign: æ”¯ä»˜å›è°ƒ
        GB->>GB: 20.æ›´æ–°å‚å›¢çŠ¶æ€(PAID)
        GB->>GB: 21.å›¢äººæ•°+1
        GB->>GB: 22.æ£€æŸ¥æ˜¯å¦æˆå›¢
        
        alt å·²æˆå›¢
            GB->>GB: 23.æ›´æ–°å›¢çŠ¶æ€(SUCCESS)
            GB->>GB: 24.æ›´æ–°æ‰€æœ‰æˆå‘˜(SUCCESS)
            GB->>OS: 25.Feign: æ‰¹é‡æ›´æ–°è®¢å•(å¾…å‘è´§)
            OS->>OS: 26.order_status=1
        end
        
        PS-->>ç”¨æˆ·: 27.æ”¯ä»˜æˆåŠŸ
    else å¾®ä¿¡æ”¯ä»˜
        PS->>å¾®ä¿¡: 13.ç»Ÿä¸€ä¸‹å•
        å¾®ä¿¡-->>ç”¨æˆ·: 14.æ”¯ä»˜å‚æ•°
        ç”¨æˆ·->>å¾®ä¿¡: 15.å®Œæˆæ”¯ä»˜
        å¾®ä¿¡->>PS: 16.æ”¯ä»˜å›è°ƒ
        PS->>PS: 17.éªŒè¯ç­¾å
        PS->>PS: 18.æ›´æ–°æ”¯ä»˜è®°å½•
        PS->>OS: 19.æ›´æ–°è®¢å•æ”¯ä»˜çŠ¶æ€
        PS->>GB: 20.æ”¯ä»˜å›è°ƒ
        Note over GB: åç»­æµç¨‹åŒä½™é¢æ”¯ä»˜
    end
```

**å…³é”®èŠ‚ç‚¹**:
- âœ… **èŠ‚ç‚¹5**: GroupBuyService â†’ OrderServiceï¼ˆåˆ›å»ºè®¢å•ï¼‰- **å·²å®ç°**
- ğŸ”´ **èŠ‚ç‚¹13**: PaymentService â†’ UserServiceï¼ˆä½™é¢æ‰£æ¬¾ï¼‰- **å¾…å¼€å‘**
- ğŸ”´ **èŠ‚ç‚¹17**: PaymentService â†’ OrderServiceï¼ˆæ›´æ–°æ”¯ä»˜çŠ¶æ€ï¼‰- **å¾…è¡¥å……æ¥å£**
- ğŸ”´ **èŠ‚ç‚¹19**: PaymentService â†’ GroupBuyServiceï¼ˆæ”¯ä»˜å›è°ƒï¼‰- **å¾…å¼€å‘**
- âœ… **èŠ‚ç‚¹25**: GroupBuyService â†’ OrderServiceï¼ˆæ‰¹é‡æ›´æ–°ï¼‰- **å·²å®ç°**

---

### é—­ç¯2: æ‹¼å›¢å¤±è´¥é€€æ¬¾æµç¨‹ â­â­â­â­

```mermaid
sequenceDiagram
    autonumber
    participant å®šæ—¶ä»»åŠ¡ as TeamExpireTask
    participant GB as GroupBuyService(8063)
    participant PS as PaymentService(8066)
    participant US as UserService(8061)
    participant OS as OrderService(8065)
    
    å®šæ—¶ä»»åŠ¡->>GB: 1.æ¯å°æ—¶æ£€æŸ¥è¿‡æœŸå›¢
    GB->>GB: 2.æŸ¥è¯¢è¿‡æœŸæœªæˆå›¢
    GB->>GB: 3.è¡Œé”æ£€æŸ¥å›¢çŠ¶æ€
    
    alt å·²è¿‡æœŸä¸”æœªæˆå›¢
        GB->>GB: 4.æ›´æ–°å›¢çŠ¶æ€(FAILED)
        GB->>GB: 5.æŸ¥è¯¢æ‰€æœ‰æˆå‘˜
        
        loop æ¯ä¸ªæˆå‘˜
            GB->>PS: 6.Feign: ç”³è¯·é€€æ¬¾
            PS->>PS: 7.æŸ¥è¯¢åŸæ”¯ä»˜è®°å½•
            PS->>PS: 8.åˆ›å»ºé€€æ¬¾è®°å½•(amount<0)
            
            alt ä½™é¢æ”¯ä»˜
                PS->>US: 9.Feign: ä½™é¢å……å€¼
                US->>US: 10.ä½™é¢å¢åŠ 
                US-->>PS: 11.è¿”å›æˆåŠŸ
            else å¾®ä¿¡æ”¯ä»˜
                PS->>å¾®ä¿¡: 9.ç”³è¯·é€€æ¬¾
                å¾®ä¿¡-->>PS: 10.é€€æ¬¾æˆåŠŸ
                å¾®ä¿¡->>PS: 11.é€€æ¬¾å›è°ƒ
            end
            
            PS->>PS: 12.æ›´æ–°é€€æ¬¾çŠ¶æ€
            PS->>OS: 13.Feign: æ›´æ–°è®¢å•çŠ¶æ€
            OS->>OS: 14.order_status=6(å·²é€€æ¬¾)
            PS-->>GB: 15.è¿”å›æˆåŠŸ
            
            GB->>GB: 16.æ›´æ–°æˆå‘˜çŠ¶æ€(CANCELLED)
        end
    end
```

**å…³é”®èŠ‚ç‚¹**:
- âœ… **èŠ‚ç‚¹1-5**: GroupBuyService å®šæ—¶ä»»åŠ¡ - **å·²å®ç°**ï¼ˆTeamExpireTaskï¼‰
- ğŸ”´ **èŠ‚ç‚¹6**: GroupBuyService â†’ PaymentServiceï¼ˆç”³è¯·é€€æ¬¾ï¼‰- **å¾…å¼€å‘**
- ğŸ”´ **èŠ‚ç‚¹9**: PaymentService â†’ UserServiceï¼ˆä½™é¢å……å€¼ï¼‰- **å·²å®ç°**
- ğŸ”´ **èŠ‚ç‚¹13**: PaymentService â†’ OrderServiceï¼ˆæ›´æ–°è®¢å•ï¼‰- **å¾…è¡¥å……æ¥å£**

---

### é—­ç¯3: å›¢é•¿ä½£é‡‘ç»“ç®—æµç¨‹ â­â­â­

```mermaid
sequenceDiagram
    autonumber
    participant å®šæ—¶ä»»åŠ¡ as CommissionTask
    participant LS as LeaderService(8068)
    participant US as UserService(8061)
    participant OS as OrderService(8065)
    
    å®šæ—¶ä»»åŠ¡->>LS: 1.æ¯æœˆ1å·å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    LS->>LS: 2.æŸ¥è¯¢å¾…ç»“ç®—ä½£é‡‘è®°å½•
    LS->>LS: 3.æŒ‰å›¢é•¿åˆ†ç»„
    
    loop æ¯ä¸ªå›¢é•¿
        LS->>LS: 4.è®¡ç®—æ€»ä½£é‡‘
        LS->>US: 5.Feign: å¢åŠ ä½™é¢
        US->>US: 6.balance += ä½£é‡‘
        US-->>LS: 7.è¿”å›æˆåŠŸ
        LS->>LS: 8.æ›´æ–°ä½£é‡‘çŠ¶æ€(å·²ç»“ç®—)
        LS->>LS: 9.è®°å½•ç»“ç®—æ‰¹æ¬¡å·
    end
    
    LS->>LS: 10.ç”Ÿæˆç»“ç®—æŠ¥å‘Š
```

**å…³é”®èŠ‚ç‚¹**:
- âœ… **èŠ‚ç‚¹1-4**: LeaderService å®šæ—¶ä»»åŠ¡ - **å·²å®ç°**ï¼ˆCommissionSettlementTaskï¼‰
- âœ… **èŠ‚ç‚¹5**: LeaderService â†’ UserServiceï¼ˆå¢åŠ ä½™é¢ï¼‰- **å·²å®ç°**
- âœ… **èŠ‚ç‚¹8**: LeaderService æ›´æ–°ä½£é‡‘çŠ¶æ€ - **å·²å®ç°**

**ä½£é‡‘è®°å½•ç”Ÿæˆæ—¶æœº**:
```mermaid
sequenceDiagram
    participant OS as OrderService(8065)
    participant LS as LeaderService(8068)
    
    Note over OS: è®¢å•é…é€å®Œæˆ(status=3)
    OS->>LS: Feign: ç”Ÿæˆä½£é‡‘è®°å½•
    LS->>LS: commission = order_amount Ã— rate / 100
    LS->>LS: åˆ›å»ºcommission_record(status=0)
```

---

### é—­ç¯4: è®¢å•é…é€æµç¨‹ â­â­â­

```mermaid
sequenceDiagram
    autonumber
    participant å›¢é•¿ as å›¢é•¿(å‰ç«¯)
    participant OS as OrderService(8065)
    participant DS as DeliveryService(8067)
    participant LS as LeaderService(8068)
    
    å›¢é•¿->>OS: 1.æŸ¥è¯¢å¾…å‘è´§è®¢å•
    OS-->>å›¢é•¿: 2.è¿”å›è®¢å•åˆ—è¡¨
    å›¢é•¿->>DS: 3.ç”Ÿæˆé…é€è·¯çº¿
    DS->>DS: 4.è·å–æ‰€æœ‰é…é€åœ°å€
    DS->>DS: 5.æ‰§è¡ŒDijkstraç®—æ³•
    DS->>DS: 6.ç”Ÿæˆæœ€ä¼˜è·¯å¾„
    DS-->>å›¢é•¿: 7.è¿”å›è·¯å¾„å’Œè·ç¦»
    
    å›¢é•¿->>OS: 8.ç¡®è®¤å‘è´§
    OS->>OS: 9.order_status=2(é…é€ä¸­)
    OS->>DS: 10.Feign: åˆ›å»ºé…é€å•
    DS->>DS: 11.è®°å½•é…é€è·¯çº¿
    
    å›¢é•¿->>OS: 12.ç¡®è®¤é€è¾¾
    OS->>OS: 13.order_status=3(å·²é€è¾¾)
    OS->>LS: 14.Feign: ç”Ÿæˆä½£é‡‘è®°å½•
    LS->>LS: 15.åˆ›å»ºcommission_record
```

**å…³é”®èŠ‚ç‚¹**:
- âœ… **èŠ‚ç‚¹1-2**: OrderService æŸ¥è¯¢è®¢å• - **å·²å®ç°**
- ğŸŸ¡ **èŠ‚ç‚¹3-7**: DeliveryService Dijkstraç®—æ³• - **å¾…å¼€å‘**
- âœ… **èŠ‚ç‚¹8-9**: OrderService å‘è´§ - **å·²å®ç°**
- ğŸŸ¡ **èŠ‚ç‚¹10**: OrderService â†’ DeliveryServiceï¼ˆåˆ›å»ºé…é€å•ï¼‰- **å¾…å¼€å‘**
- âœ… **èŠ‚ç‚¹14**: OrderService â†’ LeaderServiceï¼ˆç”Ÿæˆä½£é‡‘ï¼‰- **å¾…è¡¥å……æ¥å£**

---

## ğŸ” æœåŠ¡é—´ä¾èµ–çŸ©é˜µ

### Feignå®¢æˆ·ç«¯è°ƒç”¨å…³ç³»è¡¨

| è°ƒç”¨æ–¹ | è¢«è°ƒç”¨æ–¹ | æ¥å£ | çŠ¶æ€ | ä¼˜å…ˆçº§ |
|--------|---------|------|------|--------|
| **GroupBuyService** | UserService | `/feign/user/info/{userId}` | âœ… å·²å®ç° | - |
| **GroupBuyService** | OrderService | `/api/order/feign/create` | âœ… å·²å®ç° | - |
| **GroupBuyService** | OrderService | `/api/order/feign/batchUpdateStatus` | âœ… å·²å®ç° | - |
| **GroupBuyService** | ProductService | `/api/product/feign/info/{productId}` | âœ… å·²å®ç° | - |
| **GroupBuyService** | LeaderService | `/api/community/feign/{id}` | âœ… å·²å®ç° | - |
| **OrderService** | UserService | `/feign/user/info/{userId}` | âœ… å·²å®ç° | - |
| **OrderService** | UserService | `/feign/address/{addressId}` | âœ… å·²å®ç° | - |
| **OrderService** | LeaderService | `/api/leader/feign/info/{leaderId}` | âœ… å·²å®ç° | - |
| **OrderService** | ProductService | `/api/product/feign/info/{productId}` | âœ… å·²å®ç° | - |
| **LeaderService** | UserService | `/feign/user/updateRole` | âœ… å·²å®ç° | - |
| **LeaderService** | UserService | `/feign/account/recharge` | âœ… å·²å®ç° | - |
| ğŸ”´ **PaymentService** | UserService | `/feign/account/deduct` | âœ… å·²å®ç° | ğŸ”´ğŸ”´ğŸ”´ |
| ğŸ”´ **PaymentService** | UserService | `/feign/account/recharge` | âœ… å·²å®ç° | ğŸ”´ğŸ”´ |
| ğŸ”´ **PaymentService** | OrderService | `/api/order/feign/updatePayStatus` | â“ å¾…éªŒè¯ | ğŸ”´ğŸ”´ğŸ”´ |
| ğŸ”´ **PaymentService** | OrderService | `/api/order/feign/isGroupBuyOrder/{id}` | âŒ å¾…å¼€å‘ | ğŸ”´ğŸ”´ |
| ğŸ”´ **PaymentService** | GroupBuyService | `/api/groupbuy/payment/callback` | âœ… å·²å®ç° | ğŸ”´ğŸ”´ğŸ”´ |
| ğŸŸ¡ **DeliveryService** | OrderService | `/api/order/feign/list` | â“ å¾…éªŒè¯ | ğŸŸ¡ |
| ğŸŸ¡ **OrderService** | DeliveryService | `/api/delivery/feign/create` | âŒ å¾…å¼€å‘ | ğŸŸ¡ |
| ğŸŸ¡ **OrderService** | LeaderService | `/api/commission/feign/create` | â“ å¾…éªŒè¯ | ğŸŸ¡ |

---

### ä¾èµ–å…³ç³»å›¾ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

```
ã€æœ€é«˜ä¼˜å…ˆçº§ã€‘PaymentService ä¾èµ–ï¼ˆå…³é”®è·¯å¾„ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           PaymentService (8066)                â”‚
â”‚               ğŸ”´ å¾…å¼€å‘                         â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚              â”‚              â”‚
    â”‚ ä½™é¢æ‰£æ¬¾/å……å€¼ â”‚ æ”¯ä»˜çŠ¶æ€æ›´æ–°  â”‚ æ”¯ä»˜å›è°ƒé€šçŸ¥
    â–¼              â–¼              â–¼
UserService   OrderService   GroupBuyService
  (8061)        (8065)          (8063)
 âœ…å·²å®ç°      âœ…å·²å®ç°        âœ…å·²å®ç°
    â”‚              â”‚              â”‚
    â”‚ deduct()     â”‚ updatePay... â”‚ payment...
    â”‚ recharge()   â”‚ isGroupBuy...â”‚ Callback()
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         å…¨éƒ¨æ¥å£å·²å®ç°
```

```
ã€ä¸­ç­‰ä¼˜å…ˆçº§ã€‘DeliveryService ä¾èµ–:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          DeliveryService (8067)                â”‚
â”‚               ğŸŸ¡ å¾…å¼€å‘                         â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚              â”‚
    â”‚ è®¢å•åˆ—è¡¨æŸ¥è¯¢  â”‚ åˆ›å»ºé…é€å•
    â–¼              â–¼
OrderService   LeaderService
  (8065)         (8068)
 âœ…å·²å®ç°       âœ…å·²å®ç°
```

---

## âš ï¸ å¾…è¡¥å……çš„æ¥å£æ¸…å•

### OrderService éœ€è¦è¡¥å……ï¼ˆğŸ”´ é«˜ä¼˜å…ˆçº§ï¼‰

#### 1. æ›´æ–°è®¢å•æ”¯ä»˜çŠ¶æ€ï¼ˆFeignæ¥å£ï¼‰

```java
@PostMapping("/api/order/feign/updatePayStatus")
Result<Void> updatePayStatus(@RequestParam Long orderId, 
                             @RequestParam Integer payStatus);
```

**è°ƒç”¨æ–¹**: PaymentService  
**åŠŸèƒ½**: æ”¯ä»˜æˆåŠŸåæ›´æ–°è®¢å•çš„ `pay_status` å­—æ®µ  
**ä¼˜å…ˆçº§**: ğŸ”´ğŸ”´ğŸ”´ æœ€é«˜

---

#### 2. åˆ¤æ–­æ˜¯å¦æ‹¼å›¢è®¢å•ï¼ˆFeignæ¥å£ï¼‰

```java
@GetMapping("/api/order/feign/isGroupBuyOrder/{orderId}")
Result<Boolean> isGroupBuyOrder(@PathVariable Long orderId);
```

**è°ƒç”¨æ–¹**: PaymentService  
**åŠŸèƒ½**: åˆ¤æ–­è®¢å•æ˜¯å¦å…³è”æ‹¼å›¢æ´»åŠ¨ï¼ˆ`activity_id != null`ï¼‰  
**ä¼˜å…ˆçº§**: ğŸ”´ğŸ”´ é«˜

**å®ç°é€»è¾‘**:
```java
public Boolean isGroupBuyOrder(Long orderId) {
    OrderMain order = orderRepository.findById(orderId)
        .orElseThrow(() -> new BusinessException("è®¢å•ä¸å­˜åœ¨"));
    
    // æŸ¥è¯¢è®¢å•æ˜ç»†
    List<OrderItem> items = orderItemRepository.findByOrderId(orderId);
    
    // å¦‚æœä»»ä¸€å•†å“æœ‰activity_idï¼Œåˆ™ä¸ºæ‹¼å›¢è®¢å•
    return items.stream()
        .anyMatch(item -> item.getActivityId() != null);
}
```

---

#### 3. ç”Ÿæˆä½£é‡‘è®°å½•ï¼ˆFeignæ¥å£ï¼‰

```java
@PostMapping("/api/order/feign/completeAndCommission")
Result<Void> completeAndGenerateCommission(@RequestParam Long orderId);
```

**è°ƒç”¨æ–¹**: DeliveryService æˆ– æ‰‹åŠ¨è§¦å‘  
**åŠŸèƒ½**: è®¢å•é…é€å®Œæˆåï¼Œè°ƒç”¨ LeaderService ç”Ÿæˆä½£é‡‘è®°å½•  
**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­

---

### LeaderService éœ€è¦è¡¥å……ï¼ˆğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼‰

#### 1. ç”Ÿæˆä½£é‡‘è®°å½•ï¼ˆFeignæ¥å£ï¼‰

```java
@PostMapping("/api/commission/feign/create")
Result<Void> createCommissionRecord(@RequestBody CommissionRequest request);
```

**è°ƒç”¨æ–¹**: OrderService  
**åŠŸèƒ½**: è®¢å•å®Œæˆåç”Ÿæˆä½£é‡‘è®°å½•  
**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­

---

### DeliveryService éœ€è¦å¼€å‘ï¼ˆğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼‰

#### 1. åˆ›å»ºé…é€å•ï¼ˆFeignæ¥å£ï¼‰

```java
@PostMapping("/api/delivery/feign/create")
Result<Long> createDelivery(@RequestBody CreateDeliveryRequest request);
```

**è°ƒç”¨æ–¹**: OrderService  
**åŠŸèƒ½**: å›¢é•¿ç¡®è®¤å‘è´§ååˆ›å»ºé…é€å•  
**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­

---

## âœ… é—­ç¯å®Œæ•´æ€§éªŒè¯

### æ‹¼å›¢æ”¯ä»˜é—­ç¯éªŒè¯è¡¨

| æ­¥éª¤ | æœåŠ¡ | æ¥å£/æ–¹æ³• | çŠ¶æ€ | å¤‡æ³¨ |
|-----|------|----------|------|------|
| 1. ç”¨æˆ·å‚å›¢ | GroupBuyService | `POST /api/groupbuy/team/join` | âœ… å·²å®ç° | - |
| 2. åˆ›å»ºè®¢å• | OrderService | `POST /api/order/feign/create` | âœ… å·²å®ç° | - |
| 3. å‘èµ·æ”¯ä»˜ | PaymentService | `POST /api/payment/create` | ğŸ”´ å¾…å¼€å‘ | **å…³é”®** |
| 4. ä½™é¢æ‰£æ¬¾ | UserService | `POST /feign/account/deduct` | âœ… å·²å®ç° | - |
| 5. æ›´æ–°è®¢å•æ”¯ä»˜çŠ¶æ€ | OrderService | `POST /api/order/feign/updatePayStatus` | â“ å¾…éªŒè¯ | **éœ€è¡¥å……** |
| 6. æ”¯ä»˜å›è°ƒ | GroupBuyService | `POST /api/groupbuy/payment/callback` | âœ… å·²å®ç° | - |
| 7. æ›´æ–°å‚å›¢çŠ¶æ€ | GroupBuyService | `TeamService.paymentCallback()` | âœ… å·²å®ç° | - |
| 8. æˆå›¢æ£€æŸ¥ | GroupBuyService | `TeamService.teamSuccess()` | âœ… å·²å®ç° | - |
| 9. æ‰¹é‡æ›´æ–°è®¢å• | OrderService | `POST /api/order/feign/batchUpdateStatus` | âœ… å·²å®ç° | - |

**é—­ç¯å®Œæ•´æ€§**: ğŸŸ¡ **80%**ï¼ˆç¼ºå°‘ PaymentService + OrderService è¡¥å……æ¥å£ï¼‰

---

### é€€æ¬¾æµç¨‹é—­ç¯éªŒè¯è¡¨

| æ­¥éª¤ | æœåŠ¡ | æ¥å£/æ–¹æ³• | çŠ¶æ€ | å¤‡æ³¨ |
|-----|------|----------|------|------|
| 1. å®šæ—¶ä»»åŠ¡æ£€æµ‹ | GroupBuyService | `TeamExpireTask.checkExpiredTeams()` | âœ… å·²å®ç° | - |
| 2. ç”³è¯·é€€æ¬¾ | PaymentService | `POST /api/payment/feign/refund` | ğŸ”´ å¾…å¼€å‘ | **å…³é”®** |
| 3. ä½™é¢é€€æ¬¾ | UserService | `POST /feign/account/recharge` | âœ… å·²å®ç° | - |
| 4. å¾®ä¿¡é€€æ¬¾ | PaymentService | `WechatPayUtil.refund()` | ğŸ”´ å¾…å¼€å‘ | - |
| 5. æ›´æ–°è®¢å•çŠ¶æ€ | OrderService | `POST /api/order/feign/updateStatus` | âœ… å·²å®ç° | - |
| 6. æ›´æ–°æˆå‘˜çŠ¶æ€ | GroupBuyService | `MemberRepository.save()` | âœ… å·²å®ç° | - |

**é—­ç¯å®Œæ•´æ€§**: ğŸŸ¡ **70%**ï¼ˆç¼ºå°‘ PaymentServiceï¼‰

---

### ä½£é‡‘ç»“ç®—é—­ç¯éªŒè¯è¡¨

| æ­¥éª¤ | æœåŠ¡ | æ¥å£/æ–¹æ³• | çŠ¶æ€ | å¤‡æ³¨ |
|-----|------|----------|------|------|
| 1. è®¢å•å®Œæˆ | OrderService | `order_status=3` | âœ… å·²å®ç° | - |
| 2. ç”Ÿæˆä½£é‡‘è®°å½• | LeaderService | `POST /api/commission/feign/create` | â“ å¾…éªŒè¯ | **éœ€è¡¥å……** |
| 3. å®šæ—¶ä»»åŠ¡ç»“ç®— | LeaderService | `CommissionSettlementTask` | âœ… å·²å®ç° | - |
| 4. å¢åŠ å›¢é•¿ä½™é¢ | UserService | `POST /feign/account/recharge` | âœ… å·²å®ç° | - |
| 5. æ›´æ–°ä½£é‡‘çŠ¶æ€ | LeaderService | `CommissionService.settle()` | âœ… å·²å®ç° | - |

**é—­ç¯å®Œæ•´æ€§**: ğŸŸ¢ **90%**ï¼ˆä»…éœ€è¡¥å……æ¥å£è§¦å‘ï¼‰

---

## ğŸ“‹ å¼€å‘ä¼˜å…ˆçº§æ¸…å•

### ç¬¬ä¸€ä¼˜å…ˆçº§ï¼ˆå…³é”®è·¯å¾„ï¼‰ğŸ”´ğŸ”´ğŸ”´

1. **PaymentService å¼€å‘** - é¢„è®¡3-4å¤©
   - [x] åˆ›å»ºé¡¹ç›®éª¨æ¶
   - [ ] ä½™é¢æ”¯ä»˜å®Œæ•´æµç¨‹
   - [ ] æ”¯ä»˜å›è°ƒå¤„ç†
   - [ ] é€€æ¬¾åŠŸèƒ½
   - [ ] å¾®ä¿¡æ”¯ä»˜é›†æˆï¼ˆå¯åç½®ï¼‰

2. **OrderService è¡¥å……æ¥å£** - é¢„è®¡0.5å¤©
   - [ ] `POST /api/order/feign/updatePayStatus`
   - [ ] `GET /api/order/feign/isGroupBuyOrder/{orderId}`

---

### ç¬¬äºŒä¼˜å…ˆçº§ï¼ˆå®Œå–„åŠŸèƒ½ï¼‰ğŸŸ¡ğŸŸ¡

3. **DeliveryService å¼€å‘** - é¢„è®¡2-3å¤©
   - [ ] Dijkstraç®—æ³•å®ç°
   - [ ] é…é€å•ç®¡ç†
   - [ ] ä¸ OrderService å¯¹æ¥

4. **LeaderService è¡¥å……æ¥å£** - é¢„è®¡0.5å¤©
   - [ ] `POST /api/commission/feign/create`

---

### ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼ˆä¼˜åŒ–å¢å¼ºï¼‰ğŸŸ¢

5. **PaymentService å®Œå–„** - é¢„è®¡1-2å¤©
   - [ ] æ”¯ä»˜å®æ”¯ä»˜é›†æˆ
   - [ ] å……å€¼åŠŸèƒ½
   - [ ] å®šæ—¶ä»»åŠ¡è¡¥å¿æœºåˆ¶

6. **ç³»ç»Ÿé›†æˆæµ‹è¯•** - é¢„è®¡2-3å¤©
   - [ ] å®Œæ•´æµç¨‹æµ‹è¯•
   - [ ] å¼‚å¸¸åœºæ™¯æµ‹è¯•
   - [ ] æ€§èƒ½å‹åŠ›æµ‹è¯•

---

## ğŸ“Š æœåŠ¡å®Œæˆåº¦ç»Ÿè®¡

| æœåŠ¡å | çŠ¶æ€ | å®Œæˆåº¦ | æ¥å£æ•° | å…³é”®åŠŸèƒ½ |
|--------|------|--------|--------|---------|
| **Common** | âœ… å®Œæˆ | 100% | - | å…¬å…±ç»„ä»¶ã€æ—¥å¿—ã€å¼‚å¸¸ |
| **Gateway** | âœ… å®Œæˆ | 100% | - | JWTé‰´æƒã€è·¯ç”± |
| **UserService** | âœ… å®Œæˆ | 100% | 45ä¸ª | ç”¨æˆ·ã€è´¦æˆ·ã€åœ°å€ã€åé¦ˆ |
| **ProductService** | âœ… å®Œæˆ | 100% | 29ä¸ª | å•†å“ã€åˆ†ç±»ã€åº“å­˜ |
| **LeaderService** | âœ… å®Œæˆ | 95% | 37ä¸ª | ç¤¾åŒºã€å›¢é•¿ã€ä½£é‡‘ |
| **GroupBuyService** | âœ… å®Œæˆ | 100% | 13ä¸ª | æ‹¼å›¢ã€æˆå›¢ã€é€€æ¬¾ |
| **OrderService** | âœ… å®Œæˆ | 95% | 20ä¸ª | è®¢å•ã€è´­ç‰©è½¦ |
| **PaymentService** | ğŸ”´ å¾…å¼€å‘ | 0% | 14ä¸ª | æ”¯ä»˜ã€å……å€¼ã€é€€æ¬¾ |
| **DeliveryService** | ğŸŸ¡ å¾…å¼€å‘ | 0% | 8ä¸ª | é…é€ã€è·¯å¾„è§„åˆ’ |
| **æ€»è®¡** | - | **82%** | **165ä¸ª** | - |

**è¯´æ˜**:
- âœ… å®Œæˆï¼šä»£ç å·²å¼€å‘å¹¶æµ‹è¯•é€šè¿‡
- ğŸ”´ å¾…å¼€å‘ï¼šæœªå¼€å§‹å¼€å‘
- ğŸŸ¡ å¾…å¼€å‘ï¼šå¯é€‰åŠŸèƒ½ï¼Œä¼˜å…ˆçº§è¾ƒä½
- **æ¥å£æ•°**: åŒ…å«ç”¨æˆ·ç«¯æ¥å£ + Feignå†…éƒ¨æ¥å£

---

## ğŸ¯ æ€»ç»“ä¸å»ºè®®

### âœ… å·²å®ç°çš„å…³é”®èƒ½åŠ›

1. **ç”¨æˆ·ä½“ç³»** âœ…
   - ç”¨æˆ·æ³¨å†Œç™»å½•
   - è´¦æˆ·ä½™é¢ç®¡ç†ï¼ˆæ‰£æ¬¾ã€å……å€¼ï¼‰
   - åœ°å€ç®¡ç†

2. **å•†å“ä½“ç³»** âœ…
   - å•†å“ç®¡ç†
   - åˆ†ç±»ç®¡ç†
   - åº“å­˜ç®¡ç†

3. **æ‹¼å›¢ä½“ç³»** âœ…
   - å›¢é•¿å‘èµ·æ‹¼å›¢ï¼ˆv3.0ç¤¾åŒºæœºåˆ¶ï¼‰
   - ç”¨æˆ·å‚ä¸æ‹¼å›¢ï¼ˆè¡Œé”é˜²å¹¶å‘ï¼‰
   - æˆå›¢é€»è¾‘ï¼ˆå¹‚ç­‰æ€§ä¿è¯ï¼‰
   - å®šæ—¶ä»»åŠ¡é€€æ¬¾

4. **è®¢å•ä½“ç³»** âœ…
   - è®¢å•åˆ›å»º
   - è®¢å•çŠ¶æ€æµè½¬
   - è®¢å•æŸ¥è¯¢

5. **ç¤¾åŒºå›¢é•¿ä½“ç³»** âœ…
   - ç¤¾åŒºç®¡ç†
   - å›¢é•¿å®¡æ ¸
   - ä½£é‡‘ç»“ç®—

---

### ğŸ”´ å…³é”®ç¼ºå¤±ç¯èŠ‚

1. **PaymentService** ğŸ”´ğŸ”´ğŸ”´
   - æ”¯ä»˜æµç¨‹çš„ä¸­æ¢æœåŠ¡
   - è¿æ¥æ”¯ä»˜æ¸ é“å’Œä¸šåŠ¡æœåŠ¡
   - **å¿…é¡»ä¼˜å…ˆå¼€å‘**

2. **OrderService è¡¥å……æ¥å£** ğŸ”´ğŸ”´
   - `updatePayStatus()` - æ›´æ–°æ”¯ä»˜çŠ¶æ€
   - `isGroupBuyOrder()` - åˆ¤æ–­æ‹¼å›¢è®¢å•
   - **é…åˆ PaymentService å¼€å‘**

---

### ğŸ’¡ å¼€å‘å»ºè®®

#### å»ºè®®1: å…ˆå®Œæˆ PaymentService ä½™é¢æ”¯ä»˜

**ç†ç”±**:
- ä½™é¢æ”¯ä»˜é€»è¾‘ç®€å•ï¼ˆæ— éœ€å¯¹æ¥ç¬¬ä¸‰æ–¹ï¼‰
- å¯ä»¥å¿«é€Ÿæ‰“é€šæ•´ä¸ªæ”¯ä»˜é—­ç¯
- UserService æ‰£æ¬¾/å……å€¼æ¥å£å·²å®Œå–„

**æ­¥éª¤**:
1. Day 1: åˆ›å»º PaymentService åŸºç¡€æ¶æ„
2. Day 2: å®ç°ä½™é¢æ”¯ä»˜ + æ”¯ä»˜æˆåŠŸå¤„ç†
3. Day 2: è¡¥å…… OrderService çš„2ä¸ªæ¥å£
4. Day 3: å®Œæ•´æµç¨‹æµ‹è¯•

---

#### å»ºè®®2: æš‚ç¼“ DeliveryService å¼€å‘

**ç†ç”±**:
- DeliveryService ä¸å½±å“æ”¯ä»˜é—­ç¯
- Dijkstraç®—æ³•å®ç°å¤æ‚åº¦è¾ƒé«˜
- å¯ä»¥å…ˆç”¨ç®€å•çš„é…é€é€»è¾‘æ›¿ä»£

**å»ºè®®**: å…ˆå®Œæˆ PaymentServiceï¼Œå†è€ƒè™‘ DeliveryService

---

#### å»ºè®®3: å¾®ä¿¡æ”¯ä»˜åç½®å¼€å‘

**ç†ç”±**:
- å¾®ä¿¡æ”¯ä»˜éœ€è¦ä¼ä¸šèµ„è´¨
- æ²™ç®±ç¯å¢ƒæµ‹è¯•å¤æ‚
- ä½™é¢æ”¯ä»˜å·²è¶³å¤Ÿæ¼”ç¤ºç³»ç»Ÿå®Œæ•´æ€§

**å»ºè®®**: å…ˆå®Œæˆä½™é¢æ”¯ä»˜é—­ç¯ï¼Œå†ä¼˜åŒ–ç¬¬ä¸‰æ–¹æ”¯ä»˜

---

### ğŸ“ˆ é¡¹ç›®å®Œæˆåº¦è·¯å¾„

```
å½“å‰çŠ¶æ€: 82% âœ…
    â†“
è¡¥å…… OrderService æ¥å£ (0.5å¤©) â†’ 85%
    â†“
å¼€å‘ PaymentService ä½™é¢æ”¯ä»˜ (2å¤©) â†’ 90%
    â†“
é›†æˆæµ‹è¯• (1å¤©) â†’ 92%
    â†“
å¾®ä¿¡æ”¯ä»˜é›†æˆ (2å¤©ï¼Œå¯é€‰) â†’ 95%
    â†“
DeliveryService å¼€å‘ (3å¤©ï¼Œå¯é€‰) â†’ 98%
    â†“
å®Œå–„ä¼˜åŒ– (1-2å¤©) â†’ 100% âœ…
```

**ä¿å®ˆä¼°è®¡**: å®Œæˆ PaymentService åï¼Œé¡¹ç›®å¯è¾¾ **90%**ï¼Œå…·å¤‡å®Œæ•´æ¼”ç¤ºèƒ½åŠ›ï¼

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ†ææ—¥æœŸ**: 2025-11-01  
**åˆ†æäºº**: AIåŠ©æ‰‹  
**å®¡æ ¸**: å¾…å®¡æ ¸  
**çŠ¶æ€**: âœ… åˆ†æå®Œæˆï¼Œå¾…æ‰§è¡Œ

