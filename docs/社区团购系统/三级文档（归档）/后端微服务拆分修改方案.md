# ç¤¾åŒºå›¢è´­ç³»ç»Ÿ - åç«¯å¾®æœåŠ¡æ‹†åˆ†ä¿®æ”¹æ–¹æ¡ˆ

**é¡¹ç›®åç§°**: åŸºäºSpring Bootçš„ç¤¾åŒºå›¢è´­ç³»ç»Ÿ  
**å½“å‰ç‰ˆæœ¬**: v3.0ï¼ˆå•ä½“æ•°æ®åº“ï¼‰  
**ç›®æ ‡ç‰ˆæœ¬**: v4.0ï¼ˆå¾®æœåŠ¡æ•°æ®åº“ï¼‰  
**ä¿®æ”¹æ—¶é—´**: 2025-10-29  
**æ‰§è¡Œä¼˜å…ˆçº§**: ğŸ”´ é«˜ â†’ ğŸŸ  ä¸­ â†’ ğŸŸ¡ ä½

---

## ğŸ“Š å½“å‰åç«¯çŠ¶æ€åˆ†æ

### å·²å®Œæˆç»„ä»¶ âœ…
```
community-group-buy-backend/
â”œâ”€â”€ common/                    # å…¬å…±æ¨¡å—ï¼ˆå®Œæˆï¼‰
â”‚   â”œâ”€â”€ JWTå·¥å…·ç±»
â”‚   â”œâ”€â”€ å…¨å±€å¼‚å¸¸å¤„ç†
â”‚   â”œâ”€â”€ æ“ä½œæ—¥å¿—AOP
â”‚   â””â”€â”€ ç»Ÿä¸€å“åº”Result
â”œâ”€â”€ UserService/               # ç”¨æˆ·æœåŠ¡ï¼ˆå·²å®Œæˆï¼Œéœ€ä¿®æ”¹ï¼‰
â”‚   â”œâ”€â”€ 4ä¸ªControllerï¼ˆç”¨æˆ·ã€åœ°å€ã€è´¦æˆ·ã€åé¦ˆï¼‰
â”‚   â”œâ”€â”€ 4ä¸ªEntityï¼ˆSysUserã€UserAddressã€UserAccountã€UserFeedbackï¼‰
â”‚   â”œâ”€â”€ 4ä¸ªRepository
â”‚   â”œâ”€â”€ 4ä¸ªService
â”‚   â””â”€â”€ application.ymlï¼ˆéœ€ä¿®æ”¹æ•°æ®åº“è¿æ¥ï¼‰
â””â”€â”€ sql/                       # å¾®æœåŠ¡SQLè„šæœ¬ï¼ˆå·²ç”Ÿæˆï¼‰
    â”œâ”€â”€ 01_user_service_db.sql
    â”œâ”€â”€ 02_product_service_db.sql
    â”œâ”€â”€ ...
    â””â”€â”€ 07_leader_service_db.sql
```

### éœ€è¦ä¿®æ”¹/æ–°å¢çš„å†…å®¹ âš ï¸
```
éœ€ä¿®æ”¹ï¼š
  âŒ UserService/application.ymlï¼ˆæ•°æ®åº“è¿æ¥æŒ‡å‘å•ä½“åº“ï¼‰
  âŒ SysUserå®ä½“ï¼ˆç¼ºå°‘community_idå­—æ®µï¼‰
  âŒ pom.xmlï¼ˆéœ€æ·»åŠ OpenFeignä¾èµ–ï¼‰

éœ€æ–°å¢ï¼š
  âŒ ProductServiceï¼ˆå•†å“æœåŠ¡ï¼‰
  âŒ GroupBuyServiceï¼ˆæ‹¼å›¢æœåŠ¡ï¼‰
  âŒ OrderServiceï¼ˆè®¢å•æœåŠ¡ï¼‰
  âŒ PaymentServiceï¼ˆæ”¯ä»˜æœåŠ¡ï¼‰
  âŒ DeliveryServiceï¼ˆé…é€æœåŠ¡ï¼‰
  âŒ LeaderServiceï¼ˆå›¢é•¿æœåŠ¡ï¼‰
  âŒ Feignå®¢æˆ·ç«¯ï¼ˆè·¨æœåŠ¡è°ƒç”¨ï¼‰
  âŒ åˆ†å¸ƒå¼äº‹åŠ¡åè°ƒå™¨
```

---

## ğŸš€ ä¿®æ”¹æ–¹æ¡ˆï¼ˆåˆ†é˜¶æ®µæ‰§è¡Œï¼‰

---

## é˜¶æ®µ1ï¼šç´§æ€¥ä¿®å¤ï¼ˆç«‹å³æ‰§è¡Œï¼Œ30åˆ†é’Ÿï¼‰

### 1.1 ä¿®æ”¹UserServiceæ•°æ®åº“è¿æ¥ ğŸ”´

**é—®é¢˜**ï¼šå½“å‰è¿æ¥å•ä½“æ•°æ®åº“ `community_group_buy`  
**ç›®æ ‡**ï¼šæ”¹ä¸ºå¾®æœåŠ¡æ•°æ®åº“ `user_service_db`

**ä¿®æ”¹æ–‡ä»¶**ï¼š`UserService/src/main/resources/application.yml`

**ä¿®æ”¹å‰**ï¼ˆç¬¬18è¡Œï¼‰ï¼š
```yaml
datasource:
  url: jdbc:mysql://localhost:3306/community_group_buy?useUnicode=true&characterEncoding=utf-8&allowMultiQueries=true&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
```

**ä¿®æ”¹å**ï¼š
```yaml
datasource:
  url: jdbc:mysql://localhost:3306/user_service_db?useUnicode=true&characterEncoding=utf-8&allowMultiQueries=true&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
```

**éªŒè¯æ­¥éª¤**ï¼š
```bash
# 1. å…ˆæ‰§è¡Œç”¨æˆ·æœåŠ¡æ•°æ®åº“åˆ›å»ºè„šæœ¬
mysql -u root -p < sql/01_user_service_db.sql

# 2. é‡å¯UserService
mvn clean package -pl UserService
java -jar UserService/target/UserService.jar

# 3. æµ‹è¯•æ¥å£
curl http://localhost:8061/api/user/1
```

---

### 1.2 ä¿®æ”¹SysUserå®ä½“æ·»åŠ community_idå­—æ®µ ğŸ”´

**é—®é¢˜**ï¼šv3.0æ–°å¢ç¤¾åŒºæœºåˆ¶ï¼Œä½†å®ä½“ç±»ç¼ºå°‘`community_id`å­—æ®µ  
**å½±å“**ï¼šæ— æ³•å…³è”ç¤¾åŒºï¼Œå½±å“ç¤¾åŒºä¼˜å…ˆæ¨èåŠŸèƒ½

**ä¿®æ”¹æ–‡ä»¶**ï¼š`UserService/src/main/java/com/bcu/edu/entity/SysUser.java`

**åœ¨ç¬¬60è¡Œåæ·»åŠ **ï¼š
```java
@Column(name = "community_id")
@Comment("å½’å±ç¤¾åŒºIDï¼ˆv3.0æ–°å¢ï¼Œè·¨åº“å…³è”ï¼‰")
private Long communityId;
```

**ä¿®æ”¹åçš„å®Œæ•´å®ä½“ç±»**ï¼ˆå…³é”®éƒ¨åˆ†ï¼‰ï¼š
```java
@Data
@Entity
@Table(name = "sys_user", indexes = {
        @Index(name = "uk_username", columnList = "username", unique = true),
        @Index(name = "uk_phone", columnList = "phone", unique = true),
        @Index(name = "uk_wx_openid", columnList = "wx_openid", unique = true),
        @Index(name = "idx_community_id", columnList = "community_id") // æ–°å¢ç´¢å¼•
})
public class SysUser {
    
    // ... åŸæœ‰å­—æ®µ ...
    
    @Column(name = "avatar", length = 255)
    @Comment("å¤´åƒURL")
    private String avatar;
    
    @Column(name = "community_id")
    @Comment("å½’å±ç¤¾åŒºIDï¼ˆv3.0æ–°å¢ï¼Œè·¨åº“å…³è”ï¼‰")
    private Long communityId;  // â­ æ–°å¢å­—æ®µ
    
    @Column(name = "status", nullable = false)
    @Comment("çŠ¶æ€ï¼ˆ0-ç¦ç”¨ï¼›1-æ­£å¸¸ï¼‰")
    private Integer status = 1;
    
    // ... å…¶ä½™ä»£ç ä¸å˜ ...
}
```

**æ³¨æ„**ï¼š
- `community_id`ä¸ºLongç±»å‹ï¼Œå¯ä¸ºç©ºï¼ˆç”¨æˆ·åˆæ¬¡æ³¨å†Œæ—¶æœªå…³è”ç¤¾åŒºï¼‰
- ä¸è®¾ç½®å¤–é”®çº¦æŸï¼ˆè·¨åº“å…³è”é€šè¿‡åº”ç”¨å±‚éªŒè¯ï¼‰
- æ·»åŠ ç´¢å¼•ä»¥æ”¯æŒ"æŸ¥è¯¢ç¤¾åŒºå†…çš„ç”¨æˆ·"åŠŸèƒ½

---

### 1.3 ä¿®æ”¹UserServiceçš„JPAé…ç½® ğŸ”´

**é—®é¢˜**ï¼šJPAçš„`ddl-auto: update`å¯èƒ½ä¸ä¼šæ­£ç¡®æ·»åŠ æ–°å­—æ®µ  
**å»ºè®®**ï¼šä¸´æ—¶æ”¹ä¸º`validate`ï¼Œæ‰‹åŠ¨æ‰§è¡ŒSQLæ·»åŠ å­—æ®µ

**ä¿®æ”¹æ–‡ä»¶**ï¼š`UserService/src/main/resources/application.yml`

**ä¿®æ”¹å‰**ï¼ˆç¬¬49è¡Œï¼‰ï¼š
```yaml
jpa:
  hibernate:
    ddl-auto: update
```

**ä¿®æ”¹å**ï¼š
```yaml
jpa:
  hibernate:
    ddl-auto: none  # æ”¹ä¸ºnoneï¼Œæ‰‹åŠ¨ç®¡ç†è¡¨ç»“æ„
```

**æ‰‹åŠ¨æ·»åŠ å­—æ®µSQL**ï¼ˆå¦‚æœæ•°æ®åº“å·²å­˜åœ¨è¡¨ï¼‰ï¼š
```sql
USE user_service_db;

-- æ·»åŠ community_idå­—æ®µ
ALTER TABLE sys_user 
ADD COLUMN community_id BIGINT NULL COMMENT 'å½’å±ç¤¾åŒºIDï¼ˆv3.0æ–°å¢ï¼Œè·¨åº“å…³è”ï¼‰';

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_community_id ON sys_user(community_id);
```

---

## é˜¶æ®µ2ï¼šåˆ›å»ºå…¶ä»–6ä¸ªå¾®æœåŠ¡ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼Œ2-3å¤©ï¼‰

### 2.1 ProductServiceï¼ˆå•†å“æœåŠ¡ï¼‰ğŸŸ 

**ç›®æ ‡**ï¼šç®¡ç†å•†å“åˆ†ç±»å’Œå•†å“ä¿¡æ¯

**åˆ›å»ºæ­¥éª¤**ï¼š

#### Step 1: åˆ›å»ºæ¨¡å—ç›®å½•ç»“æ„
```bash
mkdir -p ProductService/src/main/java/com/bcu/edu/{config,controller,entity,repository,service}
mkdir -p ProductService/src/main/resources
```

#### Step 2: åˆ›å»ºpom.xml
**æ–‡ä»¶è·¯å¾„**ï¼š`ProductService/pom.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.3</version>
        <relativePath/>
    </parent>

    <groupId>com.bcu.edu</groupId>
    <artifactId>ProductService</artifactId>

    <properties>
        <java.version>17</java.version>
        <spring-cloud.version>2023.0.0</spring-cloud.version>
    </properties>

    <dependencies>
        <!-- Common Module -->
        <dependency>
            <groupId>com.bcu.edu</groupId>
            <artifactId>common</artifactId>
            <version>0.0.1-SNAPSHOT</version>
        </dependency>

        <!-- Spring Boot -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>

        <!-- Spring Cloud -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-consul-discovery</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>

        <!-- Database -->
        <dependency>
            <groupId>com.mysql</groupId>
            <artifactId>mysql-connector-j</artifactId>
            <scope>runtime</scope>
        </dependency>

        <!-- Lombok -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
    </dependencies>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
```

#### Step 3: åˆ›å»ºapplication.yml
**æ–‡ä»¶è·¯å¾„**ï¼š`ProductService/src/main/resources/application.yml`

```yaml
server:
  port: 8062

spring:
  application:
    name: ProductService
  datasource:
    url: jdbc:mysql://localhost:3306/product_service_db?useUnicode=true&characterEncoding=utf-8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: 123456
    driver-class-name: com.mysql.cj.jdbc.Driver
  jpa:
    database-platform: org.hibernate.dialect.MySQL8Dialect
    show-sql: true
    hibernate:
      ddl-auto: none  # ä½¿ç”¨SQLè„šæœ¬ç®¡ç†è¡¨ç»“æ„
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        service-name: ${spring.application.name}
        instance-id: ${spring.application.name}-${server.port}
        prefer-ip-address: true
        health-check-path: /actuator/health
        health-check-interval: 15s

management:
  endpoints:
    web:
      exposure:
        include: "*"
```

#### Step 4: åˆ›å»ºå¯åŠ¨ç±»
**æ–‡ä»¶è·¯å¾„**ï¼š`ProductService/src/main/java/com/bcu/edu/ProductServiceApplication.java`

```java
package com.bcu.edu;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.openfeign.EnableFeignClients;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;

@SpringBootApplication
@EnableDiscoveryClient
@EnableFeignClients
@EnableJpaRepositories(basePackages = "com.bcu.edu.repository")
public class ProductServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(ProductServiceApplication.class, args);
    }
}
```

#### Step 5: åˆ›å»ºå®ä½“ç±»

**ProductCategory.java**ï¼ˆå•†å“åˆ†ç±»ï¼‰ï¼š
```java
package com.bcu.edu.entity;

import jakarta.persistence.*;
import lombok.Data;
import org.hibernate.annotations.Comment;

@Data
@Entity
@Table(name = "product_category", indexes = {
    @Index(name = "idx_parent_id", columnList = "parent_id"),
    @Index(name = "idx_status", columnList = "status")
})
@Comment("å•†å“åˆ†ç±»è¡¨")
public class ProductCategory {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "category_id")
    private Long categoryId;
    
    @Column(name = "parent_id", nullable = false)
    private Long parentId = 0L;
    
    @Column(name = "category_name", nullable = false, length = 50)
    private String categoryName;
    
    @Column(name = "sort", nullable = false)
    private Integer sort = 0;
    
    @Column(name = "status", nullable = false)
    private Integer status = 1;
}
```

**Product.java**ï¼ˆå•†å“ï¼‰ï¼š
```java
package com.bcu.edu.entity;

import jakarta.persistence.*;
import lombok.Data;
import org.hibernate.annotations.Comment;
import java.math.BigDecimal;
import java.time.LocalDateTime;

@Data
@Entity
@Table(name = "product", indexes = {
    @Index(name = "idx_category_id", columnList = "category_id"),
    @Index(name = "idx_status", columnList = "status")
})
@Comment("å•†å“ä¿¡æ¯è¡¨")
public class Product {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "product_id")
    private Long productId;
    
    @Column(name = "category_id")
    private Long categoryId;  // è·¨åº“å…³è”ï¼Œä»…åº”ç”¨å±‚æ ¡éªŒ
    
    @Column(name = "product_name", nullable = false, length = 100)
    private String productName;
    
    @Column(name = "cover_img", nullable = false)
    private String coverImg;
    
    @Column(name = "detail", columnDefinition = "TEXT")
    private String detail;
    
    @Column(name = "price", nullable = false, precision = 10, scale = 2)
    private BigDecimal price;
    
    @Column(name = "group_price", precision = 10, scale = 2)
    private BigDecimal groupPrice;
    
    @Column(name = "stock", nullable = false)
    private Integer stock = 0;
    
    @Column(name = "status", nullable = false)
    private Integer status = 1;
    
    @Column(name = "create_time", nullable = false)
    private LocalDateTime createTime;
    
    @Column(name = "update_time")
    private LocalDateTime updateTime;
    
    @PrePersist
    protected void onCreate() {
        createTime = LocalDateTime.now();
    }
    
    @PreUpdate
    protected void onUpdate() {
        updateTime = LocalDateTime.now();
    }
}
```

#### Step 6: æ›´æ–°çˆ¶pom.xml
åœ¨`community-group-buy-backend/pom.xml`çš„`<modules>`èŠ‚ç‚¹æ·»åŠ ï¼š
```xml
<modules>
    <module>UserService</module>
    <module>common</module>
    <module>ProductService</module>  <!-- æ–°å¢ -->
</modules>
```

---

### 2.2 å…¶ä»–5ä¸ªå¾®æœåŠ¡åˆ›å»ºæ¨¡æ¿

ç”±äºç¯‡å¹…é™åˆ¶ï¼Œå…¶ä»–5ä¸ªå¾®æœåŠ¡ï¼ˆGroupBuyServiceã€OrderServiceã€PaymentServiceã€DeliveryServiceã€LeaderServiceï¼‰**æŒ‰ç…§ç›¸åŒæ¨¡å¼åˆ›å»º**ï¼š

**ç»Ÿä¸€æ¨¡æ¿**ï¼š
```
ServiceName/
â”œâ”€â”€ pom.xmlï¼ˆå‚è€ƒProductServiceï¼‰
â”œâ”€â”€ src/main/java/com/bcu/edu/
â”‚   â”œâ”€â”€ ServiceNameApplication.javaï¼ˆå¯åŠ¨ç±»ï¼‰
â”‚   â”œâ”€â”€ entity/ï¼ˆå®ä½“ç±»ï¼Œå‚è€ƒSQLè„šæœ¬ï¼‰
â”‚   â”œâ”€â”€ repository/ï¼ˆJPA Repositoryï¼‰
â”‚   â”œâ”€â”€ service/ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â””â”€â”€ controller/ï¼ˆREST APIï¼‰
â””â”€â”€ src/main/resources/
    â””â”€â”€ application.ymlï¼ˆä¿®æ”¹ç«¯å£å’Œæ•°æ®åº“åï¼‰
```

**ç«¯å£åˆ†é…**ï¼š
- GroupBuyService: 8063 â†’ groupbuy_service_db
- OrderService: 8065 â†’ order_service_db
- PaymentService: 8066 â†’ payment_service_db
- DeliveryService: 8067 â†’ delivery_service_db
- LeaderService: 8068 â†’ leader_service_db

---

## é˜¶æ®µ3ï¼šå®ç°æœåŠ¡é—´è°ƒç”¨ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼Œ1-2å¤©ï¼‰

### 3.1 æ·»åŠ OpenFeignä¾èµ– ğŸŸ 

**ä¿®æ”¹æ–‡ä»¶**ï¼š`common/pom.xml`

åœ¨`<dependencies>`èŠ‚ç‚¹æ·»åŠ ï¼š
```xml
<!-- OpenFeignï¼ˆæœåŠ¡é—´è°ƒç”¨ï¼‰ -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

---

### 3.2 åˆ›å»ºFeignå®¢æˆ·ç«¯æ¥å£

åœ¨`common`æ¨¡å—åˆ›å»º`client`åŒ…ï¼Œç”¨äºè·¨æœåŠ¡è°ƒç”¨ã€‚

#### UserServiceClientï¼ˆç”¨æˆ·æœåŠ¡å®¢æˆ·ç«¯ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`common/src/main/java/com/bcu/edu/common/client/UserServiceClient.java`

```java
package com.bcu.edu.common.client;

import com.bcu.edu.common.result.Result;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;

import java.math.BigDecimal;

/**
 * ç”¨æˆ·æœåŠ¡Feignå®¢æˆ·ç«¯
 * ç”¨äºå…¶ä»–æœåŠ¡è°ƒç”¨ç”¨æˆ·æœåŠ¡çš„æ¥å£
 */
@FeignClient(name = "UserService", path = "/api")
public interface UserServiceClient {
    
    /**
     * éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨
     * @param userId ç”¨æˆ·ID
     * @return ç”¨æˆ·ä¿¡æ¯DTO
     */
    @GetMapping("/user/{userId}")
    Result<UserDTO> getUserById(@PathVariable("userId") Long userId);
    
    /**
     * éªŒè¯ç”¨æˆ·åœ°å€æ˜¯å¦å­˜åœ¨
     * @param addressId åœ°å€ID
     * @return åœ°å€ä¿¡æ¯DTO
     */
    @GetMapping("/address/{addressId}")
    Result<AddressDTO> getAddressById(@PathVariable("addressId") Long addressId);
    
    /**
     * æ‰£å‡ç”¨æˆ·ä½™é¢ï¼ˆæ”¯ä»˜æ—¶è°ƒç”¨ï¼‰
     * @param userId ç”¨æˆ·ID
     * @param amount æ‰£å‡é‡‘é¢
     * @param sagaId Sagaäº‹åŠ¡ID
     * @return æ˜¯å¦æˆåŠŸ
     */
    @PostMapping("/account/deduct")
    Result<Void> deductBalance(@RequestParam("userId") Long userId, 
                               @RequestParam("amount") BigDecimal amount,
                               @RequestParam("sagaId") String sagaId);
    
    /**
     * è¿”è¿˜ç”¨æˆ·ä½™é¢ï¼ˆé€€æ¬¾æ—¶è°ƒç”¨ï¼‰
     * @param userId ç”¨æˆ·ID
     * @param amount è¿”è¿˜é‡‘é¢
     * @param sagaId Sagaäº‹åŠ¡ID
     * @return æ˜¯å¦æˆåŠŸ
     */
    @PostMapping("/account/refund")
    Result<Void> refundBalance(@RequestParam("userId") Long userId, 
                               @RequestParam("amount") BigDecimal amount,
                               @RequestParam("sagaId") String sagaId);
}

/**
 * ç”¨æˆ·DTOï¼ˆç®€åŒ–ç‰ˆï¼Œä»…åŒ…å«å¿…è¦å­—æ®µï¼‰
 */
@Data
class UserDTO {
    private Long userId;
    private String username;
    private String realName;
    private String phone;
    private Integer role;
    private Integer status;
    private Long communityId;
}

/**
 * åœ°å€DTO
 */
@Data
class AddressDTO {
    private Long addressId;
    private Long userId;
    private String receiver;
    private String phone;
    private String province;
    private String city;
    private String district;
    private String detail;
    private BigDecimal longitude;
    private BigDecimal latitude;
}
```

#### ProductServiceClientï¼ˆå•†å“æœåŠ¡å®¢æˆ·ç«¯ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`common/src/main/java/com/bcu/edu/common/client/ProductServiceClient.java`

```java
package com.bcu.edu.common.client;

import com.bcu.edu.common.result.Result;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.*;

import java.math.BigDecimal;

@FeignClient(name = "ProductService", path = "/api")
public interface ProductServiceClient {
    
    /**
     * è·å–å•†å“ä¿¡æ¯ï¼ˆä¸‹å•æ—¶éªŒè¯å•†å“å­˜åœ¨ï¼‰
     * @param productId å•†å“ID
     * @return å•†å“DTO
     */
    @GetMapping("/product/{productId}")
    Result<ProductDTO> getProduct(@PathVariable("productId") Long productId);
    
    /**
     * æ‰£å‡åº“å­˜
     * @param productId å•†å“ID
     * @param quantity æ‰£å‡æ•°é‡
     * @return æ˜¯å¦æˆåŠŸ
     */
    @PostMapping("/product/deduct-stock")
    Result<Void> deductStock(@RequestParam("productId") Long productId,
                             @RequestParam("quantity") Integer quantity);
}

@Data
class ProductDTO {
    private Long productId;
    private String productName;
    private String coverImg;
    private BigDecimal price;
    private BigDecimal groupPrice;
    private Integer stock;
    private Integer status;
}
```

#### LeaderServiceClientï¼ˆå›¢é•¿æœåŠ¡å®¢æˆ·ç«¯ï¼‰

```java
@FeignClient(name = "LeaderService", path = "/api")
public interface LeaderServiceClient {
    
    /**
     * è·å–ç¤¾åŒºä¿¡æ¯
     * @param communityId ç¤¾åŒºID
     * @return ç¤¾åŒºDTO
     */
    @GetMapping("/community/{communityId}")
    Result<CommunityDTO> getCommunity(@PathVariable("communityId") Long communityId);
}

@Data
class CommunityDTO {
    private Long communityId;
    private String communityName;
    private String province;
    private String city;
    private String district;
    private String address;
    private BigDecimal longitude;
    private BigDecimal latitude;
}
```

---

### 3.3 ä½¿ç”¨Feignå®¢æˆ·ç«¯ç¤ºä¾‹

**åœºæ™¯**ï¼šOrderServiceåˆ›å»ºè®¢å•æ—¶éªŒè¯ç”¨æˆ·å’Œå•†å“

**æ–‡ä»¶è·¯å¾„**ï¼š`OrderService/src/main/java/com/bcu/edu/service/OrderService.java`

```java
package com.bcu.edu.service;

import com.bcu.edu.common.client.UserServiceClient;
import com.bcu.edu.common.client.ProductServiceClient;
import com.bcu.edu.common.exception.BusinessException;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class OrderService {
    
    private final UserServiceClient userServiceClient;
    private final ProductServiceClient productServiceClient;
    
    public void createOrder(Long userId, Long productId, Integer quantity) {
        // 1. éªŒè¯ç”¨æˆ·å­˜åœ¨ï¼ˆè·¨æœåŠ¡è°ƒç”¨ï¼‰
        var userResult = userServiceClient.getUserById(userId);
        if (!userResult.isSuccess() || userResult.getData() == null) {
            throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // 2. éªŒè¯å•†å“å­˜åœ¨ä¸”åº“å­˜å……è¶³ï¼ˆè·¨æœåŠ¡è°ƒç”¨ï¼‰
        var productResult = productServiceClient.getProduct(productId);
        if (!productResult.isSuccess() || productResult.getData() == null) {
            throw new BusinessException("å•†å“ä¸å­˜åœ¨");
        }
        if (productResult.getData().getStock() < quantity) {
            throw new BusinessException("å•†å“åº“å­˜ä¸è¶³");
        }
        
        // 3. åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°æ“ä½œï¼‰
        // ... ä¿å­˜è®¢å•åˆ°order_service_db
    }
}
```

---

## é˜¶æ®µ4ï¼šå®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼Œ1-2å¤©ï¼‰

### 4.1 åˆ›å»ºSagaè¡¥å¿æ—¥å¿—è¡¨ ğŸŸ¡

åœ¨**æ¯ä¸ªå¾®æœåŠ¡æ•°æ®åº“**æ·»åŠ è¡¥å¿æ—¥å¿—è¡¨ï¼š

```sql
CREATE TABLE saga_compensation_log (
  saga_id VARCHAR(50) PRIMARY KEY COMMENT 'Sagaäº‹åŠ¡ID',
  service_name VARCHAR(50) NOT NULL COMMENT 'æœåŠ¡åç§°',
  action VARCHAR(50) NOT NULL COMMENT 'æ“ä½œåç§°',
  compensation_data TEXT COMMENT 'è¡¥å¿æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰',
  status TINYINT NOT NULL DEFAULT 0 COMMENT 'çŠ¶æ€ï¼ˆ0-å¾…è¡¥å¿/1-å·²è¡¥å¿ï¼‰',
  create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´'
) COMMENT = 'Sagaè¡¥å¿äº‹åŠ¡æ—¥å¿—';
```

### 4.2 åˆ›å»ºSagaåè°ƒå™¨

**æ–‡ä»¶è·¯å¾„**ï¼š`common/src/main/java/com/bcu/edu/common/saga/SagaCoordinator.java`

```java
package com.bcu.edu.common.saga;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

import java.util.*;

/**
 * Sagaåˆ†å¸ƒå¼äº‹åŠ¡åè°ƒå™¨
 */
@Slf4j
@Component
public class SagaCoordinator {
    
    /**
     * æ‰§è¡ŒSagaäº‹åŠ¡
     * @param sagaId äº‹åŠ¡ID
     * @param steps äº‹åŠ¡æ­¥éª¤åˆ—è¡¨
     * @return æ˜¯å¦æˆåŠŸ
     */
    public boolean executeSaga(String sagaId, List<SagaStep> steps) {
        Stack<SagaStep> executedSteps = new Stack<>();
        
        try {
            // é¡ºåºæ‰§è¡Œæ‰€æœ‰æ­¥éª¤
            for (SagaStep step : steps) {
                log.info("[Saga-{}] æ‰§è¡Œæ­¥éª¤: {}", sagaId, step.getName());
                step.execute();
                executedSteps.push(step);
            }
            return true;
            
        } catch (Exception e) {
            log.error("[Saga-{}] æ‰§è¡Œå¤±è´¥ï¼Œå¼€å§‹è¡¥å¿", sagaId, e);
            // é€†åºæ‰§è¡Œè¡¥å¿
            while (!executedSteps.isEmpty()) {
                SagaStep step = executedSteps.pop();
                try {
                    log.info("[Saga-{}] è¡¥å¿æ­¥éª¤: {}", sagaId, step.getName());
                    step.compensate();
                } catch (Exception ce) {
                    log.error("[Saga-{}] è¡¥å¿å¤±è´¥: {}", sagaId, step.getName(), ce);
                }
            }
            return false;
        }
    }
}

/**
 * Sagaæ­¥éª¤æ¥å£
 */
interface SagaStep {
    String getName();
    void execute() throws Exception;
    void compensate();
}
```

### 4.3 ä½¿ç”¨Sagaç¤ºä¾‹

**åœºæ™¯**ï¼šç”¨æˆ·å‚å›¢æ”¯ä»˜ï¼ˆè·¨3ä¸ªæœåŠ¡ï¼‰

```java
public void joinGroupBuy(Long userId, Long teamId, BigDecimal amount) {
    String sagaId = UUID.randomUUID().toString();
    
    List<SagaStep> steps = Arrays.asList(
        // Step 1: æ‰£å‡ç”¨æˆ·ä½™é¢
        new SagaStep() {
            public String getName() { return "æ‰£å‡ä½™é¢"; }
            public void execute() throws Exception {
                userServiceClient.deductBalance(userId, amount, sagaId);
            }
            public void compensate() {
                userServiceClient.refundBalance(userId, amount, sagaId);
            }
        },
        
        // Step 2: åˆ›å»ºè®¢å•
        new SagaStep() {
            public String getName() { return "åˆ›å»ºè®¢å•"; }
            private Long orderId;
            public void execute() throws Exception {
                orderId = orderServiceClient.createOrder(..., sagaId);
            }
            public void compensate() {
                orderServiceClient.cancelOrder(orderId, sagaId);
            }
        },
        
        // Step 3: æ·»åŠ å‚å›¢è®°å½•
        new SagaStep() {
            public String getName() { return "æ·»åŠ å‚å›¢è®°å½•"; }
            private Long memberId;
            public void execute() throws Exception {
                memberId = groupBuyMemberRepository.save(...).getMemberId();
            }
            public void compensate() {
                groupBuyMemberRepository.deleteById(memberId);
            }
        }
    );
    
    boolean success = sagaCoordinator.executeSaga(sagaId, steps);
    if (!success) {
        throw new BusinessException("å‚å›¢å¤±è´¥");
    }
}
```

---

## ğŸ“‹ ä¿®æ”¹æ£€æŸ¥æ¸…å•

### ç«‹å³æ‰§è¡Œï¼ˆé˜¶æ®µ1ï¼‰âœ…
- [ ] ä¿®æ”¹UserServiceæ•°æ®åº“è¿æ¥ä¸º`user_service_db`
- [ ] æ‰§è¡Œ`01_user_service_db.sql`åˆ›å»ºæ•°æ®åº“
- [ ] ä¿®æ”¹SysUserå®ä½“æ·»åŠ `community_id`å­—æ®µ
- [ ] æµ‹è¯•UserServiceå¯åŠ¨å’Œæ¥å£è°ƒç”¨
- [ ] æäº¤ä»£ç åˆ°Git

### æœ¬å‘¨å®Œæˆï¼ˆé˜¶æ®µ2ï¼‰â°
- [ ] åˆ›å»ºProductServiceï¼ˆ8062ç«¯å£ï¼‰
- [ ] åˆ›å»ºGroupBuyServiceï¼ˆ8063ç«¯å£ï¼‰
- [ ] åˆ›å»ºOrderServiceï¼ˆ8065ç«¯å£ï¼‰
- [ ] åˆ›å»ºPaymentServiceï¼ˆ8066ç«¯å£ï¼‰
- [ ] åˆ›å»ºDeliveryServiceï¼ˆ8067ç«¯å£ï¼‰
- [ ] åˆ›å»ºLeaderServiceï¼ˆ8068ç«¯å£ï¼‰
- [ ] æ‰§è¡Œå¯¹åº”çš„SQLè„šæœ¬åˆ›å»ºæ•°æ®åº“
- [ ] æµ‹è¯•å„æœåŠ¡ç‹¬ç«‹å¯åŠ¨

### ä¸‹å‘¨å®Œæˆï¼ˆé˜¶æ®µ3+4ï¼‰â°
- [ ] æ·»åŠ OpenFeignä¾èµ–
- [ ] åˆ›å»ºFeignå®¢æˆ·ç«¯æ¥å£
- [ ] å®ç°è·¨æœåŠ¡è°ƒç”¨éªŒè¯
- [ ] åˆ›å»ºSagaåè°ƒå™¨
- [ ] å®ç°åˆ†å¸ƒå¼äº‹åŠ¡è¡¥å¿
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•å®Œæ•´ä¸šåŠ¡æµç¨‹

---

## ğŸ¯ æ‰§è¡Œå»ºè®®

### ä¼˜å…ˆçº§æ’åº
1. **ğŸ”´ æœ€é«˜ä¼˜å…ˆçº§**ï¼šé˜¶æ®µ1ï¼ˆæ•°æ®åº“è¿æ¥ä¿®æ”¹ï¼‰ï¼Œç¡®ä¿UserServiceæ­£å¸¸è¿è¡Œ
2. **ğŸŸ  ä¸­ç­‰ä¼˜å…ˆçº§**ï¼šé˜¶æ®µ2ï¼ˆåˆ›å»ºå…¶ä»–å¾®æœåŠ¡ï¼‰ï¼Œé€ä¸ªåˆ›å»ºå¹¶æµ‹è¯•
3. **ğŸŸ¡ ä½ä¼˜å…ˆçº§**ï¼šé˜¶æ®µ3+4ï¼ˆFeignè°ƒç”¨å’Œåˆ†å¸ƒå¼äº‹åŠ¡ï¼‰ï¼Œä¼˜åŒ–ç³»ç»Ÿæ¶æ„

### æ¸è¿›å¼è¿ç§»ç­–ç•¥
```
ç¬¬1å¤©ï¼šå®Œæˆé˜¶æ®µ1ï¼ˆUserServiceä¿®æ”¹ï¼‰
ç¬¬2-3å¤©ï¼šåˆ›å»ºProductServiceã€GroupBuyService
ç¬¬4-5å¤©ï¼šåˆ›å»ºOrderServiceã€PaymentService
ç¬¬6-7å¤©ï¼šåˆ›å»ºDeliveryServiceã€LeaderService
ç¬¬8-9å¤©ï¼šå®ç°Feignå®¢æˆ·ç«¯
ç¬¬10-11å¤©ï¼šå®ç°åˆ†å¸ƒå¼äº‹åŠ¡
ç¬¬12-14å¤©ï¼šé›†æˆæµ‹è¯•å’ŒBugä¿®å¤
```

### æµ‹è¯•éªŒè¯
æ¯ä¸ªé˜¶æ®µå®Œæˆåå¿…é¡»éªŒè¯ï¼š
- [ ] æœåŠ¡èƒ½å¦æ­£å¸¸å¯åŠ¨
- [ ] Consulä¸­èƒ½å¦çœ‹åˆ°æœåŠ¡æ³¨å†Œ
- [ ] æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£ç¡®
- [ ] åŸºç¡€CRUDæ¥å£æ˜¯å¦å¯ç”¨
- [ ] è·¨æœåŠ¡è°ƒç”¨æ˜¯å¦æˆåŠŸ

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚éœ€è¯¦ç»†ä»£ç ç¤ºä¾‹æˆ–é‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. å…·ä½“æŠ¥é”™ä¿¡æ¯
2. å½“å‰æ‰§è¡Œåˆ°å“ªä¸ªé˜¶æ®µ
3. ä½¿ç”¨çš„IDEï¼ˆIDEA/VSCodeï¼‰
4. Javaç‰ˆæœ¬å’ŒMavenç‰ˆæœ¬

æˆ‘ä¼šä¸ºæ‚¨æä¾›é’ˆå¯¹æ€§çš„è§£å†³æ–¹æ¡ˆï¼

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-10-29  
**ç»´æŠ¤äºº**: AI Assistant  
**ç›¸å…³æ–‡æ¡£**: 
- `docs/ç¤¾åŒºå›¢è´­ç³»ç»Ÿ/æ•°æ®åº“è®¾è®¡è¯´æ˜æ–‡æ¡£.md`
- `community-group-buy-backend/sql/README.md`

