# ç¤¾åŒºå›¢è´­ç³»ç»Ÿ - æ‹¼å›¢æœåŠ¡APIæ¥å£æ–‡æ¡£

**æœåŠ¡åç§°**: GroupBuyService  
**æœåŠ¡ç«¯å£**: 8063  
**Base URL**: `http://localhost:8063`  
**é€šè¿‡ç½‘å…³è®¿é—®**: `http://localhost:9000`  
**ç‰ˆæœ¬**: v1.0.2  
**æ–‡æ¡£æ—¥æœŸ**: 2025-10-31  
**æœ€åæ›´æ–°**: 2025-11-07 20:30

---

## ğŸ“‹ ç›®å½•

1. [æ¥å£æ¦‚è¿°](#1-æ¥å£æ¦‚è¿°)
2. [è®¤è¯æ–¹å¼](#2-è®¤è¯æ–¹å¼)
3. [é€šç”¨å“åº”æ ¼å¼](#3-é€šç”¨å“åº”æ ¼å¼)
4. [é”™è¯¯ç è¯´æ˜](#4-é”™è¯¯ç è¯´æ˜)
5. [æ‹¼å›¢æ´»åŠ¨ç®¡ç†æ¥å£](#5-æ‹¼å›¢æ´»åŠ¨ç®¡ç†æ¥å£)
6. [å›¢ç®¡ç†æ¥å£](#6-å›¢ç®¡ç†æ¥å£)
7. [æŸ¥è¯¢æ¥å£](#7-æŸ¥è¯¢æ¥å£)
8. [å®šæ—¶ä»»åŠ¡](#8-å®šæ—¶ä»»åŠ¡)
9. [Swaggeræ–‡æ¡£](#9-swaggeræ–‡æ¡£)

---

## 1. æ¥å£æ¦‚è¿°

### 1.1 æœåŠ¡åŠŸèƒ½

æ‹¼å›¢æœåŠ¡ï¼ˆGroupBuyServiceï¼‰æ˜¯ç¤¾åŒºå›¢è´­ç³»ç»Ÿçš„æ ¸å¿ƒæœåŠ¡ä¹‹ä¸€ï¼Œè´Ÿè´£ï¼š

- âœ… æ‹¼å›¢æ´»åŠ¨ç®¡ç†ï¼ˆåˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤ï¼‰
- âœ… å›¢é•¿å‘èµ·æ‹¼å›¢ï¼ˆv3.0ï¼šéªŒè¯å›¢é•¿èº«ä»½ã€è‡ªåŠ¨å…³è”ç¤¾åŒºï¼‰
- âœ… ç”¨æˆ·å‚ä¸æ‹¼å›¢ï¼ˆè¡Œé”é˜²å¹¶å‘ã€é˜²é‡å¤å‚å›¢ï¼‰
- âœ… æ”¯ä»˜å›è°ƒå¤„ç†ï¼ˆæˆå›¢æ£€æŸ¥ã€å¹‚ç­‰æ€§ä¿è¯ï¼‰
- âœ… æŸ¥è¯¢åŠŸèƒ½ï¼ˆå›¢è¯¦æƒ…ã€æ´»åŠ¨å›¢åˆ—è¡¨ã€æˆ‘çš„æ‹¼å›¢ï¼‰
- âœ… é€€å‡ºæ‹¼å›¢ï¼ˆæˆå›¢å‰å¯é€€ã€è‡ªåŠ¨é€€æ¬¾ï¼‰
- âœ… å®šæ—¶ä»»åŠ¡ï¼ˆè¿‡æœŸå›¢è‡ªåŠ¨é€€æ¬¾ï¼‰

### 1.2 æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: Spring Boot 3.2.3
- **å¾®æœåŠ¡**: Spring Cloud 2023.0.0
- **æ•°æ®åº“**: MySQL 8.0.36
- **ORM**: Spring Data JPA
- **æœåŠ¡æ³¨å†Œ**: Consul
- **æœåŠ¡è°ƒç”¨**: OpenFeign
- **APIæ–‡æ¡£**: SpringDoc OpenAPI 2.3.0
- **è®¤è¯**: JWT Tokenï¼ˆGatewayç»Ÿä¸€é‰´æƒï¼‰

### 1.3 æŠ€æœ¯äº®ç‚¹

- â­ **æ— Redisåˆ†å¸ƒå¼é”**ï¼šä½¿ç”¨æ•°æ®åº“è¡Œé”ï¼ˆSELECT ... FOR UPDATEï¼‰
- â­ **ä¸‰å±‚å¹‚ç­‰æ€§è®¾è®¡**ï¼šæ”¯ä»˜å›è°ƒã€æˆå›¢é€»è¾‘ã€å®šæ—¶ä»»åŠ¡
- â­ **Sagaæ¨¡å¼**ï¼šè·¨æœåŠ¡è°ƒç”¨ + è¡¥å¿æœºåˆ¶
- â­ **ç¤¾åŒºä¼˜å…ˆæ¨è**ï¼šSQL ORDER BY CASEå®ç°ï¼ˆv3.0ï¼‰
- â­ **å¼‚å¸¸éš”ç¦»**ï¼šå®šæ—¶ä»»åŠ¡å•ä¸ªå›¢å¤±è´¥ä¸å½±å“å…¶ä»–å›¢

### 1.4 æ¥å£ç»Ÿè®¡

| æ¨¡å— | æ¥å£æ•° | è·¯å¾„å‰ç¼€ |
|------|--------|---------|
| æ‹¼å›¢æ´»åŠ¨ç®¡ç†ï¼ˆç®¡ç†ç«¯ï¼‰ | 6ä¸ª | `/api/groupbuy/activity`, `/api/groupbuy/product` |
| å›¢ç®¡ç†ï¼ˆæ ¸å¿ƒâ­ï¼‰ | 6ä¸ª | `/api/groupbuy/team` |
| å›¢é•¿ç®¡ç†å›¢é˜Ÿï¼ˆv3.1æ–°å¢ï¼‰ | 3ä¸ª | `/api/groupbuy/team` |
| æ”¯ä»˜å›è°ƒï¼ˆå†…éƒ¨ï¼‰ | 1ä¸ª | `/api/groupbuy/payment` |
| **æ€»è®¡** | **16ä¸ª** | - |

---

## 2. è®¤è¯æ–¹å¼

### 2.1 JWT Tokenè®¤è¯

æ‰€æœ‰éœ€è¦é‰´æƒçš„APIè¯·æ±‚éƒ½éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦JWT Tokenï¼š

```http
Authorization: Bearer <your_jwt_token>
```

**è¯´æ˜**: JWTé‰´æƒåœ¨Gatewayå±‚ç»Ÿä¸€å¤„ç†ï¼ŒGroupBuyServiceä»è¯·æ±‚å¤´è·å–ç”¨æˆ·ä¿¡æ¯ï¼š
- `X-User-Id`: ç”¨æˆ·ID
- `X-Username`: ç”¨æˆ·å
- `X-User-Role`: ç”¨æˆ·è§’è‰²ï¼ˆ1-æ™®é€šç”¨æˆ·/2-å›¢é•¿/3-ç®¡ç†å‘˜ï¼‰

### 2.2 ç™½åå•æ¥å£ï¼ˆæ— éœ€è®¤è¯ï¼‰

ä»¥ä¸‹æ¥å£æ— éœ€JWT Tokenï¼š

- `GET /api/groupbuy/team/{teamId}/detail` - å›¢è¯¦æƒ…
- `GET /api/groupbuy/activity/{activityId}/teams` - æ´»åŠ¨å›¢åˆ—è¡¨
- `GET /api/groupbuy/product/{productId}/activities` - å•†å“çš„æ‹¼å›¢æ´»åŠ¨ï¼ˆå«å›¢åˆ—è¡¨ï¼‰â­æ–°å¢
- `GET /api/groupbuy/activities` - æ´»åŠ¨åˆ—è¡¨
- `GET /api/groupbuy/activities/ongoing` - è¿›è¡Œä¸­çš„æ´»åŠ¨
- `GET /api/groupbuy/activity/{id}` - æ´»åŠ¨è¯¦æƒ…
- `GET /actuator/health` - å¥åº·æ£€æŸ¥
- `/swagger-ui/**` - Swagger UI
- `/v3/api-docs/**` - APIæ–‡æ¡£

### 2.3 è·å–Token

é€šè¿‡UserServiceçš„ç™»å½•æ¥å£è·å–Tokenï¼š

```bash
POST http://localhost:9000/api/user/login
Content-Type: application/json

{
  "username": "testuser",
  "password": "123456"
}
```

---

## 3. é€šç”¨å“åº”æ ¼å¼

### 3.1 æˆåŠŸå“åº”

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": { ... },
  "timestamp": "2025-10-31T20:00:00"
}
```

### 3.2 å¤±è´¥å“åº”

```json
{
  "code": 400,
  "message": "é”™è¯¯ä¿¡æ¯",
  "data": null,
  "timestamp": "2025-10-31T20:00:00"
}
```

### 3.3 åˆ†é¡µå“åº”

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "list": [ ... ],
    "total": 100,
    "pageNum": 1,
    "pageSize": 10,
    "pages": 10
  },
  "timestamp": "2025-10-31T20:00:00"
}
```

---

## 4. é”™è¯¯ç è¯´æ˜

| é”™è¯¯ç  | è¯´æ˜ | å¸¸è§åœºæ™¯ |
|-------|------|---------|
| 200 | æˆåŠŸ | - |
| 400 | å‚æ•°é”™è¯¯ | å¿…å¡«å‚æ•°ç¼ºå¤±ã€å‚æ•°æ ¼å¼é”™è¯¯ |
| 401 | æœªæˆæƒ | Tokenç¼ºå¤±æˆ–è¿‡æœŸ |
| 403 | æ— æƒé™ | éå›¢é•¿ç”¨æˆ·å‘èµ·æ‹¼å›¢ |
| 404 | èµ„æºä¸å­˜åœ¨ | å›¢IDä¸å­˜åœ¨ã€æ´»åŠ¨IDä¸å­˜åœ¨ |
| 409 | ä¸šåŠ¡å†²çª | é‡å¤å‚å›¢ã€å›¢å·²æ»¡å‘˜ã€æ‹¼å›¢å·²ç»“æŸ |
| 500 | æœåŠ¡å™¨é”™è¯¯ | æ•°æ®åº“å¼‚å¸¸ã€æœåŠ¡è°ƒç”¨å¤±è´¥ |
| 503 | æœåŠ¡ä¸å¯ç”¨ | ä¾èµ–æœåŠ¡ï¼ˆOrderService/UserServiceï¼‰ä¸å¯ç”¨ |

### 4.1 ä¸šåŠ¡é”™è¯¯ç 

| é”™è¯¯ä¿¡æ¯ | è¯´æ˜ | è§£å†³æ–¹æ¡ˆ |
|---------|------|---------|
| "æ‹¼å›¢æ´»åŠ¨ä¸å­˜åœ¨" | æ´»åŠ¨IDæ— æ•ˆ | æ£€æŸ¥activityId |
| "æ‹¼å›¢æ´»åŠ¨æœªå¼€å§‹æˆ–å·²ç»“æŸ" | æ´»åŠ¨ä¸åœ¨æ—¶é—´èŒƒå›´å†… | æ£€æŸ¥æ´»åŠ¨çŠ¶æ€ |
| "ä»…å›¢é•¿å¯å‘èµ·æ‹¼å›¢" | ç”¨æˆ·role!=2 | ç¡®è®¤ç”¨æˆ·ä¸ºå›¢é•¿ |
| "å›¢ä¸å­˜åœ¨" | å›¢IDæ— æ•ˆ | æ£€æŸ¥teamId |
| "æ‹¼å›¢å·²ç»“æŸ" | å›¢çŠ¶æ€!=0 | æŸ¥è¯¢å…¶ä»–å›¢ |
| "å›¢å·²æ»¡å‘˜" | current_num >= required_num | æŸ¥è¯¢å…¶ä»–å›¢ |
| "æ‹¼å›¢å·²è¿‡æœŸ" | expire_time < now | æŸ¥è¯¢å…¶ä»–å›¢ |
| "æ‚¨å·²å‚åŠ æ­¤å›¢" | é‡å¤å‚å›¢ | æ— éœ€é‡å¤æ“ä½œ |
| "æ‹¼å›¢å·²æˆåŠŸï¼Œæ— æ³•é€€å‡º" | æˆå›¢åä¸å¯é€€ | è”ç³»å®¢æœ |
| "è®¢å•æœåŠ¡æš‚æ—¶ä¸å¯ç”¨" | OrderServiceä¸å¯ç”¨ | ç¨åé‡è¯• |

---

## 5. æ‹¼å›¢æ´»åŠ¨ç®¡ç†æ¥å£

### 5.1 åˆ›å»ºæ‹¼å›¢æ´»åŠ¨

**æ¥å£**: `POST /api/groupbuy/activity`  
**æƒé™**: ç®¡ç†å‘˜  
**é‰´æƒ**: éœ€è¦Token

**è¯·æ±‚ç¤ºä¾‹**:
```json
{
  "productId": 1,
  "groupPrice": 19.90,
  "requiredNum": 3,
  "maxNum": 100,
  "startTime": "2025-10-31T00:00:00",
  "endTime": "2025-12-31T23:59:59"
}
```

**è¯·æ±‚å‚æ•°è¯´æ˜**:

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|-----|------|------|------|
| productId | Long | âœ… | å•†å“IDï¼ˆè·¨åº“å…³è”ProductServiceï¼‰ |
| groupPrice | BigDecimal | âœ… | æ‹¼å›¢ä»·ï¼ˆå¿…é¡»å°äºå•†å“åŸä»·ï¼‰ |
| requiredNum | Integer | âœ… | æˆå›¢äººæ•°ï¼ˆ2-10äººï¼‰ |
| maxNum | Integer | âŒ | æœ€å¤§äººæ•°é™åˆ¶ï¼ˆå¯ä¸ºnullï¼Œè¡¨ç¤ºæ— é™åˆ¶ï¼‰ |
| startTime | String | âœ… | æ´»åŠ¨å¼€å§‹æ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰ |
| endTime | String | âœ… | æ´»åŠ¨ç»“æŸæ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰ |

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "activityId": 1,
    "productId": 1,
    "groupPrice": 19.90,
    "requiredNum": 3,
    "maxNum": 100,
    "startTime": "2025-10-31T00:00:00",
    "endTime": "2025-12-31T23:59:59",
    "status": 1,
    "qrcodeUrl": null,
    "link": null,
    "createTime": "2025-10-31T20:00:00"
  },
  "timestamp": "2025-10-31T20:00:00"
}
```

**ä¸šåŠ¡è§„åˆ™**:
1. FeignéªŒè¯å•†å“å­˜åœ¨ï¼ˆè°ƒç”¨ProductServiceï¼‰
2. æ‹¼å›¢ä»·å¿…é¡»å°äºå•†å“åŸä»·
3. startTimeä¸èƒ½æ™šäºendTime
4. æ´»åŠ¨åˆ›å»ºåè‡ªåŠ¨è®¾ç½®status=1ï¼ˆè¿›è¡Œä¸­ï¼‰

---

### 5.2 æ›´æ–°æ‹¼å›¢æ´»åŠ¨

**æ¥å£**: `PUT /api/groupbuy/activity/{id}`  
**æƒé™**: ç®¡ç†å‘˜  
**é‰´æƒ**: éœ€è¦Token

**è¯·æ±‚ç¤ºä¾‹**:
```json
{
  "groupPrice": 18.90,
  "requiredNum": 2,
  "status": 1
}
```

**å“åº”**: åŒåˆ›å»ºæ´»åŠ¨å“åº”

---

### 5.3 åˆ é™¤æ‹¼å›¢æ´»åŠ¨

**æ¥å£**: `DELETE /api/groupbuy/activity/{id}`  
**æƒé™**: ç®¡ç†å‘˜  
**é‰´æƒ**: éœ€è¦Token

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "åˆ é™¤æˆåŠŸ",
  "data": null,
  "timestamp": "2025-10-31T20:00:00"
}
```

---

### 5.4 è·å–æ´»åŠ¨åˆ—è¡¨

**æ¥å£**: `GET /api/groupbuy/activities`  
**æƒé™**: æ—   
**é‰´æƒ**: ä¸éœ€è¦Token

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": [
    {
      "activityId": 1,
      "productId": 1,
      "groupPrice": 19.90,
      "requiredNum": 3,
      "maxNum": 100,
      "startTime": "2025-10-31T00:00:00",
      "endTime": "2025-12-31T23:59:59",
      "status": 1,
      "createTime": "2025-10-31T20:00:00"
    }
  ],
  "timestamp": "2025-10-31T20:00:00"
}
```

---

### 5.5 è·å–è¿›è¡Œä¸­çš„æ´»åŠ¨

**æ¥å£**: `GET /api/groupbuy/activities/ongoing`  
**æƒé™**: æ—   
**é‰´æƒ**: ä¸éœ€è¦Token

**è¯´æ˜**: è¿”å›status=1ä¸”åœ¨æ´»åŠ¨æ—¶é—´èŒƒå›´å†…çš„æ´»åŠ¨

**å“åº”**: åŒæ´»åŠ¨åˆ—è¡¨

---

### 5.6 è·å–æ´»åŠ¨è¯¦æƒ…

**æ¥å£**: `GET /api/groupbuy/activity/{id}`  
**æƒé™**: æ—   
**é‰´æƒ**: ä¸éœ€è¦Token

**å“åº”**: å•ä¸ªæ´»åŠ¨ä¿¡æ¯

---

## 6. å›¢ç®¡ç†æ¥å£

### 6.1 å›¢é•¿å‘èµ·æ‹¼å›¢ï¼ˆâ­v3.0æ ¸å¿ƒæ¥å£ï¼‰

**æ¥å£**: `POST /api/groupbuy/team/launch`  
**æƒé™**: å›¢é•¿ï¼ˆrole=2ï¼‰  
**é‰´æƒ**: éœ€è¦Token

**ç‰¹æ€§**:
- âœ… ä»…å›¢é•¿å¯å‘èµ·ï¼ˆFeignè°ƒç”¨UserServiceéªŒè¯role=2ï¼‰
- âœ… è‡ªåŠ¨å…³è”å›¢é•¿çš„ç¤¾åŒºï¼ˆv3.0ç‰¹æ€§ï¼‰
- âœ… å›¢é•¿å¯é€‰æ‹©æ˜¯å¦ç«‹å³å‚ä¸
- âœ… ç”Ÿæˆå”¯ä¸€å›¢å·ï¼ˆæ ¼å¼ï¼šT20251031001ï¼‰

**è¯·æ±‚ç¤ºä¾‹**:
```json
{
  "activityId": 1,
  "joinImmediately": true,
  "addressId": 1,
  "quantity": 1
}
```

**è¯·æ±‚å‚æ•°è¯´æ˜**:

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|-----|------|------|------|
| activityId | Long | âœ… | æ´»åŠ¨ID |
| joinImmediately | Boolean | âŒ | æ˜¯å¦ç«‹å³å‚ä¸ï¼ˆé»˜è®¤falseï¼‰ |
| addressId | Long | âš ï¸ | æ”¶è´§åœ°å€IDï¼ˆjoinImmediately=trueæ—¶å¿…å¡«ï¼‰ |
| quantity | Integer | âŒ | è´­ä¹°æ•°é‡ï¼ˆé»˜è®¤1ï¼‰ |

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "teamId": 1,
    "teamNo": "T20251031001",
    "activityId": 1,
    "activityName": "æ‹¼å›¢æ´»åŠ¨-1",
    "groupPrice": 19.90,
    "leaderId": 1,
    "leaderName": "å¼ å›¢é•¿",
    "communityId": 10,
    "communityName": "å¹¸ç¦å°åŒº",
    "requiredNum": 3,
    "currentNum": 1,
    "remainNum": 2,
    "teamStatus": 0,
    "teamStatusDesc": "æ‹¼å›¢ä¸­",
    "successTime": null,
    "expireTime": "2025-11-01T20:00:00",
    "createTime": "2025-10-31T20:00:00",
    "members": [
      {
        "memberId": 1,
        "userId": 1,
        "username": "leader123",
        "realName": "å¼ å›¢é•¿",
        "avatar": null,
        "isLauncher": 1,
        "payAmount": 19.90,
        "joinTime": "2025-10-31T20:00:00",
        "status": 0,
        "statusDesc": "å¾…æ”¯ä»˜"
      }
    ],
    "shareLink": "http://localhost:5173/team/1"
  },
  "timestamp": "2025-10-31T20:00:00"
}
```

**ä¸šåŠ¡æµç¨‹**:
1. Feignè°ƒç”¨UserServiceéªŒè¯å›¢é•¿èº«ä»½ï¼ˆrole=2ï¼‰
2. è·å–å›¢é•¿çš„ç¤¾åŒºIDï¼ˆcommunityIdï¼‰
3. åˆ›å»ºå›¢å®ä¾‹ï¼ˆlauncher_id = leader_id = userIdï¼‰
4. è‡ªåŠ¨å…³è”ç¤¾åŒºï¼ˆcommunity_id = å›¢é•¿ç¤¾åŒºï¼‰â­v3.0
5. ç”Ÿæˆå›¢å·ï¼ˆT + yyyyMMdd + 6ä½éšæœºæ•°ï¼‰
6. å¦‚æœjoinImmediately=trueï¼šâ­ä¼˜åŒ–v3.2
   - Feignè°ƒç”¨OrderServiceåˆ›å»ºè®¢å•
   - è®°å½•å‚å›¢ï¼ˆis_launcher=1, status=0å¾…æ”¯ä»˜ï¼‰
   - **â­è°ƒç”¨PaymentServiceåˆ›å»ºæ”¯ä»˜å¹¶è‡ªåŠ¨å®Œæˆï¼ˆä½™é¢æ”¯ä»˜ï¼‰**
   - **â­æ›´æ–°å‚å›¢çŠ¶æ€ä¸ºå·²æ”¯ä»˜ï¼ˆstatus=1ï¼‰**
   - **â­æ›´æ–°å›¢çš„current_numï¼ˆ+1ï¼‰**
   - **â­æ£€æŸ¥æ˜¯å¦æˆå›¢ï¼ˆcurrent_num >= required_numï¼‰**

**é”™è¯¯å“åº”**:
```json
// éå›¢é•¿
{
  "code": 403,
  "message": "ä»…å›¢é•¿å¯å‘èµ·æ‹¼å›¢ï¼Œå½“å‰è§’è‰²ï¼š1",
  "data": null,
  "timestamp": "2025-10-31T20:00:00"
}

// æ”¯ä»˜å¤±è´¥ï¼ˆä½™é¢ä¸è¶³ï¼‰â­v3.2æ–°å¢
{
  "code": 500,
  "message": "æ”¯ä»˜å¤±è´¥ï¼šä½™é¢ä¸è¶³",
  "data": null,
  "timestamp": "2025-11-07T20:00:00"
}
```

---

### 6.2 ç”¨æˆ·å‚ä¸æ‹¼å›¢ï¼ˆâ­æ ¸å¿ƒæ¥å£ï¼‰

**æ¥å£**: `POST /api/groupbuy/team/join`  
**æƒé™**: å·²ç™»å½•ç”¨æˆ·  
**é‰´æƒ**: éœ€è¦Token

**ç‰¹æ€§**:
- âœ… è¡Œé”æ£€æŸ¥å›¢çŠ¶æ€ï¼ˆSELECT ... FOR UPDATEï¼‰
- âœ… é˜²é‡å¤å‚å›¢ï¼ˆå”¯ä¸€ç´¢å¼• uk_team_userï¼‰
- âœ… Feignè°ƒç”¨OrderServiceåˆ›å»ºè®¢å•
- âœ… è®°å½•å‚å›¢ï¼ˆstatus=0å¾…æ”¯ä»˜ï¼‰

**è¯·æ±‚ç¤ºä¾‹**:
```json
{
  "teamId": 1,
  "addressId": 2,
  "quantity": 1
}
```

**è¯·æ±‚å‚æ•°è¯´æ˜**:

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|-----|------|------|------|
| teamId | Long | âœ… | å›¢ID |
| addressId | Long | âœ… | æ”¶è´§åœ°å€ID |
| quantity | Integer | âœ… | è´­ä¹°æ•°é‡ï¼ˆæœ€å°ä¸º1ï¼‰ |

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "orderId": 8002,
    "teamId": 1,
    "teamNo": "T20251031001",
    "currentNum": 2,
    "requiredNum": 3,
    "remainNum": 1,
    "payAmount": 19.90,
    "expireTime": "2025-11-01 20:00:00"
  },
  "timestamp": "2025-10-31T20:05:00"
}
```

**ä¸šåŠ¡æµç¨‹**:
1. æŸ¥è¯¢å›¢ï¼ˆåŠ è¡Œé”ï¼‰â­ `SELECT ... FOR UPDATE`
2. çŠ¶æ€æ ¡éªŒï¼š
   - å›¢çŠ¶æ€å¿…é¡»ä¸º"æ‹¼å›¢ä¸­"ï¼ˆteam_status=0ï¼‰
   - å½“å‰äººæ•° < æˆå›¢äººæ•°
   - æœªè¿‡æœŸï¼ˆexpire_time > nowï¼‰
3. é˜²é‡å¤å‚å›¢æ£€æŸ¥ï¼ˆexistsByTeamIdAndUserIdï¼‰
4. Feignè°ƒç”¨OrderServiceåˆ›å»ºè®¢å•
5. è®°å½•å‚å›¢ï¼ˆorder_idå…³è”ï¼Œstatus=0å¾…æ”¯ä»˜ï¼‰
6. è¿”å›è®¢å•IDï¼ˆå‰ç«¯è·³è½¬æ”¯ä»˜é¡µé¢ï¼‰

**é”™è¯¯å“åº”**:

```json
// é‡å¤å‚å›¢
{
  "code": 409,
  "message": "æ‚¨å·²å‚åŠ æ­¤å›¢",
  "data": null,
  "timestamp": "2025-10-31T20:05:00"
}

// å›¢å·²æ»¡
{
  "code": 409,
  "message": "å›¢å·²æ»¡å‘˜",
  "data": null,
  "timestamp": "2025-10-31T20:05:00"
}

// å›¢å·²ç»“æŸ
{
  "code": 409,
  "message": "æ‹¼å›¢å·²ç»“æŸï¼Œå½“å‰çŠ¶æ€ï¼šå·²æˆå›¢",
  "data": null,
  "timestamp": "2025-10-31T20:05:00"
}
```

---

### 6.3 æ”¯ä»˜å›è°ƒï¼ˆâ­æ ¸å¿ƒæ¥å£ï¼Œå†…éƒ¨è°ƒç”¨ï¼‰

**æ¥å£**: `POST /api/groupbuy/payment/callback`  
**æƒé™**: å†…éƒ¨æ¥å£  
**é‰´æƒ**: ä¸éœ€è¦Token

**è¯´æ˜**: ç”±PaymentServiceæ”¯ä»˜æˆåŠŸåå›è°ƒï¼Œè§¦å‘æˆå›¢æ£€æŸ¥

**è¯·æ±‚ç¤ºä¾‹**:
```bash
POST /api/groupbuy/payment/callback?orderId=8002
```

**è¯·æ±‚å‚æ•°**:

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|-----|------|------|------|
| orderId | Long | âœ… | è®¢å•ID |

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": null,
  "timestamp": "2025-10-31T20:10:00"
}
```

**ä¸šåŠ¡æµç¨‹**ï¼ˆâ­æ ¸å¿ƒé€»è¾‘ï¼‰:
1. æŸ¥è¯¢å‚å›¢è®°å½•ï¼ˆåŠ è¡Œé”ï¼‰â­ `findByOrderIdForUpdate`
2. å¹‚ç­‰æ€§æ£€æŸ¥ï¼š`if (status != UNPAID) return;` â­
3. æ›´æ–°å‚å›¢çŠ¶æ€ï¼ˆUNPAID â†’ PAIDï¼‰
4. æŸ¥è¯¢å›¢ï¼ˆåŠ è¡Œé”ï¼‰â­ `findByIdForUpdate`
5. æ›´æ–°å›¢äººæ•°ï¼ˆcurrent_num++ï¼‰
6. æ£€æŸ¥æ˜¯å¦æˆå›¢ï¼ˆcurrent_num >= required_numï¼‰
7. å¦‚æœæˆå›¢ï¼Œè°ƒç”¨`teamSuccess(teamId)`

**æˆå›¢é€»è¾‘**ï¼ˆå¹‚ç­‰æ€§ä¿è¯ï¼‰:
```java
@Transactional
public void teamSuccess(Long teamId) {
    // 1. æŸ¥è¯¢å›¢ï¼ˆåŠ è¡Œé”ï¼‰â­
    GroupBuyTeam team = teamRepository.findByIdForUpdate(teamId);
    
    // 2. å¹‚ç­‰æ€§æ£€æŸ¥ â­
    if (team.getTeamStatus() != JOINING) {
        return;  // å·²å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›
    }
    
    // 3. æ›´æ–°å›¢çŠ¶æ€ï¼ˆJOINING â†’ SUCCESSï¼‰
    // 4. æ‰¹é‡æ›´æ–°æˆå‘˜çŠ¶æ€ï¼ˆPAID â†’ SUCCESSï¼‰
    // 5. Feignæ‰¹é‡æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆTO_DELIVERï¼‰
}
```

**æŠ€æœ¯äº®ç‚¹**:
- âœ… åŒé‡è¡Œé”ï¼ˆå‚å›¢è®°å½•é” + å›¢é”ï¼‰
- âœ… åŒé‡å¹‚ç­‰æ£€æŸ¥ï¼ˆå‚å›¢çŠ¶æ€ + å›¢çŠ¶æ€ï¼‰
- âœ… å¹¶å‘æ”¯ä»˜å›è°ƒå®‰å…¨
- âœ… æˆå›¢é€»è¾‘åªè§¦å‘ä¸€æ¬¡

---

### 6.4 é€€å‡ºæ‹¼å›¢

**æ¥å£**: `POST /api/groupbuy/team/quit`  
**æƒé™**: å·²ç™»å½•ç”¨æˆ·  
**é‰´æƒ**: éœ€è¦Token

**è¯´æ˜**: æˆå›¢å‰å¯é€€å‡ºï¼Œè‡ªåŠ¨é€€æ¬¾

**è¯·æ±‚ç¤ºä¾‹**:
```bash
POST /api/groupbuy/team/quit?teamId=1
```

**è¯·æ±‚å‚æ•°**:

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|-----|------|------|------|
| teamId | Long | âœ… | å›¢ID |

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "é€€å‡ºæˆåŠŸï¼Œå·²é€€æ¬¾",
  "data": null,
  "timestamp": "2025-10-31T20:15:00"
}
```

**ä¸šåŠ¡æµç¨‹**:
1. æŸ¥è¯¢å‚å›¢è®°å½•
2. æŸ¥è¯¢å›¢ï¼ˆåŠ è¡Œé”ï¼‰
3. æ£€æŸ¥å›¢çŠ¶æ€ï¼ˆå·²æˆå›¢ä¸å¯é€€ï¼‰
4. åˆ é™¤å‚å›¢è®°å½•
5. æ›´æ–°å›¢äººæ•°ï¼ˆcurrent_num--ï¼‰
6. Feigné€€æ¬¾åˆ°ç”¨æˆ·ä½™é¢
7. Feignæ›´æ–°è®¢å•çŠ¶æ€ä¸º"å·²é€€æ¬¾"

**é”™è¯¯å“åº”**:
```json
{
  "code": 409,
  "message": "æ‹¼å›¢å·²æˆåŠŸï¼Œæ— æ³•é€€å‡º",
  "data": null,
  "timestamp": "2025-10-31T20:15:00"
}
```

---

### 6.5 å›¢é•¿æå‰ç»“æŸæ‹¼å›¢ï¼ˆâ­v3.1æ–°å¢ï¼‰

**æ¥å£**: `POST /api/groupbuy/team/{teamId}/finish`  
**æƒé™**: å›¢é•¿ï¼ˆrole=2ï¼‰  
**é‰´æƒ**: éœ€è¦Token

**è¯´æ˜**: å½“è¾¾åˆ°èµ·æ‹¼äººæ•°åï¼Œå›¢é•¿å¯ä»¥é€‰æ‹©æå‰ç»“æŸæ‹¼å›¢

**è¯·æ±‚ç¤ºä¾‹**:
```bash
POST /api/groupbuy/team/1/finish
Authorization: Bearer {leader_token}
```

**è·¯å¾„å‚æ•°**:

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|-----|------|------|------|
| teamId | Long | âœ… | å›¢ID |

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "æ‹¼å›¢å·²æˆåŠŸç»“æŸ",
  "data": null,
  "timestamp": "2025-11-07T20:00:00"
}
```

**ä¸šåŠ¡æµç¨‹**:
1. æ ¡éªŒå›¢é•¿æƒé™ï¼ˆåªæœ‰å›¢é•¿å¯æ“ä½œï¼‰
2. æŸ¥è¯¢å›¢ï¼ˆåŠ è¡Œé”ï¼‰
3. æ£€æŸ¥å›¢çŠ¶æ€ä¸º"æ‹¼å›¢ä¸­"
4. æ£€æŸ¥æ˜¯å¦è¾¾åˆ°èµ·æ‹¼äººæ•°ï¼ˆcurrent_num >= required_numï¼‰
5. è°ƒç”¨æˆå›¢é€»è¾‘ï¼ˆteamSuccessï¼‰
6. æ‰¹é‡æ›´æ–°æˆå‘˜çŠ¶æ€ä¸º"å·²æˆå›¢"
7. Feignæ‰¹é‡æ›´æ–°è®¢å•çŠ¶æ€ä¸º"å¾…å‘è´§"

**é”™è¯¯å“åº”**:
```json
// éå›¢é•¿æ“ä½œ
{
  "code": 403,
  "message": "ä»…å›¢é•¿å¯ä»¥æå‰ç»“æŸæ‹¼å›¢",
  "data": null,
  "timestamp": "2025-11-07T20:00:00"
}

// æœªè¾¾èµ·æ‹¼äººæ•°
{
  "code": 409,
  "message": "æœªè¾¾åˆ°èµ·æ‹¼äººæ•°ï¼Œå½“å‰2äººï¼Œéœ€è¦3äºº",
  "data": null,
  "timestamp": "2025-11-07T20:00:00"
}

// å›¢å·²ç»“æŸ
{
  "code": 409,
  "message": "è¯¥æ‹¼å›¢å·²ç»“æŸï¼Œå½“å‰çŠ¶æ€ï¼šå·²æˆå›¢",
  "data": null,
  "timestamp": "2025-11-07T20:00:00"
}
```

---

### 6.6 å›¢é•¿å–æ¶ˆæ‹¼å›¢ï¼ˆâ­v3.1æ–°å¢ï¼‰

**æ¥å£**: `POST /api/groupbuy/team/{teamId}/cancel`  
**æƒé™**: å›¢é•¿ï¼ˆrole=2ï¼‰  
**é‰´æƒ**: éœ€è¦Token

**è¯´æ˜**: å›¢é•¿å¯ä»¥å–æ¶ˆæ‹¼å›¢ï¼Œè‡ªåŠ¨é€€æ¬¾ç»™æ‰€æœ‰æˆå‘˜

**è¯·æ±‚ç¤ºä¾‹**:
```bash
POST /api/groupbuy/team/1/cancel
Authorization: Bearer {leader_token}
Content-Type: application/json

{
  "reason": "å•†å“åº“å­˜ä¸è¶³ï¼Œå–æ¶ˆæ‹¼å›¢"
}
```

**è·¯å¾„å‚æ•°**:

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|-----|------|------|------|
| teamId | Long | âœ… | å›¢ID |

**è¯·æ±‚ä½“å‚æ•°**:

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|-----|------|------|------|
| reason | String | âŒ | å–æ¶ˆåŸå›  |

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "æ‹¼å›¢å·²å–æ¶ˆï¼Œå·²é€€æ¬¾ç»™æ‰€æœ‰æˆå‘˜",
  "data": null,
  "timestamp": "2025-11-07T20:00:00"
}
```

**ä¸šåŠ¡æµç¨‹**:
1. æ ¡éªŒå›¢é•¿æƒé™ï¼ˆåªæœ‰å›¢é•¿å¯æ“ä½œï¼‰
2. æŸ¥è¯¢å›¢ï¼ˆåŠ è¡Œé”ï¼‰
3. æ£€æŸ¥å›¢çŠ¶æ€ä¸º"æ‹¼å›¢ä¸­"
4. æ›´æ–°å›¢çŠ¶æ€ä¸º"å·²å¤±è´¥"
5. æŸ¥è¯¢æ‰€æœ‰æˆå‘˜
6. æ›´æ–°æ‰€æœ‰æˆå‘˜çŠ¶æ€ä¸º"å·²å–æ¶ˆ"
7. æ‰¹é‡é€€æ¬¾ç»™æ‰€æœ‰å·²æ”¯ä»˜æˆå‘˜ï¼ˆFeignè°ƒç”¨OrderServiceï¼‰
8. æ‰¹é‡æ›´æ–°è®¢å•çŠ¶æ€ä¸º"å·²é€€æ¬¾"

**é”™è¯¯å“åº”**:
```json
// éå›¢é•¿æ“ä½œ
{
  "code": 403,
  "message": "ä»…å›¢é•¿å¯ä»¥å–æ¶ˆæ‹¼å›¢",
  "data": null,
  "timestamp": "2025-11-07T20:00:00"
}

// å›¢å·²ç»“æŸ
{
  "code": 409,
  "message": "è¯¥æ‹¼å›¢å·²ç»“æŸï¼Œå½“å‰çŠ¶æ€ï¼šå·²æˆå›¢",
  "data": null,
  "timestamp": "2025-11-07T20:00:00"
}
```

---

### 6.7 å›¢é•¿ç§»é™¤å›¢é˜Ÿæˆå‘˜ï¼ˆâ­v3.1æ–°å¢ï¼‰

**æ¥å£**: `POST /api/groupbuy/team/{teamId}/member/{memberId}/remove`  
**æƒé™**: å›¢é•¿ï¼ˆrole=2ï¼‰  
**é‰´æƒ**: éœ€è¦Token

**è¯´æ˜**: å›¢é•¿å¯ä»¥ç§»é™¤å›¢é˜Ÿä¸­çš„æˆå‘˜ï¼ˆæˆå›¢å‰ï¼‰ï¼Œè‡ªåŠ¨é€€æ¬¾ç»™è¯¥æˆå‘˜

**è¯·æ±‚ç¤ºä¾‹**:
```bash
POST /api/groupbuy/team/1/member/5/remove
Authorization: Bearer {leader_token}
Content-Type: application/json

{
  "reason": "ç”¨æˆ·è¦æ±‚é€€å‡º"
}
```

**è·¯å¾„å‚æ•°**:

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|-----|------|------|------|
| teamId | Long | âœ… | å›¢ID |
| memberId | Long | âœ… | æˆå‘˜ID |

**è¯·æ±‚ä½“å‚æ•°**:

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|-----|------|------|------|
| reason | String | âŒ | ç§»é™¤åŸå›  |

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "å·²ç§»é™¤æˆå‘˜ï¼Œå·²é€€æ¬¾ç»™è¯¥æˆå‘˜",
  "data": null,
  "timestamp": "2025-11-07T20:00:00"
}
```

**ä¸šåŠ¡æµç¨‹**:
1. æ ¡éªŒå›¢é•¿æƒé™ï¼ˆåªæœ‰å›¢é•¿å¯æ“ä½œï¼‰
2. æŸ¥è¯¢å›¢ï¼ˆåŠ è¡Œé”ï¼‰
3. æ£€æŸ¥å›¢çŠ¶æ€ä¸º"æ‹¼å›¢ä¸­"
4. æŸ¥è¯¢è¢«ç§»é™¤æˆå‘˜
5. æ£€æŸ¥æˆå‘˜æ˜¯å¦å±äºè¯¥å›¢
6. æ£€æŸ¥ä¸èƒ½ç§»é™¤å›¢é•¿æœ¬äºº
7. åˆ é™¤å‚å›¢è®°å½•
8. æ›´æ–°å›¢äººæ•°ï¼ˆcurrent_num--ï¼‰
9. é€€æ¬¾ç»™è¢«ç§»é™¤æˆå‘˜ï¼ˆFeignè°ƒç”¨OrderServiceï¼‰
10. æ›´æ–°è®¢å•çŠ¶æ€ä¸º"å·²é€€æ¬¾"

**é”™è¯¯å“åº”**:
```json
// éå›¢é•¿æ“ä½œ
{
  "code": 403,
  "message": "ä»…å›¢é•¿å¯ä»¥ç§»é™¤æˆå‘˜",
  "data": null,
  "timestamp": "2025-11-07T20:00:00"
}

// å°è¯•ç§»é™¤å›¢é•¿æœ¬äºº
{
  "code": 409,
  "message": "ä¸èƒ½ç§»é™¤å›¢é•¿æœ¬äºº",
  "data": null,
  "timestamp": "2025-11-07T20:00:00"
}

// å›¢å·²ç»“æŸ
{
  "code": 409,
  "message": "è¯¥æ‹¼å›¢å·²ç»“æŸï¼Œå½“å‰çŠ¶æ€ï¼šå·²æˆå›¢",
  "data": null,
  "timestamp": "2025-11-07T20:00:00"
}
```

---

## 7. æŸ¥è¯¢æ¥å£

### 7.1 è·å–å›¢è¯¦æƒ…

**æ¥å£**: `GET /api/groupbuy/team/{teamId}/detail`  
**æƒé™**: æ—   
**é‰´æƒ**: ä¸éœ€è¦Token

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "teamId": 1,
    "teamNo": "T20251031001",
    "activityId": 1,
    "activityName": "æ‹¼å›¢æ´»åŠ¨-1",
    "groupPrice": 19.90,
    "leaderId": 1,
    "leaderName": "å¼ å›¢é•¿",
    "communityId": 10,
    "communityName": "å¹¸ç¦å°åŒº",
    "requiredNum": 3,
    "currentNum": 3,
    "remainNum": 0,
    "teamStatus": 1,
    "teamStatusDesc": "å·²æˆå›¢",
    "successTime": "2025-10-31T20:30:00",
    "expireTime": "2025-11-01T20:00:00",
    "createTime": "2025-10-31T20:00:00",
    "members": [
      {
        "memberId": 1,
        "userId": 1,
        "username": "leader123",
        "realName": "å¼ å›¢é•¿",
        "avatar": null,
        "isLauncher": 1,
        "payAmount": 19.90,
        "joinTime": "2025-10-31T20:00:00",
        "status": 2,
        "statusDesc": "å·²æˆå›¢"
      },
      {
        "memberId": 2,
        "userId": 2,
        "username": "user001",
        "realName": "æå››",
        "avatar": null,
        "isLauncher": 0,
        "payAmount": 19.90,
        "joinTime": "2025-10-31T20:05:00",
        "status": 2,
        "statusDesc": "å·²æˆå›¢"
      },
      {
        "memberId": 3,
        "userId": 3,
        "username": "user002",
        "realName": "ç‹äº”",
        "avatar": null,
        "isLauncher": 0,
        "payAmount": 19.90,
        "joinTime": "2025-10-31T20:10:00",
        "status": 2,
        "statusDesc": "å·²æˆå›¢"
      }
    ],
    "shareLink": "http://localhost:5173/team/1"
  },
  "timestamp": "2025-10-31T20:30:00"
}
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| teamStatus | Integer | 0-æ‹¼å›¢ä¸­/1-å·²æˆå›¢/2-å·²å¤±è´¥ |
| remainNum | Integer | è¿˜å·®å‡ äººï¼ˆè®¡ç®—å­—æ®µï¼šrequired_num - current_numï¼‰ |
| members | Array | æˆå‘˜åˆ—è¡¨ï¼ˆæŒ‰å‚å›¢æ—¶é—´å‡åºï¼‰ |
| isLauncher | Integer | æ˜¯å¦å‘èµ·äººï¼ˆ0-å¦/1-æ˜¯ï¼Œæ¯ä¸ªå›¢åªæœ‰1ä¸ªå‘èµ·äººï¼‰ |

---

### 7.2 è·å–æ´»åŠ¨çš„å›¢åˆ—è¡¨ï¼ˆâ­ç¤¾åŒºä¼˜å…ˆæ’åº+çŠ¶æ€ç­›é€‰ï¼‰

**æ¥å£**: `GET /api/groupbuy/activity/{activityId}/teams`  
**æƒé™**: æ—   
**é‰´æƒ**: ä¸éœ€è¦Token

**ç‰¹æ€§**:
- âœ… v3.0ç¤¾åŒºä¼˜å…ˆæ¨è
- âœ… ä¼˜å…ˆæ˜¾ç¤ºæœ¬ç¤¾åŒºçš„å›¢
- âœ… SQL ORDER BY CASEå®ç°
- âœ… â­æ”¯æŒçŠ¶æ€ç­›é€‰ï¼ˆç®¡ç†ç«¯å¯æŸ¥çœ‹æ‰€æœ‰çŠ¶æ€ï¼‰
- âœ… â­æ”¯æŒæŸ¥çœ‹å·²è¿‡æœŸå›¢ï¼ˆç®¡ç†ç«¯ï¼‰
- âœ… é»˜è®¤åªè¿”å›æ‹¼å›¢ä¸­ä¸”æœªè¿‡æœŸçš„å›¢ï¼ˆCç«¯ï¼‰

**è¯·æ±‚ç¤ºä¾‹**:
```bash
# Cç«¯ï¼šæŸ¥è¯¢æ‹¼å›¢ä¸­ä¸”æœªè¿‡æœŸçš„å›¢ï¼ˆç¤¾åŒºä¼˜å…ˆï¼‰
GET /api/groupbuy/activity/1/teams?communityId=10

# ç®¡ç†ç«¯ï¼šæŸ¥è¯¢æ‰€æœ‰æ‹¼å›¢ä¸­çš„å›¢ï¼ˆåŒ…æ‹¬å·²è¿‡æœŸï¼‰
GET /api/groupbuy/activity/1/teams?status=0&includeExpired=true

# ç®¡ç†ç«¯ï¼šæŸ¥è¯¢å·²æˆå›¢çš„è®°å½•
GET /api/groupbuy/activity/1/teams?status=1&includeExpired=true

# ç®¡ç†ç«¯ï¼šæŸ¥è¯¢æ‰€æœ‰çŠ¶æ€çš„å›¢ï¼ˆä¸ä¼ statuså‚æ•°é»˜è®¤æ˜¾ç¤ºæ‹¼å›¢ä¸­ï¼‰
GET /api/groupbuy/activity/1/teams?includeExpired=true
```

**è¯·æ±‚å‚æ•°**:

| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|------|------|--------|------|
| communityId | Long | âŒ | null | ç”¨æˆ·çš„ç¤¾åŒºIDï¼ˆä¼ å…¥åä¼˜å…ˆæ˜¾ç¤ºæœ¬ç¤¾åŒºå›¢ï¼‰ |
| status | Integer | âŒ | null | å›¢çŠ¶æ€ï¼ˆ0-æ‹¼å›¢ä¸­, 1-å·²æˆå›¢, 2-å·²å¤±è´¥ï¼Œnull-é»˜è®¤åªæ˜¾ç¤ºæ‹¼å›¢ä¸­ï¼‰â­æ–°å¢ |
| includeExpired | Boolean | âŒ | false | æ˜¯å¦åŒ…å«å·²è¿‡æœŸçš„å›¢ï¼ˆtrue-åŒ…å«ï¼Œfalse-åªæ˜¾ç¤ºæœªè¿‡æœŸï¼‰â­æ–°å¢ |

**SQLå®ç°**ï¼ˆâ­æŠ€æœ¯äº®ç‚¹ï¼‰:
```sql
SELECT * FROM group_buy_team t
WHERE t.activity_id = :activityId
  AND t.team_status = 0
  AND t.expire_time > NOW()
ORDER BY 
  CASE WHEN t.community_id = :communityId THEN 0 ELSE 1 END ASC,
  t.create_time DESC
LIMIT 20
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": [
    {
      "teamId": 1,
      "teamNo": "T20251031001",
      "communityId": 10,
      "communityName": "å¹¸ç¦å°åŒº",
      "currentNum": 2,
      "requiredNum": 3,
      "remainNum": 1,
      "teamStatus": 0,
      "teamStatusDesc": "æ‹¼å›¢ä¸­",
      "expireTime": "2025-11-01T20:00:00",
      "createTime": "2025-10-31T20:00:00"
    },
    {
      "teamId": 2,
      "teamNo": "T20251031002",
      "communityId": 11,
      "communityName": "é˜³å…‰å°åŒº",
      "currentNum": 1,
      "requiredNum": 3,
      "remainNum": 2,
      "teamStatus": 0,
      "teamStatusDesc": "æ‹¼å›¢ä¸­",
      "expireTime": "2025-11-01T20:30:00",
      "createTime": "2025-10-31T20:30:00"
    }
  ],
  "timestamp": "2025-10-31T21:00:00"
}
```

**æ’åºè§„åˆ™**ï¼ˆv3.0ï¼‰:
1. **ä¼˜å…ˆçº§1**: communityIdåŒ¹é…çš„å›¢æ’åœ¨å‰é¢ï¼ˆCASE WHEN = 0ï¼‰
2. **ä¼˜å…ˆçº§2**: å…¶ä»–ç¤¾åŒºçš„å›¢æ’åœ¨åé¢ï¼ˆCASE WHEN = 1ï¼‰
3. **ä¼˜å…ˆçº§3**: åŒä¸€ä¼˜å…ˆçº§å†…æŒ‰åˆ›å»ºæ—¶é—´å€’åº

**ç¤ºä¾‹è¯´æ˜**:
- ç”¨æˆ·ä¼ å…¥`communityId=10`
- å›¢1ï¼ˆcommunityId=10ï¼‰æ’åœ¨å‰é¢â­
- å›¢2ï¼ˆcommunityId=11ï¼‰æ’åœ¨åé¢

---

### 7.3 æ ¹æ®å•†å“IDè·å–æ‹¼å›¢æ´»åŠ¨ï¼ˆâ­å•†å“è¯¦æƒ…é¡µä¸“ç”¨ï¼‰

**æ¥å£**: `GET /api/groupbuy/product/{productId}/activities`  
**æƒé™**: æ—   
**é‰´æƒ**: ä¸éœ€è¦Token  
**ç‰ˆæœ¬**: v1.0.1 æ–°å¢

**ç‰¹æ€§**:
- âœ… è¿”å›è¯¥å•†å“çš„æ‰€æœ‰è¿›è¡Œä¸­æ‹¼å›¢æ´»åŠ¨
- âœ… æ¯ä¸ªæ´»åŠ¨åŒ…å«è¿›è¡Œä¸­çš„å›¢åˆ—è¡¨ï¼ˆæœ€å¤š10ä¸ªï¼‰
- âœ… æ”¯æŒç¤¾åŒºä¼˜å…ˆæ’åº
- âœ… æ— éœ€ç™»å½•å³å¯è®¿é—®
- âœ… ç”¨äºå•†å“è¯¦æƒ…é¡µå±•ç¤ºæ‹¼å›¢ä¿¡æ¯

**è¯·æ±‚ç¤ºä¾‹**:
```bash
GET /api/groupbuy/product/1/activities?communityId=1
```

**è¯·æ±‚å‚æ•°**:

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|-----|------|------|------|
| productId | Long | âœ… | å•†å“IDï¼ˆè·¯å¾„å‚æ•°ï¼‰ |
| communityId | Long | âŒ | ç”¨æˆ·ç¤¾åŒºIDï¼ˆå¯é€‰ï¼Œç”¨äºç¤¾åŒºä¼˜å…ˆæ’åºï¼‰ |

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": [
    {
      "activityId": 1,
      "productId": 1,
      "groupPrice": 19.90,
      "requiredNum": 3,
      "maxNum": 100,
      "startTime": "2025-10-31T00:00:00",
      "endTime": "2025-12-31T23:59:59",
      "status": 1,
      "teams": [
        {
          "teamId": 5001,
          "teamNo": "T20251101001",
          "leaderId": 2001,
          "leaderName": "å¼ å›¢é•¿",
          "communityId": 1,
          "communityName": "é˜³å…‰å°åŒº",
          "requiredNum": 3,
          "currentNum": 2,
          "teamStatus": 0,
          "expireTime": "2025-11-02T12:00:00",
          "createTime": "2025-11-01T12:00:00"
        },
        {
          "teamId": 5002,
          "teamNo": "T20251101002",
          "leaderId": 2002,
          "leaderName": "æå›¢é•¿",
          "communityId": 2,
          "communityName": "å¹¸ç¦å°åŒº",
          "requiredNum": 3,
          "currentNum": 1,
          "teamStatus": 0,
          "expireTime": "2025-11-02T14:00:00",
          "createTime": "2025-11-01T14:00:00"
        }
      ]
    },
    {
      "activityId": 2,
      "productId": 1,
      "groupPrice": 18.90,
      "requiredNum": 2,
      "maxNum": 50,
      "startTime": "2025-11-01T00:00:00",
      "endTime": "2025-11-30T23:59:59",
      "status": 1,
      "teams": []
    }
  ],
  "timestamp": "2025-11-01T18:30:00"
}
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| activityId | Long | æ´»åŠ¨ID |
| productId | Long | å•†å“ID |
| groupPrice | BigDecimal | æ‹¼å›¢ä»· |
| requiredNum | Integer | æˆå›¢äººæ•° |
| maxNum | Integer | æœ€å¤§äººæ•°é™åˆ¶ |
| startTime | String | æ´»åŠ¨å¼€å§‹æ—¶é—´ |
| endTime | String | æ´»åŠ¨ç»“æŸæ—¶é—´ |
| status | Integer | æ´»åŠ¨çŠ¶æ€ï¼ˆ1-è¿›è¡Œä¸­ï¼‰ |
| teams | Array | è¯¥æ´»åŠ¨çš„å›¢åˆ—è¡¨ï¼ˆè¿›è¡Œä¸­çš„å›¢ï¼Œæœ€å¤š10ä¸ªï¼‰ |

**å›¢ä¿¡æ¯å­—æ®µ**:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| teamId | Long | å›¢ID |
| teamNo | String | å›¢å· |
| leaderId | Long | å›¢é•¿ID |
| leaderName | String | å›¢é•¿å§“å |
| communityId | Long | ç¤¾åŒºID |
| communityName | String | ç¤¾åŒºåç§° |
| requiredNum | Integer | æˆå›¢äººæ•° |
| currentNum | Integer | å½“å‰äººæ•° |
| teamStatus | Integer | å›¢çŠ¶æ€ï¼ˆ0-æ‹¼å›¢ä¸­/1-å·²æˆå›¢/2-å·²å¤±è´¥ï¼‰ |
| expireTime | String | è¿‡æœŸæ—¶é—´ |
| createTime | String | åˆ›å»ºæ—¶é—´ |

**ä¸šåŠ¡è§„åˆ™**:
1. åªè¿”å›è¿›è¡Œä¸­çš„æ´»åŠ¨ï¼ˆstatus=1ä¸”åœ¨æ—¶é—´èŒƒå›´å†…ï¼‰
2. æ¯ä¸ªæ´»åŠ¨æœ€å¤šè¿”å›10ä¸ªè¿›è¡Œä¸­çš„å›¢
3. å›¢åˆ—è¡¨æ”¯æŒç¤¾åŒºä¼˜å…ˆæ’åºï¼ˆä¼ å…¥communityIdæ—¶ä¼˜å…ˆæ˜¾ç¤ºæœ¬ç¤¾åŒºçš„å›¢ï¼‰
4. å›¢åˆ—è¡¨åªåŒ…å«æ‹¼å›¢ä¸­çš„å›¢ï¼ˆteam_status=0ä¸”æœªè¿‡æœŸï¼‰
5. å¦‚æœæ´»åŠ¨æ— è¿›è¡Œä¸­çš„å›¢ï¼Œteamså­—æ®µä¸ºç©ºæ•°ç»„

**ä½¿ç”¨åœºæ™¯**:
- å•†å“è¯¦æƒ…é¡µå±•ç¤ºæ‹¼å›¢ä¿¡æ¯
- ç”¨æˆ·æµè§ˆå•†å“æ—¶æŸ¥çœ‹å¯å‚ä¸çš„æ‹¼å›¢æ´»åŠ¨å’Œå›¢é˜Ÿ
- æ”¯æŒæœªç™»å½•ç”¨æˆ·æŸ¥çœ‹ï¼ˆæ— éœ€Tokenï¼‰

**å›¢åˆ—è¡¨æ’åºè§„åˆ™**ï¼ˆä¼ å…¥communityIdæ—¶ï¼‰:
1. **ä¼˜å…ˆçº§1**: æœ¬ç¤¾åŒºçš„å›¢æ’åœ¨å‰é¢â­
2. **ä¼˜å…ˆçº§2**: å…¶ä»–ç¤¾åŒºçš„å›¢æ’åœ¨åé¢
3. **ä¼˜å…ˆçº§3**: åŒä¸€ä¼˜å…ˆçº§å†…æŒ‰åˆ›å»ºæ—¶é—´å€’åº

---

### 7.4 æŸ¥è¯¢æˆ‘çš„æ‹¼å›¢è®°å½•ï¼ˆâ­ç”¨æˆ·ç«¯æ ¸å¿ƒæ¥å£ï¼‰

**æ¥å£**: `GET /api/groupbuy/teams/my`  
**æƒé™**: éœ€è¦ç™»å½•  
**é‰´æƒ**: éœ€è¦JWT Token  
**ç‰ˆæœ¬**: v1.0.2 æ›´æ–°ï¼ˆè¿”å›MyTeamResponseï¼‰

**åŠŸèƒ½**: æŸ¥è¯¢å½“å‰ç”¨æˆ·å‚ä¸çš„æ‰€æœ‰æ‹¼å›¢è®°å½•ï¼ŒåŒ…å«å‚å›¢ä¿¡æ¯å’Œå›¢è¯¦æƒ…

**ç‰¹æ€§**:
- âœ… è¿”å›ç”¨æˆ·çš„æ‰€æœ‰å‚å›¢è®°å½•ï¼ˆåŒ…æ‹¬å‘èµ·çš„å’Œå‚ä¸çš„ï¼‰
- âœ… æŒ‰å‚å›¢æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
- âœ… åŒ…å«å®Œæ•´çš„å›¢ä¿¡æ¯ã€å•†å“ä¿¡æ¯ã€æˆå‘˜åˆ—è¡¨
- âœ… è‡ªåŠ¨è°ƒç”¨UserServiceè·å–æˆå‘˜å¤´åƒå’Œç”¨æˆ·å
- âœ… æ”¯æŒçŠ¶æ€ç­›é€‰ï¼ˆå‰ç«¯å®ç°ï¼‰

**è¯·æ±‚ç¤ºä¾‹**:
```bash
GET /api/groupbuy/teams/my
Authorization: Bearer {your_jwt_token}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": [
    {
      "memberId": 1,
      "isLauncher": 1,
      "payAmount": 19.90,
      "joinTime": "2025-11-07T14:00:00",
      "orderId": 8001,
      "teamId": 1,
      "teamNo": "T20251107001",
      "activityId": 1,
      "activityName": "æœ‰æœºè”¬èœæ‹¼å›¢",
      "productId": 101,
      "productName": "æœ‰æœºè”¬èœ",
      "productCoverImg": "http://localhost:8062/uploads/product/veg001.jpg",
      "productPrice": 28.00,
      "groupPrice": 19.90,
      "leaderId": 3,
      "leaderName": "å¼ å›¢é•¿",
      "communityId": 1,
      "communityName": "é˜³å…‰å°åŒº",
      "requiredNum": 3,
      "currentNum": 2,
      "teamStatus": 0,
      "teamStatusDesc": "æ‹¼å›¢ä¸­",
      "successTime": null,
      "expireTime": "2025-11-08T14:00:00",
      "createTime": "2025-11-07T14:00:00",
      "members": [
        {
          "memberId": 1,
          "userId": 3,
          "username": "leader123",
          "realName": "å¼ å›¢é•¿",
          "avatar": "http://localhost:8061/uploads/user/avatar001.jpg",
          "isLauncher": 1,
          "payAmount": 19.90,
          "joinTime": "2025-11-07T14:00:00",
          "status": 1,
          "statusDesc": "å·²æ”¯ä»˜"
        },
        {
          "memberId": 2,
          "userId": 4,
          "username": "user001",
          "realName": "æå››",
          "avatar": "http://localhost:8061/uploads/user/avatar002.jpg",
          "isLauncher": 0,
          "payAmount": 19.90,
          "joinTime": "2025-11-07T14:05:00",
          "status": 1,
          "statusDesc": "å·²æ”¯ä»˜"
        }
      ],
      "shareLink": "http://localhost:5173/team/1"
    },
    {
      "memberId": 3,
      "isLauncher": 0,
      "payAmount": 29.90,
      "joinTime": "2025-11-06T10:00:00",
      "orderId": 8002,
      "teamId": 5,
      "teamNo": "T20251106001",
      "activityId": 2,
      "activityName": "æ°´æœæ‹¼å›¢",
      "productId": 102,
      "productName": "è¿›å£æ°´æœ",
      "productCoverImg": "http://localhost:8062/uploads/product/fruit001.jpg",
      "productPrice": 38.00,
      "groupPrice": 29.90,
      "leaderId": 2,
      "leaderName": "ç‹å›¢é•¿",
      "communityId": 2,
      "communityName": "å¹¸ç¦å°åŒº",
      "requiredNum": 3,
      "currentNum": 3,
      "teamStatus": 1,
      "teamStatusDesc": "å·²æˆå›¢",
      "successTime": "2025-11-06T10:30:00",
      "expireTime": "2025-11-07T10:00:00",
      "createTime": "2025-11-06T10:00:00",
      "members": [
        {
          "memberId": 4,
          "userId": 2,
          "username": "leader456",
          "realName": "ç‹å›¢é•¿",
          "avatar": "http://localhost:8061/uploads/user/avatar003.jpg",
          "isLauncher": 1,
          "payAmount": 29.90,
          "joinTime": "2025-11-06T10:00:00",
          "status": 2,
          "statusDesc": "å·²æˆå›¢"
        },
        {
          "memberId": 3,
          "userId": 4,
          "username": "user001",
          "realName": "æå››",
          "avatar": "http://localhost:8061/uploads/user/avatar002.jpg",
          "isLauncher": 0,
          "payAmount": 29.90,
          "joinTime": "2025-11-06T10:00:00",
          "status": 2,
          "statusDesc": "å·²æˆå›¢"
        },
        {
          "memberId": 5,
          "userId": 5,
          "username": "user002",
          "realName": "ç‹äº”",
          "avatar": "http://localhost:8061/uploads/user/avatar004.jpg",
          "isLauncher": 0,
          "payAmount": 29.90,
          "joinTime": "2025-11-06T10:15:00",
          "status": 2,
          "statusDesc": "å·²æˆå›¢"
        }
      ],
      "shareLink": "http://localhost:5173/team/5"
    }
  ],
  "timestamp": "2025-11-07T21:30:00"
}
```

**å­—æ®µè¯´æ˜**:

**å‚å›¢è®°å½•å­—æ®µ**ï¼ˆMyTeamResponseï¼‰:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| memberId | Long | å‚å›¢è®°å½•ID |
| isLauncher | Integer | æ˜¯å¦å‘èµ·äººï¼ˆ0-å¦/1-æ˜¯ï¼‰ |
| payAmount | BigDecimal | ç”¨æˆ·æ”¯ä»˜é‡‘é¢ |
| joinTime | LocalDateTime | ç”¨æˆ·å‚å›¢æ—¶é—´ |
| orderId | Long | è®¢å•ID |

**å›¢ä¿¡æ¯å­—æ®µ**:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| teamId | Long | å›¢ID |
| teamNo | String | å›¢å· |
| activityId | Long | æ´»åŠ¨ID |
| activityName | String | æ´»åŠ¨åç§° |
| productId | Long | å•†å“ID |
| productName | String | å•†å“åç§° |
| productCoverImg | String | å•†å“å°é¢å›¾ |
| productPrice | BigDecimal | å•†å“åŸä»· |
| groupPrice | BigDecimal | æ‹¼å›¢ä»· |
| leaderId | Long | å›¢é•¿ID |
| leaderName | String | å›¢é•¿å§“å |
| communityId | Long | ç¤¾åŒºID |
| communityName | String | ç¤¾åŒºåç§° |
| requiredNum | Integer | æˆå›¢äººæ•° |
| currentNum | Integer | å½“å‰äººæ•° |
| teamStatus | Integer | å›¢çŠ¶æ€ï¼ˆ0-æ‹¼å›¢ä¸­/1-å·²æˆå›¢/2-å·²å¤±è´¥ï¼‰ |
| teamStatusDesc | String | å›¢çŠ¶æ€æè¿° |
| successTime | LocalDateTime | æˆå›¢æ—¶é—´ |
| expireTime | LocalDateTime | è¿‡æœŸæ—¶é—´ |
| createTime | LocalDateTime | åˆ›å»ºæ—¶é—´ |
| members | Array | å›¢é˜Ÿæˆå‘˜åˆ—è¡¨ |
| shareLink | String | åˆ†äº«é“¾æ¥ |

**æˆå‘˜ä¿¡æ¯å­—æ®µ**ï¼ˆMemberInfoResponseï¼‰:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| memberId | Long | å‚å›¢è®°å½•ID |
| userId | Long | ç”¨æˆ·ID |
| username | String | ç”¨æˆ·åï¼ˆä»UserServiceè·å–ï¼‰ |
| realName | String | çœŸå®å§“åï¼ˆä»UserServiceè·å–ï¼‰ |
| avatar | String | å¤´åƒURLï¼ˆä»UserServiceè·å–ï¼‰ |
| isLauncher | Integer | æ˜¯å¦å‘èµ·äººï¼ˆ0-å¦/1-æ˜¯ï¼‰ |
| payAmount | BigDecimal | æ”¯ä»˜é‡‘é¢ |
| joinTime | LocalDateTime | å‚å›¢æ—¶é—´ |
| status | Integer | å‚å›¢çŠ¶æ€ï¼ˆ0-å¾…æ”¯ä»˜/1-å·²æ”¯ä»˜/2-å·²æˆå›¢/3-å·²å–æ¶ˆï¼‰ |
| statusDesc | String | å‚å›¢çŠ¶æ€æè¿° |

**å›¢çŠ¶æ€è¯´æ˜**:

| çŠ¶æ€ç  | çŠ¶æ€æè¿° | è¯´æ˜ |
|-------|---------|------|
| 0 | æ‹¼å›¢ä¸­ | å›¢æ­£åœ¨æ‹›å‹Ÿæˆå‘˜ï¼Œæœªè¾¾æˆå›¢äººæ•° |
| 1 | å·²æˆå›¢ | å·²è¾¾æˆå›¢äººæ•°ï¼Œæ‹¼å›¢æˆåŠŸ |
| 2 | å·²å¤±è´¥ | è¶…æ—¶æœªæˆå›¢æˆ–å…¶ä»–åŸå› å¯¼è‡´å¤±è´¥ |

**å‚å›¢çŠ¶æ€è¯´æ˜**:

| çŠ¶æ€ç  | çŠ¶æ€æè¿° | è¯´æ˜ |
|-------|---------|------|
| 0 | å¾…æ”¯ä»˜ | ç”¨æˆ·å·²å‚å›¢ä½†æœªæ”¯ä»˜ |
| 1 | å·²æ”¯ä»˜ | ç”¨æˆ·å·²æ”¯ä»˜ï¼Œç­‰å¾…æˆå›¢ |
| 2 | å·²æˆå›¢ | æ‹¼å›¢æˆåŠŸï¼Œè®¢å•è¿›å…¥å¾…å‘è´§ |
| 3 | å·²å–æ¶ˆ | ç”¨æˆ·ä¸»åŠ¨é€€å‡ºæˆ–æ‹¼å›¢å¤±è´¥é€€æ¬¾ |

**ä¸šåŠ¡é€»è¾‘**:

1. ä»è¯·æ±‚å¤´è·å–ç”¨æˆ·IDï¼ˆX-User-Idï¼‰
2. æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰å‚å›¢è®°å½•ï¼ˆgroup_buy_memberè¡¨ï¼‰
3. æŒ‰å‚å›¢æ—¶é—´å€’åºæ’åˆ—
4. å¯¹æ¯æ¡è®°å½•ï¼š
   - æŸ¥è¯¢å›¢ä¿¡æ¯ï¼ˆgroup_buy_teamè¡¨ï¼‰
   - æŸ¥è¯¢æ´»åŠ¨ä¿¡æ¯ï¼ˆgroup_buy_activityè¡¨ï¼‰
   - è°ƒç”¨ProductServiceè·å–å•†å“ä¿¡æ¯ï¼ˆåŒ…å«å•†å“å›¾ç‰‡ï¼‰
   - è°ƒç”¨UserServiceè·å–å›¢é•¿ä¿¡æ¯
   - è°ƒç”¨LeaderServiceè·å–ç¤¾åŒºä¿¡æ¯
   - æŸ¥è¯¢å›¢çš„æ‰€æœ‰æˆå‘˜
   - è°ƒç”¨UserServiceè·å–æ¯ä¸ªæˆå‘˜çš„è¯¦ç»†ä¿¡æ¯ï¼ˆå¤´åƒã€ç”¨æˆ·åï¼‰â­
5. æ„å»ºMyTeamResponseå“åº”

**æŠ€æœ¯äº®ç‚¹**:

- âœ… **è·¨æœåŠ¡è°ƒç”¨**: è°ƒç”¨UserServiceã€ProductServiceã€LeaderServiceè·å–å®Œæ•´ä¿¡æ¯
- âœ… **å¼‚å¸¸å®¹é”™**: UserServiceè°ƒç”¨å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å€¼ï¼ˆ"ç”¨æˆ·{userId}"ï¼‰
- âœ… **æ€§èƒ½ä¼˜åŒ–**: æ‰¹é‡æŸ¥è¯¢æˆå‘˜ï¼Œå‡å°‘æ•°æ®åº“è®¿é—®
- âœ… **æ•°æ®å®Œæ•´æ€§**: åŒ…å«å‚å›¢è®°å½•ã€å›¢ä¿¡æ¯ã€å•†å“ä¿¡æ¯ã€æˆå‘˜è¯¦æƒ…

**ä½¿ç”¨åœºæ™¯**:

- ç”¨æˆ·ç«¯"æˆ‘çš„æ‹¼å›¢"é¡µé¢
- æŸ¥çœ‹å‚ä¸çš„æ‰€æœ‰æ‹¼å›¢è®°å½•
- æŸ¥çœ‹æ‹¼å›¢è¿›åº¦å’ŒçŠ¶æ€
- é‚€è¯·å¥½å‹å‚å›¢
- é€€å‡ºæ‹¼å›¢

**é”™è¯¯å“åº”**:

```json
{
  "code": 401,
  "message": "æœªç™»å½•",
  "data": null,
  "timestamp": "2025-11-07T21:30:00"
}
```

**æ³¨æ„äº‹é¡¹**:

1. éœ€è¦JWT Tokenè®¤è¯
2. è¿”å›çš„æ˜¯ç”¨æˆ·çš„å‚å›¢è®°å½•ï¼Œä¸æ˜¯å›¢åˆ—è¡¨
3. æ¯æ¡è®°å½•åŒ…å«ç”¨æˆ·çš„å‚å›¢ä¿¡æ¯ï¼ˆmemberIdã€isLauncherã€payAmountã€joinTimeã€orderIdï¼‰
4. membersæ•°ç»„åŒ…å«è¯¥å›¢çš„æ‰€æœ‰æˆå‘˜è¯¦ç»†ä¿¡æ¯
5. å¤´åƒã€ç”¨æˆ·åç­‰ä¿¡æ¯é€šè¿‡UserServiceå®æ—¶è·å–ï¼Œç¡®ä¿æ•°æ®æœ€æ–°

---

## 8. å®šæ—¶ä»»åŠ¡

### 8.1 è¿‡æœŸå›¢æ£€æŸ¥ä»»åŠ¡ï¼ˆâ­æ ¸å¿ƒä»»åŠ¡ï¼‰

**æ‰§è¡Œæ—¶é—´**: æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡  
**Cronè¡¨è¾¾å¼**: `0 0 * * * ?`  
**ä»»åŠ¡ç±»**: `TeamExpireTask.java`

**åŠŸèƒ½**:
- âœ… æŸ¥è¯¢è¿‡æœŸçš„å›¢ï¼ˆteam_status=0 ä¸” expire_time < nowï¼‰
- âœ… éå†é€€æ¬¾ï¼ˆå¹‚ç­‰æ€§ä¿è¯ï¼‰
- âœ… å¼‚å¸¸éš”ç¦»ï¼ˆå•ä¸ªå›¢å¤±è´¥ä¸å½±å“å…¶ä»–å›¢ï¼‰

**æ‰§è¡Œæµç¨‹**:
```
1. æŸ¥è¯¢è¿‡æœŸå›¢IDåˆ—è¡¨
   â†“
2. éå†æ¯ä¸ªå›¢ï¼ˆtry-catchæ•è·å¼‚å¸¸ï¼‰
   â†“
3. æŸ¥è¯¢å›¢ï¼ˆåŠ è¡Œé”ï¼‰â­
   â†“
4. å¹‚ç­‰æ€§æ£€æŸ¥ï¼ˆteam_status != JOINING åˆ™è·³è¿‡ï¼‰â­
   â†“
5. æ ‡è®°å›¢å¤±è´¥ï¼ˆJOINING â†’ FAILEDï¼‰
   â†“
6. æŸ¥è¯¢å·²æ”¯ä»˜çš„æˆå‘˜ï¼ˆstatus=1ï¼‰
   â†“
7. éå†é€€æ¬¾ï¼š
   - Feigné€€æ¬¾åˆ°ç”¨æˆ·ä½™é¢
   - Feignæ›´æ–°è®¢å•çŠ¶æ€ä¸º"å·²é€€æ¬¾"
   - æ›´æ–°å‚å›¢çŠ¶æ€ä¸º"å·²å–æ¶ˆ"
   â†“
8. å‘é€æ‹¼å›¢å¤±è´¥é€šçŸ¥ï¼ˆTODOï¼‰
```

**æ—¥å¿—ç¤ºä¾‹**:
```
====================================
å¼€å§‹æ£€æŸ¥è¿‡æœŸå›¢ï¼Œå½“å‰æ—¶é—´ï¼š2025-11-01T20:00:00
====================================
å‘ç°2ä¸ªè¿‡æœŸå›¢éœ€è¦å¤„ç†ï¼š[1, 2]
âœ… å›¢1é€€æ¬¾æˆåŠŸ
âœ… å›¢2é€€æ¬¾æˆåŠŸ
====================================
è¿‡æœŸå›¢å¤„ç†å®Œæˆ
æ€»è®¡ï¼š2ä¸ªï¼ŒæˆåŠŸï¼š2ä¸ªï¼Œå¤±è´¥ï¼š0ä¸ª
æˆåŠŸç‡ï¼š100%
====================================
```

**æŠ€æœ¯äº®ç‚¹**:
- âœ… å¹‚ç­‰æ€§è®¾è®¡ï¼šè¡Œé” + çŠ¶æ€æ£€æŸ¥
- âœ… å¼‚å¸¸éš”ç¦»ï¼štry-catchæ•è·å•ä¸ªå›¢å¼‚å¸¸
- âœ… äº‹åŠ¡ç‹¬ç«‹ï¼šæ¯ä¸ªå›¢å•ç‹¬äº‹åŠ¡å¤„ç†
- âœ… é«˜å¯ç”¨ï¼šå¤±è´¥ä¸å½±å“å…¶ä»–å›¢

---

## 9. Swaggeræ–‡æ¡£

### 9.1 è®¿é—®åœ°å€

**ç›´è¿è®¿é—®**:
```
http://localhost:8063/swagger-ui.html
```

**é€šè¿‡ç½‘å…³è®¿é—®**:
```
http://localhost:9000/swagger-ui.html
```

### 9.2 API Docs

**JSONæ ¼å¼**:
```
http://localhost:8063/v3/api-docs
```

### 9.3 æ¥å£åˆ†ç»„

Swagger UIå°†æ¥å£åˆ†ä¸ºä»¥ä¸‹åˆ†ç»„ï¼š

- **æ‹¼å›¢ç®¡ç†** (`TeamController`)
  - å›¢é•¿å‘èµ·æ‹¼å›¢
  - ç”¨æˆ·å‚ä¸æ‹¼å›¢
  - æ”¯ä»˜å›è°ƒ
  - è·å–å›¢è¯¦æƒ…
  - è·å–æ´»åŠ¨å›¢åˆ—è¡¨
  - é€€å‡ºæ‹¼å›¢

- **æ‹¼å›¢æ´»åŠ¨ç®¡ç†** (`ActivityController`)
  - åˆ›å»ºæ´»åŠ¨
  - æ›´æ–°æ´»åŠ¨
  - åˆ é™¤æ´»åŠ¨
  - è·å–æ´»åŠ¨åˆ—è¡¨
  - è·å–æ´»åŠ¨è¯¦æƒ…

---

## 10. ä½¿ç”¨ç¤ºä¾‹

### 10.1 å®Œæ•´æ‹¼å›¢æµç¨‹

#### æ­¥éª¤1: ç®¡ç†å‘˜åˆ›å»ºæ´»åŠ¨

```bash
POST http://localhost:9000/api/groupbuy/activity
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  "productId": 1,
  "groupPrice": 19.90,
  "requiredNum": 3,
  "startTime": "2025-10-31T00:00:00",
  "endTime": "2025-12-31T23:59:59"
}
```

#### æ­¥éª¤2: å›¢é•¿å‘èµ·æ‹¼å›¢

```bash
POST http://localhost:9000/api/groupbuy/team/launch
Authorization: Bearer {leader_token}
Content-Type: application/json

{
  "activityId": 1,
  "joinImmediately": true,
  "addressId": 1,
  "quantity": 1
}

# å“åº”ï¼šteamId=1, orderId=8001
```

#### æ­¥éª¤3: ç”¨æˆ·1å‚å›¢

```bash
POST http://localhost:9000/api/groupbuy/team/join
Authorization: Bearer {user1_token}
Content-Type: application/json

{
  "teamId": 1,
  "addressId": 2,
  "quantity": 1
}

# å“åº”ï¼šorderId=8002, currentNum=2, remainNum=1
```

#### æ­¥éª¤4: ç”¨æˆ·2å‚å›¢ï¼ˆæ»¡3äººï¼‰

```bash
POST http://localhost:9000/api/groupbuy/team/join
Authorization: Bearer {user2_token}
Content-Type: application/json

{
  "teamId": 1,
  "addressId": 3,
  "quantity": 1
}

# å“åº”ï¼šorderId=8003, currentNum=3, remainNum=0
```

#### æ­¥éª¤5: æ¨¡æ‹Ÿæ”¯ä»˜å›è°ƒï¼ˆ3æ¬¡ï¼‰

```bash
# å›¢é•¿æ”¯ä»˜
POST http://localhost:9000/api/groupbuy/payment/callback?orderId=8001

# ç”¨æˆ·1æ”¯ä»˜
POST http://localhost:9000/api/groupbuy/payment/callback?orderId=8002

# ç”¨æˆ·2æ”¯ä»˜ï¼ˆè§¦å‘æˆå›¢ï¼‰â­
POST http://localhost:9000/api/groupbuy/payment/callback?orderId=8003
```

**æˆå›¢åè‡ªåŠ¨æ‰§è¡Œ**:
1. æ›´æ–°å›¢çŠ¶æ€ä¸º"å·²æˆå›¢"ï¼ˆteam_status=1ï¼‰
2. æ›´æ–°æ‰€æœ‰æˆå‘˜çŠ¶æ€ä¸º"å·²æˆå›¢"ï¼ˆstatus=2ï¼‰
3. Feignæ‰¹é‡æ›´æ–°è®¢å•çŠ¶æ€ä¸º"å¾…å‘è´§"ï¼ˆorder_status=1ï¼‰

#### æ­¥éª¤6: æŸ¥è¯¢å›¢è¯¦æƒ…ï¼ˆéªŒè¯æˆå›¢ï¼‰

```bash
GET http://localhost:9000/api/groupbuy/team/1/detail

# å“åº”ï¼šteamStatus=1, teamStatusDesc="å·²æˆå›¢"
```

---

### 10.2 ç¤¾åŒºä¼˜å…ˆæ¨èç¤ºä¾‹

```bash
# ç”¨æˆ·Aï¼ˆcommunityId=10ï¼‰æŸ¥è¯¢æ´»åŠ¨1çš„å›¢åˆ—è¡¨
GET http://localhost:9000/api/groupbuy/activity/1/teams?communityId=10

# é¢„æœŸç»“æœï¼š
# 1. communityId=10çš„å›¢æ’åœ¨å‰é¢ï¼ˆæœ¬ç¤¾åŒºä¼˜å…ˆï¼‰â­
# 2. å…¶ä»–ç¤¾åŒºçš„å›¢æ’åœ¨åé¢
# 3. åŒä¸€ä¼˜å…ˆçº§å†…æŒ‰åˆ›å»ºæ—¶é—´å€’åº
```

---

### 10.3 é€€å‡ºæ‹¼å›¢ç¤ºä¾‹

```bash
# ç”¨æˆ·åœ¨æˆå›¢å‰é€€å‡º
POST http://localhost:9000/api/groupbuy/team/quit?teamId=1
Authorization: Bearer {user_token}

# å“åº”ï¼š
# {
#   "code": 200,
#   "message": "é€€å‡ºæˆåŠŸï¼Œå·²é€€æ¬¾"
# }

# ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œï¼š
# 1. åˆ é™¤å‚å›¢è®°å½•
# 2. æ›´æ–°å›¢äººæ•°ï¼ˆcurrent_num--ï¼‰
# 3. é€€æ¬¾åˆ°ç”¨æˆ·ä½™é¢
# 4. æ›´æ–°è®¢å•çŠ¶æ€ä¸º"å·²é€€æ¬¾"
```

---

## 11. å¸¸è§é—®é¢˜

### 11.1 å¦‚ä½•éªŒè¯å›¢é•¿èº«ä»½ï¼Ÿ

**ç­”**: GroupBuyServiceé€šè¿‡Feignè°ƒç”¨UserServiceçš„`getUserInfo`æ¥å£è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œæ£€æŸ¥`role`å­—æ®µæ˜¯å¦ä¸º2ã€‚

```java
Result<UserInfoDTO> userResult = userServiceClient.getUserInfo(userId);
UserInfoDTO user = userResult.getData();
if (user.getRole() != 2) {
    throw new BusinessException("ä»…å›¢é•¿å¯å‘èµ·æ‹¼å›¢");
}
```

### 11.2 å¦‚ä½•ä¿è¯å¹¶å‘å®‰å…¨ï¼Ÿ

**ç­”**: ä½¿ç”¨æ•°æ®åº“è¡Œé”ï¼ˆSELECT ... FOR UPDATEï¼‰ä»£æ›¿Redisåˆ†å¸ƒå¼é”ã€‚

```java
// æŸ¥è¯¢å›¢å¹¶åŠ è¡Œé”
@Query("SELECT t FROM GroupBuyTeam t WHERE t.teamId = :teamId")
@Lock(LockModeType.PESSIMISTIC_WRITE)
Optional<GroupBuyTeam> findByIdForUpdate(@Param("teamId") Long teamId);

// åº”ç”¨åœºæ™¯ï¼š
// 1. ç”¨æˆ·å‚å›¢æ—¶é”å®šå›¢è®°å½•
// 2. æ”¯ä»˜å›è°ƒæ—¶é”å®šå‚å›¢è®°å½•å’Œå›¢è®°å½•
// 3. å®šæ—¶ä»»åŠ¡å¤„ç†è¿‡æœŸå›¢æ—¶é”å®šå›¢è®°å½•
```

### 11.3 å¦‚ä½•ä¿è¯å¹‚ç­‰æ€§ï¼Ÿ

**ç­”**: ä¸‰å±‚å¹‚ç­‰æ€§è®¾è®¡ï¼ˆçŠ¶æ€æ£€æŸ¥ + è¡Œé”ï¼‰ã€‚

```java
// 1. æ”¯ä»˜å›è°ƒå¹‚ç­‰æ€§
if (member.getStatus() != MemberStatus.UNPAID.getCode()) {
    return;  // å·²å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›
}

// 2. æˆå›¢é€»è¾‘å¹‚ç­‰æ€§
if (team.getTeamStatus() != TeamStatus.JOINING.getCode()) {
    return;  // å·²å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›
}

// 3. å®šæ—¶ä»»åŠ¡å¹‚ç­‰æ€§
if (team.getTeamStatus() != TeamStatus.JOINING.getCode()) {
    return;  // å·²å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›
}
```

### 11.4 ç¤¾åŒºä¼˜å…ˆæ’åºå¦‚ä½•å®ç°ï¼Ÿ

**ç­”**: ä½¿ç”¨SQL `ORDER BY CASE` å®ç°ã€‚

```sql
ORDER BY 
  CASE WHEN t.community_id = :communityId THEN 0 ELSE 1 END ASC,
  t.create_time DESC
```

### 11.5 å®šæ—¶ä»»åŠ¡å¦‚ä½•ä¿è¯å¼‚å¸¸éš”ç¦»ï¼Ÿ

**ç­”**: try-catchæ•è·å•ä¸ªå›¢çš„å¼‚å¸¸ï¼Œä¸æŠ›å‡ºï¼Œç»§ç»­å¤„ç†å…¶ä»–å›¢ã€‚

```java
for (Long teamId : expiredTeamIds) {
    try {
        refundService.refundExpiredTeam(teamId);
        successCount++;
    } catch (Exception e) {
        log.error("å›¢{}é€€æ¬¾å¤±è´¥", teamId, e);
        failCount++;
        // ä¸æŠ›å¼‚å¸¸ï¼Œç»§ç»­å¤„ç†å…¶ä»–å›¢ â­
    }
}
```

---

## 12. ä¾èµ–æœåŠ¡æ¥å£

### 12.1 UserServiceä¾èµ–

**å¿…éœ€æ¥å£**:
```java
GET /api/user/feign/info/{userId} - è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆéªŒè¯å›¢é•¿èº«ä»½ï¼‰
POST /api/account/feign/refund - é€€æ¬¾åˆ°ç”¨æˆ·ä½™é¢
```

### 12.2 OrderServiceä¾èµ–

**å¿…éœ€æ¥å£**ï¼ˆâ­å¾…å¼€å‘ï¼‰:
```java
POST /api/order/feign/create - åˆ›å»ºè®¢å•
POST /api/order/feign/batchUpdateStatus - æ‰¹é‡æ›´æ–°è®¢å•çŠ¶æ€
POST /api/order/feign/updateStatus - æ›´æ–°è®¢å•çŠ¶æ€
POST /api/order/feign/cancel/{orderId} - å–æ¶ˆè®¢å•
```

### 12.3 ProductServiceä¾èµ–

**å¯é€‰æ¥å£**:
```java
GET /api/product/feign/{productId} - è·å–å•†å“ä¿¡æ¯
```

### 12.4 LeaderServiceä¾èµ–

**å¯é€‰æ¥å£**:
```java
GET /api/community/feign/{communityId} - è·å–ç¤¾åŒºä¿¡æ¯
```

---

## 13. ç‰ˆæœ¬å†å²

### v1.0.1 (2025-11-01)

**æ–°åŠŸèƒ½**:
- âœ… æ–°å¢å•†å“è¯¦æƒ…é¡µæ‹¼å›¢æ¥å£ï¼ˆ`GET /api/groupbuy/product/{productId}/activities`ï¼‰
- âœ… æ”¯æŒæ ¹æ®å•†å“IDæŸ¥è¯¢æ‰€æœ‰æ‹¼å›¢æ´»åŠ¨åŠå›¢åˆ—è¡¨
- âœ… æ¯ä¸ªæ´»åŠ¨è¿”å›æœ€å¤š10ä¸ªè¿›è¡Œä¸­çš„å›¢ï¼ˆæ”¯æŒç¤¾åŒºä¼˜å…ˆï¼‰
- âœ… ä¼˜åŒ–å•†å“è¯¦æƒ…é¡µæ‹¼å›¢å±•ç¤ºé€»è¾‘

**ä¼˜åŒ–æ”¹è¿›**:
- ğŸ”§ å•†å“è¯¦æƒ…é¡µå¯ç›´æ¥æŸ¥çœ‹å¹¶å‚ä¸æ‹¼å›¢
- ğŸ”§ ç”¨æˆ·æ— éœ€ç™»å½•å³å¯æµè§ˆæ‹¼å›¢ä¿¡æ¯
- ğŸ”§ æ”¯æŒç¤¾åŒºä¼˜å…ˆæ’åºï¼Œæå‡æœ¬ç¤¾åŒºæ‹¼å›¢ä½“éªŒ

### v1.0.0 (2025-10-31)

**æ–°åŠŸèƒ½**:
- âœ… æ‹¼å›¢æ´»åŠ¨ç®¡ç†ï¼ˆCRUDï¼‰
- âœ… å›¢é•¿å‘èµ·æ‹¼å›¢ï¼ˆv3.0ï¼šéªŒè¯å›¢é•¿èº«ä»½ã€è‡ªåŠ¨å…³è”ç¤¾åŒºï¼‰
- âœ… ç”¨æˆ·å‚ä¸æ‹¼å›¢ï¼ˆè¡Œé”é˜²å¹¶å‘ã€é˜²é‡å¤å‚å›¢ï¼‰
- âœ… æ”¯ä»˜å›è°ƒå¤„ç†ï¼ˆæˆå›¢æ£€æŸ¥ã€å¹‚ç­‰æ€§ä¿è¯ï¼‰
- âœ… æŸ¥è¯¢åŠŸèƒ½ï¼ˆå›¢è¯¦æƒ…ã€æ´»åŠ¨å›¢åˆ—è¡¨ã€ç¤¾åŒºä¼˜å…ˆæ’åºï¼‰
- âœ… é€€å‡ºæ‹¼å›¢ï¼ˆæˆå›¢å‰å¯é€€ã€è‡ªåŠ¨é€€æ¬¾ï¼‰
- âœ… å®šæ—¶ä»»åŠ¡ï¼ˆè¿‡æœŸå›¢è‡ªåŠ¨é€€æ¬¾ã€å¼‚å¸¸éš”ç¦»ï¼‰

**æŠ€æœ¯äº®ç‚¹**:
- â­ æ— Redisåˆ†å¸ƒå¼é”æ–¹æ¡ˆï¼ˆæ•°æ®åº“è¡Œé”ï¼‰
- â­ ä¸‰å±‚å¹‚ç­‰æ€§è®¾è®¡ï¼ˆæ”¯ä»˜å›è°ƒã€æˆå›¢é€»è¾‘ã€å®šæ—¶ä»»åŠ¡ï¼‰
- â­ Sagaæ¨¡å¼è·¨æœåŠ¡è°ƒç”¨ï¼ˆè¡¥å¿æœºåˆ¶ï¼‰
- â­ ç¤¾åŒºä¼˜å…ˆæ¨èï¼ˆSQL ORDER BY CASEï¼‰
- â­ å®šæ—¶ä»»åŠ¡å¼‚å¸¸éš”ç¦»ï¼ˆå•ä¸ªå›¢å¤±è´¥ä¸å½±å“å…¶ä»–å›¢ï¼‰

---

## 14. è”ç³»æ–¹å¼

**å¼€å‘è€…**: è€¿åº·ç‘  
**å­¦å·**: 20221204229  
**å­¦æ ¡**: åŒ—äº¬åŸå¸‚å­¦é™¢  
**ä¸“ä¸š**: è½¯ä»¶å·¥ç¨‹  
**é‚®ç®±**: gkr@bcu.edu.cn

**é¡¹ç›®åœ°å€**: E:\E\BYSJ\community-group-buy-backend\GroupBuyService

**ç›¸å…³æ–‡æ¡£**:
- [README](../../community-group-buy-backend/GroupBuyService/README.md)
- [ç³»ç»Ÿæ¶æ„è®¾è®¡](../ä¸‰çº§æ–‡æ¡£ï¼ˆå½’æ¡£ï¼‰/DESIGN_GroupBuyService.md)
- [å¼€å‘å®ŒæˆæŠ¥å‘Š](../ä¸‰çº§æ–‡æ¡£ï¼ˆå½’æ¡£ï¼‰/FINAL_GroupBuyService.md)

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæˆ  
**æœ€åæ›´æ–°**: 2025-11-01 18:30  
**ç‰ˆæœ¬**: v1.0.1

