# å•†å“è¯¦æƒ…é¡µæ‹¼å›¢é€»è¾‘ä¼˜åŒ–æ–¹æ¡ˆ

**åˆ›å»ºæ—¥æœŸ**: 2025-11-01  
**ä¼˜åŒ–ç›®æ ‡**: åœ¨å•†å“è¯¦æƒ…é¡µæ˜¾ç¤ºè¯¥å•†å“çš„æ‰€æœ‰æ‹¼å›¢æ´»åŠ¨å’Œå›¢åˆ—è¡¨ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥å‚å›¢  
**ç¬¦åˆè§„èŒƒ**: v3.0æ‹¼å›¢é€»è¾‘ï¼ˆä»…å›¢é•¿å¯å‘èµ·æ‹¼å›¢ï¼Œç”¨æˆ·å¯å‚ä¸ï¼‰

---

## ğŸ“‹ é—®é¢˜åˆ†æ

### å½“å‰é—®é¢˜

1. **ç¼ºå°‘æ‹¼å›¢å…¥å£**
   - å•†å“è¯¦æƒ…é¡µåªæœ‰"åŠ å…¥è´­ç‰©è½¦"å’Œ"ç«‹å³è´­ä¹°"æŒ‰é’®
   - ç”¨æˆ·æ— æ³•ç›´æ¥çœ‹åˆ°è¯¥å•†å“çš„æ‹¼å›¢æ´»åŠ¨

2. **ç”¨æˆ·ä½“éªŒä¸ä½³**
   - ç”¨æˆ·éœ€è¦è·³è½¬åˆ°"æ‹¼å›¢æ´»åŠ¨åˆ—è¡¨"é¡µé¢æ‰èƒ½å‚å›¢
   - æ— æ³•åœ¨å•†å“è¯¦æƒ…é¡µç›´æ¥äº†è§£æ‹¼å›¢æƒ…å†µ

3. **æµç¨‹ä¸å¤Ÿä¾¿æ·**
   - ç”¨æˆ·éœ€è¦å¤šæ¬¡è·³è½¬æ‰èƒ½å®Œæˆå‚å›¢
   - ç¼ºå°‘"å¿«é€Ÿå‚å›¢"åŠŸèƒ½

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

### æ ¸å¿ƒç›®æ ‡

1. âœ… åœ¨å•†å“è¯¦æƒ…é¡µæ˜¾ç¤ºè¯¥å•†å“çš„æ‰€æœ‰æ‹¼å›¢æ´»åŠ¨
2. âœ… æ˜¾ç¤ºæ¯ä¸ªæ´»åŠ¨ä¸‹è¿›è¡Œä¸­çš„å›¢åˆ—è¡¨
3. âœ… æ”¯æŒç¤¾åŒºä¼˜å…ˆæ˜¾ç¤ºï¼ˆæœ¬ç¤¾åŒºçš„å›¢æ’åœ¨å‰é¢ï¼‰
4. âœ… ç”¨æˆ·å¯ä»¥ä¸€é”®å‚å›¢
5. âœ… ä¿æŒv3.0æ‹¼å›¢é€»è¾‘è§„èŒƒ

---

## ğŸ¨ UIè®¾è®¡æ–¹æ¡ˆ

### é¡µé¢å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å•†å“å›¾ç‰‡å’Œä¿¡æ¯                      â”‚
â”‚  - å•†å“åç§°ã€ä»·æ ¼ã€åº“å­˜                                â”‚
â”‚  - åŠ å…¥è´­ç‰©è½¦ã€ç«‹å³è´­ä¹°æŒ‰é’®                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ğŸ“ æ‹¼å›¢ä¸“åŒºï¼ˆæ–°å¢ï¼‰                        â”‚
â”‚                                                       â”‚
â”‚  ã€æ‹¼å›¢æ´»åŠ¨1ã€‘                                         â”‚
â”‚  - æ‹¼å›¢ä»·ï¼šÂ¥XX  æˆå›¢äººæ•°ï¼šXäºº                          â”‚
â”‚  - æ´»åŠ¨æ—¶é—´ï¼šYYYY-MM-DD ~ YYYY-MM-DD                 â”‚
â”‚                                                       â”‚
â”‚  è¿›è¡Œä¸­çš„å›¢ï¼ˆ3ä¸ªï¼‰                          [æŸ¥çœ‹å…¨éƒ¨]  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ å›¢å·ï¼šT20251101001  [æœ¬ç¤¾åŒº]                  â”‚    â”‚
â”‚  â”‚ è¿›åº¦ï¼š2/3äºº  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 67%                    â”‚    â”‚
â”‚  â”‚ ã€å‚ä¸æ‹¼å›¢ã€‘                                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ å›¢å·ï¼šT20251101002  [å…¶ä»–ç¤¾åŒº]                â”‚    â”‚
â”‚  â”‚ è¿›åº¦ï¼š1/3äºº  â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 33%                    â”‚    â”‚
â”‚  â”‚ ã€å‚ä¸æ‹¼å›¢ã€‘                                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                       â”‚
â”‚  ã€æ‹¼å›¢æ´»åŠ¨2ã€‘                                         â”‚
â”‚  ...                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ¨èå•†å“                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 1. APIæ¥å£è¡¥å……

#### 1.1 æ ¹æ®å•†å“IDè·å–æ‹¼å›¢æ´»åŠ¨

**æ–°å¢æ¥å£ï¼ˆåç«¯éœ€è¦æä¾›ï¼‰**:
```javascript
/**
 * æ ¹æ®å•†å“IDè·å–æ‹¼å›¢æ´»åŠ¨åˆ—è¡¨ï¼ˆåŒ…å«å›¢åˆ—è¡¨ï¼‰
 * @param {number} productId - å•†å“ID
 * @param {object} params - æŸ¥è¯¢å‚æ•°
 * @param {number} params.communityId - ç”¨æˆ·ç¤¾åŒºIDï¼ˆç”¨äºç¤¾åŒºä¼˜å…ˆæ’åºï¼‰
 * @returns {Promise<Array>} æ´»åŠ¨åˆ—è¡¨ï¼ˆæ¯ä¸ªæ´»åŠ¨åŒ…å«teamså­—æ®µï¼‰
 */
export const getProductGroupBuyActivities = (productId, params) => {
  return request({
    url: `/api/groupbuy/product/${productId}/activities`,
    method: 'GET',
    params
  })
}
```

**è¿”å›æ•°æ®ç»“æ„**:
```json
[
  {
    "activityId": 1,
    "productId": 101,
    "groupPrice": 29.9,
    "requiredNum": 3,
    "maxNum": null,
    "startTime": "2025-11-01T00:00:00",
    "endTime": "2025-11-10T23:59:59",
    "status": 1,
    "teams": [
      {
        "teamId": 5001,
        "teamNo": "T20251101001",
        "launcherId": 2001,
        "leaderId": 2001,
        "leaderName": "å¼ å›¢é•¿",
        "communityId": 3001,
        "communityName": "é˜³å…‰å°åŒº",
        "requiredNum": 3,
        "currentNum": 2,
        "teamStatus": 0,
        "expireTime": "2025-11-02T12:00:00",
        "createTime": "2025-11-01T12:00:00"
      },
      {
        "teamId": 5002,
        "teamNo": "T20251101002",
        "launcherId": 2002,
        "leaderId": 2002,
        "leaderName": "æå›¢é•¿",
        "communityId": 3002,
        "communityName": "èŠ±å›­å°åŒº",
        "requiredNum": 3,
        "currentNum": 1,
        "teamStatus": 0,
        "expireTime": "2025-11-02T14:00:00",
        "createTime": "2025-11-01T14:00:00"
      }
    ]
  }
]
```

---

### 2. å‰ç«¯ç»„ä»¶è®¾è®¡

#### 2.1 ç»„ä»¶ç»“æ„

```
ProductDetailView.vue (ä¸»é¡µé¢)
    â”œâ”€â”€ ProductGroupBuySection.vue (æ‹¼å›¢ä¸“åŒº - æ–°å¢)
    â”‚   â”œâ”€â”€ GroupBuyActivityCard.vue (æ´»åŠ¨å¡ç‰‡)
    â”‚   â”‚   â”œâ”€â”€ ActivityInfo (æ´»åŠ¨ä¿¡æ¯)
    â”‚   â”‚   â””â”€â”€ TeamList (å›¢åˆ—è¡¨)
    â”‚   â”‚       â””â”€â”€ TeamItem (å›¢é¡¹ç›®)
    â”‚   â”‚           â”œâ”€â”€ TeamInfo (å›¢ä¿¡æ¯)
    â”‚   â”‚           â”œâ”€â”€ TeamProgress (è¿›åº¦æ¡)
    â”‚   â”‚           â””â”€â”€ JoinButton (å‚å›¢æŒ‰é’®)
    â”‚   â””â”€â”€ JoinTeamDialog.vue (å‚å›¢å¯¹è¯æ¡† - é€‰æ‹©åœ°å€)
```

#### 2.2 æ ¸å¿ƒç»„ä»¶å®ç°

**ProductGroupBuySection.vue** (æ‹¼å›¢ä¸“åŒºç»„ä»¶):
```vue
<template>
  <div class="groupbuy-section">
    <div class="section-header">
      <h2 class="section-title">
        <el-icon><Grid /></el-icon>
        æ‹¼å›¢ä¸“åŒº
      </h2>
      <p class="section-desc">å›¢è´­æ›´ä¼˜æƒ ï¼Œæ”¯æŒæœ¬ç¤¾åŒºä¼˜å…ˆé…é€</p>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <el-skeleton v-if="loading" :rows="4" animated />

    <!-- æ´»åŠ¨åˆ—è¡¨ -->
    <div v-else-if="activities.length > 0" class="activities-list">
      <GroupBuyActivityCard
        v-for="activity in activities"
        :key="activity.activityId"
        :activity="activity"
        :user-community-id="userCommunityId"
        @join-team="handleJoinTeam"
        @view-all-teams="handleViewAllTeams"
      />
    </div>

    <!-- æ— æ´»åŠ¨ -->
    <el-empty 
      v-else 
      description="è¯¥å•†å“æš‚æ— æ‹¼å›¢æ´»åŠ¨"
      :image-size="120"
    >
      <template #image>
        <el-icon :size="120" color="#909399"><ShoppingCart /></el-icon>
      </template>
    </el-empty>

    <!-- å‚å›¢å¯¹è¯æ¡† -->
    <JoinTeamDialog
      v-model="joinDialogVisible"
      :team="selectedTeam"
      :activity="selectedActivity"
      :product="product"
      @confirm="handleConfirmJoin"
    />

    <!-- å…¨éƒ¨å›¢åˆ—è¡¨å¯¹è¯æ¡† -->
    <AllTeamsDialog
      v-model="allTeamsDialogVisible"
      :activity="selectedActivity"
      :user-community-id="userCommunityId"
      @join-team="handleJoinTeam"
    />
  </div>
</template>

<script setup>
import { ref, computed, watch } from 'vue'
import { ElMessage } from 'element-plus'
import { Grid, ShoppingCart } from '@element-plus/icons-vue'
import GroupBuyActivityCard from './GroupBuyActivityCard.vue'
import JoinTeamDialog from './JoinTeamDialog.vue'
import AllTeamsDialog from './AllTeamsDialog.vue'
import { getProductGroupBuyActivities, joinTeam } from '@/api/groupbuy'
import { useUserStore } from '@/stores/user'
import { useRouter } from 'vue-router'

const props = defineProps({
  productId: {
    type: Number,
    required: true
  },
  product: {
    type: Object,
    default: null
  }
})

const router = useRouter()
const userStore = useUserStore()

// æ•°æ®
const loading = ref(false)
const activities = ref([])
const joinDialogVisible = ref(false)
const allTeamsDialogVisible = ref(false)
const selectedTeam = ref(null)
const selectedActivity = ref(null)

// ç”¨æˆ·ç¤¾åŒºID
const userCommunityId = computed(() => {
  return userStore.userInfo?.communityId || null
})

// è·å–æ‹¼å›¢æ´»åŠ¨
const fetchActivities = async () => {
  if (!props.productId) return

  loading.value = true
  try {
    const params = userCommunityId.value ? { communityId: userCommunityId.value } : {}
    const data = await getProductGroupBuyActivities(props.productId, params)
    activities.value = data || []
  } catch (error) {
    console.error('è·å–æ‹¼å›¢æ´»åŠ¨å¤±è´¥:', error)
    // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
  } finally {
    loading.value = false
  }
}

// å‚å›¢
const handleJoinTeam = (team, activity) => {
  if (!userStore.isLogin) {
    ElMessage.warning('è¯·å…ˆç™»å½•')
    router.push('/login')
    return
  }

  selectedTeam.value = team
  selectedActivity.value = activity
  joinDialogVisible.value = true
}

// ç¡®è®¤å‚å›¢
const handleConfirmJoin = async (data) => {
  try {
    await joinTeam(data)
    ElMessage.success('å‚å›¢æˆåŠŸï¼Œè¯·å°½å¿«æ”¯ä»˜')
    
    // è·³è½¬åˆ°æ”¯ä»˜é¡µé¢ï¼ˆå‡è®¾è¿”å›äº†è®¢å•IDï¼‰
    if (data.orderId) {
      router.push(`/payment?orderId=${data.orderId}`)
    }
    
    // åˆ·æ–°æ´»åŠ¨åˆ—è¡¨
    await fetchActivities()
  } catch (error) {
    console.error('å‚å›¢å¤±è´¥:', error)
    ElMessage.error(error.message || 'å‚å›¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
  }
}

// æŸ¥çœ‹å…¨éƒ¨å›¢
const handleViewAllTeams = (activity) => {
  selectedActivity.value = activity
  allTeamsDialogVisible.value = true
}

// ç›‘å¬å•†å“IDå˜åŒ–
watch(() => props.productId, () => {
  fetchActivities()
}, { immediate: true })
</script>

<style scoped>
.groupbuy-section {
  margin-top: 40px;
  padding: 30px;
  background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
  border-radius: 12px;
  border: 2px dashed #f56c6c;
}

.section-header {
  margin-bottom: 24px;
  text-align: center;
}

.section-title {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-size: 24px;
  font-weight: bold;
  color: #f56c6c;
  margin: 0 0 8px 0;
}

.section-desc {
  font-size: 14px;
  color: #909399;
  margin: 0;
}

.activities-list {
  display: flex;
  flex-direction: column;
  gap: 20px;
}
</style>
```

**GroupBuyActivityCard.vue** (æ´»åŠ¨å¡ç‰‡ç»„ä»¶):
```vue
<template>
  <el-card class="activity-card" shadow="hover">
    <!-- æ´»åŠ¨ä¿¡æ¯ -->
    <div class="activity-header">
      <div class="activity-info">
        <el-tag type="danger" size="large" effect="dark">æ‹¼å›¢æ´»åŠ¨</el-tag>
        <div class="price-info">
          <span class="group-price">Â¥{{ activity.groupPrice }}</span>
          <span class="price-label">æ‹¼å›¢ä»·</span>
        </div>
        <div class="people-info">
          <el-icon><User /></el-icon>
          <span>{{ activity.requiredNum }}äººæˆå›¢</span>
        </div>
      </div>
      <div class="activity-time">
        <el-icon><Clock /></el-icon>
        <span>{{ formatTimeRange(activity.startTime, activity.endTime) }}</span>
      </div>
    </div>

    <!-- å›¢åˆ—è¡¨ -->
    <div v-if="activity.teams && activity.teams.length > 0" class="teams-section">
      <div class="teams-header">
        <span class="teams-count">è¿›è¡Œä¸­çš„å›¢ï¼ˆ{{ activity.teams.length }}ï¼‰</span>
        <el-button 
          v-if="activity.teams.length > 3"
          link 
          type="primary"
          @click="emit('view-all-teams', activity)"
        >
          æŸ¥çœ‹å…¨éƒ¨
        </el-button>
      </div>

      <div class="teams-list">
        <div 
          v-for="team in displayTeams" 
          :key="team.teamId"
          class="team-item"
        >
          <!-- å›¢ä¿¡æ¯ -->
          <div class="team-header">
            <div class="team-info">
              <span class="team-no">{{ team.teamNo }}</span>
              <el-tag 
                v-if="team.communityId === userCommunityId"
                type="success" 
                size="small"
                effect="dark"
              >
                æœ¬ç¤¾åŒº
              </el-tag>
              <el-tag 
                v-else-if="team.communityName"
                size="small"
              >
                {{ team.communityName }}
              </el-tag>
            </div>
            <span class="leader-name">{{ team.leaderName }}å›¢é•¿</span>
          </div>

          <!-- è¿›åº¦æ¡ -->
          <div class="team-progress">
            <div class="progress-info">
              <span class="progress-text">{{ team.currentNum }}/{{ team.requiredNum }}äºº</span>
              <span class="expire-time">å‰©ä½™{{ getExpireTime(team.expireTime) }}</span>
            </div>
            <el-progress 
              :percentage="(team.currentNum / team.requiredNum) * 100"
              :stroke-width="10"
              :color="getProgressColor(team.currentNum, team.requiredNum)"
            />
          </div>

          <!-- å‚å›¢æŒ‰é’® -->
          <el-button 
            type="primary"
            size="large"
            class="join-button"
            @click="emit('join-team', team, activity)"
          >
            <el-icon><UserFilled /></el-icon>
            ç«‹å³å‚å›¢
          </el-button>
        </div>
      </div>
    </div>

    <!-- æ— å›¢æç¤º -->
    <div v-else class="no-teams">
      <el-icon :size="40" color="#909399"><InfoFilled /></el-icon>
      <p>è¯¥æ´»åŠ¨æš‚æ— è¿›è¡Œä¸­çš„å›¢</p>
      <p class="hint">å¯ä»¥ç­‰å¾…å›¢é•¿å‘èµ·æ–°çš„å›¢å“¦~</p>
    </div>
  </el-card>
</template>

<script setup>
import { computed } from 'vue'
import { User, Clock, UserFilled, InfoFilled } from '@element-plus/icons-vue'
import { formatDateRange, getTimeRemaining } from '@/utils/formatter'

const props = defineProps({
  activity: {
    type: Object,
    required: true
  },
  userCommunityId: {
    type: Number,
    default: null
  }
})

const emit = defineEmits(['join-team', 'view-all-teams'])

// æ˜¾ç¤ºå‰3ä¸ªå›¢
const displayTeams = computed(() => {
  return props.activity.teams?.slice(0, 3) || []
})

// æ ¼å¼åŒ–æ—¶é—´èŒƒå›´
const formatTimeRange = (start, end) => {
  return formatDateRange(start, end)
}

// è®¡ç®—å‰©ä½™æ—¶é—´
const getExpireTime = (expireTime) => {
  return getTimeRemaining(expireTime)
}

// è¿›åº¦æ¡é¢œè‰²
const getProgressColor = (current, required) => {
  const percentage = (current / required) * 100
  if (percentage >= 80) return '#67c23a'
  if (percentage >= 50) return '#e6a23c'
  return '#409eff'
}
</script>

<style scoped>
.activity-card {
  border-radius: 12px;
}

.activity-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 2px solid #f5f7fa;
}

.activity-info {
  display: flex;
  align-items: center;
  gap: 16px;
}

.price-info {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.group-price {
  font-size: 28px;
  font-weight: bold;
  color: #f56c6c;
  line-height: 1;
}

.price-label {
  font-size: 12px;
  color: #909399;
  margin-top: 4px;
}

.people-info {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 14px;
  color: #606266;
  padding: 8px 16px;
  background: #f5f7fa;
  border-radius: 20px;
}

.activity-time {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 13px;
  color: #909399;
}

.teams-section {
  margin-top: 16px;
}

.teams-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.teams-count {
  font-size: 15px;
  font-weight: 500;
  color: #303133;
}

.teams-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.team-item {
  padding: 16px;
  background: #f8f9fa;
  border-radius: 8px;
  transition: all 0.3s;
}

.team-item:hover {
  background: #ecf5ff;
  transform: translateX(4px);
}

.team-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.team-info {
  display: flex;
  align-items: center;
  gap: 8px;
}

.team-no {
  font-size: 14px;
  font-weight: 500;
  color: #303133;
}

.leader-name {
  font-size: 13px;
  color: #606266;
}

.team-progress {
  margin-bottom: 12px;
}

.progress-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 13px;
}

.progress-text {
  color: #303133;
  font-weight: 500;
}

.expire-time {
  color: #f56c6c;
}

.join-button {
  width: 100%;
}

.no-teams {
  text-align: center;
  padding: 40px 20px;
  color: #909399;
}

.no-teams p {
  margin: 8px 0;
  font-size: 14px;
}

.no-teams .hint {
  font-size: 12px;
  color: #c0c4cc;
}
</style>
```

---

### 3. å‚å›¢æµç¨‹è®¾è®¡

#### 3.1 å‚å›¢æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant P as å•†å“è¯¦æƒ…é¡µ
    participant D as å‚å›¢å¯¹è¯æ¡†
    participant API as åç«¯API
    participant Pay as æ”¯ä»˜é¡µé¢
    
    U->>P: æŸ¥çœ‹å•†å“
    P->>API: è·å–æ‹¼å›¢æ´»åŠ¨å’Œå›¢åˆ—è¡¨
    API-->>P: è¿”å›æ´»åŠ¨+å›¢æ•°æ®
    P-->>U: æ˜¾ç¤ºæ‹¼å›¢ä¸“åŒº
    
    U->>P: ç‚¹å‡»"ç«‹å³å‚å›¢"
    P->>D: æ‰“å¼€å‚å›¢å¯¹è¯æ¡†
    D-->>U: æ˜¾ç¤ºå›¢ä¿¡æ¯+åœ°å€é€‰æ‹©
    
    U->>D: é€‰æ‹©æ”¶è´§åœ°å€+æ•°é‡
    U->>D: ç‚¹å‡»"ç¡®è®¤å‚å›¢"
    D->>API: POST /api/groupbuy/team/join
    API->>API: åˆ›å»ºè®¢å•+è®°å½•å‚å›¢
    API-->>D: è¿”å›è®¢å•ID
    D-->>P: å…³é—­å¯¹è¯æ¡†
    P->>Pay: è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
```

#### 3.2 JoinTeamDialogç»„ä»¶

```vue
<template>
  <el-dialog
    :model-value="modelValue"
    title="å‚ä¸æ‹¼å›¢"
    width="600px"
    @update:model-value="emit('update:modelValue', $event)"
    @close="handleClose"
  >
    <div v-if="team" class="dialog-content">
      <!-- å›¢ä¿¡æ¯ -->
      <div class="team-info-section">
        <h3>å›¢ä¿¡æ¯</h3>
        <el-descriptions :column="2" border>
          <el-descriptions-item label="å›¢å·">
            {{ team.teamNo }}
          </el-descriptions-item>
          <el-descriptions-item label="å›¢é•¿">
            {{ team.leaderName }}
          </el-descriptions-item>
          <el-descriptions-item label="è¿›åº¦">
            {{ team.currentNum }}/{{ team.requiredNum }}äºº
          </el-descriptions-item>
          <el-descriptions-item label="è¿‡æœŸæ—¶é—´">
            {{ formatDateTime(team.expireTime) }}
          </el-descriptions-item>
        </el-descriptions>
      </div>

      <!-- å•†å“ä¿¡æ¯ -->
      <div class="product-info-section">
        <h3>å•†å“ä¿¡æ¯</h3>
        <div class="product-item">
          <img :src="product.coverImg" :alt="product.productName" />
          <div class="product-details">
            <div class="product-name">{{ product.productName }}</div>
            <div class="product-price">æ‹¼å›¢ä»·ï¼šÂ¥{{ activity.groupPrice }}</div>
          </div>
        </div>
      </div>

      <!-- è´­ä¹°æ•°é‡ -->
      <div class="quantity-section">
        <h3>è´­ä¹°æ•°é‡</h3>
        <el-input-number
          v-model="form.quantity"
          :min="1"
          :max="product.stock"
        />
      </div>

      <!-- æ”¶è´§åœ°å€é€‰æ‹© -->
      <div class="address-section">
        <h3>æ”¶è´§åœ°å€</h3>
        <el-radio-group v-model="form.addressId" class="address-list">
          <el-radio
            v-for="addr in addresses"
            :key="addr.addressId"
            :label="addr.addressId"
            border
            class="address-item"
          >
            <div class="address-content">
              <div class="address-main">
                <span class="receiver">{{ addr.receiverName }}</span>
                <span class="phone">{{ addr.phone }}</span>
                <el-tag v-if="addr.isDefault === 1" type="danger" size="small">
                  é»˜è®¤
                </el-tag>
              </div>
              <div class="address-detail">
                {{ addr.province }} {{ addr.city }} {{ addr.district }} {{ addr.detailAddress }}
              </div>
            </div>
          </el-radio>
        </el-radio-group>

        <el-button 
          type="primary" 
          link 
          @click="handleAddAddress"
        >
          + æ·»åŠ æ–°åœ°å€
        </el-button>
      </div>
    </div>

    <template #footer>
      <div class="dialog-footer">
        <div class="total-price">
          åˆè®¡ï¼š<span class="price">Â¥{{ totalPrice }}</span>
        </div>
        <div class="buttons">
          <el-button @click="handleClose">å–æ¶ˆ</el-button>
          <el-button 
            type="primary" 
            @click="handleConfirm"
            :loading="submitting"
            :disabled="!form.addressId"
          >
            ç¡®è®¤å‚å›¢
          </el-button>
        </div>
      </div>
    </template>
  </el-dialog>
</template>

<script setup>
import { ref, computed, watch } from 'vue'
import { useRouter } from 'vue-router'
import { ElMessage } from 'element-plus'
import { getUserAddresses } from '@/api/user'
import { formatDateTime } from '@/utils/formatter'

const props = defineProps({
  modelValue: Boolean,
  team: Object,
  activity: Object,
  product: Object
})

const emit = defineEmits(['update:modelValue', 'confirm'])
const router = useRouter()

// è¡¨å•æ•°æ®
const form = ref({
  addressId: null,
  quantity: 1
})

const addresses = ref([])
const submitting = ref(false)

// è®¡ç®—æ€»ä»·
const totalPrice = computed(() => {
  if (!props.activity) return 0
  return (props.activity.groupPrice * form.value.quantity).toFixed(2)
})

// è·å–åœ°å€åˆ—è¡¨
const fetchAddresses = async () => {
  try {
    const data = await getUserAddresses()
    addresses.value = data || []
    // è‡ªåŠ¨é€‰æ‹©é»˜è®¤åœ°å€
    const defaultAddr = addresses.value.find(addr => addr.isDefault === 1)
    if (defaultAddr) {
      form.value.addressId = defaultAddr.addressId
    }
  } catch (error) {
    console.error('è·å–åœ°å€åˆ—è¡¨å¤±è´¥:', error)
  }
}

// ç¡®è®¤å‚å›¢
const handleConfirm = () => {
  if (!form.value.addressId) {
    ElMessage.warning('è¯·é€‰æ‹©æ”¶è´§åœ°å€')
    return
  }

  emit('confirm', {
    teamId: props.team.teamId,
    addressId: form.value.addressId,
    quantity: form.value.quantity
  })
}

// å…³é—­
const handleClose = () => {
  emit('update:modelValue', false)
  // é‡ç½®è¡¨å•
  form.value = {
    addressId: null,
    quantity: 1
  }
}

// æ·»åŠ åœ°å€
const handleAddAddress = () => {
  router.push('/user/address')
}

// ç›‘å¬å¯¹è¯æ¡†æ‰“å¼€
watch(() => props.modelValue, (newVal) => {
  if (newVal) {
    fetchAddresses()
  }
})
</script>

<style scoped>
.dialog-content {
  max-height: 60vh;
  overflow-y: auto;
}

.team-info-section,
.product-info-section,
.quantity-section,
.address-section {
  margin-bottom: 24px;
}

.team-info-section h3,
.product-info-section h3,
.quantity-section h3,
.address-section h3 {
  font-size: 16px;
  font-weight: 500;
  color: #303133;
  margin: 0 0 12px 0;
}

.product-item {
  display: flex;
  gap: 12px;
  padding: 12px;
  background: #f5f7fa;
  border-radius: 8px;
}

.product-item img {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 4px;
}

.product-details {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 8px;
}

.product-name {
  font-size: 14px;
  font-weight: 500;
  color: #303133;
}

.product-price {
  font-size: 16px;
  font-weight: bold;
  color: #f56c6c;
}

.address-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 100%;
}

.address-item {
  width: 100%;
  margin: 0;
}

.address-content {
  width: 100%;
}

.address-main {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
}

.receiver {
  font-size: 14px;
  font-weight: 500;
  color: #303133;
}

.phone {
  font-size: 13px;
  color: #606266;
}

.address-detail {
  font-size: 13px;
  color: #909399;
  line-height: 1.5;
}

.dialog-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.total-price {
  font-size: 16px;
  color: #303133;
}

.total-price .price {
  font-size: 24px;
  font-weight: bold;
  color: #f56c6c;
  margin-left: 8px;
}

.buttons {
  display: flex;
  gap: 12px;
}
</style>
```

---

## ğŸ“ APIæ¥å£è¡¥å……è¯´æ˜

### åç«¯éœ€è¦æä¾›çš„æ–°æ¥å£

#### 1. æ ¹æ®å•†å“IDè·å–æ‹¼å›¢æ´»åŠ¨ï¼ˆåŒ…å«å›¢åˆ—è¡¨ï¼‰

**æ¥å£**: `GET /api/groupbuy/product/{productId}/activities`

**è¯·æ±‚å‚æ•°**:
- `communityId` (å¯é€‰): ç”¨æˆ·ç¤¾åŒºIDï¼Œç”¨äºç¤¾åŒºä¼˜å…ˆæ’åº

**è¿”å›æ•°æ®**:
```json
[
  {
    "activityId": 1,
    "productId": 101,
    "groupPrice": 29.9,
    "requiredNum": 3,
    "maxNum": null,
    "startTime": "2025-11-01T00:00:00",
    "endTime": "2025-11-10T23:59:59",
    "status": 1,
    "teams": [
      {
        "teamId": 5001,
        "teamNo": "T20251101001",
        "launcherId": 2001,
        "leaderId": 2001,
        "leaderName": "å¼ å›¢é•¿",
        "communityId": 3001,
        "communityName": "é˜³å…‰å°åŒº",
        "requiredNum": 3,
        "currentNum": 2,
        "teamStatus": 0,
        "expireTime": "2025-11-02T12:00:00",
        "createTime": "2025-11-01T12:00:00"
      }
    ]
  }
]
```

**SQLå®ç°ç¤ºä¾‹**:
```sql
-- Step 1: æŸ¥è¯¢å•†å“çš„æ‹¼å›¢æ´»åŠ¨
SELECT * FROM group_buy
WHERE product_id = ?
  AND status = 1
  AND NOW() BETWEEN start_time AND end_time
ORDER BY create_time DESC;

-- Step 2: å¯¹äºæ¯ä¸ªæ´»åŠ¨ï¼ŒæŸ¥è¯¢è¿›è¡Œä¸­çš„å›¢ï¼ˆç¤¾åŒºä¼˜å…ˆæ’åºï¼‰
SELECT 
  t.*,
  l.leader_name,
  c.community_name
FROM group_buy_team t
LEFT JOIN group_leader_store l ON t.leader_id = l.leader_id
LEFT JOIN community c ON t.community_id = c.community_id
WHERE t.activity_id = ?
  AND t.team_status = 0
  AND t.current_num < t.required_num
  AND t.expire_time > NOW()
ORDER BY 
  CASE WHEN t.community_id = ? THEN 0 ELSE 1 END ASC, -- ç¤¾åŒºä¼˜å…ˆ
  t.create_time DESC
LIMIT 10;
```

---

## ğŸ¯ ä¼˜åŒ–æ•ˆæœ

### ä¼˜åŒ–å‰ vs ä¼˜åŒ–å

| å¯¹æ¯”é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|-------|-------|-------|
| **æ‹¼å›¢å…¥å£** | éœ€è·³è½¬åˆ°æ‹¼å›¢åˆ—è¡¨é¡µ | å•†å“è¯¦æƒ…é¡µç›´æ¥æ˜¾ç¤º |
| **æ“ä½œæ­¥éª¤** | 4æ­¥ï¼ˆå•†å“â†’åˆ—è¡¨â†’æ´»åŠ¨â†’å‚å›¢ï¼‰ | 2æ­¥ï¼ˆå•†å“â†’å‚å›¢ï¼‰ |
| **ç”¨æˆ·ä½“éªŒ** | ç¹ç | ä¾¿æ· |
| **ç¤¾åŒºä¼˜å…ˆ** | ä¸æ”¯æŒ | æ”¯æŒï¼ˆæœ¬ç¤¾åŒºå›¢ä¼˜å…ˆæ˜¾ç¤ºï¼‰ |
| **è½¬åŒ–ç‡** | ä½ | é«˜ â¬†ï¸ |

---

## ğŸš€ å®æ–½æ­¥éª¤

### é˜¶æ®µ1ï¼šAPIæ¥å£å¼€å‘ï¼ˆåç«¯ï¼‰

1. [ ] å¼€å‘ `GET /api/groupbuy/product/{productId}/activities` æ¥å£
2. [ ] å®ç°ç¤¾åŒºä¼˜å…ˆæ’åºé€»è¾‘
3. [ ] æ¥å£æµ‹è¯•å’Œæ–‡æ¡£æ›´æ–°

### é˜¶æ®µ2ï¼šå‰ç«¯ç»„ä»¶å¼€å‘

1. [ ] åˆ›å»º `ProductGroupBuySection.vue` ç»„ä»¶
2. [ ] åˆ›å»º `GroupBuyActivityCard.vue` ç»„ä»¶
3. [ ] åˆ›å»º `JoinTeamDialog.vue` ç»„ä»¶
4. [ ] æ›´æ–° `ProductDetailView.vue` é›†æˆæ‹¼å›¢ä¸“åŒº

### é˜¶æ®µ3ï¼šAPIè°ƒç”¨å’Œè”è°ƒ

1. [ ] åœ¨ `groupbuy.js` æ·»åŠ æ–°æ¥å£
2. [ ] å‰åç«¯è”è°ƒæµ‹è¯•
3. [ ] ä¿®å¤Bugå’Œä¼˜åŒ–ä½“éªŒ

### é˜¶æ®µ4ï¼šæµ‹è¯•å’Œä¸Šçº¿

1. [ ] åŠŸèƒ½æµ‹è¯•ï¼ˆåŠ å…¥æ‹¼å›¢æµç¨‹ï¼‰
2. [ ] UIæµ‹è¯•ï¼ˆå“åº”å¼é€‚é…ï¼‰
3. [ ] ç¤¾åŒºä¼˜å…ˆåŠŸèƒ½æµ‹è¯•
4. [ ] ä¸Šçº¿å‘å¸ƒ

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] å•†å“è¯¦æƒ…é¡µèƒ½æ­£ç¡®æ˜¾ç¤ºè¯¥å•†å“çš„æ‰€æœ‰æ‹¼å›¢æ´»åŠ¨
- [ ] æ¯ä¸ªæ´»åŠ¨æ˜¾ç¤ºè¿›è¡Œä¸­çš„å›¢åˆ—è¡¨ï¼ˆæœ€å¤š3ä¸ªé¢„è§ˆï¼‰
- [ ] æ”¯æŒç¤¾åŒºä¼˜å…ˆæ˜¾ç¤ºï¼ˆæœ¬ç¤¾åŒºçš„å›¢æ’åœ¨å‰é¢ï¼‰
- [ ] ç”¨æˆ·å¯ä»¥ç‚¹å‡»"ç«‹å³å‚å›¢"æŒ‰é’®
- [ ] å‚å›¢å¯¹è¯æ¡†æ­£ç¡®æ˜¾ç¤ºå›¢ä¿¡æ¯ã€å•†å“ä¿¡æ¯ã€åœ°å€é€‰æ‹©
- [ ] ç¡®è®¤å‚å›¢ååˆ›å»ºè®¢å•å¹¶è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
- [ ] æ— æ‹¼å›¢æ´»åŠ¨æ—¶æ˜¾ç¤ºå‹å¥½çš„ç©ºçŠ¶æ€

### ä½“éªŒéªŒæ”¶

- [ ] é¡µé¢åŠ è½½é€Ÿåº¦å¿«ï¼ˆ<2ç§’ï¼‰
- [ ] UIç¾è§‚ã€å¸ƒå±€åˆç†
- [ ] ç§»åŠ¨ç«¯é€‚é…è‰¯å¥½
- [ ] äº¤äº’æµç•…ã€æ— å¡é¡¿
- [ ] é”™è¯¯æç¤ºå‹å¥½

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ‹¼å›¢é€»è¾‘ä¼˜åŒ–æ–¹æ¡ˆv3.0](./æ‹¼å›¢é€»è¾‘ä¼˜åŒ–æ–¹æ¡ˆ.md)
- [API_GroupBuyService](./äºŒçº§æ–‡æ¡£ï¼ˆå‚è€ƒï¼‰/API_GroupBuyService.md)
- [æ•°æ®åº“è®¾è®¡è¯´æ˜æ–‡æ¡£](./äºŒçº§æ–‡æ¡£ï¼ˆå‚è€ƒï¼‰/æ•°æ®åº“è®¾è®¡è¯´æ˜æ–‡æ¡£_v6.0.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-11-01  
**çŠ¶æ€**: âœ… æ–¹æ¡ˆå·²å®Œæˆï¼Œå¾…å®æ–½

