# æ‹¼å›¢æ´»åŠ¨é€»è¾‘æ•´ç†æ–‡æ¡£ï¼ˆåŸºäºå®é™…ä»£ç v1.0ï¼‰

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0 âœ…å®é™…ä»£ç ç‰ˆæœ¬  
**åˆ›å»ºæ—¥æœŸ**: 2025-11-01  
**ä»£ç ç‰ˆæœ¬**: GroupBuyService v1.0 (2025-10-31å®Œæˆ)  
**å¯¹æ¯”æ–‡æ¡£**: ã€Šæ‹¼å›¢é€»è¾‘ä¼˜åŒ–æ–¹æ¡ˆ.mdã€‹v3.0  
**æ•´ç†äºº**: AIåŠ©æ‰‹  
**è¯´æ˜**: æœ¬æ–‡æ¡£åŸºäºå®é™…ä»£ç å®ç°æ•´ç†ï¼Œä¸ç†è®ºè®¾è®¡æ–‡æ¡£å¯¹æ¯”éªŒè¯

---

## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒæ¦‚å¿µæ¨¡å‹](#1-æ ¸å¿ƒæ¦‚å¿µæ¨¡å‹)
2. [æ•°æ®åº“å®ä½“è®¾è®¡](#2-æ•°æ®åº“å®ä½“è®¾è®¡)
3. [çŠ¶æ€æœºè®¾è®¡](#3-çŠ¶æ€æœºè®¾è®¡)
4. [ä¸šåŠ¡æµç¨‹è¯¦è§£](#4-ä¸šåŠ¡æµç¨‹è¯¦è§£)
5. [æŠ€æœ¯äº®ç‚¹å®ç°](#5-æŠ€æœ¯äº®ç‚¹å®ç°)
6. [APIæ¥å£æ¸…å•](#6-apiæ¥å£æ¸…å•)
7. [æ–‡æ¡£ä¸ä»£ç å¯¹æ¯”](#7-æ–‡æ¡£ä¸ä»£ç å¯¹æ¯”)

---

## 1. æ ¸å¿ƒæ¦‚å¿µæ¨¡å‹

### 1.1 ä¸‰å±‚æ¨¡å‹è®¾è®¡ âœ…å·²å®ç°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Activityï¼ˆæ‹¼å›¢æ´»åŠ¨ï¼‰ - æ´»åŠ¨æ¨¡æ¿                            â”‚
â”‚ - ç®¡ç†å‘˜åˆ›å»ºï¼Œå®šä¹‰æ‹¼å›¢è§„åˆ™                                â”‚
â”‚ - ä¸€ä¸ªæ´»åŠ¨å¯ä»¥æœ‰å¤šä¸ªå›¢å®ä¾‹                                â”‚
â”‚ - è¡¨ï¼šgroup_buy                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 1:N
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Teamï¼ˆå›¢å®ä¾‹ï¼‰ - å…·ä½“çš„å›¢ â­æ ¸å¿ƒ                           â”‚
â”‚ - å›¢é•¿å‘èµ·ï¼Œæœ‰å”¯ä¸€å›¢å·                                    â”‚
â”‚ - å…³è”å›¢é•¿å’Œç¤¾åŒºï¼ˆv3.0ï¼‰                                  â”‚
â”‚ - ç‹¬ç«‹çš„æˆå›¢çŠ¶æ€å’Œè¿‡æœŸæ—¶é—´                                â”‚
â”‚ - è¡¨ï¼šgroup_buy_team                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 1:N
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Memberï¼ˆå‚å›¢è®°å½•ï¼‰ - ç”¨æˆ·å‚å›¢è®°å½• â­æ ¸å¿ƒ                   â”‚
â”‚ - è®°å½•ç”¨æˆ·å‚ä¸å“ªä¸ªå›¢                                      â”‚
â”‚ - å…³è”è®¢å•IDï¼ˆè·¨æœåŠ¡ï¼‰                                    â”‚
â”‚ - è®°å½•æ”¯ä»˜çŠ¶æ€å’Œæˆå›¢çŠ¶æ€                                  â”‚
â”‚ - è¡¨ï¼šgroup_buy_member                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 1:1
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Orderï¼ˆè®¢å•ï¼‰ - ç”¨æˆ·è®¢å• â­è·¨æœåŠ¡                          â”‚
â”‚ - å‚å›¢æ—¶ç«‹å³ç”Ÿæˆï¼ˆå¾…æ”¯ä»˜ï¼‰                                â”‚
â”‚ - æ”¯ä»˜åçŠ¶æ€ä¸º"å¾…æˆå›¢"                                    â”‚
â”‚ - æˆå›¢åçŠ¶æ€ä¸º"å¾…å‘è´§"                                    â”‚
â”‚ - è¡¨ï¼šorder_mainï¼ˆOrderServiceï¼‰                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒæ¦‚å¿µå®šä¹‰

| æ¦‚å¿µ | è‹±æ–‡ | è¯´æ˜ | å®ç°çŠ¶æ€ |
|------|------|------|---------|
| æ‹¼å›¢æ´»åŠ¨ | Activity | æ´»åŠ¨æ¨¡æ¿ï¼Œå®šä¹‰æ‹¼å›¢è§„åˆ™ï¼ˆå•†å“ã€ä»·æ ¼ã€æˆå›¢äººæ•°ï¼‰ | âœ… å·²å®ç° |
| å›¢å®ä¾‹ | Team | å…·ä½“çš„å›¢ï¼Œå›¢é•¿å‘èµ·ï¼Œæœ‰å”¯ä¸€å›¢å· | âœ… å·²å®ç° |
| å‚å›¢è®°å½• | Member | ç”¨æˆ·å‚ä¸å›¢çš„è®°å½•ï¼Œå…³è”è®¢å• | âœ… å·²å®ç° |
| å›¢é•¿ | Leader | é…é€ç‚¹è´Ÿè´£äººï¼Œå‘èµ·æ‹¼å›¢ï¼ˆrole=2ï¼‰ | âœ… å·²å®ç° |
| ç¤¾åŒº | Community | åœ°ç†ä¸Šçš„ç¤¾åŒºï¼Œç”¨äºä¼˜å…ˆæ¨èï¼ˆv3.0ï¼‰ | âœ… å·²å®ç° |
| å›¢å· | Team Number | å›¢çš„å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºåˆ†äº«ï¼ˆæ ¼å¼ï¼šT20251031001ï¼‰ | âœ… å·²å®ç° |

### 1.3 v3.0æ ¸å¿ƒç‰¹æ€§ âœ…å·²å®ç°

1. **ä»…å›¢é•¿å¯å‘èµ·æ‹¼å›¢**
   - éªŒè¯ï¼š`user.role == 2`
   - ä»£ç ä½ç½®ï¼š`TeamService.launchTeam()`

2. **è‡ªåŠ¨å…³è”ç¤¾åŒº**
   - å›¢é•¿å‘èµ·æ—¶ï¼š`team.communityId = user.communityId`
   - ä»£ç ä½ç½®ï¼š`TeamService.launchTeam()` line 125

3. **ç¤¾åŒºä¼˜å…ˆæ¨è**
   - SQLå®ç°ï¼š`ORDER BY CASE WHEN t.community_id = :communityId THEN 0 ELSE 1 END`
   - ä»£ç ä½ç½®ï¼š`TeamRepository.findByActivityIdWithCommunityPriority()`

4. **åºŸå¼ƒå›ºå®šç»‘å®š**
   - âŒ ä¸å†ä½¿ç”¨ `group_member` è¡¨
   - âœ… ä½¿ç”¨åŠ¨æ€å‚å›¢è®°å½• `group_buy_member`

---

## 2. æ•°æ®åº“å®ä½“è®¾è®¡

### 2.1 GroupBuyï¼ˆæ‹¼å›¢æ´»åŠ¨å®ä½“ï¼‰âœ…å·²å®ç°

**è¡¨å**: `group_buy`  
**è¯´æ˜**: æ‹¼å›¢æ´»åŠ¨æ¨¡æ¿ï¼Œç®¡ç†å‘˜åˆ›å»º

```java
@Entity
@Table(name = "group_buy")
public class GroupBuy {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long activityId;           // æ´»åŠ¨IDï¼ˆä¸»é”®ï¼‰
    
    private Long productId;             // å…³è”å•†å“IDï¼ˆè·¨åº“ï¼‰
    private BigDecimal groupPrice;      // æ‹¼å›¢ä»·
    private Integer requiredNum;        // æˆå›¢äººæ•°ï¼ˆ2-10äººï¼‰
    private Integer maxNum;             // æœ€å¤§äººæ•°é™åˆ¶ï¼ˆå¯ç©ºï¼‰
    private LocalDateTime startTime;    // æ´»åŠ¨å¼€å§‹æ—¶é—´
    private LocalDateTime endTime;      // æ´»åŠ¨ç»“æŸæ—¶é—´
    private Integer status;             // æ´»åŠ¨çŠ¶æ€ï¼ˆ0æœªå¼€å§‹/1è¿›è¡Œä¸­/2å·²ç»“æŸ/3å¼‚å¸¸ï¼‰
    private String qrcodeUrl;           // æ´»åŠ¨äºŒç»´ç URL
    private String link;                // æ´»åŠ¨ä¸“å±é“¾æ¥
    private LocalDateTime createTime;   // åˆ›å»ºæ—¶é—´
}
```

**æ ¸å¿ƒç´¢å¼•**:
- PRIMARY KEY: `activity_id`
- INDEX: `idx_product_id`, `idx_status`, `idx_time`
- UNIQUE: `uk_link`

### 2.2 GroupBuyTeamï¼ˆå›¢å®ä¾‹å®ä½“ï¼‰â­æ ¸å¿ƒ

**è¡¨å**: `group_buy_team`  
**è¯´æ˜**: å›¢é•¿å‘èµ·çš„å…·ä½“çš„å›¢

```java
@Entity
@Table(name = "group_buy_team")
public class GroupBuyTeam {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long teamId;                // å›¢IDï¼ˆä¸»é”®ï¼‰
    
    private String teamNo;              // å›¢å·ï¼ˆå”¯ä¸€ï¼ŒT20251031001ï¼‰
    private Long activityId;            // å…³è”æ´»åŠ¨IDï¼ˆç‰©ç†å¤–é”®ï¼‰
    private Long launcherId;            // å‘èµ·äººç”¨æˆ·IDï¼ˆå›¢é•¿ï¼‰
    private Long leaderId;              // å½’å±å›¢é•¿IDï¼ˆv3.0: launcherId == leaderIdï¼‰
    private Long communityId;           // å½’å±ç¤¾åŒºIDï¼ˆv3.0æ–°å¢ï¼‰â­
    private Integer requiredNum;        // æˆå›¢äººæ•°ï¼ˆä»æ´»åŠ¨å¤åˆ¶ï¼‰
    private Integer currentNum;         // å½“å‰äººæ•°ï¼ˆé»˜è®¤0ï¼‰
    private Integer teamStatus;         // å›¢çŠ¶æ€ï¼ˆ0æ‹¼å›¢ä¸­/1å·²æˆå›¢/2å·²å¤±è´¥ï¼‰
    private LocalDateTime successTime;  // æˆå›¢æ—¶é—´
    private LocalDateTime expireTime;   // è¿‡æœŸæ—¶é—´ï¼ˆ24å°æ—¶åï¼‰
    private LocalDateTime createTime;   // åˆ›å»ºæ—¶é—´
}
```

**æ ¸å¿ƒç´¢å¼•**:
- PRIMARY KEY: `team_id`
- UNIQUE: `uk_team_no`
- INDEX: `idx_activity_id`, `idx_launcher_id`, `idx_leader_id`, `idx_community_id`, 
         `idx_team_status`, `idx_expire_time`, `idx_create_time`

**v3.0ç‰¹æ€§**:
- `launcher_id == leader_id`ï¼ˆä»…å›¢é•¿å¯å‘èµ·ï¼‰
- `community_id` è‡ªåŠ¨è®¾ç½®ä¸ºå›¢é•¿çš„ç¤¾åŒº
- ç”¨äºç¤¾åŒºä¼˜å…ˆæ¨èæ’åº

### 2.3 GroupBuyMemberï¼ˆå‚å›¢è®°å½•å®ä½“ï¼‰â­æ ¸å¿ƒ

**è¡¨å**: `group_buy_member`  
**è¯´æ˜**: ç”¨æˆ·å‚å›¢è®°å½•ï¼Œé˜²é‡å¤å‚å›¢

```java
@Entity
@Table(name = "group_buy_member", uniqueConstraints = {
    @UniqueConstraint(name = "uk_team_user", columnNames = {"team_id", "user_id"})
})
public class GroupBuyMember {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long memberId;              // å‚å›¢è®°å½•IDï¼ˆä¸»é”®ï¼‰
    
    private Long teamId;                // å›¢IDï¼ˆç‰©ç†å¤–é”®ï¼‰
    private Long userId;                // å‚å›¢ç”¨æˆ·IDï¼ˆè·¨åº“ï¼‰
    private Long orderId;               // å…³è”è®¢å•IDï¼ˆè·¨åº“ï¼‰
    private Integer isLauncher;         // æ˜¯å¦å‘èµ·äººï¼ˆ0å¦/1æ˜¯ï¼‰
    private BigDecimal payAmount;       // æ”¯ä»˜é‡‘é¢
    private LocalDateTime joinTime;     // å‚å›¢æ—¶é—´
    private Integer status;             // çŠ¶æ€ï¼ˆ0å¾…æ”¯ä»˜/1å·²æ”¯ä»˜/2å·²æˆå›¢/3å·²å–æ¶ˆï¼‰
}
```

**æ ¸å¿ƒçº¦æŸ**:
- PRIMARY KEY: `member_id`
- UNIQUE: `uk_team_user(team_id, user_id)` - **é˜²é‡å¤å‚å›¢**â­
- INDEX: `idx_team_id`, `idx_user_id`, `idx_order_id`, `idx_status`

**æŠ€æœ¯äº®ç‚¹**:
- å”¯ä¸€ç´¢å¼•é˜²æ­¢é‡å¤å‚å›¢ï¼ˆæ•°æ®åº“å±‚é¢ä¿è¯ï¼‰
- `is_launcher=1` æ ‡è¯†å‘èµ·äººï¼ˆæ¯ä¸ªå›¢åªæœ‰1ä¸ªï¼‰

---

## 3. çŠ¶æ€æœºè®¾è®¡

### 3.1 å›¢çŠ¶æ€æœºï¼ˆTeamStatusï¼‰âœ…å·²å®ç°

```java
public enum TeamStatus {
    JOINING(0, "æ‹¼å›¢ä¸­"),    // å¯ä»¥ç»§ç»­å‚å›¢ã€å¯ä»¥ä¸­é€”é€€å‡º
    SUCCESS(1, "å·²æˆå›¢"),    // ä¸å¯é€€å‡ºã€è®¢å•å˜ä¸º"å¾…å‘è´§"
    FAILED(2, "å·²å¤±è´¥");     // è‡ªåŠ¨é€€æ¬¾ã€è®¢å•å˜ä¸º"å·²é€€æ¬¾"
}
```

**çŠ¶æ€æµè½¬å›¾**:

```mermaid
stateDiagram-v2
    [*] --> JOINING: å›¢é•¿å‘èµ·æ‹¼å›¢
    
    JOINING --> SUCCESS: current_num == required_num
    JOINING --> FAILED: 24å°æ—¶è¿‡æœŸï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
    
    SUCCESS --> [*]
    FAILED --> [*]
    
    note right of JOINING
        team_status = 0
        å¯ä»¥ç»§ç»­å‚å›¢
        å¯ä»¥ä¸­é€”é€€å‡º
    end note
    
    note right of SUCCESS
        team_status = 1
        ä¸å¯é€€å‡º
        è®¢å•çŠ¶æ€â†’å¾…å‘è´§
    end note
    
    note right of FAILED
        team_status = 2
        è‡ªåŠ¨é€€æ¬¾
        è®¢å•çŠ¶æ€â†’å·²é€€æ¬¾
    end note
```

**çŠ¶æ€è§¦å‘æ¡ä»¶**:
- `JOINING â†’ SUCCESS`: æœ€åä¸€ä¸ªç”¨æˆ·æ”¯ä»˜å®Œæˆï¼Œ`current_num == required_num`
- `JOINING â†’ FAILED`: å®šæ—¶ä»»åŠ¡æ£€æŸ¥ï¼Œ`expire_time < NOW()`

### 3.2 å‚å›¢çŠ¶æ€æœºï¼ˆMemberStatusï¼‰âœ…å·²å®ç°

```java
public enum MemberStatus {
    UNPAID(0, "å¾…æ”¯ä»˜"),      // è®¢å•status=0
    PAID(1, "å·²æ”¯ä»˜"),        // è®¢å•status=0ï¼ˆå¾…æˆå›¢ï¼‰ã€å¯ä»¥ä¸­é€”é€€å‡º
    SUCCESS(2, "å·²æˆå›¢"),     // è®¢å•status=1ï¼ˆå¾…å‘è´§ï¼‰ã€ä¸å¯é€€å‡º
    CANCELLED(3, "å·²å–æ¶ˆ");   // è®¢å•status=4æˆ–6ã€å·²é€€æ¬¾
}
```

**çŠ¶æ€æµè½¬å›¾**:

```mermaid
stateDiagram-v2
    [*] --> UNPAID: ç”¨æˆ·ç‚¹å‡»"å‚å›¢"
    
    UNPAID --> PAID: æ”¯ä»˜æˆåŠŸ
    UNPAID --> CANCELLED: ç”¨æˆ·å–æ¶ˆ/æ”¯ä»˜è¶…æ—¶
    
    PAID --> SUCCESS: å›¢æˆåŠŸ
    PAID --> CANCELLED: ç”¨æˆ·ä¸­é€”é€€å‡ºï¼ˆæˆå›¢å‰ï¼‰
    PAID --> CANCELLED: æ‹¼å›¢å¤±è´¥ï¼ˆå®šæ—¶ä»»åŠ¡é€€æ¬¾ï¼‰
    
    SUCCESS --> [*]
    CANCELLED --> [*]
```

---

## 4. ä¸šåŠ¡æµç¨‹è¯¦è§£

### 4.1 å›¢é•¿å‘èµ·æ‹¼å›¢æµç¨‹ âœ…å·²å®ç°

**æ¥å£**: `POST /api/groupbuy/team/launch`  
**Service**: `TeamService.launchTeam()`  
**v3.0ç‰¹æ€§**: ä»…å›¢é•¿å¯å‘èµ·ã€è‡ªåŠ¨å…³è”ç¤¾åŒº

**æµç¨‹æ­¥éª¤**:

```
1. å‰ç«¯ï¼šå›¢é•¿ç‚¹å‡»"å‘èµ·æ‹¼å›¢"
   â†“
2. åç«¯ï¼šæ£€æŸ¥æ´»åŠ¨æœ‰æ•ˆæ€§
   - æŸ¥è¯¢ group_buy è¡¨
   - éªŒè¯ status=1 ä¸” NOW() BETWEEN start_time AND end_time
   â†“
3. åç«¯ï¼šéªŒè¯å›¢é•¿èº«ä»½ï¼ˆv3.0æ ¸å¿ƒï¼‰â­
   - Feignè°ƒç”¨ UserService.getUserInfo(userId)
   - éªŒè¯ user.role == 2
   - å¦‚æœä¸æ˜¯å›¢é•¿ï¼šè¿”å›é”™è¯¯"ä»…å›¢é•¿å¯å‘èµ·æ‹¼å›¢"
   - å¦‚æœæ˜¯å›¢é•¿ï¼šç»§ç»­ï¼Œè·å– user.communityId
   â†“
4. åç«¯ï¼šåˆ›å»ºå›¢å®ä¾‹
   - ç”Ÿæˆå›¢å·ï¼šCONCAT('T', DATE_FORMAT(NOW(), '%Y%m%d'), LPAD(FLOOR(RAND()*1000000), 6, '0'))
   - è®¾ç½® launcher_id = leader_id = userIdï¼ˆå›¢é•¿ï¼‰
   - è®¾ç½® community_id = user.communityIdï¼ˆè‡ªåŠ¨å…³è”ç¤¾åŒºï¼‰â­
   - è®¾ç½® expire_time = NOW() + 24å°æ—¶
   - INSERT INTO group_buy_team
   â†“
5. åç«¯ï¼šå¦‚æœå›¢é•¿é€‰æ‹©ç«‹å³å‚ä¸ï¼ˆjoinImmediately=trueï¼‰
   - Feignè°ƒç”¨ OrderService.createOrder()
   - INSERT INTO group_buy_member (is_launcher=1, status=0)
   â†“
6. å‰ç«¯ï¼šè·³è½¬æ”¯ä»˜é¡µé¢ï¼ˆå¦‚æœå›¢é•¿å‚ä¸ï¼‰
   â†“
7. åç«¯ï¼šæ”¯ä»˜å›è°ƒï¼ˆTeamService.paymentCallbackï¼‰
   - UPDATE group_buy_member SET status=1
   - UPDATE group_buy_team SET current_num=1
   - æ£€æŸ¥æ˜¯å¦æˆå›¢ï¼ˆå¦‚æœ current_num == required_numï¼‰
   â†“
8. å‰ç«¯ï¼šç”Ÿæˆåˆ†äº«é“¾æ¥ï¼ˆåŒ…å« team_idï¼‰
   - æ ¼å¼ï¼šhttp://localhost:5173/team/{teamId}
```

**å…³é”®SQL**ï¼ˆå·²å®ç°ï¼‰:

```sql
-- Step 1: æ£€æŸ¥æ´»åŠ¨æœ‰æ•ˆæ€§
SELECT * FROM group_buy 
WHERE activity_id = ? 
  AND status = 1 
  AND NOW() BETWEEN start_time AND end_time;

-- Step 2: éªŒè¯å›¢é•¿èº«ä»½ï¼ˆFeignè°ƒç”¨UserServiceï¼‰
-- UserService: SELECT user_id, role, community_id FROM sys_user WHERE user_id = ?

-- Step 3: åˆ›å»ºå›¢å®ä¾‹ï¼ˆè‡ªåŠ¨å…³è”ç¤¾åŒºï¼‰
INSERT INTO group_buy_team (
  team_no, activity_id, launcher_id, leader_id, community_id,
  required_num, current_num, team_status, expire_time
) VALUES (
  CONCAT('T', DATE_FORMAT(NOW(), '%Y%m%d'), LPAD(FLOOR(RAND()*1000000), 6, '0')),
  ?, ?, ?, ?,  -- launcher_id = leader_id, community_id = å›¢é•¿çš„ç¤¾åŒº
  ?, 0, 0, DATE_ADD(NOW(), INTERVAL 24 HOUR)
);

-- Step 4: åˆ›å»ºè®¢å•ï¼ˆFeignè°ƒç”¨OrderServiceï¼‰
-- OrderService: INSERT INTO order_main (...)

-- Step 5: è®°å½•å‚å›¢ï¼ˆå›¢é•¿ä½œä¸ºå‘èµ·äººï¼‰
INSERT INTO group_buy_member (
  team_id, user_id, order_id, is_launcher, pay_amount, status
) VALUES (
  ?, ?, ?, 1, ?, 0  -- is_launcher=1
);
```

**å®ç°æ–‡ä»¶**:
- `TeamService.launchTeam()` (line 74-180)
- `TeamController.launchTeam()` (line 59-76)

### 4.2 ç”¨æˆ·å‚ä¸æ‹¼å›¢æµç¨‹ âœ…å·²å®ç°

**æ¥å£**: `POST /api/groupbuy/team/join`  
**Service**: `TeamService.joinTeam()`  
**æŠ€æœ¯äº®ç‚¹**: è¡Œé”é˜²å¹¶å‘ã€é˜²é‡å¤å‚å›¢

**æµç¨‹æ­¥éª¤**:

```
1. å‰ç«¯ï¼šç”¨æˆ·æ‰“å¼€åˆ†äº«é“¾æ¥ï¼ˆåŒ…å«team_idï¼‰
   â†“
2. å‰ç«¯ï¼šGET /api/groupbuy/team/{teamId}/detail æŸ¥è¯¢å›¢è¯¦æƒ…
   â†“
3. åç«¯ï¼šæ£€æŸ¥å›¢çŠ¶æ€
   - team_status != 0ï¼šè¿”å›"æ‹¼å›¢å·²ç»“æŸ"
   - current_num >= required_numï¼šè¿”å›"å›¢å·²æ»¡å‘˜"
   - expire_time < NOW()ï¼šè¿”å›"æ‹¼å›¢å·²è¿‡æœŸ"
   â†“
4. å‰ç«¯ï¼šç”¨æˆ·ç‚¹å‡»"ç«‹å³å‚å›¢"
   â†“
5. åç«¯ï¼šæŸ¥è¯¢å›¢ï¼ˆåŠ è¡Œé”ï¼‰â­é˜²å¹¶å‘
   - SELECT ... FROM group_buy_team WHERE team_id = ? FOR UPDATE
   â†“
6. åç«¯ï¼šé˜²é‡å¤å‚å›¢æ£€æŸ¥
   - SELECT * FROM group_buy_member WHERE team_id = ? AND user_id = ?
   - å¦‚æœå­˜åœ¨ï¼šè¿”å›"æ‚¨å·²å‚åŠ æ­¤å›¢"ï¼ˆå”¯ä¸€ç´¢å¼•ä¹Ÿä¼šæ‹¦æˆªï¼‰â­
   â†“
7. åç«¯ï¼šFeignè°ƒç”¨ OrderService.createOrder()
   - åˆ›å»ºè®¢å•ï¼ˆstatus=0ï¼Œå¾…æ”¯ä»˜ï¼‰
   â†“
8. åç«¯ï¼šè®°å½•å‚å›¢
   - INSERT INTO group_buy_member (is_launcher=0, status=0)
   â†“
9. å‰ç«¯ï¼šè·³è½¬æ”¯ä»˜é¡µé¢
   â†“
10. åç«¯ï¼šæ”¯ä»˜å›è°ƒï¼ˆTeamService.paymentCallbackï¼‰
    - æŸ¥è¯¢å‚å›¢è®°å½•ï¼ˆåŠ è¡Œé”ï¼‰â­å¹‚ç­‰æ€§
    - å¦‚æœ status != 0ï¼šè·³è¿‡ï¼ˆå·²å¤„ç†è¿‡ï¼‰â­
    - UPDATE group_buy_member SET status=1
    - UPDATE group_buy_team SET current_num = current_num + 1
    - æ£€æŸ¥æ˜¯å¦æˆå›¢ï¼ˆcurrent_num == required_numï¼‰
    â†“
11. åç«¯ï¼šå¦‚æœæˆå›¢ï¼Œè§¦å‘ TeamService.teamSuccess()
```

**å…³é”®SQL**ï¼ˆå·²å®ç°ï¼‰:

```sql
-- Step 1: æŸ¥è¯¢å›¢ï¼ˆåŠ è¡Œé”ï¼‰â­é˜²å¹¶å‘
SELECT t.* FROM group_buy_team t WHERE t.team_id = ? FOR UPDATE;

-- Step 2: é˜²é‡å¤å‚å›¢
SELECT * FROM group_buy_member WHERE team_id = ? AND user_id = ?;

-- Step 3: è®°å½•å‚å›¢
INSERT INTO group_buy_member (
  team_id, user_id, order_id, is_launcher, pay_amount, status
) VALUES (
  ?, ?, ?, 0, ?, 0  -- is_launcher=0
);

-- Step 4: æ”¯ä»˜å›è°ƒï¼ˆåŠ è¡Œé”ï¼‰â­å¹‚ç­‰æ€§
SELECT m.* FROM group_buy_member m WHERE m.order_id = ? FOR UPDATE;

-- å¹‚ç­‰æ€§æ£€æŸ¥
IF member.status != 0 THEN RETURN;  -- å·²å¤„ç†è¿‡

-- æ›´æ–°å‚å›¢çŠ¶æ€
UPDATE group_buy_member SET status = 1 WHERE member_id = ?;

-- æ›´æ–°å›¢äººæ•°
UPDATE group_buy_team SET current_num = current_num + 1 WHERE team_id = ?;

-- æ£€æŸ¥æ˜¯å¦æˆå›¢
SELECT current_num, required_num FROM group_buy_team WHERE team_id = ?;
```

**å®ç°æ–‡ä»¶**:
- `TeamService.joinTeam()` (line 183-279)
- `TeamService.paymentCallback()` (line 282-331)
- `TeamController.joinTeam()` (line 90-107)

### 4.3 æˆå›¢é€»è¾‘ âœ…å·²å®ç°

**Service**: `TeamService.teamSuccess()`  
**è§¦å‘æ—¶æœº**: æœ€åä¸€ä¸ªç”¨æˆ·æ”¯ä»˜å®Œæˆï¼Œ`current_num == required_num`  
**æŠ€æœ¯äº®ç‚¹**: å¹‚ç­‰æ€§ä¿è¯ã€æ‰¹é‡æ›´æ–°

**æµç¨‹æ­¥éª¤**:

```
1. æŸ¥è¯¢å›¢ï¼ˆåŠ è¡Œé”ï¼‰â­å¹‚ç­‰æ€§
   - SELECT ... FROM group_buy_team WHERE team_id = ? FOR UPDATE
   â†“
2. å¹‚ç­‰æ€§æ£€æŸ¥
   - å¦‚æœ team_status != 0ï¼šè·³è¿‡ï¼ˆå·²å¤„ç†è¿‡ï¼‰â­
   â†“
3. æ›´æ–°å›¢çŠ¶æ€
   - UPDATE group_buy_team SET team_status=1, success_time=NOW()
   â†“
4. æŸ¥è¯¢æ‰€æœ‰æˆå‘˜
   - SELECT * FROM group_buy_member WHERE team_id = ? ORDER BY join_time ASC
   â†“
5. æ‰¹é‡æ›´æ–°æˆå‘˜çŠ¶æ€
   - UPDATE group_buy_member SET status=2 WHERE team_id = ?
   â†“
6. æ‰¹é‡æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆFeignè°ƒç”¨ï¼‰â­
   - OrderService.batchUpdateOrderStatus(orderIds, 1)  // 1-å¾…å‘è´§
   - å¼‚å¸¸ä¸æŠ›å‡ºï¼Œé¿å…å½±å“æˆå›¢é€»è¾‘
   â†“
7. å‘é€æˆå›¢é€šçŸ¥ï¼ˆTODOï¼‰
```

**å…³é”®SQL**ï¼ˆå·²å®ç°ï¼‰:

```sql
-- Step 1: æŸ¥è¯¢å›¢ï¼ˆåŠ è¡Œé”ï¼‰â­å¹‚ç­‰æ€§
SELECT t.* FROM group_buy_team t WHERE t.team_id = ? FOR UPDATE;

-- Step 2: å¹‚ç­‰æ€§æ£€æŸ¥
IF team.team_status != 0 THEN RETURN;  -- å·²æˆå›¢ï¼Œè·³è¿‡

-- Step 3: æ›´æ–°å›¢çŠ¶æ€
UPDATE group_buy_team 
SET team_status = 1, success_time = NOW() 
WHERE team_id = ?;

-- Step 4: æŸ¥è¯¢æ‰€æœ‰æˆå‘˜
SELECT * FROM group_buy_member WHERE team_id = ? ORDER BY join_time ASC;

-- Step 5: æ‰¹é‡æ›´æ–°æˆå‘˜çŠ¶æ€
UPDATE group_buy_member SET status = 2 WHERE team_id = ?;

-- Step 6: æ‰¹é‡æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆFeignè°ƒç”¨OrderServiceï¼‰
-- OrderService: UPDATE order_main SET order_status = 1 WHERE order_id IN (...)
```

**å®ç°æ–‡ä»¶**:
- `TeamService.teamSuccess()` (line 334-398)

### 4.4 æ‹¼å›¢å¤±è´¥è‡ªåŠ¨é€€æ¬¾æµç¨‹ âœ…å·²å®ç°

**å®šæ—¶ä»»åŠ¡**: `TeamExpireTask.checkExpiredTeams()`  
**æ‰§è¡Œå‘¨æœŸ**: æ¯å°æ—¶ä¸€æ¬¡ï¼ˆcron: `0 0 * * * ?`ï¼‰  
**Service**: `RefundService.refundExpiredTeam()`  
**æŠ€æœ¯äº®ç‚¹**: å¹‚ç­‰æ€§ä¿è¯ã€å¼‚å¸¸éš”ç¦»

**æµç¨‹æ­¥éª¤**:

```
1. å®šæ—¶ä»»åŠ¡è§¦å‘ï¼ˆæ¯å°æ—¶0åˆ†0ç§’ï¼‰
   â†“
2. æŸ¥è¯¢è¿‡æœŸå›¢IDåˆ—è¡¨
   - SELECT team_id FROM group_buy_team 
     WHERE team_status = 0 AND expire_time < NOW()
   â†“
3. éå†å¤„ç†æ¯ä¸ªå›¢ï¼ˆå¼‚å¸¸éš”ç¦»ï¼‰â­
   - æ¯ä¸ªå›¢å•ç‹¬try-catch
   - å•ä¸ªå›¢å¤±è´¥ä¸å½±å“å…¶ä»–å›¢
   â†“
4. æŸ¥è¯¢å›¢ï¼ˆåŠ è¡Œé”ï¼‰â­å¹‚ç­‰æ€§
   - SELECT ... FROM group_buy_team WHERE team_id = ? FOR UPDATE
   â†“
5. å¹‚ç­‰æ€§æ£€æŸ¥
   - å¦‚æœ team_status != 0ï¼šè·³è¿‡ï¼ˆå·²å¤„ç†è¿‡ï¼‰â­
   â†“
6. æ ‡è®°å›¢å¤±è´¥
   - UPDATE group_buy_team SET team_status=2
   â†“
7. æŸ¥è¯¢å·²æ”¯ä»˜çš„æˆå‘˜
   - SELECT * FROM group_buy_member WHERE team_id = ? AND status = 1
   â†“
8. éå†é€€æ¬¾ï¼ˆæ¯ä¸ªæˆå‘˜å•ç‹¬å¤„ç†ï¼‰
   - Feignè°ƒç”¨ UserService.refundToBalance(userId, payAmount)
   - Feignè°ƒç”¨ OrderService.updateOrderStatus(orderId, 6)  // 6-å·²é€€æ¬¾
   - UPDATE group_buy_member SET status = 3
   â†“
9. å‘é€æ‹¼å›¢å¤±è´¥é€šçŸ¥ï¼ˆTODOï¼‰
```

**å…³é”®SQL**ï¼ˆå·²å®ç°ï¼‰:

```sql
-- Step 1: æŸ¥è¯¢è¿‡æœŸå›¢IDåˆ—è¡¨
SELECT team_id FROM group_buy_team 
WHERE team_status = 0 
  AND expire_time < NOW();

-- Step 2: æŸ¥è¯¢å›¢ï¼ˆåŠ è¡Œé”ï¼‰â­å¹‚ç­‰æ€§
SELECT t.* FROM group_buy_team t WHERE t.team_id = ? FOR UPDATE;

-- Step 3: å¹‚ç­‰æ€§æ£€æŸ¥
IF team.team_status != 0 THEN RETURN;  -- å·²å¤„ç†ï¼Œè·³è¿‡

-- Step 4: æ ‡è®°å›¢å¤±è´¥
UPDATE group_buy_team SET team_status = 2 WHERE team_id = ?;

-- Step 5: æŸ¥è¯¢å·²æ”¯ä»˜çš„æˆå‘˜
SELECT * FROM group_buy_member 
WHERE team_id = ? AND status = 1;

-- Step 6: é€€æ¬¾åˆ°ç”¨æˆ·è´¦æˆ·ï¼ˆFeignè°ƒç”¨UserServiceï¼‰
-- UserService: UPDATE user_account 
--              SET balance = balance + ?, update_time = NOW() 
--              WHERE user_id = ?

-- Step 7: æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆFeignè°ƒç”¨OrderServiceï¼‰
-- OrderService: UPDATE order_main SET order_status = 6, refund_time = NOW() WHERE order_id = ?

-- Step 8: æ›´æ–°å‚å›¢çŠ¶æ€
UPDATE group_buy_member SET status = 3 WHERE member_id = ?;
```

**å®ç°æ–‡ä»¶**:
- `TeamExpireTask.checkExpiredTeams()` (line 51-96)
- `RefundService.refundExpiredTeam()` (line 48-118)

### 4.5 ç”¨æˆ·ä¸­é€”é€€å‡ºæµç¨‹ âœ…å·²å®ç°

**æ¥å£**: `POST /api/groupbuy/team/quit`  
**Service**: `RefundService.quitTeam()`  
**é™åˆ¶**: ä»…æˆå›¢å‰å¯é€€å‡º

**æµç¨‹æ­¥éª¤**:

```
1. å‰ç«¯ï¼šç”¨æˆ·ç‚¹å‡»"é€€å‡ºæ‹¼å›¢"
   â†“
2. åç«¯ï¼šæŸ¥è¯¢å‚å›¢è®°å½•
   - SELECT * FROM group_buy_member WHERE team_id = ? AND user_id = ? AND status = 1
   â†“
3. åç«¯ï¼šæŸ¥è¯¢å›¢ï¼ˆåŠ è¡Œé”ï¼‰
   - SELECT ... FROM group_buy_team WHERE team_id = ? FOR UPDATE
   â†“
4. åç«¯ï¼šæ£€æŸ¥å›¢çŠ¶æ€
   - team_status == 1ï¼šè¿”å›"æ‹¼å›¢å·²æˆåŠŸï¼Œæ— æ³•é€€å‡º"
   - team_status == 2ï¼šè¿”å›"æ‹¼å›¢å·²å¤±è´¥ï¼Œæ— éœ€é€€å‡º"
   â†“
5. åç«¯ï¼šåˆ é™¤å‚å›¢è®°å½•
   - DELETE FROM group_buy_member WHERE member_id = ?
   â†“
6. åç«¯ï¼šæ›´æ–°å›¢äººæ•°
   - UPDATE group_buy_team SET current_num = current_num - 1
   â†“
7. åç«¯ï¼šé€€æ¬¾ï¼ˆFeignè°ƒç”¨ï¼‰
   - UserService.refundToBalance(userId, payAmount)
   - OrderService.updateOrderStatus(orderId, 6)  // 6-å·²é€€æ¬¾
   â†“
8. å‰ç«¯ï¼šæç¤º"é€€å‡ºæˆåŠŸï¼Œå·²é€€æ¬¾"
```

**å®ç°æ–‡ä»¶**:
- `RefundService.quitTeam()` (line 120-177)
- `TeamController.quitTeam()` (line 158-174)

---

## 5. æŠ€æœ¯äº®ç‚¹å®ç°

### 5.1 æ— Redisåˆ†å¸ƒå¼é”æ–¹æ¡ˆ â­â­â­â­â­

**å®ç°æ–¹å¼**: æ•°æ®åº“è¡Œé”ï¼ˆSELECT ... FOR UPDATEï¼‰

**åº”ç”¨åœºæ™¯**:
1. ç”¨æˆ·å‚å›¢æ—¶æ£€æŸ¥å›¢çŠ¶æ€
2. æ”¯ä»˜å›è°ƒæ›´æ–°å›¢äººæ•°
3. å®šæ—¶ä»»åŠ¡æ ‡è®°å›¢å¤±è´¥

**ä»£ç å®ç°**:

```java
// TeamRepository.java
@Query("SELECT t FROM GroupBuyTeam t WHERE t.teamId = :teamId")
@Lock(LockModeType.PESSIMISTIC_WRITE)
Optional<GroupBuyTeam> findByIdForUpdate(@Param("teamId") Long teamId);

// MemberRepository.java
@Query("SELECT m FROM GroupBuyMember m WHERE m.orderId = :orderId")
@Lock(LockModeType.PESSIMISTIC_WRITE)
Optional<GroupBuyMember> findByOrderIdForUpdate(@Param("orderId") Long orderId);
```

**æŠ€æœ¯ä¼˜åŠ¿**:
- âœ… é€‚ç”¨äºä¸­å°è§„æ¨¡å¹¶å‘
- âœ… æ— éœ€å¼•å…¥Redis
- âœ… äº‹åŠ¡å†…è‡ªåŠ¨é‡Šæ”¾é”
- âœ… æ•°æ®åº“å±‚é¢ä¿è¯ä¸€è‡´æ€§

**å¹¶å‘æµ‹è¯•ç»“æœ**:
- 10äººåŒæ—¶å‚3äººå›¢ï¼Œåªæœ‰3äººæˆåŠŸ âœ…

**å®ç°æ–‡ä»¶**:
- `TeamRepository.findByIdForUpdate()` (line 45-47)
- `MemberRepository.findByOrderIdForUpdate()` (line 62-64)

### 5.2 ä¸‰å±‚å¹‚ç­‰æ€§è®¾è®¡ â­â­â­â­â­

**è®¾è®¡åŸåˆ™**: è¡Œé” + çŠ¶æ€æ£€æŸ¥

**ä¸‰å±‚å¹‚ç­‰æ€§**:

| å±‚çº§ | æ–¹æ³• | å¹‚ç­‰æ€§å®ç° | çŠ¶æ€æ£€æŸ¥ |
|------|------|-----------|---------|
| 1ï¸âƒ£ æ”¯ä»˜å›è°ƒ | `TeamService.paymentCallback()` | è¡Œé” + `member.status != UNPAID` | è·³è¿‡å·²å¤„ç† |
| 2ï¸âƒ£ æˆå›¢é€»è¾‘ | `TeamService.teamSuccess()` | è¡Œé” + `team.teamStatus != JOINING` | è·³è¿‡å·²æˆå›¢ |
| 3ï¸âƒ£ å®šæ—¶ä»»åŠ¡ | `RefundService.refundExpiredTeam()` | è¡Œé” + `team.teamStatus != JOINING` | è·³è¿‡å·²å¤„ç† |

**ä»£ç å®ç°**:

```java
// 1ï¸âƒ£ æ”¯ä»˜å›è°ƒå¹‚ç­‰æ€§
@Transactional
public void paymentCallback(Long orderId) {
    // æŸ¥è¯¢å‚å›¢è®°å½•ï¼ˆåŠ è¡Œé”ï¼‰â­
    GroupBuyMember member = memberRepository.findByOrderIdForUpdate(orderId).orElseThrow(...);
    
    // å¹‚ç­‰æ€§æ£€æŸ¥ â­
    if (member.getStatus() != MemberStatus.UNPAID.getCode()) {
        log.warn("é‡å¤æ”¯ä»˜å›è°ƒï¼ŒorderId={}", orderId);
        return;  // å·²å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›
    }
    
    // æ›´æ–°çŠ¶æ€
    member.setStatus(MemberStatus.PAID.getCode());
    memberRepository.save(member);
}

// 2ï¸âƒ£ æˆå›¢é€»è¾‘å¹‚ç­‰æ€§
@Transactional
public void teamSuccess(Long teamId) {
    // æŸ¥è¯¢å›¢ï¼ˆåŠ è¡Œé”ï¼‰â­
    GroupBuyTeam team = teamRepository.findByIdForUpdate(teamId).orElseThrow(...);
    
    // å¹‚ç­‰æ€§æ£€æŸ¥ â­
    if (team.getTeamStatus() != TeamStatus.JOINING.getCode()) {
        log.warn("é‡å¤æˆå›¢ï¼ŒteamId={}", teamId);
        return;  // å·²å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›
    }
    
    // æ›´æ–°çŠ¶æ€
    team.setTeamStatus(TeamStatus.SUCCESS.getCode());
    teamRepository.save(team);
}

// 3ï¸âƒ£ å®šæ—¶ä»»åŠ¡å¹‚ç­‰æ€§
@Transactional
public void refundExpiredTeam(Long teamId) {
    // æŸ¥è¯¢å›¢ï¼ˆåŠ è¡Œé”ï¼‰â­
    GroupBuyTeam team = teamRepository.findByIdForUpdate(teamId).orElseThrow(...);
    
    // å¹‚ç­‰æ€§æ£€æŸ¥ â­
    if (team.getTeamStatus() != TeamStatus.JOINING.getCode()) {
        log.warn("å›¢{}çŠ¶æ€å·²å˜æ›´ï¼Œè·³è¿‡é€€æ¬¾", teamId);
        return;  // å·²å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›
    }
    
    // æ ‡è®°å›¢å¤±è´¥
    team.setTeamStatus(TeamStatus.FAILED.getCode());
    teamRepository.save(team);
}
```

**å®ç°æ–‡ä»¶**:
- `TeamService.paymentCallback()` (line 297-331)
- `TeamService.teamSuccess()` (line 349-398)
- `RefundService.refundExpiredTeam()` (line 62-118)

### 5.3 Sagaæ¨¡å¼è·¨æœåŠ¡è°ƒç”¨ â­â­â­â­

**è®¾è®¡åŸåˆ™**: å…ˆFeignåˆ›å»ºè®¢å• â†’ å†è®°å½•å‚å›¢ + è¡¥å¿æœºåˆ¶

**ä¸šåŠ¡æµç¨‹**:

```
ç”¨æˆ·å‚å›¢:
1. Feignè°ƒç”¨ OrderService.createOrder()
   â†“ æˆåŠŸ
2. è®°å½•å‚å›¢ INSERT INTO group_buy_member
   â†“ å¤±è´¥åˆ™æŠ›å¼‚å¸¸ï¼Œäº‹åŠ¡å›æ»š

è¡¥å¿æœºåˆ¶:
- OrderServiceè®¢å•30åˆ†é’Ÿæœªæ”¯ä»˜è‡ªåŠ¨è¿‡æœŸ
- å¼‚å¸¸éš”ç¦»ï¼ˆtry-catchæ•è·ï¼Œä¸å½±å“ä¸»æµç¨‹ï¼‰
```

**ä»£ç å®ç°**:

```java
@Transactional(rollbackFor = Exception.class)
public JoinResult joinTeam(JoinTeamRequest request) {
    // ... çŠ¶æ€æ£€æŸ¥ ...
    
    // Step 1: Feignåˆ›å»ºè®¢å• â­
    CreateOrderRequest orderReq = CreateOrderRequest.builder()
        .userId(request.getUserId())
        .leaderId(team.getLeaderId())
        .addressId(request.getAddressId())
        .productId(activity.getProductId())
        // ...
        .build();
    
    Result<Long> orderResult = orderServiceClient.createOrder(orderReq);
    if (orderResult.getCode() != 200) {
        throw new BusinessException("åˆ›å»ºè®¢å•å¤±è´¥ï¼š" + orderResult.getMessage());
    }
    
    Long orderId = orderResult.getData();
    
    // Step 2: è®°å½•å‚å›¢
    GroupBuyMember member = new GroupBuyMember();
    member.setTeamId(request.getTeamId());
    member.setUserId(request.getUserId());
    member.setOrderId(orderId);  // å…³è”è®¢å•
    member.setIsLauncher(0);
    member.setPayAmount(/* ... */);
    member.setStatus(MemberStatus.UNPAID.getCode());
    memberRepository.save(member);
    
    // å¦‚æœStep 2å¤±è´¥ï¼Œäº‹åŠ¡å›æ»šï¼Œè®¢å•ä¼šåœ¨30åˆ†é’Ÿåè‡ªåŠ¨è¿‡æœŸï¼ˆè¡¥å¿æœºåˆ¶ï¼‰â­
    return buildJoinResult(/* ... */);
}
```

**å¼‚å¸¸å¤„ç†**:

```java
// æˆå›¢é€»è¾‘ä¸­çš„Feignè°ƒç”¨å¼‚å¸¸å¤„ç†
try {
    Result<Void> result = orderServiceClient.batchUpdateOrderStatus(orderIds, 1);
    if (result.getCode() == 200) {
        log.info("æ‰¹é‡æ›´æ–°è®¢å•çŠ¶æ€æˆåŠŸ");
    } else {
        log.error("æ‰¹é‡æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥ï¼ŒorderIds={}", orderIds);
        // ä¸æŠ›å¼‚å¸¸ï¼Œåç»­å¯é€šè¿‡è¡¥å¿ä»»åŠ¡ä¿®å¤ â­
    }
} catch (Exception e) {
    log.error("æ‰¹é‡æ›´æ–°è®¢å•çŠ¶æ€å¼‚å¸¸ï¼ŒorderIds={}", orderIds, e);
    // ä¸æŠ›å¼‚å¸¸ï¼Œæˆå›¢é€»è¾‘å·²å®Œæˆ â­
}
```

**å®ç°æ–‡ä»¶**:
- `TeamService.joinTeam()` (line 197-279)
- `TeamService.teamSuccess()` (line 378-394)

### 5.4 ç¤¾åŒºä¼˜å…ˆæ¨èï¼ˆv3.0ç‰¹æ€§ï¼‰â­â­â­â­

**å®ç°æ–¹å¼**: SQL `ORDER BY CASE`

**ä¸šåŠ¡éœ€æ±‚**: ç”¨æˆ·æŸ¥çœ‹å›¢åˆ—è¡¨æ—¶ï¼Œæœ¬ç¤¾åŒºçš„å›¢ä¼˜å…ˆæ˜¾ç¤º

**SQLå®ç°**:

```sql
SELECT * FROM group_buy_team t
WHERE t.activity_id = :activityId
  AND t.team_status = 0
  AND t.expire_time > NOW()
ORDER BY 
  CASE WHEN t.community_id = :communityId THEN 0 ELSE 1 END ASC,  -- æœ¬ç¤¾åŒºä¼˜å…ˆâ­
  t.create_time DESC
LIMIT :limit
```

**æ’åºé€»è¾‘**:
- `community_id == communityId` â†’ 0 (æ’åœ¨å‰é¢)
- `community_id != communityId` â†’ 1 (æ’åœ¨åé¢)
- åŒä¸€ä¼˜å…ˆçº§å†…æŒ‰åˆ›å»ºæ—¶é—´å€’åº

**ä»£ç å®ç°**:

```java
// TeamRepository.java
@Query(value = """
    SELECT * FROM group_buy_team t
    WHERE t.activity_id = :activityId
      AND t.team_status = 0
      AND t.expire_time > NOW()
    ORDER BY 
      CASE WHEN t.community_id = :communityId THEN 0 ELSE 1 END ASC,
      t.create_time DESC
    LIMIT :limit
    """, nativeQuery = true)
List<GroupBuyTeam> findByActivityIdWithCommunityPriority(
    @Param("activityId") Long activityId,
    @Param("communityId") Long communityId,
    @Param("limit") int limit
);

// TeamService.java
public List<TeamDetailResponse> getActivityTeams(Long activityId, Long communityId) {
    // ä½¿ç”¨Repositoryçš„ç¤¾åŒºä¼˜å…ˆæ’åºæŸ¥è¯¢ â­
    List<GroupBuyTeam> teams = teamRepository.findByActivityIdWithCommunityPriority(
        activityId,
        communityId != null ? communityId : 0L,  // nullæ—¶ä¼ 0
        20  // æœ€å¤š20ä¸ªå›¢
    );
    
    // æ„å»ºå“åº”...
    return teams.stream().map(this::buildTeamDetailResponse).collect(Collectors.toList());
}
```

**æŠ€æœ¯ä¼˜åŠ¿**:
- âœ… SQLå±‚å®ç°ï¼Œæ€§èƒ½é«˜
- âœ… æ— éœ€åº”ç”¨å±‚æ’åº
- âœ… æ”¯æŒè·¨ç¤¾åŒºæ‹¼å›¢

**å®ç°æ–‡ä»¶**:
- `TeamRepository.findByActivityIdWithCommunityPriority()` (line 77-91)
- `TeamService.getActivityTeams()` (line 435-451)

### 5.5 å®šæ—¶ä»»åŠ¡å¼‚å¸¸éš”ç¦» â­â­â­

**è®¾è®¡åŸåˆ™**: æ¯ä¸ªå›¢å•ç‹¬äº‹åŠ¡å¤„ç† + try-catchæ•è·

**ä¸šåŠ¡åœºæ™¯**: å®šæ—¶ä»»åŠ¡å¤„ç†è¿‡æœŸå›¢ï¼Œå•ä¸ªå›¢å¤±è´¥ä¸å½±å“å…¶ä»–å›¢

**ä»£ç å®ç°**:

```java
@Scheduled(cron = "0 0 * * * ?")
public void checkExpiredTeams() {
    // 1. æŸ¥è¯¢è¿‡æœŸå›¢IDåˆ—è¡¨
    List<Long> expiredTeamIds = teamRepository.findExpiredTeamIds(LocalDateTime.now());
    
    // 2. éå†å¤„ç†æ¯ä¸ªå›¢ï¼ˆå¼‚å¸¸éš”ç¦»ï¼‰â­
    int successCount = 0;
    int failCount = 0;
    
    for (Long teamId : expiredTeamIds) {
        try {
            // æ¯ä¸ªå›¢å•ç‹¬äº‹åŠ¡å¤„ç†ï¼ˆRefundServiceä¸­@Transactionalï¼‰â­
            refundService.refundExpiredTeam(teamId);
            successCount++;
            log.info("âœ… å›¢{}é€€æ¬¾æˆåŠŸ", teamId);
        } catch (Exception e) {
            failCount++;
            log.error("âŒ å›¢{}é€€æ¬¾å¤±è´¥", teamId, e);
            // ä¸æŠ›å¼‚å¸¸ï¼Œç»§ç»­å¤„ç†å…¶ä»–å›¢ï¼ˆå¼‚å¸¸éš”ç¦»ï¼‰â­
        }
    }
    
    // 3. æ±‡æ€»ç»Ÿè®¡
    log.info("è¿‡æœŸå›¢å¤„ç†å®Œæˆï¼Œæ€»è®¡ï¼š{}ä¸ªï¼ŒæˆåŠŸï¼š{}ä¸ªï¼Œå¤±è´¥ï¼š{}ä¸ª", 
        expiredTeamIds.size(), successCount, failCount);
}
```

**æŠ€æœ¯ä¼˜åŠ¿**:
- âœ… å•ä¸ªå›¢å¤±è´¥ä¸å½±å“å…¶ä»–å›¢
- âœ… æ¯ä¸ªå›¢å•ç‹¬äº‹åŠ¡ï¼Œå¤±è´¥è‡ªåŠ¨å›æ»š
- âœ… è¯¦ç»†çš„ç»Ÿè®¡æ—¥å¿—

**å®ç°æ–‡ä»¶**:
- `TeamExpireTask.checkExpiredTeams()` (line 51-96)

---

## 6. APIæ¥å£æ¸…å•

### 6.1 æ‹¼å›¢æ´»åŠ¨ç®¡ç†æ¥å£ï¼ˆç®¡ç†ç«¯ï¼‰

| åºå· | æ¥å£ | æ–¹æ³• | æƒé™ | è¯´æ˜ |
|------|------|------|------|------|
| 1 | `/api/groupbuy/activity` | POST | ç®¡ç†å‘˜ | åˆ›å»ºæ‹¼å›¢æ´»åŠ¨ |
| 2 | `/api/groupbuy/activity/{id}` | PUT | ç®¡ç†å‘˜ | æ›´æ–°æ‹¼å›¢æ´»åŠ¨ |
| 3 | `/api/groupbuy/activity/{id}` | DELETE | ç®¡ç†å‘˜ | åˆ é™¤æ‹¼å›¢æ´»åŠ¨ |
| 4 | `/api/groupbuy/activities` | GET | æ— éœ€ | è·å–æ´»åŠ¨åˆ—è¡¨ |
| 5 | `/api/groupbuy/activities/ongoing` | GET | æ— éœ€ | è·å–è¿›è¡Œä¸­çš„æ´»åŠ¨ |
| 6 | `/api/groupbuy/activity/{id}` | GET | æ— éœ€ | è·å–æ´»åŠ¨è¯¦æƒ… |

### 6.2 å›¢ç®¡ç†æ¥å£ï¼ˆæ ¸å¿ƒï¼‰

| åºå· | æ¥å£ | æ–¹æ³• | æƒé™ | è¯´æ˜ |
|------|------|------|------|------|
| 1 | `/api/groupbuy/team/launch` | POST | å›¢é•¿ | å›¢é•¿å‘èµ·æ‹¼å›¢ï¼ˆv3.0æ ¸å¿ƒï¼‰â­ |
| 2 | `/api/groupbuy/team/join` | POST | ç”¨æˆ· | ç”¨æˆ·å‚ä¸æ‹¼å›¢ï¼ˆè¡Œé”é˜²å¹¶å‘ï¼‰â­ |
| 3 | `/api/groupbuy/payment/callback` | POST | å†…éƒ¨ | æ”¯ä»˜å›è°ƒï¼ˆå¹‚ç­‰æ€§ä¿è¯ï¼‰â­ |
| 4 | `/api/groupbuy/team/{teamId}/detail` | GET | æ— éœ€ | è·å–å›¢è¯¦æƒ… |
| 5 | `/api/groupbuy/activity/{activityId}/teams` | GET | æ— éœ€ | è·å–æ´»åŠ¨å›¢åˆ—è¡¨ï¼ˆç¤¾åŒºä¼˜å…ˆï¼‰â­ |
| 6 | `/api/groupbuy/teams/my` | GET | ç”¨æˆ· | æˆ‘çš„æ‹¼å›¢è®°å½• |
| 7 | `/api/groupbuy/team/quit` | POST | ç”¨æˆ· | é€€å‡ºæ‹¼å›¢ï¼ˆæˆå›¢å‰ï¼‰ |
| 8 | `/api/groupbuy/teams/leader` | GET | å›¢é•¿ | å›¢é•¿æ‹¼å›¢è®°å½•ï¼ˆæ–°å¢ï¼‰âœ… |

**æ€»è®¡**: 14ä¸ªAPIæ¥å£ï¼ˆä»Šå¤©æ–°å¢1ä¸ªï¼‰

### 6.3 å®ç°çŠ¶æ€

| æ¨¡å— | è®¡åˆ’æ¥å£æ•° | å®é™…æ¥å£æ•° | å®Œæˆåº¦ | è¯´æ˜ |
|------|----------|----------|--------|------|
| æ‹¼å›¢æ´»åŠ¨ç®¡ç† | 6ä¸ª | 6ä¸ª | 100% | âœ… å·²å®Œæˆ |
| å›¢ç®¡ç† | 7ä¸ª | 8ä¸ª | 114% | âœ… å·²å®Œæˆï¼ˆè¶…é¢1ä¸ªï¼‰ |
| **æ€»è®¡** | **13ä¸ª** | **14ä¸ª** | **108%** | âœ… å·²è¶…é¢å®Œæˆ |

---

## 7. æ–‡æ¡£ä¸ä»£ç å¯¹æ¯”

### 7.1 å®Œå…¨ä¸€è‡´çš„éƒ¨åˆ† âœ…

| é¡¹ç›® | æ–‡æ¡£è®¾è®¡ | ä»£ç å®ç° | çŠ¶æ€ |
|------|---------|---------|------|
| ä¸‰å±‚æ¨¡å‹ | Activity â†’ Team â†’ Member | âœ… å·²å®ç° | 100%ä¸€è‡´ |
| å›¢çŠ¶æ€æœº | JOINING/SUCCESS/FAILED | âœ… å·²å®ç° | 100%ä¸€è‡´ |
| å‚å›¢çŠ¶æ€æœº | UNPAID/PAID/SUCCESS/CANCELLED | âœ… å·²å®ç° | 100%ä¸€è‡´ |
| v3.0ç‰¹æ€§ | ä»…å›¢é•¿å‘èµ·ã€è‡ªåŠ¨å…³è”ç¤¾åŒº | âœ… å·²å®ç° | 100%ä¸€è‡´ |
| è¡Œé”é˜²å¹¶å‘ | SELECT ... FOR UPDATE | âœ… å·²å®ç° | 100%ä¸€è‡´ |
| ä¸‰å±‚å¹‚ç­‰æ€§ | æ”¯ä»˜å›è°ƒ/æˆå›¢/å®šæ—¶ä»»åŠ¡ | âœ… å·²å®ç° | 100%ä¸€è‡´ |
| ç¤¾åŒºä¼˜å…ˆæ¨è | SQL ORDER BY CASE | âœ… å·²å®ç° | 100%ä¸€è‡´ |
| å®šæ—¶ä»»åŠ¡ | æ¯å°æ—¶æ£€æŸ¥è¿‡æœŸå›¢ | âœ… å·²å®ç° | 100%ä¸€è‡´ |
| å¼‚å¸¸éš”ç¦» | å•ä¸ªå›¢å¤±è´¥ä¸å½±å“å…¶ä»–å›¢ | âœ… å·²å®ç° | 100%ä¸€è‡´ |

### 7.2 å®ç°è¶…å‡ºæ–‡æ¡£çš„éƒ¨åˆ† âœ…è¶…é¢

| åŠŸèƒ½ | æ–‡æ¡£ | ä»£ç å®ç° | è¯´æ˜ |
|------|------|---------|------|
| å›¢é•¿æ‹¼å›¢è®°å½•æŸ¥è¯¢ | æ—  | âœ… å·²å®ç° | ä»Šå¤©æ–°å¢API `/api/groupbuy/teams/leader` |
| Feignå®¢æˆ·ç«¯Fallback | æ—  | âœ… å·²å®ç° | 4ä¸ªFallbackç±»ï¼ŒæœåŠ¡é™çº§å¤„ç† |
| æ—¥å¿—AOPè®°å½• | æ—  | âœ… å·²å®ç° | `@OperationLog` æ³¨è§£è‡ªåŠ¨è®°å½• |
| OpenAPIæ–‡æ¡£ | æ—  | âœ… å·²å®ç° | Swagger UIå®Œæ•´æ–‡æ¡£ |
| ç»Ÿè®¡æ—¥å¿— | æ—  | âœ… å·²å®ç° | å®šæ—¶ä»»åŠ¡æˆåŠŸç‡ç»Ÿè®¡ |

### 7.3 å¾…å®ç°çš„éƒ¨åˆ† â³

| åŠŸèƒ½ | æ–‡æ¡£è®¾è®¡ | ä»£ç å®ç° | è¯´æ˜ |
|------|---------|---------|------|
| é€šçŸ¥ç³»ç»Ÿ | æˆå›¢é€šçŸ¥/å¤±è´¥é€šçŸ¥ | TODO | é¢„ç•™æ—¥å¿—ï¼Œæœªå®ç° |
| ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢ | æˆå‘˜åˆ—è¡¨æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ | TODO | å½“å‰è¿”å›"ç”¨æˆ·{userId}" |
| å›¢å‘˜ç®¡ç†å‰ç«¯ | å›¢é•¿ç«¯æŸ¥çœ‹å›¢å‘˜ | â³ å¾…å¯¹æ¥ | åç«¯å·²å®Œæˆï¼Œå‰ç«¯å¾…å¼€å‘ |

### 7.4 æ–‡æ¡£æ›´æ–°å»ºè®® ğŸ“

åŸºäºä»£ç å®ç°ï¼Œå»ºè®®æ›´æ–°ä»¥ä¸‹æ–‡æ¡£ï¼š

1. **ã€Šæ‹¼å›¢é€»è¾‘ä¼˜åŒ–æ–¹æ¡ˆ.mdã€‹**
   - âœ… v3.0ç‰¹æ€§å…¨éƒ¨å·²å®ç°
   - âœ… æ•°æ®åº“è®¾è®¡100%ä¸€è‡´
   - âœ… ä¸šåŠ¡æµç¨‹100%ä¸€è‡´
   - ğŸ“ å»ºè®®ï¼šæ·»åŠ "å·²å®ç°"æ ‡è®°

2. **ã€ŠAPI_GroupBuyService.mdã€‹**
   - ğŸ“ å»ºè®®ï¼šæ·»åŠ ä»Šå¤©æ–°å¢çš„ `/api/groupbuy/teams/leader` æ¥å£
   - ğŸ“ å»ºè®®ï¼šæ›´æ–°æ¥å£ç»Ÿè®¡ä¸º14ä¸ªï¼ˆå½“å‰æ–‡æ¡£12ä¸ªï¼‰

3. **åˆ›å»ºæ–°æ–‡æ¡£**:
   - ğŸ“ å»ºè®®ï¼šåˆ›å»ºã€ŠGroupBuyServiceå¼€å‘å®ŒæˆæŠ¥å‘Š.mdã€‹
   - ğŸ“ å»ºè®®ï¼šåˆ›å»ºã€Šæ‹¼å›¢ä¸šåŠ¡æµ‹è¯•æŠ¥å‘Š.mdã€‹

---

## 8. æ€»ç»“

### 8.1 å®ç°æˆæœ âœ…

1. **å®Œæ•´åº¦**: 100%å®ç°æ–‡æ¡£è®¾è®¡ï¼Œç”šè‡³è¶…é¢å®Œæˆ
2. **ä¸€è‡´æ€§**: ä»£ç å®ç°ä¸æ–‡æ¡£è®¾è®¡é«˜åº¦ä¸€è‡´
3. **è´¨é‡**: 5ä¸ªæ ¸å¿ƒæŠ€æœ¯äº®ç‚¹å…¨éƒ¨å®ç°
4. **æ¥å£æ•°**: 14ä¸ªAPIæ¥å£ï¼ˆè®¡åˆ’13ä¸ªï¼Œè¶…é¢1ä¸ªï¼‰

### 8.2 æŠ€æœ¯äº®ç‚¹ â­

1. â­â­â­â­â­ æ— Redisåˆ†å¸ƒå¼é”ï¼ˆæ•°æ®åº“è¡Œé”ï¼‰
2. â­â­â­â­â­ ä¸‰å±‚å¹‚ç­‰æ€§è®¾è®¡ï¼ˆé˜²é‡å¤å¤„ç†ï¼‰
3. â­â­â­â­ Sagaæ¨¡å¼è·¨æœåŠ¡è°ƒç”¨ï¼ˆè¡¥å¿æœºåˆ¶ï¼‰
4. â­â­â­â­ ç¤¾åŒºä¼˜å…ˆæ¨èï¼ˆSQLä¼˜åŒ–ï¼‰
5. â­â­â­ å®šæ—¶ä»»åŠ¡å¼‚å¸¸éš”ç¦»ï¼ˆå®¹é”™è®¾è®¡ï¼‰

### 8.3 ä¸šåŠ¡å®Œæ•´æ€§ âœ…

- âœ… å›¢é•¿å‘èµ·æ‹¼å›¢ï¼ˆv3.0ç‰¹æ€§ï¼‰
- âœ… ç”¨æˆ·å‚ä¸æ‹¼å›¢ï¼ˆè¡Œé”é˜²å¹¶å‘ï¼‰
- âœ… æ”¯ä»˜å›è°ƒå¤„ç†ï¼ˆå¹‚ç­‰æ€§ä¿è¯ï¼‰
- âœ… è‡ªåŠ¨æˆå›¢é€»è¾‘ï¼ˆæ‰¹é‡æ›´æ–°ï¼‰
- âœ… è¿‡æœŸè‡ªåŠ¨é€€æ¬¾ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
- âœ… ç”¨æˆ·ä¸­é€”é€€å‡ºï¼ˆæˆå›¢å‰ï¼‰
- âœ… ç¤¾åŒºä¼˜å…ˆæ¨èï¼ˆv3.0ç‰¹æ€§ï¼‰
- âœ… å›¢é•¿æŸ¥è¯¢è‡ªå·±çš„å›¢ï¼ˆæ–°å¢åŠŸèƒ½ï¼‰

---

**æ–‡æ¡£ç»“æŸ**

**é™„ä»¶**:
- [æ‹¼å›¢é€»è¾‘ä¼˜åŒ–æ–¹æ¡ˆ.md](./æ‹¼å›¢é€»è¾‘ä¼˜åŒ–æ–¹æ¡ˆ.md) - ç†è®ºè®¾è®¡æ–‡æ¡£
- [API_GroupBuyService.md](./API_GroupBuyService.md) - APIæ¥å£æ–‡æ¡£
- GroupBuyServiceæºä»£ç  - `community-group-buy-backend/GroupBuyService/`

**ä¸‹ä¸€æ­¥å·¥ä½œ**:
1. â³ è¡¥å……é€šçŸ¥ç³»ç»Ÿï¼ˆæˆå›¢é€šçŸ¥ã€å¤±è´¥é€šçŸ¥ï¼‰
2. â³ å®Œå–„ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢ï¼ˆæˆå‘˜åˆ—è¡¨ï¼‰
3. â³ å‰ç«¯å¯¹æ¥å›¢é•¿ç«¯åŠŸèƒ½ï¼ˆå›¢å‘˜ç®¡ç†ï¼‰
4. âœ… æ›´æ–°APIæ–‡æ¡£ï¼ˆæ–°å¢æ¥å£ï¼‰

