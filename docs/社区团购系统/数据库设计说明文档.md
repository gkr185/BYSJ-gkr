# 社区团购系统 - 数据库设计说明文档

**项目名称**: 基于Spring Boot的社区团购系统  
**数据库名称**: `community_group_buy`  
**数据库版本**: MySQL 8.0.36  
**字符集**: utf8mb4  
**排序规则**: utf8mb4_0900_ai_ci  
**文档版本**: v1.0  
**更新日期**: 2025-10-12

---

## 目录

1. [数据库概述](#1-数据库概述)
2. [表结构设计](#2-表结构设计)
3. [表关系图](#3-表关系图)
4. [索引设计](#4-索引设计)
5. [外键约束](#5-外键约束)
6. [字段类型说明](#6-字段类型说明)
7. [业务规则说明](#7-业务规则说明)
8. [数据字典](#8-数据字典)

---

## 1. 数据库概述

### 1.1 设计原则

- **规范化设计**: 遵循第三范式(3NF)，减少数据冗余
- **完整性约束**: 使用主键、外键、唯一索引保证数据完整性
- **性能优化**: 合理设计索引，支持高效查询
- **可扩展性**: 预留扩展字段，支持业务发展
- **安全性**: 敏感数据加密存储（密码、手机号、支付信息）

### 1.2 表分类

系统共设计 **17张表**，按业务域分类如下：

#### 用户域 (4张表)
- `sys_user` - 用户基础信息表
- `user_address` - 用户收货地址表
- `user_account` - 用户账户表
- `user_feedback` - 用户反馈表

#### 商品域 (2张表)
- `product_category` - 商品分类表
- `product` - 商品信息表

#### 拼团域 (2张表)
- `group_buy` - 拼团活动表
- `group_buy_join` - 拼团参与记录表

#### 订单域 (3张表)
- `shopping_cart` - 购物车表
- `order_main` - 订单主表
- `order_item` - 订单明细表

#### 配送域 (1张表)
- `delivery` - 配送单表

#### 支付域 (2张表)
- `payment_record` - 支付记录表
- `commission_record` - 佣金记录表

#### 团长域 (2张表)
- `group_leader_store` - 团长团点表
- `group_member` - 团员关系表

#### 系统域 (1张表)
- `sys_operation_log` - 系统操作日志表

### 1.3 命名规范

- **表名**: 小写+下划线，如 `sys_user`
- **字段名**: 小写+下划线，如 `user_id`
- **主键**: `{表名}_id`，如 `user_id`
- **外键**: `fk_{当前表}_{关联表}`
- **索引**: `idx_{字段名}`
- **唯一索引**: `uk_{字段名}`

---

## 2. 表结构设计

### 2.1 用户基础信息表 (sys_user)

**表名**: `sys_user`  
**说明**: 存储所有用户（普通用户、团长、管理员）的基础信息  
**引擎**: InnoDB  
**字符集**: utf8mb4

#### 表结构

| 字段名 | 类型 | 长度 | 空值 | 主键 | 默认值 | 说明 |
|--------|------|------|------|------|--------|------|
| user_id | bigint | - | NO | YES | 自增 | 用户唯一ID |
| username | varchar | 50 | NO | NO | - | 登录账号 |
| password | varchar | 100 | NO | NO | - | 加密密码（MD5/SHA256） |
| role | tinyint | - | NO | NO | - | 角色（1-普通用户；2-团长；3-管理员） |
| real_name | varchar | 50 | YES | NO | NULL | 真实姓名 |
| phone | varchar | 20 | YES | NO | NULL | 手机号（加密存储） |
| wx_openid | varchar | 100 | YES | NO | NULL | 微信OpenID |
| avatar | varchar | 255 | YES | NO | NULL | 头像URL |
| status | tinyint | - | NO | NO | 1 | 状态（0-禁用；1-正常） |
| create_time | datetime | - | NO | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | YES | NO | NULL | 更新时间 |

#### 索引

- **主键索引**: `PRIMARY KEY (user_id)`
- **唯一索引**: 
  - `uk_username (username)` - 账号唯一
  - `uk_phone (phone)` - 手机号唯一
  - `uk_wx_openid (wx_openid)` - 微信OpenID唯一

#### 业务规则

1. `username` 必须唯一，用于登录
2. `password` 必须使用SHA256+盐值加密存储
3. `phone` 使用AES加密存储
4. `role` 枚举值：
   - 1: 普通用户（社区居民）
   - 2: 团长（社区服务点负责人）
   - 3: 系统管理员
5. `status=0` 时用户被禁用，无法登录

---

### 2.2 用户收货地址表 (user_address)

**表名**: `user_address`  
**说明**: 存储用户收货地址，支持地理路径计算（Dijkstra算法）  
**引擎**: InnoDB

#### 表结构

| 字段名 | 类型 | 长度 | 小数点 | 空值 | 主键 | 默认值 | 说明 |
|--------|------|------|--------|------|------|--------|------|
| address_id | bigint | - | - | NO | YES | 自增 | 地址ID |
| user_id | bigint | - | - | NO | NO | - | 关联用户ID |
| receiver | varchar | 50 | - | NO | NO | - | 收件人 |
| phone | varchar | 20 | - | NO | NO | - | 收件人电话（加密存储） |
| province | varchar | 20 | - | NO | NO | - | 省份 |
| city | varchar | 20 | - | NO | NO | - | 城市 |
| district | varchar | 20 | - | NO | NO | - | 区/县 |
| detail | varchar | 255 | - | NO | NO | - | 详细地址 |
| longitude | decimal | 10 | 6 | NO | NO | - | 地址经度（Dijkstra算法输入） |
| latitude | decimal | 10 | 6 | NO | NO | - | 地址纬度（Dijkstra算法输入） |
| is_default | tinyint | - | - | NO | NO | 0 | 是否默认（0-否；1-是） |

#### 索引与约束

- **主键**: `address_id`
- **普通索引**: `idx_user_id` - 查询用户的所有地址
- **外键**: `fk_address_user` → `sys_user(user_id)` 级联删除

#### 业务规则

1. 每个用户可以有多个收货地址
2. 每个用户只能有一个默认地址 (`is_default=1`)
3. 经纬度由高德地图API地理编码获取
4. 删除用户时级联删除所有地址

---

### 2.3 用户账户表 (user_account)

**表名**: `user_account`  
**说明**: 管理用户余额及资金流转  
**引擎**: InnoDB

#### 表结构

| 字段名 | 类型 | 长度 | 小数点 | 空值 | 主键 | 默认值 | 说明 |
|--------|------|------|--------|------|------|--------|------|
| account_id | bigint | - | - | NO | YES | 自增 | 账户ID |
| user_id | bigint | - | - | NO | NO | - | 关联用户ID |
| balance | decimal | 10 | 2 | NO | NO | 0.00 | 可用余额 |
| freeze_amount | decimal | 10 | 2 | NO | NO | 0.00 | 冻结金额（未结算佣金/退款中） |
| update_time | datetime | - | - | NO | NO | CURRENT_TIMESTAMP | 最后更新时间 |

#### 索引与约束

- **主键**: `account_id`
- **唯一索引**: `uk_user_id` - 一个用户只能有一个账户
- **外键**: `fk_account_user` → `sys_user(user_id)` 级联删除

#### 业务规则

1. 用户注册后自动创建账户，初始余额为0
2. `balance` 为可用余额，可用于支付订单
3. `freeze_amount` 为冻结金额：
   - 团长未结算佣金
   - 退款处理中的金额
4. 充值、消费、退款需使用数据库事务保证一致性

---

### 2.4 用户反馈表 (user_feedback) ⭐新增

**表名**: `user_feedback`  
**说明**: 存储用户反馈信息，支持管理员处理与回复  
**引擎**: InnoDB

#### 表结构

| 字段名 | 类型 | 空值 | 默认值 | 说明 |
|--------|------|------|--------|------|
| feedback_id | bigint | NO | 自增 | 反馈ID |
| user_id | bigint | NO | - | 用户ID |
| type | tinyint | NO | - | 反馈类型 |
| content | text | NO | - | 反馈内容 |
| images | text | YES | NULL | 图片URL（多张用逗号分隔） |
| status | tinyint | NO | 0 | 处理状态 |
| reply | text | YES | NULL | 处理意见（管理员回复） |
| reply_time | datetime | YES | NULL | 处理时间 |
| create_time | datetime | NO | CURRENT_TIMESTAMP | 反馈提交时间 |
| update_time | datetime | YES | NULL | 更新时间 |

#### 枚举值

**type (反馈类型)**:
- 1: 功能问题（如登录失败、页面报错）
- 2: 商品问题（如商品描述不符、质量问题）
- 3: 配送问题（如配送延迟、地址错误）
- 4: 支付问题（如支付失败、退款问题）
- 5: 其他

**status (处理状态)**:
- 0: 待处理
- 1: 处理中
- 2: 已解决
- 3: 已关闭

#### 索引与约束

- **主键**: `feedback_id`
- **普通索引**: 
  - `idx_user_id` - 查询用户反馈
  - `idx_status` - 按状态筛选
  - `idx_create_time` - 按时间排序
- **外键**: `fk_feedback_user` → `sys_user(user_id)` 级联删除

---

### 2.5 商品分类表 (product_category)

**表名**: `product_category`  
**说明**: 管理商品分类体系，支持多级分类  
**引擎**: InnoDB

#### 表结构

| 字段名 | 类型 | 长度 | 空值 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| category_id | bigint | - | NO | 自增 | 分类ID |
| parent_id | bigint | - | NO | 0 | 父分类ID（0-顶级分类） |
| category_name | varchar | 50 | NO | - | 分类名称 |
| sort | int | - | NO | 0 | 排序权重（值越小越靠前） |
| status | tinyint | - | NO | 1 | 状态（0-禁用；1-启用） |

#### 索引

- **主键**: `category_id`
- **普通索引**: `idx_parent_id` - 查询子分类

#### 业务规则

1. 支持二级分类结构（顶级分类 → 子分类）
2. 顶级分类的 `parent_id=0`
3. 删除分类时需检查是否有商品关联
4. `sort` 值越小，显示顺序越靠前

---

### 2.6 商品信息表 (product)

**表名**: `product`  
**说明**: 存储商品信息，支持拼团及普通购买  
**引擎**: InnoDB

#### 表结构

| 字段名 | 类型 | 长度 | 小数点 | 空值 | 默认值 | 说明 |
|--------|------|------|--------|------|--------|------|
| product_id | bigint | - | - | NO | 自增 | 商品ID |
| category_id | bigint | - | - | YES | NULL | 关联分类ID |
| product_name | varchar | 100 | - | NO | - | 商品名称 |
| cover_img | varchar | 255 | - | NO | - | 封面图URL |
| detail | text | - | - | YES | NULL | 商品详情（富文本） |
| price | decimal | 10 | 2 | NO | - | 原价 |
| group_price | decimal | 10 | 2 | YES | NULL | 拼团参考价（可被活动覆盖） |
| stock | int | - | - | NO | 0 | 库存数量 |
| status | tinyint | - | - | NO | 1 | 状态（0-下架；1-上架） |
| create_time | datetime | - | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | - | YES | NULL | 更新时间 |

#### 索引与约束

- **主键**: `product_id`
- **普通索引**: `idx_category_id` - 按分类查询
- **外键**: `fk_product_category` → `product_category(category_id)` SET NULL

#### 业务规则

1. `status=1` 时商品在前端展示
2. `stock=0` 时商品显示"缺货"
3. `group_price` 为拼团参考价，实际拼团价格由 `group_buy` 表的 `group_price` 决定
4. 删除分类时，商品的 `category_id` 设为 NULL

---

### 2.7 团长团点表 (group_leader_store)

**表名**: `group_leader_store`  
**说明**: 存储团长信息及团点地理数据，支持分单与配送  
**引擎**: InnoDB

#### 表结构

| 字段名 | 类型 | 长度 | 小数点 | 空值 | 默认值 | 说明 |
|--------|------|------|--------|------|--------|------|
| store_id | bigint | - | - | NO | 自增 | 团点ID |
| leader_id | bigint | - | - | NO | - | 关联团长用户ID（role=2） |
| store_name | varchar | 100 | - | NO | - | 团点名称 |
| province | varchar | 20 | - | NO | - | 所在省份 |
| city | varchar | 20 | - | NO | - | 所在城市 |
| district | varchar | 20 | - | NO | - | 所在区/县 |
| detail_address | varchar | 255 | - | NO | - | 详细地址 |
| longitude | decimal | 10 | 6 | NO | - | 团点经度（路径计算起点） |
| latitude | decimal | 10 | 6 | NO | - | 团点纬度（路径计算起点） |
| max_delivery_range | int | - | - | NO | 3000 | 最大配送范围（米，分单逻辑依据） |
| audit_status | tinyint | - | - | NO | 0 | 资质审核状态 |
| audit_time | datetime | - | - | YES | NULL | 审核时间 |
| commission_rate | decimal | 5 | 2 | NO | 5.00 | 佣金比例（%） |

#### 枚举值

**audit_status (审核状态)**:
- 0: 待审核
- 1: 审核通过
- 2: 审核拒绝

#### 索引与约束

- **主键**: `store_id`
- **唯一索引**: `uk_leader_id` - 一个团长只能有一个团点
- **外键**: `fk_store_leader` → `sys_user(user_id)` 级联删除

#### 业务规则

1. 用户申请成为团长后，管理员审核通过 (`audit_status=1`) 才能开展业务
2. `max_delivery_range` 定义团点服务范围，用于订单分单
3. `commission_rate` 为团长佣金比例，范围0-100
4. 经纬度由高德地图API获取

---

### 2.8 团员关系表 (group_member)

**表名**: `group_member`  
**说明**: 管理团长与团员的绑定关系  
**引擎**: InnoDB

#### 表结构

| 字段名 | 类型 | 空值 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | bigint | NO | 自增 | 记录ID |
| leader_id | bigint | NO | - | 团长用户ID（role=2） |
| member_id | bigint | NO | - | 团员用户ID（role=1） |
| join_time | datetime | NO | CURRENT_TIMESTAMP | 加入时间 |
| status | tinyint | NO | 1 | 状态（0-已退出；1-正常） |

#### 索引与约束

- **主键**: `id`
- **唯一索引**: `uk_leader_member (leader_id, member_id)` - 一个用户不能重复加入同一团长
- **普通索引**: 
  - `idx_leader_id` - 查询团长的所有团员
  - `idx_member_id` - 查询团员所属团长
- **外键**: 
  - `fk_member_leader` → `sys_user(user_id)` 级联删除
  - `fk_member_user` → `sys_user(user_id)` 级联删除

#### 业务规则

1. 用户可以加入多个团长
2. 团长审核通过团员申请后，创建记录
3. `status=0` 表示团员已退出该团长

---

### 2.9 拼团活动表 (group_buy)

**表名**: `group_buy`  
**说明**: 存储拼团活动核心参数，覆盖全生命周期  
**引擎**: InnoDB

#### 表结构

| 字段名 | 类型 | 长度 | 小数点 | 空值 | 默认值 | 说明 |
|--------|------|------|--------|------|--------|------|
| activity_id | bigint | - | - | NO | 自增 | 活动ID |
| product_id | bigint | - | - | NO | - | 关联商品ID |
| leader_id | bigint | - | - | YES | NULL | 发起团长ID（可空，系统默认团长） |
| group_price | decimal | 10 | 2 | NO | - | 拼团价（活动专属） |
| required_num | int | - | - | NO | 2 | 成团人数 |
| start_time | datetime | - | - | NO | - | 活动开始时间 |
| end_time | datetime | - | - | NO | - | 活动结束时间 |
| status | tinyint | - | - | NO | 0 | 状态 |
| qrcode_url | varchar | 255 | - | YES | NULL | 拼团二维码URL |
| link | varchar | 255 | - | YES | NULL | 拼团专属链接 |

#### 枚举值

**status (活动状态)**:
- 0: 未开始
- 1: 进行中
- 2: 已结束
- 3: 异常（如商品下架）

#### 索引与约束

- **主键**: `activity_id`
- **唯一索引**: `uk_link` - 拼团链接唯一
- **普通索引**: 
  - `idx_product_id` - 查询商品的所有拼团活动
  - `idx_leader_id` - 查询团长的所有拼团活动
- **外键**: 
  - `fk_group_product` → `product(product_id)` 级联删除
  - `fk_group_leader` → `sys_user(user_id)` SET NULL

#### 业务规则

1. `group_price` 必须小于商品的 `price`
2. `required_num` 通常为2-10人
3. `link` 格式：`/group/{activity_id}/{token}`
4. 当前时间在 `start_time` 和 `end_time` 之间时，`status=1`
5. 参与人数达到 `required_num` 时自动成团

---

### 2.10 拼团参与表 (group_buy_join)

**表名**: `group_buy_join`  
**说明**: 记录用户参与拼团的行为与状态  
**引擎**: InnoDB

#### 表结构

| 字段名 | 类型 | 空值 | 默认值 | 说明 |
|--------|------|------|--------|------|
| join_id | bigint | NO | 自增 | 参与ID |
| activity_id | bigint | NO | - | 关联活动ID |
| user_id | bigint | NO | - | 参与用户ID |
| is_launcher | tinyint | NO | 0 | 是否发起者（0-否；1-是） |
| join_time | datetime | NO | CURRENT_TIMESTAMP | 加入时间 |
| status | tinyint | NO | 1 | 状态 |

#### 枚举值

**status (参与状态)**:
- 0: 已退出
- 1: 参与中
- 2: 成团

#### 索引与约束

- **主键**: `join_id`
- **普通索引**: 
  - `idx_activity_id` - 查询活动的所有参与者
  - `idx_user_id` - 查询用户参与的所有活动
- **外键**: 
  - `fk_join_activity` → `group_buy(activity_id)` 级联删除
  - `fk_join_user` → `sys_user(user_id)` 级联删除

#### 业务规则

1. 发起拼团的用户 `is_launcher=1`
2. 参与人数 = `COUNT(activity_id WHERE status IN (1,2))`
3. 当参与人数达到 `required_num` 时，所有参与者 `status` 更新为2（成团）

---

### 2.11 购物车表 (shopping_cart)

**表名**: `shopping_cart`  
**说明**: 存储用户待购商品，支持拼团/普通商品混存  
**引擎**: InnoDB

#### 表结构

| 字段名 | 类型 | 空值 | 默认值 | 说明 |
|--------|------|------|--------|------|
| cart_id | bigint | NO | 自增 | 购物车ID |
| user_id | bigint | NO | - | 关联用户ID |
| product_id | bigint | NO | - | 关联商品ID |
| activity_id | bigint | YES | NULL | 关联拼团活动ID（非拼团商品为null） |
| quantity | int | NO | 1 | 数量 |
| add_time | datetime | NO | CURRENT_TIMESTAMP | 添加时间 |
| update_time | datetime | YES | NULL | 更新时间 |

#### 索引与约束

- **主键**: `cart_id`
- **唯一索引**: `uk_user_product_activity (user_id, product_id, activity_id)` - 防止重复添加
- **普通索引**: 
  - `idx_user_id` - 查询用户购物车
  - `idx_product_id` - 商品关联查询
  - `idx_activity_id` - 拼团活动关联查询
- **外键**: 
  - `fk_cart_user` → `sys_user(user_id)` 级联删除
  - `fk_cart_product` → `product(product_id)` 级联删除
  - `fk_cart_activity` → `group_buy(activity_id)` 级联删除

#### 业务规则

1. `activity_id=NULL` 表示普通购买，价格使用商品的 `price`
2. `activity_id≠NULL` 表示拼团购买，价格使用活动的 `group_price`
3. 同一商品、同一活动不能重复添加到购物车

---

### 2.12 订单主表 (order_main)

**表名**: `order_main`  
**说明**: 存储订单核心信息，关联用户、团长与配送  
**引擎**: InnoDB

#### 表结构

| 字段名 | 类型 | 长度 | 小数点 | 空值 | 默认值 | 说明 |
|--------|------|------|--------|------|--------|------|
| order_id | bigint | - | - | NO | 自增 | 订单ID |
| user_id | bigint | - | - | NO | - | 下单用户ID |
| leader_id | bigint | - | - | NO | - | 取货团长ID |
| order_sn | varchar | 50 | - | NO | - | 订单编号（规则：日期+随机数） |
| total_amount | decimal | 10 | 2 | NO | - | 商品总金额 |
| discount_amount | decimal | 10 | 2 | NO | 0.00 | 优惠金额 |
| pay_amount | decimal | 10 | 2 | NO | - | 实付金额（total - discount） |
| order_status | tinyint | - | - | NO | 0 | 订单状态 |
| pay_status | tinyint | - | - | NO | 0 | 支付状态 |
| pay_time | datetime | - | - | YES | NULL | 支付时间 |
| receive_address_id | bigint | - | - | NO | - | 收货地址ID |
| dispatch_group | varchar | 50 | - | YES | NULL | 分单组标识（同批次配送订单） |
| delivery_id | bigint | - | - | YES | NULL | 关联配送单ID |
| create_time | datetime | - | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | - | YES | NULL | 更新时间 |

#### 枚举值

**order_status (订单状态)**:
- 0: 待支付
- 1: 待发货
- 2: 配送中
- 3: 已送达
- 4: 已取消
- 5: 退款中
- 6: 已退款

**pay_status (支付状态)**:
- 0: 未支付
- 1: 已支付

#### 索引与约束

- **主键**: `order_id`
- **唯一索引**: `uk_order_sn` - 订单编号唯一
- **普通索引**: 
  - `idx_user_id` - 查询用户订单
  - `idx_leader_id` - 查询团长订单
  - `idx_delivery_id` - 配送单关联查询
  - `idx_dispatch_group` - 分单组查询
- **外键**: 
  - `fk_order_user` → `sys_user(user_id)` RESTRICT
  - `fk_order_leader` → `sys_user(user_id)` RESTRICT
  - `fk_order_address` → `user_address(address_id)` RESTRICT
  - `fk_order_delivery` → `delivery(delivery_id)` SET NULL

#### 业务规则

1. `order_sn` 格式：`yyyyMMddHHmmss + 6位随机数`
2. `pay_amount = total_amount - discount_amount`
3. 订单状态流转：0→1→2→3（正常流程）
4. 支付超时（30分钟）自动取消订单
5. `dispatch_group` 用于批量配送，格式：`leader_{leader_id}_{yyyyMMdd}_{batch}`

---

### 2.13 订单明细表 (order_item)

**表名**: `order_item`  
**说明**: 存储订单商品明细（快照设计）  
**引擎**: InnoDB

#### 表结构

| 字段名 | 类型 | 长度 | 小数点 | 空值 | 默认值 | 说明 |
|--------|------|------|--------|------|--------|------|
| item_id | bigint | - | - | NO | 自增 | 订单项ID |
| order_id | bigint | - | - | NO | - | 关联订单ID |
| product_id | bigint | - | - | NO | - | 关联商品ID |
| activity_id | bigint | - | - | YES | NULL | 关联拼团活动ID（非拼团为null） |
| product_name | varchar | 100 | - | NO | - | 商品名称（下单时快照） |
| product_img | varchar | 255 | - | YES | NULL | 商品图片（下单时快照） |
| price | decimal | 10 | 2 | NO | - | 购买单价（拼团价/原价） |
| quantity | int | - | - | NO | - | 购买数量 |
| total_price | decimal | 10 | 2 | NO | - | 小计金额（price×quantity） |

#### 索引与约束

- **主键**: `item_id`
- **普通索引**: 
  - `idx_order_id` - 查询订单所有商品
  - `idx_product_id` - 商品销量统计
  - `idx_activity_id` - 拼团活动统计
- **外键**: 
  - `fk_item_order` → `order_main(order_id)` 级联删除
  - `fk_item_product` → `product(product_id)` RESTRICT
  - `fk_item_activity` → `group_buy(activity_id)` SET NULL

#### 业务规则

1. **快照设计**：`product_name`、`product_img`、`price` 保存下单时的商品信息
2. `total_price = price × quantity`
3. 订单的 `total_amount = SUM(total_price)`

---

### 2.14 配送单表 (delivery)

**表名**: `delivery`  
**说明**: 存储配送路径与分单结果（支撑Dijkstra算法）  
**引擎**: InnoDB

#### 表结构

| 字段名 | 类型 | 长度 | 小数点 | 空值 | 默认值 | 说明 |
|--------|------|------|--------|------|--------|------|
| delivery_id | bigint | - | - | NO | 自增 | 配送单ID |
| leader_id | bigint | - | - | NO | - | 负责团长ID |
| dispatch_group | varchar | 50 | - | NO | - | 关联分单组 |
| start_time | datetime | - | - | YES | NULL | 配送开始时间 |
| end_time | datetime | - | - | YES | NULL | 配送完成时间 |
| optimal_route | text | - | - | NO | - | 最优路径（经纬度序列） |
| distance | decimal | 10 | 2 | NO | - | 总配送距离（米） |
| status | tinyint | - | - | NO | 0 | 配送状态 |

#### 枚举值

**status (配送状态)**:
- 0: 待分配
- 1: 配送中
- 2: 已完成

#### 索引与约束

- **主键**: `delivery_id`
- **普通索引**: 
  - `idx_leader_id` - 查询团长配送单
  - `idx_dispatch_group` - 分单组查询
- **外键**: `fk_delivery_leader` → `sys_user(user_id)` RESTRICT

#### 业务规则

1. `optimal_route` 格式：`lat1,lng1;lat2,lng2;...`（Dijkstra算法输出）
2. `distance` 单位为米
3. 团长点击"生成配送路线"时触发Dijkstra算法计算

---

### 2.15 支付记录表 (payment_record)

**表名**: `payment_record`  
**说明**: 记录支付/充值/退款明细，保障交易安全  
**引擎**: InnoDB

#### 表结构

| 字段名 | 类型 | 长度 | 小数点 | 空值 | 默认值 | 说明 |
|--------|------|------|--------|------|--------|------|
| pay_id | bigint | - | - | NO | 自增 | 支付记录ID |
| user_id | bigint | - | - | NO | - | 关联用户ID |
| order_id | bigint | - | - | YES | NULL | 关联订单ID（充值时为null） |
| pay_type | tinyint | - | - | NO | - | 支付类型 |
| amount | decimal | 10 | 2 | NO | - | 金额（正数-支付/充值；负数-退款） |
| pay_status | tinyint | - | - | NO | 0 | 状态（0-失败；1-成功） |
| transaction_id | varchar | 100 | - | YES | NULL | 第三方支付流水号（通用） |
| wx_transaction_id | varchar | 100 | - | YES | NULL | 微信支付专用流水号 |
| pay_callback_info | text | - | - | YES | NULL | 支付回调信息（AES加密存储） |
| encrypt_sign | varchar | 255 | - | NO | - | 数据加密签名（防篡改，SHA256+盐值） |
| create_time | datetime | - | - | NO | CURRENT_TIMESTAMP | 创建时间 |

#### 枚举值

**pay_type (支付类型)**:
- 1: 微信支付
- 2: 支付宝支付
- 3: 余额支付

#### 索引与约束

- **主键**: `pay_id`
- **普通索引**: 
  - `idx_user_id` - 查询用户支付记录
  - `idx_order_id` - 查询订单支付记录
  - `idx_transaction_id` - 第三方流水号查询
- **外键**: 
  - `fk_payment_user` → `sys_user(user_id)` RESTRICT
  - `fk_payment_order` → `order_main(order_id)` SET NULL

#### 业务规则

1. **安全设计**：
   - `pay_callback_info` 使用AES加密存储
   - `encrypt_sign` 使用SHA256+盐值防篡改
2. 充值时 `order_id=NULL`
3. 退款时 `amount` 为负数
4. 支付成功后更新订单的 `pay_status=1`

---

### 2.16 佣金记录表 (commission_record)

**表名**: `commission_record`  
**说明**: 记录团长佣金计算与结算明细  
**引擎**: InnoDB

#### 表结构

| 字段名 | 类型 | 长度 | 小数点 | 空值 | 默认值 | 说明 |
|--------|------|------|--------|------|--------|------|
| commission_id | bigint | - | - | NO | 自增 | 佣金ID |
| leader_id | bigint | - | - | NO | - | 关联团长ID |
| order_id | bigint | - | - | NO | - | 关联订单ID |
| amount | decimal | 10 | 2 | NO | - | 佣金金额（订单实付×佣金比例） |
| status | tinyint | - | - | NO | 0 | 状态（0-未结算；1-已结算） |
| settle_time | datetime | - | - | YES | NULL | 结算时间 |
| create_time | datetime | - | - | NO | CURRENT_TIMESTAMP | 生成时间（订单支付后） |

#### 索引与约束

- **主键**: `commission_id`
- **普通索引**: 
  - `idx_leader_id` - 查询团长佣金
  - `idx_order_id` - 订单佣金查询
- **外键**: 
  - `fk_commission_leader` → `sys_user(user_id)` RESTRICT
  - `fk_commission_order` → `order_main(order_id)` RESTRICT

#### 业务规则

1. 订单配送完成 (`order_status=3`) 后自动生成佣金记录
2. `amount = order.pay_amount × leader_store.commission_rate`
3. 每月1号批量结算：`status=1`，金额转入团长账户 `balance`

---

### 2.17 系统操作日志表 (sys_operation_log)

**表名**: `sys_operation_log`  
**说明**: 记录系统操作审计日志，保障安全  
**引擎**: InnoDB

#### 表结构

| 字段名 | 类型 | 长度 | 空值 | 默认值 | 说明 |
|--------|------|------|--------|--------|------|
| log_id | bigint | - | NO | 自增 | 日志ID |
| user_id | bigint | - | YES | NULL | 操作人ID（管理员/团长） |
| operation | varchar | 255 | NO | - | 操作内容 |
| module | varchar | 50 | NO | - | 操作模块 |
| ip | varchar | 50 | YES | NULL | 操作IP地址 |
| create_time | datetime | - | NO | CURRENT_TIMESTAMP | 操作时间 |

#### 索引

- **主键**: `log_id`
- **普通索引**: 
  - `idx_user_id` - 查询用户操作记录
  - `idx_module` - 按模块筛选
  - `idx_create_time` - 按时间查询

#### 业务规则

1. 记录关键操作：登录、修改密码、审核、删除等
2. `operation` 示例：`"创建拼团活动"`、`"审核团长资质"`
3. `module` 示例：`"拼团活动"`、`"订单管理"`

---

## 3. 表关系图

### 3.1 核心表关系

```
sys_user (用户表) - 核心实体
    ├─ 1:n → user_address (地址表)
    ├─ 1:1 → user_account (账户表)
    ├─ 1:n → user_feedback (反馈表)
    ├─ 1:1 → group_leader_store (团点表，role=2时)
    ├─ 1:n → group_member (团员关系，作为团长)
    ├─ 1:n → group_member (团员关系，作为团员)
    ├─ 1:n → group_buy (拼团活动)
    ├─ 1:n → group_buy_join (拼团参与)
    ├─ 1:n → shopping_cart (购物车)
    ├─ 1:n → order_main (订单，作为下单用户)
    ├─ 1:n → order_main (订单，作为取货团长)
    ├─ 1:n → payment_record (支付记录)
    ├─ 1:n → commission_record (佣金记录)
    └─ 1:n → sys_operation_log (操作日志)

product_category (分类表)
    └─ 1:n → product (商品表)

product (商品表)
    ├─ 1:n → group_buy (拼团活动)
    ├─ 1:n → shopping_cart (购物车)
    └─ 1:n → order_item (订单项)

group_buy (拼团活动表)
    ├─ 1:n → group_buy_join (拼团参与)
    ├─ 1:n → shopping_cart (购物车)
    └─ 1:n → order_item (订单项)

order_main (订单主表)
    ├─ 1:n → order_item (订单项)
    ├─ 1:1 → payment_record (支付记录)
    ├─ 1:1 → commission_record (佣金记录)
    └─ n:1 → delivery (配送单)

delivery (配送单表)
    └─ 1:n → order_main (订单主表)
```

### 3.2 ER关系矩阵

| 表A | 关系 | 表B | 外键 | 说明 |
|-----|------|-----|------|------|
| sys_user | 1:n | user_address | fk_address_user | 用户拥有多个地址 |
| sys_user | 1:1 | user_account | fk_account_user | 用户有一个账户 |
| sys_user | 1:n | user_feedback | fk_feedback_user | 用户提交多个反馈 |
| sys_user | 1:1 | group_leader_store | fk_store_leader | 团长有一个团点 |
| sys_user | 1:n | group_member | fk_member_leader | 团长管理多个团员 |
| sys_user | 1:n | group_member | fk_member_user | 用户可加入多个团长 |
| product_category | 1:n | product | fk_product_category | 分类包含多个商品 |
| product | 1:n | group_buy | fk_group_product | 商品有多个拼团活动 |
| group_buy | 1:n | group_buy_join | fk_join_activity | 活动有多个参与者 |
| sys_user | n:m | group_buy | group_buy_join | 用户参与多个活动（多对多） |
| order_main | 1:n | order_item | fk_item_order | 订单包含多个商品 |
| order_main | 1:1 | payment_record | fk_payment_order | 订单对应一个支付记录 |
| order_main | 1:1 | commission_record | fk_commission_order | 订单产生一笔佣金 |
| delivery | 1:n | order_main | fk_order_delivery | 配送单包含多个订单 |

---

## 4. 索引设计

### 4.1 主键索引汇总

所有表的主键索引设计遵循统一规范：

| 表名 | 主键字段 | 索引名 | 类型 |
|------|---------|--------|------|
| sys_user | user_id | PRIMARY | BTREE |
| user_address | address_id | PRIMARY | BTREE |
| user_account | account_id | PRIMARY | BTREE |
| user_feedback | feedback_id | PRIMARY | BTREE |
| product_category | category_id | PRIMARY | BTREE |
| product | product_id | PRIMARY | BTREE |
| group_leader_store | store_id | PRIMARY | BTREE |
| group_member | id | PRIMARY | BTREE |
| group_buy | activity_id | PRIMARY | BTREE |
| group_buy_join | join_id | PRIMARY | BTREE |
| shopping_cart | cart_id | PRIMARY | BTREE |
| order_main | order_id | PRIMARY | BTREE |
| order_item | item_id | PRIMARY | BTREE |
| delivery | delivery_id | PRIMARY | BTREE |
| payment_record | pay_id | PRIMARY | BTREE |
| commission_record | commission_id | PRIMARY | BTREE |
| sys_operation_log | log_id | PRIMARY | BTREE |

### 4.2 唯一索引汇总

| 表名 | 索引名 | 字段 | 用途 |
|------|--------|------|------|
| sys_user | uk_username | username | 账号唯一 |
| sys_user | uk_phone | phone | 手机号唯一 |
| sys_user | uk_wx_openid | wx_openid | 微信OpenID唯一 |
| user_account | uk_user_id | user_id | 一个用户一个账户 |
| group_leader_store | uk_leader_id | leader_id | 一个团长一个团点 |
| group_member | uk_leader_member | leader_id, member_id | 不能重复加入同一团长 |
| group_buy | uk_link | link | 拼团链接唯一 |
| shopping_cart | uk_user_product_activity | user_id, product_id, activity_id | 防止重复添加 |
| order_main | uk_order_sn | order_sn | 订单编号唯一 |

### 4.3 普通索引汇总

#### 按查询频率分类

**高频查询索引**（建议优先优化）:
- `sys_user`: 无（主键查询为主）
- `user_address.idx_user_id`: 查询用户的所有地址
- `order_main.idx_user_id`: 查询用户的所有订单
- `order_main.idx_leader_id`: 查询团长的所有订单
- `order_item.idx_order_id`: 查询订单的所有商品
- `shopping_cart.idx_user_id`: 查询用户购物车

**中频查询索引**:
- `product.idx_category_id`: 按分类查询商品
- `group_buy.idx_product_id`: 查询商品的拼团活动
- `group_buy_join.idx_activity_id`: 查询活动参与者
- `payment_record.idx_order_id`: 查询订单支付记录
- `commission_record.idx_leader_id`: 查询团长佣金

**低频查询索引**（审计、统计用）:
- `sys_operation_log.idx_user_id`: 查询用户操作记录
- `sys_operation_log.idx_module`: 按模块筛选日志
- `sys_operation_log.idx_create_time`: 按时间查询日志
- `user_feedback.idx_status`: 按状态筛选反馈

---

## 5. 外键约束

### 5.1 级联策略说明

| 策略 | 说明 | 应用场景 |
|------|------|---------|
| CASCADE | 级联删除/更新 | 用户删除时，其地址、账户等应一起删除 |
| RESTRICT | 限制删除 | 订单关联的用户不能删除 |
| SET NULL | 设为NULL | 分类删除时，商品的category_id设为NULL |

### 5.2 外键约束汇总

| 外键名 | 子表 | 子表字段 | 父表 | 父表字段 | DELETE策略 | UPDATE策略 |
|--------|------|---------|------|---------|-----------|-----------|
| fk_address_user | user_address | user_id | sys_user | user_id | CASCADE | CASCADE |
| fk_account_user | user_account | user_id | sys_user | user_id | CASCADE | CASCADE |
| fk_feedback_user | user_feedback | user_id | sys_user | user_id | CASCADE | CASCADE |
| fk_product_category | product | category_id | product_category | category_id | SET NULL | CASCADE |
| fk_store_leader | group_leader_store | leader_id | sys_user | user_id | CASCADE | CASCADE |
| fk_member_leader | group_member | leader_id | sys_user | user_id | CASCADE | CASCADE |
| fk_member_user | group_member | member_id | sys_user | user_id | CASCADE | CASCADE |
| fk_group_product | group_buy | product_id | product | product_id | CASCADE | CASCADE |
| fk_group_leader | group_buy | leader_id | sys_user | user_id | SET NULL | CASCADE |
| fk_join_activity | group_buy_join | activity_id | group_buy | activity_id | CASCADE | CASCADE |
| fk_join_user | group_buy_join | user_id | sys_user | user_id | CASCADE | CASCADE |
| fk_cart_user | shopping_cart | user_id | sys_user | user_id | CASCADE | CASCADE |
| fk_cart_product | shopping_cart | product_id | product | product_id | CASCADE | CASCADE |
| fk_cart_activity | shopping_cart | activity_id | group_buy | activity_id | CASCADE | CASCADE |
| fk_order_user | order_main | user_id | sys_user | user_id | RESTRICT | CASCADE |
| fk_order_leader | order_main | leader_id | sys_user | user_id | RESTRICT | CASCADE |
| fk_order_address | order_main | receive_address_id | user_address | address_id | RESTRICT | CASCADE |
| fk_order_delivery | order_main | delivery_id | delivery | delivery_id | SET NULL | CASCADE |
| fk_item_order | order_item | order_id | order_main | order_id | CASCADE | CASCADE |
| fk_item_product | order_item | product_id | product | product_id | RESTRICT | CASCADE |
| fk_item_activity | order_item | activity_id | group_buy | activity_id | SET NULL | CASCADE |
| fk_delivery_leader | delivery | leader_id | sys_user | user_id | RESTRICT | CASCADE |
| fk_payment_user | payment_record | user_id | sys_user | user_id | RESTRICT | CASCADE |
| fk_payment_order | payment_record | order_id | order_main | order_id | SET NULL | CASCADE |
| fk_commission_leader | commission_record | leader_id | sys_user | user_id | RESTRICT | CASCADE |
| fk_commission_order | commission_record | order_id | order_main | order_id | RESTRICT | CASCADE |
| fk_log_user | sys_operation_log | user_id | sys_user | user_id | SET NULL | CASCADE |

---

## 6. 字段类型说明

### 6.1 常用字段类型

| 类型 | 说明 | 使用场景 | 示例 |
|------|------|---------|------|
| bigint | 大整数，8字节 | 主键、外键 | user_id, order_id |
| int | 整数，4字节 | 数量、权重 | stock, sort, quantity |
| tinyint | 小整数，1字节 | 状态、类型 | status, role, type |
| decimal(10,2) | 定点数，2位小数 | 金额、价格 | price, amount, balance |
| decimal(10,6) | 定点数，6位小数 | 经纬度 | longitude, latitude |
| varchar(n) | 可变长字符串 | 名称、地址 | username, product_name |
| text | 长文本 | 详情、描述 | detail, content, reply |
| datetime | 日期时间 | 时间戳 | create_time, update_time |

### 6.2 字段长度规范

| 字段用途 | 类型 | 长度 | 示例 |
|---------|------|------|------|
| 用户名 | varchar | 50 | username |
| 密码（加密后） | varchar | 100 | password |
| 手机号 | varchar | 20 | phone |
| 姓名 | varchar | 50 | real_name, receiver |
| 商品名称 | varchar | 100 | product_name |
| 地址 | varchar | 255 | detail_address |
| URL | varchar | 255 | cover_img, avatar, qrcode_url |
| 订单编号 | varchar | 50 | order_sn |
| IP地址 | varchar | 50 | ip |
| OpenID | varchar | 100 | wx_openid |

---

## 7. 业务规则说明

### 7.1 用户系统

#### 用户角色
```sql
-- 普通用户（role=1）
- 可浏览商品、发起拼团、下单支付
- 可申请成为团长

-- 团长（role=2）
- 继承普通用户权限
- 可管理团员、处理订单、生成配送路线
- 可获得佣金

-- 管理员（role=3）
- 拥有所有权限
- 可审核团长资质、管理商品、查看统计数据
```

#### 密码安全
```
1. 用户注册时，密码使用 SHA256 + 随机盐值 加密
2. 盐值存储在配置文件中，不存数据库
3. 示例代码：
   String salt = "your_salt_key";
   String encryptedPassword = SecureUtil.sha256(password + salt);
```

### 7.2 拼团业务

#### 拼团流程
```
1. 团长/系统创建拼团活动（group_buy）
2. 用户发起拼团（group_buy_join，is_launcher=1）
3. 其他用户参与拼团（group_buy_join，is_launcher=0）
4. 人数达到 required_num 时自动成团
5. 成团后所有参与者的 status 更新为 2
6. 系统生成订单（order_main + order_item）
```

#### 成团逻辑（SQL示例）
```sql
-- 检查是否成团
SELECT COUNT(*) as join_count
FROM group_buy_join
WHERE activity_id = ? AND status IN (1, 2);

-- 如果 join_count >= required_num，则成团
UPDATE group_buy_join
SET status = 2
WHERE activity_id = ? AND status = 1;
```

### 7.3 订单业务

#### 订单状态流转
```
正常流程:
  0(待支付) → 1(待发货) → 2(配送中) → 3(已送达)

取消流程:
  0(待支付) → 4(已取消)

退款流程:
  1/2(待发货/配送中) → 5(退款中) → 6(已退款)
```

#### 订单超时自动取消
```sql
-- 定时任务（每5分钟执行）
UPDATE order_main
SET order_status = 4, update_time = NOW()
WHERE order_status = 0
  AND pay_status = 0
  AND create_time < DATE_SUB(NOW(), INTERVAL 30 MINUTE);
```

### 7.4 配送业务

#### 订单分单规则
```
1. 按团长分组：同一团长的订单归为一组
2. 按日期分批：同一天的订单归为一批
3. dispatch_group 格式：leader_{leader_id}_{yyyyMMdd}_{batch}
   例如：leader_1001_20251012_01
```

#### Dijkstra算法流程
```
输入：
  - 起点：团点坐标（group_leader_store.longitude, latitude）
  - 终点列表：所有订单的收货地址坐标（user_address.longitude, latitude）

算法：
  1. 构建距离矩阵（节点间欧几里得距离）
  2. 执行Dijkstra算法计算最短路径
  3. 生成路径序列（按访问顺序）

输出：
  - optimal_route: "lat1,lng1;lat2,lng2;..."
  - distance: 总距离（米）
```

### 7.5 支付业务

#### 微信支付流程
```
1. 用户点击"支付"按钮
2. 后端调用微信统一下单接口，获取 prepay_id
3. 前端调起微信支付
4. 微信支付完成后回调后端接口
5. 后端验证签名，更新订单支付状态
6. 记录支付信息到 payment_record
```

#### 支付数据加密
```java
// 加密回调信息
String callbackInfo = "..."; // 微信回调JSON
String encryptedInfo = SecureUtil.aes(aesKey).encryptBase64(callbackInfo);

// 生成签名
String signData = pay_id + user_id + order_id + amount + timestamp;
String sign = SecureUtil.sha256(signData + salt);
```

### 7.6 佣金业务

#### 佣金计算
```
订单配送完成后（order_status=3）自动生成佣金记录：

amount = order.pay_amount × leader_store.commission_rate

例如：
  订单实付金额：100元
  团长佣金比例：5%
  佣金金额：100 × 0.05 = 5元
```

#### 佣金结算
```sql
-- 每月1号执行结算
-- 1. 查询未结算佣金
SELECT leader_id, SUM(amount) as total_amount
FROM commission_record
WHERE status = 0
GROUP BY leader_id;

-- 2. 更新账户余额
UPDATE user_account
SET balance = balance + ?,
    update_time = NOW()
WHERE user_id = ?;

-- 3. 标记佣金已结算
UPDATE commission_record
SET status = 1, settle_time = NOW()
WHERE leader_id = ? AND status = 0;
```

---

## 8. 数据字典

### 8.1 枚举值汇总

#### sys_user.role (用户角色)
| 值 | 说明 | 权限 |
|----|------|------|
| 1 | 普通用户 | 浏览商品、下单支付、申请团长 |
| 2 | 团长 | 普通用户权限 + 管理团员、处理订单、配送管理 |
| 3 | 系统管理员 | 所有权限（商品管理、团长审核、数据统计） |

#### sys_user.status / product.status / product_category.status
| 值 | 说明 |
|----|------|
| 0 | 禁用/下架 |
| 1 | 正常/上架 |

#### user_feedback.type (反馈类型)
| 值 | 说明 | 示例 |
|----|------|------|
| 1 | 功能问题 | 登录失败、页面报错 |
| 2 | 商品问题 | 商品描述不符、质量问题 |
| 3 | 配送问题 | 配送延迟、地址错误 |
| 4 | 支付问题 | 支付失败、退款问题 |
| 5 | 其他 | 其他类型反馈 |

#### user_feedback.status (处理状态)
| 值 | 说明 |
|----|------|
| 0 | 待处理 |
| 1 | 处理中 |
| 2 | 已解决 |
| 3 | 已关闭 |

#### group_leader_store.audit_status (审核状态)
| 值 | 说明 |
|----|------|
| 0 | 待审核 |
| 1 | 审核通过 |
| 2 | 审核拒绝 |

#### group_buy.status (拼团活动状态)
| 值 | 说明 |
|----|------|
| 0 | 未开始 |
| 1 | 进行中 |
| 2 | 已结束 |
| 3 | 异常（商品下架等） |

#### group_buy_join.status / group_member.status
| 值 | 说明 |
|----|------|
| 0 | 已退出 |
| 1 | 参与中/正常 |
| 2 | 成团（仅group_buy_join） |

#### order_main.order_status (订单状态)
| 值 | 说明 | 可操作 |
|----|------|--------|
| 0 | 待支付 | 支付、取消 |
| 1 | 待发货 | 发货、退款 |
| 2 | 配送中 | 完成配送 |
| 3 | 已送达 | 无 |
| 4 | 已取消 | 无 |
| 5 | 退款中 | 无 |
| 6 | 已退款 | 无 |

#### order_main.pay_status (支付状态)
| 值 | 说明 |
|----|------|
| 0 | 未支付 |
| 1 | 已支付 |

#### delivery.status (配送状态)
| 值 | 说明 |
|----|------|
| 0 | 待分配 |
| 1 | 配送中 |
| 2 | 已完成 |

#### payment_record.pay_type (支付类型)
| 值 | 说明 |
|----|------|
| 1 | 微信支付 |
| 2 | 支付宝支付 |
| 3 | 余额支付 |

#### payment_record.pay_status / commission_record.status
| 值 | 说明 |
|----|------|
| 0 | 失败/未结算 |
| 1 | 成功/已结算 |

---

## 附录A: SQL快速参考

### A.1 创建数据库
```sql
CREATE DATABASE IF NOT EXISTS community_group_buy
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_0900_ai_ci;

USE community_group_buy;
```

### A.2 执行建表脚本
```bash
# 完整SQL文件
mysql -u root -p < community_group_buy.sql

# 仅user_feedback表
mysql -u root -p community_group_buy < user_feedback.sql
```

### A.3 常用查询示例

#### 查询用户订单
```sql
SELECT o.order_id, o.order_sn, o.total_amount, o.order_status,
       u.real_name, u.phone
FROM order_main o
JOIN sys_user u ON o.user_id = u.user_id
WHERE o.user_id = ? AND o.order_status != 4
ORDER BY o.create_time DESC;
```

#### 查询拼团进度
```sql
SELECT
  gb.activity_id,
  gb.required_num,
  COUNT(gbj.join_id) as current_num,
  gb.end_time
FROM group_buy gb
LEFT JOIN group_buy_join gbj ON gb.activity_id = gbj.activity_id
  AND gbj.status IN (1, 2)
WHERE gb.activity_id = ?
GROUP BY gb.activity_id;
```

#### 查询团长佣金汇总
```sql
SELECT
  SUM(CASE WHEN status = 0 THEN amount ELSE 0 END) as unsettled,
  SUM(CASE WHEN status = 1 THEN amount ELSE 0 END) as settled,
  SUM(amount) as total
FROM commission_record
WHERE leader_id = ?;
```

---

## 附录B: 维护建议

### B.1 定期维护任务

#### 每日任务
- 清理超时未支付订单
- 备份数据库（增量备份）
- 检查日志表大小

#### 每周任务
- 分析慢查询日志
- 优化索引
- 清理过期购物车数据

#### 每月任务
- 全量数据库备份
- 归档历史订单数据
- 统计报表生成
- 团长佣金结算

### B.2 性能优化建议

#### 索引优化
```sql
-- 分析表统计信息
ANALYZE TABLE order_main;

-- 查看索引使用情况
SHOW INDEX FROM order_main;

-- 查看慢查询
SHOW VARIABLES LIKE 'slow_query%';
```

#### 数据归档
```sql
-- 归档1年前的订单
INSERT INTO order_main_archive
SELECT * FROM order_main
WHERE create_time < DATE_SUB(NOW(), INTERVAL 1 YEAR);

DELETE FROM order_main
WHERE create_time < DATE_SUB(NOW(), INTERVAL 1 YEAR);
```

### B.3 安全建议

1. **敏感数据加密**
   - password: SHA256 + 盐值
   - phone: AES加密
   - pay_callback_info: AES加密

2. **定期备份**
   - 每日增量备份
   - 每周全量备份
   - 异地备份

3. **权限控制**
   - 应用账号只授予必要权限（SELECT, INSERT, UPDATE, DELETE）
   - 禁止DROP、TRUNCATE权限
   - 定期审计操作日志

---

**文档结束**

**版本**: v1.0  
**最后更新**: 2025-10-12  
**维护人**: AI Assistant  
**联系方式**: 参见开题报告

