# 第5章 数据库设计说明

## 5.1 关系型数据库设计

### 5.1.1 外部设计

本系统基于MySQL 8.0.36作为主要的数据库开发平台，采用微服务架构设计原则，**按服务拆分数据库**，共创建了**7个独立的数据库Schema**，每个微服务对应一个独立数据库，避免服务间直接访问对方数据库，降低耦合度。

各数据库及其对应的微服务信息如下表所示：

**表5-1 微服务数据库映射关系表**

| 数据库名称 | 对应微服务 | 端口 | 包含表数 | 表名列表 |
|-----------|-----------|------|---------|---------|
| user_service_db | UserService | 8061 | 5张 | sys_user、user_address、user_account、user_feedback、sys_operation_log |
| product_service_db | ProductService | 8062 | 2张 | product_category、product |
| groupbuy_service_db | GroupBuyService | 8063 | 3张 | group_buy、group_buy_team、group_buy_member |
| order_service_db | OrderService | 8065 | 3张 | shopping_cart、order_main、order_item |
| payment_service_db | PaymentService | 8066 | 1张 | payment_record |
| delivery_service_db | DeliveryService | 8067 | 1张 | delivery |
| leader_service_db | LeaderService | 8068 | 4张 | group_leader_store、commission_record、community、community_application |

**总计**：7个数据库，19张数据表。

各数据库采用统一的字符集**utf8mb4**和排序规则**utf8mb4_0900_ai_ci**，支持emoji表情和国际化字符存储。各微服务通过独立的数据库连接配置访问对应数据库，**严格禁止跨库直接访问**，服务间数据交互通过HTTP REST API实现。

#### 微服务数据库拆分优势

1. **服务独立性**：每个服务拥有独立数据库，可独立部署、升级、扩容，互不影响；
2. **故障隔离**：单个数据库故障不影响其他服务的正常运行；
3. **性能优化**：可针对单个服务数据库进行针对性的索引优化和查询优化；
4. **技术异构**：不同服务可根据业务特点选择不同的数据库类型（如引入Redis缓存）；
5. **团队协作**：不同团队可独立开发各自服务，降低协作成本和代码冲突。

---

### 5.1.2 约定

#### （1）数据库名规范

在定义数据库名称的过程中，所有标识符均使用小写字母，并通过下划线连接各个单词，确保名称长度不超过32个字符。名称设计需直观反映其含义，严禁混合使用拼音和英文，确保名称的明确性和规范性。

例如：
- 用户服务数据库命名为"user_service_db"
- 商品服务数据库命名为"product_service_db"
- 拼团服务数据库命名为"groupbuy_service_db"

数据库名称格式：`{服务名}_service_db`，清晰反映数据库与微服务的对应关系。

#### （2）数据库表名规范

数据库表的命名应直接反映其存储内容或用途，并采用下划线连接各个单词以确保名称的清晰度和一致性。表名统一使用小写字母，避免使用复数形式。

例如：
- 用户表：`sys_user`（sys-系统前缀，user-用户）
- 商品分类表：`product_category`（product-商品，category-分类）
- 拼团活动表：`group_buy`（group-团购，buy-购买）

表名前缀约定：
- `sys_`：系统表（如sys_user、sys_operation_log）
- `user_`：用户相关表（如user_address、user_account）
- `product_`：商品相关表（如product_category）
- `group_`：拼团相关表（如group_buy、group_leader_store）
- `order_`：订单相关表（如order_main、order_item）

#### （3）数据库字段名规范

在为数据库字段命名时，名称应结合字段的含义，并使用下划线来区分名称中的不同部分。字段名统一使用小写字母，避免使用MySQL保留字。

字段命名约定：
- 主键：`{表名}_id`（如user_id、product_id、order_id）
- 外键：与关联表的主键同名（如user_id关联sys_user表的user_id）
- 时间字段：`{动作}_time`（如create_time、update_time、expire_time）
- 状态字段：统一使用`status`
- 金额字段：`{用途}_amount`（如total_amount、pay_amount、discount_amount）

#### （4）索引命名规范

- 主键索引：`PRIMARY KEY`（默认）
- 唯一索引：`uk_{字段名}`（如uk_username、uk_phone）
- 普通索引：`idx_{字段名}`（如idx_user_id、idx_status）
- 外键约束：`fk_{当前表}_{关联表}`（如fk_order_user、fk_address_user）

#### （5）字段类型约定

- 主键、外键：`BIGINT`（8字节，支持大数据量）
- 状态、类型枚举：`TINYINT`（1字节，节省存储空间）
- 金额、价格：`DECIMAL(10,2)`（定点数，避免浮点数精度问题）
- 经纬度坐标：`DECIMAL(10,6)`（6位小数，精确到米级）
- 短字符串：`VARCHAR(n)`（如VARCHAR(50)、VARCHAR(100)）
- 长文本：`TEXT`（如商品详情、反馈内容）
- 时间戳：`DATETIME`（精确到秒，默认值CURRENT_TIMESTAMP）

---

### 5.1.3 结构设计

#### （1）确定实体集

本系统通过对社区团购业务流程的分析，抽象出以下核心实体。这些实体均是系统运行中需要持久化存储的核心数据对象，并为多个功能模块提供服务。本系统中实体集如下表所示：

**表5-2 本系统实体集**

| 实体集名称 | 内容 | 标识码 |
|-----------|------|--------|
| 用户 | id，用户名，密码，角色，真实姓名，手机号，头像，社区id，状态 | id |
| 用户地址 | id，用户id，收货人，联系电话，省份，城市，区县，详细地址，经度，纬度，是否默认地址 | id |
| 用户账户 | id，用户id，余额，冻结金额 | id |
| 用户反馈 | id，用户id，反馈类型，反馈内容，图片，处理状态，处理意见 | id |
| 社区 | id，社区名称，省份，城市，区县，详细地址，经度，纬度，状态，创建时间 | id |
| 社区申请 | id，申请人id，社区名称，省份，城市，区县，详细地址，经度，纬度，申请说明，审核状态，拒绝原因，审核后社区id，审核人id，审核时间，申请时间 | id |
| 商品分类 | id，分类名称，父分类id，状态 | id |
| 商品 | id，商品名称，分类id，市场价，拼团价，库存，主图，状态 | id |
| 团长团点 | id，团长id，团点名称，省份，城市，区县，详细地址，经度，纬度，社区id，审核状态，佣金比例 | id |
| 拼团活动 | id，商品id，拼团价，成团人数，开始时间，结束时间，状态 | id |
| 团实例 | id，团号，活动id，发起人id，团长id，社区id，成团人数，当前人数，团状态，成团时间，过期时间，创建时间 | id |
| 参团记录 | id，团id，用户id，订单id，是否发起者，支付金额，参团时间，状态 | id |
| 购物车 | id，用户id，商品id，活动id，数量，添加时间 | id |
| 订单主表 | id，用户id，团长id，订单编号，总金额，实付金额，订单状态，支付状态，收货地址id，配送单id | id |
| 订单项 | id，订单id，商品id，活动id，商品名称，商品图片，单价，数量，小计金额 | id |
| 配送单 | id，团长id，分单组，开始时间，结束时间，最优路径，配送距离，状态 | id |
| 支付记录 | id，用户id，订单id，支付类型，金额，状态，第三方流水号 | id |
| 佣金记录 | id，团长id，订单id，佣金金额，状态，结算时间 | id |
| 系统操作日志 | id，用户id，操作内容，操作模块，操作IP，操作时间 | id |

#### （2）确定联系集

通过分析本系统中实体集关系，可得本系统中联系集如下表所示：

**表5-3 本系统联系集**

| 联系集 | 关系实体 | 构成关系 | 表示码 |
|--------|---------|---------|--------|
| 拥有 | 用户与用户地址 | 1:n | user_id |
| 管理 | 用户与用户账户 | 1:1 | user_id |
| 提交 | 用户与用户反馈 | 1:n | user_id |
| 归属 | 用户与社区 | n:1 | community_id |
| 申请 | 用户与社区申请 | 1:n | applicant_id |
| 归属 | 商品与商品分类 | n:1 | category_id |
| 管理 | 用户与团长团点 | 1:1 | leader_id |
| 归属 | 团长团点与社区 | n:1 | community_id |
| 依托 | 拼团活动与商品 | n:1 | product_id |
| 发起 | 团长与团实例 | 1:n | leader_id |
| 依托 | 拼团活动与团实例 | 1:n | activity_id |
| 归属 | 团实例与社区 | n:1 | community_id |
| 包含 | 团实例与参团记录 | 1:n | team_id |
| 参与 | 用户与参团记录 | 1:n | user_id |
| 关联 | 参团记录与订单 | 1:1 | order_id |
| 存放 | 用户与购物车 | 1:n | user_id |
| 选择 | 购物车与商品 | n:1 | product_id |
| 生成 | 用户与订单 | 1:n | user_id |
| 负责 | 团长与订单 | 1:n | leader_id |
| 包含 | 订单与订单项 | 1:n | order_id |
| 配送 | 配送单与订单 | 1:n | delivery_id |
| 支付 | 用户与支付记录 | 1:n | user_id |
| 关联 | 订单与支付记录 | 1:1 | order_id |
| 计算 | 团长与佣金记录 | 1:n | leader_id |
| 触发 | 订单与佣金记录 | 1:1 | order_id |
| 记录 | 用户与操作日志 | 1:n | user_id |

**联系集关系说明**：

（1）拥有 - 用户与用户地址：一个用户可以拥有多个收货地址，但每个地址只属于一个用户。

（2）归属 - 用户与社区：多个用户归属于同一个社区，用户添加地址时自动匹配最近社区（≤5km）。

（3）管理 - 用户与团长团点：角色为团长的用户拥有一个团点，用于自提和配送管理。

（4）依托 - 拼团活动与团实例：一个拼团活动可以有多个团实例，每个团实例由团长发起。

（5）归属 - 团实例与社区：团实例归属于团长所在社区，用于优先推荐本社区用户参团。

（6）包含 - 团实例与参团记录：一个团包含多条参团记录，记录每个用户的参团信息。

（7）关联 - 参团记录与订单：每条参团记录关联一个订单，用户参团时立即生成订单并支付。

（8）包含 - 订单与订单项：一个订单包含多个订单项，采用快照设计保存下单时的商品信息。

（9）配送 - 配送单与订单：一个配送单包含多个订单，团长使用Dijkstra算法生成最优配送路径。

#### （3）生成E-R图

本系统E-R图如图5-1所示：

**图5-1 社区团购系统E-R图**

```
[此处应使用Draw.io或PowerDesigner绘制E-R图]

核心实体及关系示意：

┌─────────┐
│  社区   │
│community│
└────┬────┘
     │1
     │归属
     │n
┌────┴─────┐        ┌──────────┐
│  用户    │   1    │  用户账户 │
│sys_user  ├────────┤user_account│
└────┬─────┘  管理   └──────────┘
     │1
     │拥有
     │n
┌────┴────────┐     ┌─────────────┐
│ 用户地址     │     │  用户反馈    │
│user_address │     │user_feedback│
└─────────────┘     └─────────────┘

┌──────────┐         ┌────────┐
│ 商品分类  │ 1      │  商品  │
│product_  ├────归属──┤product │
│category  │    n    └───┬────┘
└──────────┘            │1
                        │依托
                        │n
                   ┌────┴─────┐
                   │ 拼团活动  │
                   │group_buy │
                   └────┬─────┘
                        │1
                        │依托
                        │n
                   ┌────┴──────────┐
                   │   团实例      │
                   │group_buy_team │
                   └────┬──────────┘
                        │1
                        │包含
                        │n
                   ┌────┴────────────┐
                   │   参团记录       │
                   │group_buy_member │
                   └────┬────────────┘
                        │1
                        │关联
                        │1
┌──────────┐       ┌────┴──────┐      ┌──────────┐
│ 购物车    │  n    │ 订单主表   │ 1    │ 订单项    │
│shopping_ ├───生成─┤order_main├──包含─┤order_item│
│cart      │       └────┬──────┘      └──────────┘
└──────────┘            │n
                        │配送
                        │1
                   ┌────┴─────┐
                   │  配送单   │
                   │ delivery │
                   └──────────┘

┌──────────┐       ┌──────────┐
│ 支付记录  │  1    │ 佣金记录  │
│payment_  ├───关联─┤commission│
│record    │       │_record   │
└──────────┘       └──────────┘

┌───────────────┐
│ 系统操作日志   │
│sys_operation_ │
│log            │
└───────────────┘
```

**E-R图说明**：
1. 实体用矩形表示，关系用菱形表示，属性用椭圆表示（简化未画出）
2. 连线上的数字表示关系的基数（1表示一个，n表示多个）
3. 粗线框表示强实体，细线框表示弱实体（如订单项依赖订单主表）
4. 虚线表示可选关系（如用户可选择社区）

---

### 5.1.4 运用设计

#### （1）微服务数据库跨库关联处理策略

由于微服务架构下各服务拥有独立数据库，禁止跨库JOIN查询，本系统采用以下策略处理跨库关联：

**① 数据冗余策略（快照设计）**：
- 订单明细表（order_item）冗余商品快照（商品名称product_name、单价price、商品图片product_img），避免查询订单时跨库关联商品表
- 订单主表（order_main）冗余收货地址快照（省市区、详细地址、联系人、电话），避免地址信息变更影响历史订单

**② 服务间调用策略（HTTP REST API）**：
- 订单服务创建订单时，通过HTTP调用商品服务的`GET /api/product/{productId}`接口查询商品详情
- 支付服务回调时，通过HTTP调用订单服务的`PUT /api/order/{orderId}/status`接口更新订单状态
- 拼团服务成团后，通过HTTP调用订单服务批量更新订单状态为"待发货"
- 使用Spring Cloud OpenFeign声明式HTTP客户端简化服务间调用

**③ 分布式事务处理（最终一致性）**：
- 采用Saga模式或消息队列（RabbitMQ）保证最终一致性
- 示例：订单创建→扣减库存→生成配送单，通过消息队列依次执行
- 任一步骤失败通过补偿机制回滚（如库存回退、订单取消）

**④ 外键约束设计原则**：
- 单库内表关联：设置物理外键约束（FOREIGN KEY），保证引用完整性
- 跨库表关联：不设置物理外键，仅在应用层通过代码校验数据完整性

#### （2）数据字典设计

本系统表设计如下表5-4到表5-22所示：

---

**【用户服务数据库 user_service_db】**

**表5-4 用户表（sys_user）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| user_id | bigint | - | - | TRUE | TRUE | 自增 | 用户唯一ID |
| username | varchar | 50 | - | TRUE | FALSE | - | 登录账号 |
| password | varchar | 100 | - | TRUE | FALSE | - | 加密密码（SHA256） |
| role | tinyint | - | - | TRUE | FALSE | - | 角色（1-普通用户；2-团长；3-管理员） |
| real_name | varchar | 50 | - | FALSE | FALSE | NULL | 真实姓名 |
| phone | varchar | 128 | - | FALSE | FALSE | NULL | 手机号（AES加密） |
| wx_openid | varchar | 100 | - | FALSE | FALSE | NULL | 微信OpenID |
| avatar | varchar | 255 | - | FALSE | FALSE | NULL | 头像URL |
| community_id | bigint | - | - | FALSE | FALSE | NULL | 社区id |
| status | tinyint | - | - | TRUE | FALSE | 1 | 状态（0-禁用；1-正常） |
| create_time | datetime | - | - | TRUE | FALSE | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | - | FALSE | FALSE | ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
- PRIMARY KEY (user_id)
- UNIQUE KEY uk_username (username)
- UNIQUE KEY uk_phone (phone)
- INDEX idx_community_id (community_id)
- INDEX idx_role (role)

**外键约束**：
- FOREIGN KEY fk_user_community (community_id) REFERENCES leader_service_db.community(community_id) ON DELETE SET NULL
- 说明：跨库外键不设置物理约束，仅在应用层校验

---

**表5-5 用户地址表（user_address）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| address_id | bigint | - | - | TRUE | TRUE | 自增 | 地址ID |
| user_id | bigint | - | - | TRUE | FALSE | - | 关联用户ID |
| receiver | varchar | 50 | - | TRUE | FALSE | - | 收件人 |
| phone | varchar | 20 | - | TRUE | FALSE | - | 联系电话 |
| province | varchar | 20 | - | TRUE | FALSE | - | 省份 |
| city | varchar | 20 | - | TRUE | FALSE | - | 城市 |
| district | varchar | 20 | - | TRUE | FALSE | - | 区县 |
| detail | varchar | 255 | - | TRUE | FALSE | - | 详细地址 |
| longitude | decimal | 10 | 6 | TRUE | FALSE | - | 地址经度（Dijkstra算法输入） |
| latitude | decimal | 10 | 6 | TRUE | FALSE | - | 地址纬度（Dijkstra算法输入） |
| is_default | tinyint | - | - | TRUE | FALSE | 0 | 是否默认地址（0-否；1-是） |

**索引设计**：
- PRIMARY KEY (address_id)
- INDEX idx_user_id (user_id)

**外键约束**：
- FOREIGN KEY fk_address_user (user_id) REFERENCES sys_user(user_id) ON DELETE CASCADE

---

**表5-6 用户账户表（user_account）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| account_id | bigint | - | - | TRUE | TRUE | 自增 | 账户ID |
| user_id | bigint | - | - | TRUE | FALSE | - | 关联用户ID |
| balance | decimal | 10 | 2 | TRUE | FALSE | 0.00 | 可用余额 |
| freeze_amount | decimal | 10 | 2 | TRUE | FALSE | 0.00 | 冻结金额 |
| update_time | datetime | - | - | TRUE | FALSE | CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
- PRIMARY KEY (account_id)
- UNIQUE KEY uk_user_id (user_id)

**外键约束**：
- FOREIGN KEY fk_account_user (user_id) REFERENCES sys_user(user_id) ON DELETE CASCADE

---

**表5-7 用户反馈表（user_feedback）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| feedback_id | bigint | - | - | TRUE | TRUE | 自增 | 反馈ID |
| user_id | bigint | - | - | TRUE | FALSE | - | 用户ID |
| type | tinyint | - | - | TRUE | FALSE | - | 反馈类型（1-功能问题；2-商品问题；3-配送问题；4-支付问题；5-其他） |
| content | text | - | - | TRUE | FALSE | - | 反馈内容 |
| images | text | - | - | FALSE | FALSE | NULL | 图片URL（多张用逗号分隔） |
| status | tinyint | - | - | TRUE | FALSE | 0 | 处理状态（0-待处理；1-处理中；2-已解决；3-已关闭） |
| reply | text | - | - | FALSE | FALSE | NULL | 处理意见（管理员回复） |
| reply_time | datetime | - | - | FALSE | FALSE | NULL | 处理时间 |
| create_time | datetime | - | - | TRUE | FALSE | CURRENT_TIMESTAMP | 反馈提交时间 |
| update_time | datetime | - | - | FALSE | FALSE | NULL | 更新时间 |

**索引设计**：
- PRIMARY KEY (feedback_id)
- INDEX idx_user_id (user_id)
- INDEX idx_status (status)

**外键约束**：
- FOREIGN KEY fk_feedback_user (user_id) REFERENCES sys_user(user_id) ON DELETE CASCADE

---

**表5-8 系统操作日志表（sys_operation_log）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| log_id | bigint | - | - | TRUE | TRUE | 自增 | 日志ID |
| user_id | bigint | - | - | FALSE | FALSE | NULL | 操作人ID |
| username | varchar | 50 | - | FALSE | FALSE | NULL | 操作人用户名 |
| operation | varchar | 255 | - | TRUE | FALSE | - | 操作内容 |
| module | varchar | 50 | - | TRUE | FALSE | - | 操作模块 |
| method | varchar | 500 | - | FALSE | FALSE | NULL | 操作方法名 |
| params | text | - | - | FALSE | FALSE | NULL | 请求参数（JSON格式） |
| result | varchar | 20 | - | FALSE | FALSE | NULL | 操作结果（SUCCESS/FAIL） |
| error_msg | text | - | - | FALSE | FALSE | NULL | 错误信息 |
| duration | int | - | - | FALSE | FALSE | NULL | 执行时长（毫秒） |
| ip | varchar | 50 | - | FALSE | FALSE | NULL | 操作IP地址 |
| create_time | datetime | - | - | TRUE | FALSE | CURRENT_TIMESTAMP | 操作时间 |

**索引设计**：
- PRIMARY KEY (log_id)
- INDEX idx_user_id (user_id)
- INDEX idx_module (module)
- INDEX idx_create_time (create_time)

**外键约束**：
- FOREIGN KEY fk_log_user (user_id) REFERENCES sys_user(user_id) ON DELETE SET NULL

---

**【商品服务数据库 product_service_db】**

**表5-9 商品分类表（product_category）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| category_id | bigint | - | - | TRUE | TRUE | 自增 | 分类ID |
| parent_id | bigint | - | - | TRUE | FALSE | 0 | 父分类ID（0-顶级分类） |
| category_name | varchar | 50 | - | TRUE | FALSE | - | 分类名称 |
| sort | int | - | - | TRUE | FALSE | 0 | 排序权重（值越小越靠前） |
| status | tinyint | - | - | TRUE | FALSE | 1 | 状态（0-禁用；1-启用） |

**索引设计**：
- PRIMARY KEY (category_id)
- INDEX idx_parent_id (parent_id)

---

**表5-10 商品表（product）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| product_id | bigint | - | - | TRUE | TRUE | 自增 | 商品ID |
| category_id | bigint | - | - | FALSE | FALSE | NULL | 关联分类ID |
| product_name | varchar | 100 | - | TRUE | FALSE | - | 商品名称 |
| cover_img | varchar | 255 | - | TRUE | FALSE | - | 封面图URL |
| detail | text | - | - | FALSE | FALSE | NULL | 商品详情（富文本） |
| price | decimal | 10 | 2 | TRUE | FALSE | - | 原价 |
| group_price | decimal | 10 | 2 | FALSE | FALSE | NULL | 拼团参考价 |
| stock | int | - | - | TRUE | FALSE | 0 | 库存数量 |
| status | tinyint | - | - | TRUE | FALSE | 1 | 状态（0-下架；1-上架） |
| create_time | datetime | - | - | TRUE | FALSE | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | - | FALSE | FALSE | NULL | 更新时间 |

**索引设计**：
- PRIMARY KEY (product_id)
- INDEX idx_category_id (category_id)
- INDEX idx_status (status)

**外键约束**：
- FOREIGN KEY fk_product_category (category_id) REFERENCES product_category(category_id) ON DELETE SET NULL

---

**【拼团服务数据库 groupbuy_service_db】**

**表5-11 拼团活动表（group_buy）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| activity_id | bigint | - | - | TRUE | TRUE | 自增 | 活动ID |
| product_id | bigint | - | - | TRUE | FALSE | - | 关联商品ID |
| group_price | decimal | 10 | 2 | TRUE | FALSE | - | 拼团价 |
| required_num | int | - | - | TRUE | FALSE | 2 | 成团人数 |
| max_num | int | - | - | FALSE | FALSE | NULL | 最大参团人数 |
| start_time | datetime | - | - | TRUE | FALSE | - | 开始时间 |
| end_time | datetime | - | - | TRUE | FALSE | - | 结束时间 |
| status | tinyint | - | - | TRUE | FALSE | 0 | 状态（0-未开始；1-进行中；2-已结束；3-异常） |
| qrcode_url | varchar | 255 | - | FALSE | FALSE | NULL | 二维码URL |
| link | varchar | 255 | - | FALSE | FALSE | NULL | 专属链接 |

**索引设计**：
- PRIMARY KEY (activity_id)
- INDEX idx_product_id (product_id)
- INDEX idx_status (status)
- UNIQUE KEY uk_link (link)

**外键约束**：
- FOREIGN KEY fk_group_product (product_id) REFERENCES product_service_db.product(product_id)
- 说明：跨库外键不设置物理约束，仅在应用层校验

---

**表5-12 团实例表（group_buy_team）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| team_id | bigint | - | - | TRUE | TRUE | 自增 | 团实例唯一ID |
| team_no | varchar | 32 | - | TRUE | FALSE | - | 团号（格式：T+日期+随机数） |
| activity_id | bigint | - | - | TRUE | FALSE | - | 关联拼团活动ID |
| launcher_id | bigint | - | - | TRUE | FALSE | - | 发起人ID（仅团长可发起） |
| leader_id | bigint | - | - | TRUE | FALSE | - | 归属团长ID（与发起人ID一致） |
| community_id | bigint | - | - | FALSE | FALSE | NULL | 归属社区ID |
| required_num | int | - | - | TRUE | FALSE | - | 成团人数（从拼团活动复制） |
| current_num | int | - | - | TRUE | FALSE | 0 | 当前参团人数 |
| team_status | tinyint | - | - | TRUE | FALSE | 0 | 团状态（0-拼团中；1-已成团；2-已失败） |
| success_time | datetime | - | - | FALSE | FALSE | NULL | 成团时间 |
| expire_time | datetime | - | - | TRUE | FALSE | - | 过期时间（默认活动结束后24小时） |
| create_time | datetime | - | - | TRUE | FALSE | CURRENT_TIMESTAMP | 创建时间 |

**索引设计**：
- PRIMARY KEY (team_id)
- UNIQUE KEY uk_team_no (team_no)
- INDEX idx_activity_id (activity_id)
- INDEX idx_launcher_id (launcher_id)
- INDEX idx_community_id (community_id)
- INDEX idx_team_status (team_status)

**外键约束**：
- FOREIGN KEY fk_team_activity (activity_id) REFERENCES group_buy(activity_id) ON DELETE CASCADE
- FOREIGN KEY fk_team_launcher (launcher_id) REFERENCES user_service_db.sys_user(user_id)
- FOREIGN KEY fk_team_community (community_id) REFERENCES leader_service_db.community(community_id)
- 说明：跨库外键不设置物理约束

---

**表5-13 参团记录表（group_buy_member）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| member_id | bigint | - | - | TRUE | TRUE | 自增 | 参团记录唯一ID |
| team_id | bigint | - | - | TRUE | FALSE | - | 关联团实例ID |
| user_id | bigint | - | - | TRUE | FALSE | - | 参团用户ID |
| order_id | bigint | - | - | FALSE | FALSE | NULL | 关联订单ID |
| is_launcher | tinyint | - | - | TRUE | FALSE | 0 | 是否发起人（0-否；1-是） |
| pay_amount | decimal | 10 | 2 | TRUE | FALSE | - | 支付金额 |
| join_time | datetime | - | - | TRUE | FALSE | CURRENT_TIMESTAMP | 参团时间 |
| status | tinyint | - | - | TRUE | FALSE | 0 | 状态（0-待支付；1-已支付；2-已成团；3-已取消） |

**索引设计**：
- PRIMARY KEY (member_id)
- UNIQUE KEY uk_team_user (team_id, user_id)
- INDEX idx_team_id (team_id)
- INDEX idx_user_id (user_id)
- INDEX idx_order_id (order_id)

**外键约束**：
- FOREIGN KEY fk_member_team (team_id) REFERENCES group_buy_team(team_id) ON DELETE CASCADE
- FOREIGN KEY fk_member_user (user_id) REFERENCES user_service_db.sys_user(user_id)
- FOREIGN KEY fk_member_order (order_id) REFERENCES order_service_db.order_main(order_id)
- 说明：跨库外键不设置物理约束

---

**【订单服务数据库 order_service_db】**

**表5-14 购物车表（shopping_cart）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| cart_id | bigint | - | - | TRUE | TRUE | 自增 | 购物车ID |
| user_id | bigint | - | - | TRUE | FALSE | - | 关联用户ID |
| product_id | bigint | - | - | TRUE | FALSE | - | 关联商品ID |
| activity_id | bigint | - | - | FALSE | FALSE | NULL | 关联活动ID（NULL表示普通购买） |
| quantity | int | - | - | TRUE | FALSE | 1 | 数量 |
| add_time | datetime | - | - | TRUE | FALSE | CURRENT_TIMESTAMP | 添加时间 |
| update_time | datetime | - | - | FALSE | FALSE | NULL | 更新时间 |

**索引设计**：
- PRIMARY KEY (cart_id)
- UNIQUE KEY uk_user_product_activity (user_id, product_id, activity_id)
- INDEX idx_user_id (user_id)

**外键约束**：
- 跨库外键不设置物理约束，仅在应用层校验

---

**表5-15 订单主表（order_main）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| order_id | bigint | - | - | TRUE | TRUE | 自增 | 订单ID |
| user_id | bigint | - | - | TRUE | FALSE | - | 下单用户ID |
| leader_id | bigint | - | - | TRUE | FALSE | - | 取货团长ID |
| order_sn | varchar | 50 | - | TRUE | FALSE | - | 订单编号（规则：日期+随机数） |
| total_amount | decimal | 10 | 2 | TRUE | FALSE | - | 商品总金额 |
| discount_amount | decimal | 10 | 2 | TRUE | FALSE | 0.00 | 优惠金额 |
| pay_amount | decimal | 10 | 2 | TRUE | FALSE | - | 实付金额（total-discount） |
| order_status | tinyint | - | - | TRUE | FALSE | 0 | 订单状态（0-待支付；1-待发货；2-配送中；3-已送达；4-已取消；5-退款中；6-已退款） |
| pay_status | tinyint | - | - | TRUE | FALSE | 0 | 支付状态（0-未支付；1-已支付） |
| pay_time | datetime | - | - | FALSE | FALSE | NULL | 支付时间 |
| receive_address_id | bigint | - | - | TRUE | FALSE | - | 收货地址ID |
| dispatch_group | varchar | 50 | - | FALSE | FALSE | NULL | 分单组标识（同批次配送订单） |
| delivery_id | bigint | - | - | FALSE | FALSE | NULL | 关联配送单ID |
| create_time | datetime | - | - | TRUE | FALSE | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | - | FALSE | FALSE | NULL | 更新时间 |

**索引设计**：
- PRIMARY KEY (order_id)
- UNIQUE KEY uk_order_sn (order_sn)
- INDEX idx_user_id (user_id)
- INDEX idx_leader_id (leader_id)
- INDEX idx_dispatch_group (dispatch_group)

**外键约束**：
- 跨库外键不设置物理约束，仅在应用层校验

---

**表5-16 订单项表（order_item）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| item_id | bigint | - | - | TRUE | TRUE | 自增 | 订单项ID |
| order_id | bigint | - | - | TRUE | FALSE | - | 关联订单ID |
| product_id | bigint | - | - | TRUE | FALSE | - | 关联商品ID |
| activity_id | bigint | - | - | FALSE | FALSE | NULL | 关联活动ID（非拼团为null） |
| product_name | varchar | 100 | - | TRUE | FALSE | - | 商品名称（下单时快照） |
| product_img | varchar | 255 | - | FALSE | FALSE | NULL | 商品图片（下单时快照） |
| price | decimal | 10 | 2 | TRUE | FALSE | - | 购买单价（拼团价/原价） |
| quantity | int | - | - | TRUE | FALSE | - | 购买数量 |
| total_price | decimal | 10 | 2 | TRUE | FALSE | - | 小计金额（price×quantity） |

**索引设计**：
- PRIMARY KEY (item_id)
- INDEX idx_order_id (order_id)

**外键约束**：
- FOREIGN KEY fk_item_order (order_id) REFERENCES order_main(order_id) ON DELETE CASCADE

---

**【支付服务数据库 payment_service_db】**

**表5-17 支付记录表（payment_record）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| pay_id | bigint | - | - | TRUE | TRUE | 自增 | 支付记录ID |
| user_id | bigint | - | - | TRUE | FALSE | - | 关联用户ID |
| order_id | bigint | - | - | FALSE | FALSE | NULL | 关联订单ID（充值时为null） |
| pay_type | tinyint | - | - | TRUE | FALSE | - | 支付类型（1-微信支付；2-支付宝支付；3-余额支付） |
| amount | decimal | 10 | 2 | TRUE | FALSE | - | 金额（正数-支付/充值；负数-退款） |
| pay_status | tinyint | - | - | TRUE | FALSE | 0 | 状态（0-失败；1-成功） |
| transaction_id | varchar | 100 | - | FALSE | FALSE | NULL | 第三方支付流水号 |
| wx_transaction_id | varchar | 100 | - | FALSE | FALSE | NULL | 微信支付专用流水号 |
| pay_callback_info | text | - | - | FALSE | FALSE | NULL | 支付回调信息（AES加密存储） |
| encrypt_sign | varchar | 255 | - | TRUE | FALSE | - | 数据加密签名（SHA256+盐值） |
| create_time | datetime | - | - | TRUE | FALSE | CURRENT_TIMESTAMP | 创建时间 |

**索引设计**：
- PRIMARY KEY (pay_id)
- INDEX idx_user_id (user_id)
- INDEX idx_order_id (order_id)
- INDEX idx_transaction_id (transaction_id)

**外键约束**：
- 跨库外键不设置物理约束，仅在应用层校验

---

**【配送服务数据库 delivery_service_db】**

**表5-18 配送单表（delivery）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| delivery_id | bigint | - | - | TRUE | TRUE | 自增 | 配送单ID |
| leader_id | bigint | - | - | TRUE | FALSE | - | 负责团长ID |
| dispatch_group | varchar | 50 | - | TRUE | FALSE | - | 关联分单组 |
| start_time | datetime | - | - | FALSE | FALSE | NULL | 配送开始时间 |
| end_time | datetime | - | - | FALSE | FALSE | NULL | 配送完成时间 |
| optimal_route | text | - | - | TRUE | FALSE | - | 最优路径（经纬度序列） |
| distance | decimal | 10 | 2 | TRUE | FALSE | - | 总配送距离（米） |
| status | tinyint | - | - | TRUE | FALSE | 0 | 配送状态（0-待分配；1-配送中；2-已完成） |

**索引设计**：
- PRIMARY KEY (delivery_id)
- INDEX idx_leader_id (leader_id)
- INDEX idx_dispatch_group (dispatch_group)

**外键约束**：
- 跨库外键不设置物理约束，仅在应用层校验

---

**【团长服务数据库 leader_service_db】**

**表5-19 团长团点表（group_leader_store）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| store_id | bigint | - | - | TRUE | TRUE | 自增 | 团点ID |
| leader_id | bigint | - | - | TRUE | FALSE | - | 关联团长ID |
| store_name | varchar | 100 | - | TRUE | FALSE | - | 团点名称 |
| province | varchar | 20 | - | TRUE | FALSE | - | 省份 |
| city | varchar | 20 | - | TRUE | FALSE | - | 城市 |
| district | varchar | 20 | - | TRUE | FALSE | - | 区县 |
| detail_address | varchar | 255 | - | TRUE | FALSE | - | 详细地址 |
| longitude | decimal | 10 | 6 | TRUE | FALSE | - | 团点经度 |
| latitude | decimal | 10 | 6 | TRUE | FALSE | - | 团点纬度 |
| community_id | bigint | - | - | FALSE | FALSE | NULL | 社区id |
| max_delivery_range | int | - | - | TRUE | FALSE | 3000 | 最大配送范围（米） |
| audit_status | tinyint | - | - | TRUE | FALSE | 0 | 审核状态（0-待审核；1-审核通过；2-审核拒绝） |
| audit_time | datetime | - | - | FALSE | FALSE | NULL | 审核时间 |
| commission_rate | decimal | 5 | 2 | TRUE | FALSE | 5.00 | 佣金比例（%） |

**索引设计**：
- PRIMARY KEY (store_id)
- UNIQUE KEY uk_leader_id (leader_id)
- INDEX idx_community_id (community_id)

**外键约束**：
- FOREIGN KEY fk_store_community (community_id) REFERENCES community(community_id) ON DELETE SET NULL
- 跨库外键fk_store_leader不设置物理约束

---

**表5-20 佣金记录表（commission_record）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| commission_id | bigint | - | - | TRUE | TRUE | 自增 | 佣金ID |
| leader_id | bigint | - | - | TRUE | FALSE | - | 关联团长ID |
| order_id | bigint | - | - | TRUE | FALSE | - | 关联订单ID |
| amount | decimal | 10 | 2 | TRUE | FALSE | - | 佣金金额（订单实付×佣金比例） |
| status | tinyint | - | - | TRUE | FALSE | 0 | 状态（0-未结算；1-已结算） |
| settle_time | datetime | - | - | FALSE | FALSE | NULL | 结算时间 |
| create_time | datetime | - | - | TRUE | FALSE | CURRENT_TIMESTAMP | 生成时间（订单支付后） |

**索引设计**：
- PRIMARY KEY (commission_id)
- INDEX idx_leader_id (leader_id)
- INDEX idx_order_id (order_id)

**外键约束**：
- 跨库外键不设置物理约束，仅在应用层校验

---

**表5-21 社区表（community）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| community_id | bigint | - | - | TRUE | TRUE | 自增 | 社区唯一ID |
| community_name | varchar | 100 | - | TRUE | FALSE | - | 社区名称 |
| province | varchar | 20 | - | TRUE | FALSE | - | 省份 |
| city | varchar | 20 | - | TRUE | FALSE | - | 城市 |
| district | varchar | 20 | - | TRUE | FALSE | - | 区县 |
| address | varchar | 255 | - | TRUE | FALSE | - | 详细地址 |
| longitude | decimal | 10 | 6 | TRUE | FALSE | - | 社区中心经度 |
| latitude | decimal | 10 | 6 | TRUE | FALSE | - | 社区中心纬度 |
| status | tinyint | - | - | TRUE | FALSE | 1 | 状态（0-禁用；1-启用） |
| create_time | datetime | - | - | TRUE | FALSE | CURRENT_TIMESTAMP | 创建时间 |

**索引设计**：
- PRIMARY KEY (community_id)
- INDEX idx_location (province, city, district)
- INDEX idx_status (status)

---

**表5-22 社区申请表（community_application）**

| 名称 | 类型 | 长度 | 小数点 | 非空 | 主键 | 默认值 | 注释 |
|------|------|------|--------|------|------|--------|------|
| application_id | bigint | - | - | TRUE | TRUE | 自增 | 申请唯一ID |
| applicant_id | bigint | - | - | TRUE | FALSE | - | 申请人ID（团长申请人） |
| community_name | varchar | 100 | - | TRUE | FALSE | - | 申请的社区名称 |
| province | varchar | 20 | - | TRUE | FALSE | - | 省份 |
| city | varchar | 20 | - | TRUE | FALSE | - | 城市 |
| district | varchar | 20 | - | TRUE | FALSE | - | 区县 |
| address | varchar | 255 | - | TRUE | FALSE | - | 详细地址 |
| longitude | decimal | 10 | 6 | FALSE | FALSE | NULL | 经度（管理员审核时填写） |
| latitude | decimal | 10 | 6 | FALSE | FALSE | NULL | 纬度（管理员审核时填写） |
| description | text | - | - | FALSE | FALSE | NULL | 申请说明 |
| status | tinyint | - | - | TRUE | FALSE | 0 | 审核状态（0-待审核；1-已通过；2-已拒绝） |
| reject_reason | varchar | 255 | - | FALSE | FALSE | NULL | 拒绝原因 |
| approved_community_id | bigint | - | - | FALSE | FALSE | NULL | 审核通过后生成的社区ID |
| auditor_id | bigint | - | - | FALSE | FALSE | NULL | 审核人ID |
| audit_time | datetime | - | - | FALSE | FALSE | NULL | 审核时间 |
| create_time | datetime | - | - | TRUE | FALSE | CURRENT_TIMESTAMP | 申请时间 |

**索引设计**：
- PRIMARY KEY (application_id)
- INDEX idx_applicant_id (applicant_id)
- INDEX idx_status (status)

**外键约束**：
- FOREIGN KEY fk_app_community (approved_community_id) REFERENCES community(community_id) ON DELETE SET NULL
- 跨库外键不设置物理约束

---

## 5.2 微服务数据库架构图

本系统采用微服务架构，数据库按服务拆分，各服务间通过HTTP REST API进行数据交互。微服务数据库架构如图5-2所示：

**图5-2 微服务数据库架构图**

```
[此处应使用Draw.io或类似工具绘制架构图]

架构示意：

┌─────────────────────────────────────────────────────────┐
│              前端应用层（Vue 3）                          │
│  用户端(5173)  │ 团长端(5175) │  管理端(5174)           │
└────────────────┬────────────────────────────────────────┘
                 │ HTTP/REST API
                 ▼
┌─────────────────────────────────────────────────────────┐
│              服务注册中心（Consul）                       │
└────────────────┬────────────────────────────────────────┘
                 │ 服务发现与负载均衡
    ┌────────────┼────────────┬──────────┬───────────┐
    │            │            │          │           │
    ▼            ▼            ▼          ▼           ▼
┌────────┐  ┌────────┐  ┌─────────┐ ┌────────┐ ┌────────┐
│  User  │  │Product │  │GroupBuy │ │ Order  │ │Payment │
│Service │  │Service │  │Service  │ │Service │ │Service │
│  8061  │  │  8062  │  │  8063   │ │  8065  │ │  8066  │
└───┬────┘  └───┬────┘  └────┬────┘ └───┬────┘ └───┬────┘
    │           │            │          │          │
    ▼           ▼            ▼          ▼          ▼
┌────────┐  ┌────────┐  ┌─────────┐ ┌────────┐ ┌────────┐
│user_   │  │product_│  │groupbuy_│ │order_  │ │payment_│
│service │  │service │  │service  │ │service │ │service │
│_db     │  │_db     │  │_db      │ │_db     │ │_db     │
│5张表   │  │2张表   │  │3张表    │ │3张表   │ │1张表   │
└────────┘  └────────┘  └─────────┘ └────────┘ └────────┘

    ┌────────────┬───────────┐
    │            │           │
    ▼            ▼           ▼
┌────────┐  ┌────────┐ ┌────────┐
│Delivery│  │ Leader │ │        │
│Service │  │Service │ │        │
│  8067  │  │  8068  │ │        │
└───┬────┘  └───┬────┘ └────────┘
    │           │
    ▼           ▼
┌────────┐  ┌────────┐
│delivery│  │leader_ │
│_service│  │service │
│_db     │  │_db     │
│1张表   │  │4张表   │
└────────┘  └────────┘

服务间调用示例（虚线箭头表示HTTP调用）：
OrderService -----> ProductService：查询商品详情
OrderService -----> UserService：查询用户地址
PaymentService ---> OrderService：更新订单支付状态
GroupBuyService --> ProductService：验证商品库存
DeliveryService --> OrderService：获取订单配送信息
```

**架构说明**：
1. 每个微服务拥有独立的数据库Schema，实现数据库层面的服务隔离
2. 服务间不直接访问对方数据库，严格通过HTTP REST API进行数据交互
3. Consul作为服务注册中心，实现服务发现与负载均衡
4. 跨库关联通过应用层代码实现，采用数据冗余（快照）和API调用策略
5. 分布式事务通过Saga模式或消息队列实现最终一致性

---

**文档结束**

---

**说明**：
1. 本章节按照样例格式编写，内容基于开题报告的19张表设计
2. 重点体现了微服务数据库拆分设计，符合"每个子系统对应一个数据库"的要求
3. E-R图和架构图需要使用Draw.io或PowerDesigner等工具绘制
4. 表结构设计保持了开题报告的原有格式和内容
5. 增加了跨库关联处理策略说明，体现微服务架构特点

