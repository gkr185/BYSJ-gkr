# 毕业设计报告补充内容 - 第二部分

## 4.6.1 出错信息（完善版）

本系统采用统一的错误码体系，分为系统错误、业务错误和网络错误三大类。所有错误信息遵循统一格式返回，便于前端统一处理和用户友好提示。

### 错误码设计规范

- **成功码**：200
- **客户端错误**：400-499
- **服务器错误**：500-599  
- **业务错误**：1000-9999（按模块划分）
  - 用户相关：1000-1099
  - 认证相关：1100-1199
  - 商品相关：1200-1299
  - 拼团相关：1300-1399
  - 订单相关：1400-1499
  - 支付相关：1500-1599
  - 配送相关：1600-1699
  - 团长相关：1700-1799

### 系统错误信息表

**表 4-2 系统出错信息表**

| 错误码 | 错误名称 | 系统输出信息 | 处理方法 |
|--------|---------|-------------|---------|
| 400 | 请求参数错误 | "请求参数不合法，请检查输入" | 清空输入，提示具体字段错误信息，返回当前页面 |
| 401 | 未认证 | "未登录或登录已过期，请重新登录" | 清除本地Token，跳转至登录页面 |
| 403 | 权限不足 | "您没有权限执行该操作" | 提示用户权限不足，返回上一页 |
| 404 | 资源不存在 | "请求的资源不存在" | 提示资源不存在，返回首页或上一页 |
| 429 | 请求过于频繁 | "请求过于频繁，请稍后再试" | 等待倒计时结束后重新请求 |
| 500 | 服务器内部错误 | "服务器繁忙，请稍后再试" | 记录错误日志，提示用户稍后重试 |
| 503 | 服务不可用 | "服务暂时不可用，请稍后再试" | 检查服务状态，自动重试或人工介入 |

### 用户认证错误信息表

**表 4-3 用户认证出错信息表**

| 错误码 | 错误名称 | 系统输出信息 | 处理方法 |
|--------|---------|-------------|---------|
| 1001 | 用户不存在 | "用户名或密码错误" | 清空输入，返回登录页面 |
| 1002 | 密码错误 | "用户名或密码错误" | 清空密码输入框，提示剩余尝试次数 |
| 1003 | 密码错误超过3次 | "密码错误次数过多，账号已被锁定1小时" | 禁止登录1小时，跳转至密码重置页面 |
| 1004 | 账号已禁用 | "您的账号已被禁用，请联系管理员" | 跳转至客服联系页面 |
| 1005 | Token已过期 | "登录已过期，请重新登录" | 清除本地Token，跳转至登录页面 |
| 1006 | Token无效 | "登录信息无效，请重新登录" | 清除本地Token，跳转至登录页面 |
| 1007 | 用户名已存在 | "该用户名已被注册" | 提示更换用户名，保留其他输入信息 |
| 1008 | 手机号已注册 | "该手机号已被注册" | 提示更换手机号或使用该号码登录 |

### 业务操作错误信息表

**表 4-4 业务操作出错信息表**

| 错误码 | 错误名称 | 系统输出信息 | 处理方法 |
|--------|---------|-------------|---------|
| 1201 | 商品不存在 | "商品不存在或已下架" | 返回商品列表页面 |
| 1202 | 库存不足 | "商品库存不足，剩余库存{n}件" | 提示剩余库存，引导调整购买数量 |
| 1203 | 商品已下架 | "该商品已下架" | 返回商品列表，推荐相似商品 |
| 1301 | 拼团活动不存在 | "拼团活动不存在或已结束" | 返回拼团活动列表 |
| 1302 | 拼团已满 | "该拼团人数已满" | 推荐其他进行中的拼团 |
| 1303 | 拼团已超时 | "该拼团已超时失败" | 提示拼团失败，引导发起新拼团 |
| 1304 | 非团长无法发起拼团 | "仅团长可发起拼团，您可以参与其他拼团" | 展示可参与的拼团列表 |
| 1305 | 已参与该拼团 | "您已参与该拼团，无需重复操作" | 跳转至拼团详情页 |
| 1401 | 订单不存在 | "订单不存在" | 返回订单列表页面 |
| 1402 | 订单状态异常 | "订单状态异常，无法执行该操作" | 提示当前订单状态，刷新页面 |
| 1403 | 订单已取消 | "订单已取消，无法继续操作" | 返回订单列表 |
| 1404 | 订单超时未支付 | "订单已超时自动取消" | 提示重新下单 |
| 1501 | 支付失败 | "支付失败，请重试" | 返回订单页面，提供重新支付按钮 |
| 1502 | 余额不足 | "账户余额不足，请充值" | 跳转至充值页面 |
| 1503 | 支付金额异常 | "支付金额与订单金额不符" | 记录异常日志，人工审核 |
| 1504 | 退款失败 | "退款处理失败，请联系客服" | 提供客服联系方式 |
| 1701 | 非团长用户 | "该操作仅限团长用户" | 提示申请成为团长 |
| 1702 | 团长资质待审核 | "您的团长申请正在审核中" | 展示审核进度 |
| 1703 | 团长资质已拒绝 | "您的团长申请未通过：{原因}" | 展示拒绝原因，允许重新申请 |

### 数据验证错误信息表

**表 4-5 数据验证出错信息表**

| 错误码 | 错误名称 | 系统输出信息 | 处理方法 |
|--------|---------|-------------|---------|
| 400 | 输入格式错误 | "输入格式不正确，请检查后再输入" | 高亮错误字段，提示正确格式 |
| 400 | 必填项为空 | "{字段名}不能为空" | 高亮空字段，提示必须填写 |
| 400 | 手机号格式错误 | "请输入正确的手机号" | 提示手机号格式要求（11位数字） |
| 400 | 邮箱格式错误 | "请输入正确的邮箱地址" | 提示邮箱格式示例 |
| 400 | 密码长度不符 | "密码长度必须为6-20位" | 提示密码长度要求 |
| 400 | 图片格式不支持 | "仅支持JPG、PNG、GIF格式图片" | 提示支持的图片格式 |
| 400 | 图片大小超限 | "图片大小不能超过5MB" | 提示压缩图片或更换图片 |
| 400 | 日期格式错误 | "请选择正确的日期" | 提供日期选择器 |

### 网络与服务错误信息表

**表 4-6 网络与服务出错信息表**

| 错误码 | 错误名称 | 系统输出信息 | 处理方法 |
|--------|---------|-------------|---------|
| -1 | 网络连接失败 | "网络连接失败，请检查网络设置" | 提示检查网络，提供重试按钮 |
| -2 | 请求超时 | "请求超时，请稍后重试" | 自动重试3次，仍失败则提示手动重试 |
| 503 | 服务维护中 | "系统维护中，预计{时间}恢复" | 展示维护公告，提供预计恢复时间 |
| 500 | 数据库连接失败 | "服务暂时不可用，请稍后再试" | 记录错误日志，发送告警通知管理员 |
| 500 | 第三方服务异常 | "支付服务暂时不可用，请稍后再试" | 记录日志，提示用户稍后重试 |

### 错误处理流程

1. **前端错误拦截**：Axios响应拦截器统一捕获HTTP错误，根据状态码展示对应提示
2. **后端异常捕获**：GlobalExceptionHandler捕获所有异常，返回标准错误格式
3. **日志记录**：所有错误记录到error日志文件，包含请求路径、参数、用户ID、堆栈跟踪
4. **用户提示**：前端使用ElMessage组件展示友好错误提示（避免直接展示技术错误信息）
5. **告警机制**：5xx错误自动发送钉钉/邮件告警通知管理员

---

## 4.6.2 补救措施（完善版）

为确保系统在异常情况下能够快速恢复并保障数据安全，本系统制定了完善的补救措施体系，涵盖数据备份、服务容错、日志监控和应急响应等多个方面。

### 1. 数据备份与恢复

**数据库备份策略**：
- **全量备份**：每日凌晨3:00自动执行MySQL全量备份，使用`mysqldump`工具导出SQL文件
- **增量备份**：每4小时备份binlog日志文件，支持精确时间点恢复
- **备份存储**：备份文件同时存储在本地服务器（保留7天）和远程OSS对象存储（保留30天）
- **备份验证**：每周一自动执行备份文件恢复测试，验证备份有效性

**数据恢复流程**：
1. 发现数据丢失或损坏后，立即停止对受影响表的写操作
2. 根据故障时间点，选择最近的全量备份文件
3. 恢复全量备份后，按时间顺序应用binlog增量日志
4. 验证数据完整性，确认无误后切换至恢复后的数据库
5. 预计恢复时间：全量恢复≤30分钟，增量恢复≤10分钟

**代码与配置备份**：
- 所有代码托管至Git仓库（每日自动推送远程仓库）
- 配置文件（application.yml、数据库连接信息）加密存储至配置中心
- 定期备份服务器环境配置（JDK版本、依赖库清单）

### 2. 服务容错与高可用

**服务多实例部署**：
- 核心服务（UserService、OrderService、PaymentService）部署至少2个实例
- 通过Consul实现服务注册与健康检查，自动剔除故障实例
- Spring Cloud LoadBalancer实现客户端负载均衡，请求自动转发至健康实例

**服务熔断与降级**（待实现）：
- 引入Sentinel框架，配置熔断规则：错误率>50%时触发熔断
- 熔断后返回降级响应（如商品列表查询失败时返回缓存数据）
- 半开状态下每10秒尝试恢复，成功率>80%时自动恢复正常

**数据库主从切换**（待实现）：
- 配置MySQL主从复制，主库宕机时自动切换至从库
- 使用MHA（Master High Availability）工具实现秒级故障切换
- 切换过程对业务透明，应用层无需修改代码

### 3. 日志监控与告警

**实时日志监控**：
- 使用ELK（Elasticsearch + Logstash + Kibana）收集分析日志（待实现）
- 监控关键指标：错误日志数量、接口响应时间、数据库慢查询
- 设置告警规则：5分钟内ERROR日志>10条触发告警

**系统资源监控**：
- 使用Prometheus + Grafana监控服务器资源（CPU、内存、磁盘、网络）
- 告警阈值：CPU使用率>80%、内存使用率>85%、磁盘空间<10%
- 告警通知方式：钉钉群消息 + 邮件 + 短信（紧急情况）

**业务指标监控**：
- 监控订单支付成功率、拼团成团率、接口调用量
- 异常下降时（如支付成功率<95%）自动告警
- 每日生成业务报表，发送至管理员邮箱

### 4. 应急响应机制

**服务器宕机应急预案**：
1. **发现故障**：Consul健康检查失败，触发告警
2. **快速响应**：运维人员5分钟内响应，查看监控平台定位故障
3. **服务切换**：若主服务器无法恢复，手动切换至备用服务器
4. **故障修复**：修复故障服务器，验证正常后重新加入集群
5. **事后复盘**：记录故障原因、影响范围、恢复时间，编写故障报告

**数据库宕机应急预案**：
1. **检测告警**：应用连接数据库失败，自动记录错误日志
2. **主从切换**：自动切换至从库（若已配置主从）
3. **数据恢复**：若主从均不可用，从最近备份恢复数据
4. **服务恢复**：数据库恢复后，重启应用服务，验证功能正常

**网络攻击应急预案**：
1. **DDoS攻击**：触发流量清洗服务（如阿里云DDoS防护），拦截恶意流量
2. **SQL注入**：预编译SQL语句防注入，检测到异常SQL自动拦截并记录IP
3. **XSS攻击**：前端输入过滤、后端响应转义，防止恶意脚本执行
4. **暴力破解**：检测到同一IP短时间内登录失败>5次，封禁IP 1小时

### 5. 人工介入机制

**问题升级流程**：
- **一级告警**（轻微）：自动记录日志，不影响核心功能，次日处理
- **二级告警**（中等）：影响部分功能（如图片上传失败），2小时内响应
- **三级告警**（严重）：核心功能异常（如无法支付），15分钟内响应
- **四级告警**（紧急）：系统崩溃或数据泄露，立即响应，启动应急预案

**技术支持联系方式**：
- 技术负责人：耿康瑞（电话、微信）
- 指导教师：付华（邮箱）
- 运维团队：7×24小时值班电话

**补偿机制**：
- **订单异常**：支付成功但订单未创建时，自动触发退款流程
- **库存异常**：超卖情况下，按下单时间顺序处理，晚下单用户自动退款
- **配送延迟**：超过承诺送达时间，自动发放优惠券补偿用户

### 6. 定期维护计划

**系统维护时间窗口**：
- 每周日凌晨2:00-4:00为系统维护时间（用户访问量最低）
- 维护内容：数据库优化、日志清理、安全补丁更新
- 维护期间系统进入只读模式，禁止下单和支付操作

**预防性维护措施**：
- 每月执行一次压力测试，验证系统承载能力
- 每季度进行一次安全漏洞扫描，修复潜在风险
- 每半年更新一次技术依赖库版本，避免已知漏洞

**数据清理策略**：
- 已完成订单数据保留1年后归档至历史库
- 技术日志文件保留30天后自动删除
- 用户操作日志保留180天（满足审计要求）

通过上述多层次的补救措施，系统能够在发生故障时快速恢复，最大限度地减少对用户的影响，确保业务连续性。预计系统可用性可达到**99.5%以上**（即每月宕机时间<3.6小时），满足社区团购业务的可靠性要求。

---

## 第5章 数据库设计说明

本章详细阐述社区团购系统的数据库设计方案，包括数据库选型、实体关系分析、逻辑结构设计和物理表结构设计。

### 5.1 数据库选型与设计原则

**数据库选型**：
- **类型**：关系型数据库MySQL 8.0.36
- **存储引擎**：InnoDB（支持事务、外键、行级锁）
- **字符集**：utf8mb4（支持emoji表情和生僻字）
- **排序规则**：utf8mb4_0900_ai_ci（不区分大小写，支持中文拼音排序）

**设计原则**：
1. **规范化设计**：遵循第三范式(3NF)，减少数据冗余
2. **完整性约束**：使用主键、外键、唯一索引保证数据完整性
3. **性能优化**：为高频查询字段添加索引，支持快速检索
4. **可扩展性**：预留扩展字段（如status、remark），适应业务发展
5. **安全性**：敏感数据加密存储（密码SHA256、手机号AES、支付数据AES）

### 5.2 数据库实体与联系

本系统共设计**19张表**，按业务域分为8个实体组，各实体间存在明确的关联关系。

#### 5.2.1 核心实体识别

**用户域实体**：
- **用户实体**（sys_user）：存储用户基础信息，属性包括用户ID、用户名、密码、手机号、角色、社区ID等
- **收货地址实体**（user_address）：存储用户收货地址，包含省市区、详细地址、经纬度坐标、是否默认等
- **用户账户实体**（user_account）：管理用户余额、冻结金额、累计消费等财务信息
- **用户反馈实体**（user_feedback）：记录用户提交的反馈内容、处理状态、管理员回复

**社区域实体**（v3.0新增）：
- **社区实体**（community）：存储社区地理信息，包括社区名称、省市区、详细地址、中心经纬度、状态
- **社区申请实体**（community_application）：记录团长申请新社区的审核流程

**商品域实体**：
- **商品分类实体**（product_category）：存储商品分类信息，支持树状结构（父分类ID）
- **商品实体**（product）：商品基础信息，包括名称、价格、库存、分类、图片URL、状态等

**拼团域实体**（v2.0/v3.0优化）：
- **拼团活动实体**（group_buy）：拼团活动模板，定义成团人数、优惠价格、有效期等
- **团实例实体**（group_buy_team）：具体的拼团实例，记录团长、社区、当前人数、成团状态
- **参团记录实体**（group_buy_member）：用户参与拼团的记录，关联团实例和用户

**订单域实体**：
- **购物车实体**（shopping_cart）：临时存储用户选购的商品，包括商品ID、数量、规格
- **订单主表实体**（order_main）：订单基础信息，包括订单号、用户ID、总金额、状态、收货地址
- **订单明细实体**（order_item）：订单商品明细，采用快照设计（冗余商品名称、价格等）

**配送域实体**：
- **配送单实体**（delivery）：配送任务信息，包括配送员、配送路线、预计送达时间、配送状态

**支付域实体**：
- **支付记录实体**（payment_record）：支付流水记录，包括支付方式、金额、第三方交易号、支付时间
- **佣金记录实体**（commission_record）：团长佣金明细，记录订单来源、佣金金额、结算状态

**团长域实体**：
- **团长团点实体**（group_leader_store）：团长自提点信息，包括团长ID、社区ID、团点地址、经纬度

**系统域实体**：
- **操作日志实体**（sys_operation_log）：记录用户操作行为，包括操作类型、请求参数、IP地址、执行时间

#### 5.2.2 实体间联系

**用户与地址（1:N）**：
- 一个用户可以拥有多个收货地址
- 外键：user_address.user_id → sys_user.user_id

**用户与账户（1:1）**：
- 每个用户对应唯一账户
- 外键：user_account.user_id → sys_user.user_id（UNIQUE约束）

**用户与社区（N:1）**：
- 多个用户属于同一社区
- 外键：sys_user.community_id → community.community_id

**商品与分类（N:1）**：
- 多个商品属于同一分类
- 外键：product.category_id → product_category.category_id

**拼团活动与商品（N:1）**：
- 多个拼团活动关联同一商品
- 外键：group_buy.product_id → product.product_id

**拼团活动与团实例（1:N）**：
- 一个拼团活动可以有多个团实例
- 外键：group_buy_team.activity_id → group_buy.activity_id

**团实例与参团记录（1:N）**：
- 一个团实例有多条参团记录
- 外键：group_buy_member.team_id → group_buy_team.team_id

**订单与用户（N:1）**：
- 多个订单属于同一用户
- 外键：order_main.user_id → sys_user.user_id

**订单与订单明细（1:N）**：
- 一个订单包含多个订单明细
- 外键：order_item.order_id → order_main.order_id

**订单与支付记录（1:1）**：
- 每个订单对应一条支付记录
- 外键：payment_record.order_id → order_main.order_id（UNIQUE约束）

**团长与团点（1:1）**：
- 每个团长管理一个团点
- 外键：group_leader_store.leader_id → sys_user.user_id

**团长与佣金记录（1:N）**：
- 一个团长有多条佣金记录
- 外键：commission_record.leader_id → sys_user.user_id

---

### 5.3 E-R图

本系统的实体关系图（Entity-Relationship Diagram）如图5-1所示，清晰展示了各实体间的联系类型及基数关系。

**图5-1 社区团购系统E-R图**

```
[图形描述 - 建议使用Draw.io或PowerDesigner绘制]

核心关系：
┌─────────┐
│sys_user │
│（用户）  │
└────┬────┘
     │1
     │拥有
     │N
┌────┴────────┐       ┌─────────────┐
│user_address │       │user_account │
│（收货地址）  │       │（用户账户）  │
└─────────────┘       └─────────────┘

┌─────────┐         ┌──────────┐
│community│ N       │ product  │
│（社区）  ├────属于─┤ category │
└────┬────┘   1     │（商品分类）│
     │N             └─────┬────┘
     │所在             1 │包含
     │1                  │N
┌────┴────┐         ┌────┴────┐
│sys_user │         │ product │
│（用户）  │         │（商品）  │
└────┬────┘         └────┬────┘
     │1                  │1
     │下单             关联│
     │N                  │N
┌────┴──────┐      ┌─────┴────┐
│order_main │      │group_buy │
│（订单主表）│      │（拼团活动）│
└────┬──────┘      └────┬─────┘
     │1                 │1
     │包含            发起│
     │N                 │N
┌────┴──────┐      ┌─────┴──────────┐
│order_item │      │group_buy_team  │
│（订单明细）│      │（团实例）       │
└───────────┘      └────┬───────────┘
                        │1
                        │包含
                        │N
                   ┌────┴────────────┐
                   │group_buy_member │
                   │（参团记录）      │
                   └─────────────────┘
```

**E-R图说明**：
1. 实体用矩形表示，属性省略（详见数据库表结构）
2. 关系用菱形表示，标注联系名称
3. 基数标注：1表示一个，N表示多个
4. 粗线框表示强实体，细线框表示弱实体（如订单明细依赖订单主表）

---

### 5.4 数据库逻辑结构设计

基于微服务架构设计原则，本系统采用**按服务拆分数据库**的策略，每个微服务对应独立的数据库Schema，避免服务间直接访问对方数据库，降低耦合度。

#### 5.4.1 数据库Schema划分

**Database 1: user_service_db（用户服务数据库）**
- sys_user（用户表）
- user_address（收货地址表）
- user_account（用户账户表）
- user_feedback（用户反馈表）
- sys_operation_log（操作日志表）

**Database 2: product_service_db（商品服务数据库）**
- product_category（商品分类表）
- product（商品表）

**Database 3: groupbuy_service_db（拼团服务数据库）**
- group_buy（拼团活动表）
- group_buy_team（团实例表）
- group_buy_member（参团记录表）

**Database 4: order_service_db（订单服务数据库）**
- shopping_cart（购物车表）
- order_main（订单主表）
- order_item（订单明细表）

**Database 5: payment_service_db（支付服务数据库）**
- payment_record（支付记录表）

**Database 6: delivery_service_db（配送服务数据库）**
- delivery（配送单表）

**Database 7: leader_service_db（团长服务数据库）**
- group_leader_store（团长团点表）
- commission_record（佣金记录表）
- community（社区表）
- community_application（社区申请表）

#### 5.4.2 跨库关联处理策略

由于微服务架构下禁止跨库JOIN查询，本系统采用以下策略处理跨库关联：

**1. 数据冗余策略**：
- 订单明细表（order_item）冗余商品快照（商品名称、价格、图片URL）
- 订单主表（order_main）冗余收货地址快照（省市区、详细地址、联系人、电话）
- 避免查询订单时需要关联商品表和地址表

**2. 服务间调用策略**：
- 订单服务创建订单时，通过HTTP调用商品服务查询商品详情
- 支付服务回调时，通过HTTP调用订单服务更新订单状态
- 使用Feign声明式HTTP客户端简化服务间调用

**3. 分布式事务处理**（待实现）：
- 采用最终一致性策略，通过消息队列（如RabbitMQ）保证事务最终完成
- 示例：订单创建→扣减库存→生成配送单，通过三条消息依次执行
- 任一步骤失败通过补偿机制回滚（如库存回退）

#### 5.4.3 外键约束设计原则

**单库内表关联**：
- 设置物理外键约束，保证引用完整性
- 级联删除策略：CASCADE（如删除订单时级联删除订单明细）
- 级联更新策略：RESTRICT（禁止更新被引用的主键）

**跨库表关联**：
- 不设置物理外键，仅在逻辑层维护关联关系
- 在应用层通过代码校验数据完整性（如创建订单前校验用户ID存在性）

---

*（第5.5节"数据库详细设计"内容较长，包含19张表的完整结构，将在下一部分继续生成）*


